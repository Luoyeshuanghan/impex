/*
 * impexjs is a powerful web application engine to build 
 * reactive webUI system
 *
 *
 * Copyright 2015-2016 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://impexjs.org
 * last build: 2016-07-22
 */
!function(global){"use strict";function setArray(e,t,n){isNaN(t)||(e[t>>0]=n)}function delArray(e,t){isNaN(t)||e.splice(t,1)}function observeData(e,t,n,i){if(n&&n.__im__propChain)return n;var r=n instanceof Array?[]:{};for(var s in n){var a=n[s];if("object"==typeof a){var o=t.concat();o.push(s);var h=observeData(e,o,a,i);r[s]=h}else r[s]=a}Object.defineProperty(r,"__im__propChain",{enumerable:!1,writable:!1,value:t}),Object.defineProperty(r,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]});var l=new Proxy(r,e);Object.defineProperty(l,"__im__target",{enumerable:!1,writable:!1,value:r});var c=Date.now()+Math.random();return Object.defineProperty(r,"__im__oid",{enumerable:!1,writable:!1,value:c}),l}function getter(e){return this.__im__innerProps[e]}function setter(e,t){var n=this.__im__innerProps[e];if(clearObserve(n),"object"==typeof t){var i=this.__im__propChain.concat();i.push(e),t=observeData(i,t,this.__im__comp)}this.__im__innerProps[e]=t;this.__im__propChain,this.__im__extPropChain;handler([{name:e,target:this,oldVal:n,newVal:t,type:"update"}],!0)}function observeData(e,t,n){if(t&&t.__im__propChain)return t;var i=t instanceof Array?[]:{};Object.defineProperty(i,"__im__innerProps",{enumerable:!1,writable:!0,value:{}});var r={},s={};for(var a in t)if(t.hasOwnProperty(a)){var o=t[a];if("object"==typeof o){var h=e.concat();h.push(a);var l=observeData(h,o,n);i.__im__innerProps[a]=l}else i.__im__innerProps[a]=o;s[a]=o,!function(e){r[e]={get:function(){return getter.call(this,e)},set:function(t){setter.call(this,e,t)},enumerable:!0,configurable:!0}}(a)}Object.defineProperties(i,r),Object.defineProperty(i,"__im__propChain",{enumerable:!1,writable:!1,value:e}),Object.defineProperty(i,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]}),Object.defineProperty(i,"__im__target",{enumerable:!1,writable:!1,value:i.__im__innerProps}),Object.defineProperty(i,"__im__comp",{enumerable:!1,writable:!1,value:n});var c=Date.now()+Math.random();return Object.defineProperty(i,"__im__oid",{enumerable:!1,writable:!1,value:c}),observedObjects.push({snap:s,now:i,id:c}),i}function dirtyCheck(){RAF(function(){for(var e=observedObjects.length;e--;){var t=observedObjects[e],n=t.snap,i=t.now,r=(t.id,[]);for(var s in n)if(!(s in i)){var a={};a.name=s,a.target=i,a.oldVal=n[s],a.snap=n,a.type="delete",a.id=r.push(a)}for(var s in i)if(!(s in n)){var a={};a.name=s,a.target=i,a.newVal=i[s],a.snap=n,a.type="add",r.push(a)}r.length>0&&handler(r)}dirtyCheck()})}function clearObserve(e){for(var t=null,n=observedObjects.length;n--&&(t=observedObjects[n],t.id!==e.__im__oid););n>-1&&(observedObjects.splice(n,1),"object"==typeof t&&clearObserve(t))}function handler(e,t){for(var n=e.length;n--;){var i=e[n],r=i.name,s=i.target,a=s.__im__propChain,o=s.__im__extPropChain,h=s.__im__comp,l=i.oldVal,c=i.newVal,p=i.type,u=i.snap;if("add"===p){if(u[r]=c,s.__im__innerProps[r]=c,"object"==typeof c){var _=a.concat();_.push(r),s.__im__innerProps[r]=observeData(_,c,h)}!function(e,t){Object.defineProperty(t,e,{get:function(){return getter.call(this,e)},set:function(t){setter.call(this,e,t)},enumerable:!0,configurable:!0})}(r,s)}else if("delete"===p){var d=u[r];"object"==typeof d&&clearObserve(d),delete u[r]}else if(!t){console.log("无效update");continue}var v={object:s,name:r,pc:a,xpc:o,oldVal:l,newVal:c,comp:h,type:p};ChangeHandler.handle(v)}}function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,n,i,r,s){this.node=e,this.attrName=t,this.origin=n,this.expMap=i,this.component=r,this.toHTML=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,n){this.cbk=e,this.ctrlScope=t,this.segments=n}function Component(e){var t="C_"+im_counter++;this.__id=t,this.__state=Component.state.created,this.view=e,this.name,this.parent,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,this.__watcher,this.__eventMap={},this.template,this.templateURL,this.replace=!0,this.restrict,this.isolate,this.data={},this.methods={},this.events={},impex._cs[this.__id]=this}function broadcast(e,t,n){for(var i=0;i<e.length;i++){var r=e[i],s=r.__eventMap[t],a=!0;if(s){a=!1;for(var o=0;o<s.length;o++)a=s[o].apply(r,n)}a&&r.children.length>0&&broadcast(r.children,t,n)}}function View(e,t,n){this.el=e,this.__nodes=n,this.__evMap={},this.__target=t}function tmplExpFilter(e,t,n){return e=e.replace(REG_TMPL_EXP,function(e,i){var i=i.replace(/\s/gm,"");if("CONTENT"===i)return t;if("BINDPROPS"===i){for(var r="",s=Object.keys(n),a=s.length;a--;)r+=n[s[a]].nodeName+'="'+n[s[a]].nodeValue+'" ';return r}var o=n[i]&&n[i].nodeValue;return o||""})}function Directive(e,t){Component.call(this),this.value=t,this.name=e,this.params,this.filter,this["final"]=!1,this.endTag=null,this.priority=0,this.observe}function Filter(e){this.component=e,this.value,this.onCreate}function Service(){this.singleton,this.host,this.onCreate}function Transition(e,t,n){if(TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE)),n&&n.css===!1)this.__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var i=window.getComputedStyle(TESTNODE,null),r=i["transition-duration"].split(","),s=i["transition-delay"].split(","),a=-1,o=r.length;o--;){var h=parseFloat(r[o]),l=parseFloat(s[o]);h+l>a&&(a=h+l)}if(a>0){var c=t.view,p=t.__expNodes;p.length<1&&t.parent&&(p=t.parent.__expNodes);for(var o=p.length;o--;){var u=p[o];"class"===u.attrName&&(u.origin+=" "+e+"-transition")}c.addClass(e+"-transition"),this.__longest=a;var _=null;for(var d in TRANSITIONS)if(void 0!==c.el.style[d]){_=TRANSITIONS[d];break}c.el.addEventListener(_,this.__done.bind(this),!1),this.__css=!0}}this.__comp=t,this.__view=c,this.__hook=n||{},this.__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function n(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&(r[this.url]||(r[this.url]=this.responseText),this.cbk&&this.cbk(this.responseText))}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype._super=t.prototype},this.ext=function(e,t){for(var n=Object.keys(t),i=n.length;i--;){var r=n[i];e[r]=t[r]}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var i=document.createElement("div");this.isDOMStr=function(e){return i.innerHTML=e,i.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName};var r={};this.loadTemplate=function(i,s,a){if(r[i])return void(s&&s(r[i]));var o=new XMLHttpRequest;o.open("get",i,!0),o.timeout=a||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=n:o.onreadystatechange=n,o.cbk=s,o.url=i,o.send(null)}},Observer={observe:function(e,t){if(e&&e.__im__propChain)return e;var n={comp:t,set:function(e,t,n){var i=!(t in e),r=e[t],s=n;if(r===s)return!0;if("object"==typeof s){var a=e.__im__propChain.concat();a.push(t),s=observeData(this,a,s,this.comp)}e instanceof Array?setArray(e,t,s):e[t]=s;var o=e.__im__propChain,h=e.__im__extPropChain,l={object:e,name:t,pc:o,xpc:h,oldVal:r,newVal:s,comp:this.comp,type:i?"add":"update"};return ChangeHandler.handle(l),!0},deleteProperty:function(e,t){var n=e[t];e instanceof Array?delArray(e,t):delete e[t];var i=e.__im__propChain,r=e.__im__extPropChain,s={object:e,name:t,pc:i,xpc:r,oldVal:n,comp:this.comp,type:"delete"};return ChangeHandler.handle(s),!0}};return observeData(n,[],e,t)}};if(!window.Proxy){var RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),observedObjects=[],observedArys=[],Observer={};Observer.observe=function(e,t){return e&&e.__im__propChain?e:observeData([],e,t)},dirtyCheck()}var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,r){if(o.test(e)){var s=i(r,t);return c="var",s}return a.test(e)?(c="str",n(t,RegExp.$1)):(c="",e)}function n(e,t){for(var n=!1,i=t,r=1;r<e.length;r++){var s=e[r];if("\\"!==s){if(!n&&s===t)return i+t;i+=s,n=!1}else n=!0,i+=s}}function i(n,r,s,a){for(var c="",p=[],u=-1,_=-1,d=-1,v=a||e(),f=0;f<r.length;f++){var m=r[f];if(p.length>0)if(o.test(m)){var g=e(),b=i(n,r.substr(f),!0,g);f=f+b.length-1;var y=b;o.test(b[0])&&l.indexOf(y)<0&&(v.subVars["."+b]=g,l.indexOf(y)<0&&(y=["."+y])),v.words.push(y)}else if("]"===m||")"===m){if(p.pop(),0===p.length){var w=r.substring(u,f+1);c+=w,v.segments.push(w),d=f}")"===m&&(v.isFunc=!0),v.words.push(m),_=f}else{var x=t(m,r.substr(f),n);f=f+x.length-1,v.words.push(x),_=f}else if(h.test(m)){if(c+=m,"."===m){var y=c.substr(d+1);y=y.replace(/\./,""),y&&(v.segments.push(y),d=f)}}else{if("["!==m&&"("!==m){if("]"!==m&&")"!==m||!s){var y=c.substr(_+1);y&&("."!==y[0]&&l.indexOf(y)<0&&(y=["."+y]),v.words.push(y));var E=c.substr(d+1);return E&&(v.segments.push(E),d=f),!s&&l.indexOf(y)<0&&(n["."+c]=v),c}var y=c;if(y[y.length-1]!==m){y=y.substring(_+1,y.length),y&&v.words.push(0===r.indexOf(y)?["."+y]:y);var C=y.lastIndexOf(".");C>0&&(y=y.substr(C)),y&&v.segments.push(y),d=f}return _=f,c}p.push(m),u=f,v.brakLength++;var O=c.substr(_+1);if(O){var y=O;l.indexOf(O)<0&&0>_&&(y=["."+O]),v.words.push(y)}v.words.push(m);var T="["===m?"]":")";if(c[f-1]!==T){var P=O.lastIndexOf(".");P>-1?(O=O.substr(P),v.segments.push(O)):O&&v.segments.push(O),d=f}_=f}}var R=c.substr(c.lastIndexOf("]")+1),N=c.substr(c.lastIndexOf(")")+1);if(R&&N){var F=R.length<N.length?R:N,E=c.substr(d+1);v.segments.push(E);var y="["===F[0]||"("===F[0]?F:"."===F[0]?F:"."+F;v.words.length<1&&l.indexOf(y)<0&&(y=[y]),v.words.push(y)}return s||(n["."+c]=v),c}function r(e){for(var t in e){var n=e[t],i=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,n.brakLength);var h="]"===t[t.length-1]?"[":"(",l=n.brakLength;n.watchPathWords=[];for(var c=0;c<n.words.length;c++){var p=n.words[c];if(p===h&&--l<1)break;n.watchPathWords.push(p)}}else n.watchPathWords=n.words.concat(),n.watchPathWords.splice(-1,1);i=t.substr(o),n.lastVar="("===i[0]?t:i,Object.keys(n.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),n.watchPath=a);for(var c=n.segments.length;c--;)n.segments[c]=n.segments[c].replace(/^\.|\.$/g,"");r(n.subVars)}}function s(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(("["===i||"("===i)&&--t<1)return n}}var a=/(['"])/,o=/[a-zA-Z$_]/,h=/[a-zA-Z$_0-9.]/,l=["as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var n=[],i={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),i);switch(s=s+o.length-1,c){case"var":n.push(l.indexOf(o)<0?["."+o]:o);break;case"str":case"":n.push(o)}}return r(i),p[e]={words:n,varTree:i},p[e]}}(),Scanner=new function(){function e(e){var n=[],i=[];t(e,n);for(var r=n.length;r--;){var e=n[r],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,n){var i=s.substring(o,n);i&&a.push(i),a.push(e),o=n+e.length});var h=s.substring(o,s.length);if(h&&a.push(h),a.length<2)i.unshift(null);else{for(var l=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);l.appendChild(p)}i.unshift(l)}}for(var c=n.length;c--;){var u=n[c];i[c]&&i[c].childNodes.length>1&&u.parentNode&&u.parentNode.replaceChild(i[c],u)}}function t(e,n){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var i=0,r=e.childNodes.length;r>i;i++)t(e.childNodes[i],n)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n.push(e)}}function n(e){if(e.restrict)return e;for(var t=e.parent;t;){if(t.name&&t.restrict)return t;t=t.parent}return null}function i(e,t){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var s=e.tagName.toLowerCase(),a=[],o=e.attributes.length;o--;){var h=e.attributes[o];a.push([h.name,h.value])}for(var l=[],o=a.length;o--;){var c=a[o][0];if(0===c.indexOf(CMD_PREFIX)){var p=c.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&(DirectiveFactory.isFinal(p)||DirectiveFactory.hasEndTag(p))&&l.push([p,a[o],DirectiveFactory.priority(p)||0])}}if(l.length>0){l.sort(function(e,t){return t[2]-e[2]});var p=l[0][0],_=l[0][1];if(DirectiveFactory.isFinal(p))return void DirectiveFactory.newInstanceOf(p,e,t,_[0],_[1]);if(DirectiveFactory.hasEndTag(p))return[p,_[1]]}if(ComponentFactory.hasTypeOf(s)){var d=n(t);if(d&&d.restrict.children){var v=d.restrict.children.split(",");if(v.indexOf(s)<0)return}var f=ComponentFactory.getRestrictOf(s);if(f&&f.parents){var m=f.parents.split(",");if(m.indexOf(d.name)<0)return}return void t.createSubComponentOf(s,e)}for(var o=a.length;o--;){var g=a[o][0],b=a[o][1];if(REG_CMD.test(g)){var p=g.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&DirectiveFactory.newInstanceOf(p,e,t,g,b)}else":"===g[0]?DirectiveFactory.newInstanceOf("on",e,t,g,b):REG_EXP.test(b)&&r(b,e,t,g)}}if(e.childNodes.length>0){for(var y=null,w=[],o=0,x=e.childNodes.length;x>o;o++)if(y){w.push(e.childNodes[o]);var E=DirectiveFactory.hasEndTag(y[0]),h=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+E);Util.isString(h)&&(DirectiveFactory.newInstanceOf(y[0],w,t,CMD_PREFIX+y[0],y[1]),y=null,w=[])}else y=i(e.childNodes[o],t),y&&w.push(e.childNodes[o]);y&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+y[0]+"]")}}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,e,t)}}function r(e,t,n,i){var r={},a=!i&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);if(a&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,t){var i={},a=1,o=null;FILTER_EXP.test(t)&&(o=s(lexer(RegExp.$1),i,n),a=t.indexOf(FILTER_EXP_START_TAG));var h=t;a>1&&(h=t.substring(0,a));var l=lexer(h);o&&Util.ext(l.varTree,o),r[t]={words:l.words,varTree:l.varTree,filters:i}}),!(Object.keys(r).length<1)){var o=new ExpNode(t,i,e,r,n,a);n.__expNodes.push(o)}}function s(e,t,n){for(var i=[],r=null,s=!1,a={},o=[],h=e.words,l=0;l<h.length;l++)if(h[l]instanceof Array)for(var c=h[l][0],p=c.split("."),u=1;u<p.length;u++)o.push([p[u]]);else o.push(h[l]);for(var l=0;l<o.length;l++){var c=o[l];switch(c){case":":s=!0,null!==r&&i.push(r),r="";break;case".":s=!1,null!==r&&i.push(r),r="",i=[];break;default:if(c instanceof Array){var _=c[0],d=_.toLowerCase();if(!s&&d&&FilterFactory.hasTypeOf(d))r=null,t[d]=[FilterFactory.newInstanceOf(d,n),i];else{var p=lexer(_);Util.ext(a,p.varTree),i.push(p),r=null}}else{if(!s||!c.replace(/\s+/,""))continue;r+=c.replace(/^['"]|['"]$/g,"")}}}return r&&i.push(r),a}this.scan=function(t,n){for(var r=t.__nodes?t.__nodes:[t.el],s=null,a=[],o=0,h=r.length;h>o;o++)if(e(r[o]),s){a.push(r[o]);var l=DirectiveFactory.hasEndTag(s[0]),c=r[o].getAttribute&&r[o].getAttribute(CMD_PREFIX+l);Util.isString(c)&&(DirectiveFactory.newInstanceOf(s[0],a,n,CMD_PREFIX+s[0],s[1]),s=null,a=[])}else s=i(r[o],n),s&&a.push(r[o]);s&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")},this.parseFilters=s},Builder=new function(){function e(e){for(var n=e.__expNodes.length;n--;){var i=e.__expNodes[n];for(var r in i.expMap){var s=i.expMap[r],a=s.varTree;for(var o in a){var h=a[o];t(e,h,i)}}}}function t(e,i,r){for(var s in i.subVars){var a=i.subVars[s];t(e,a,r)}for(var o=n(e.__expPropRoot.subProps,i.segments[0],r),h=1;h<i.segments.length;h++)o=n(o.subProps,i.segments[h],r)}function n(e,t,n){var i=e[t];return i||(i=e[t]=new ExpProp(t)),n instanceof ExpNode?i.expNodes.indexOf(n)<0&&i.expNodes.push(n):n instanceof AttrObserveNode?i.attrObserveNodes.indexOf(n)<0&&i.attrObserveNodes.push(n):n instanceof Watch&&i.watchs.indexOf(n)<0&&i.watchs.push(n),e[t]}this.buildExpModel=t,this.build=function(t){e(t)}},ChangeHandler=new function(){function mergeChange(e){for(var t=changeQ.length;t--;){var n=changeQ[t];if(n.object.__im__oid===e.object.__im__oid&&n.name===e.name)break}t>-1?changeQ.splice(t,1,e):changeQ.push(e)}function handlePath(e,t,n,i,r,s,a){__propStr=null,__lastMatch=void 0;var o=[];if(a[0]instanceof Directive){var h=void 0===a[2]?r:a[2];n=a[0].subComponents[parseInt(h)],o.push(a[1]),Util.isUndefined(a[2])&&n instanceof Component&&(n.data[a[1]]=e)}else o=a.concat(),Util.isArray(s)||o.push(r);n&&findExpProp(s,r,n,o,i,e,t,0,n)}function mergeExpNodes(e){for(var t=[],n=e.length;n--;)for(var i=e[n].expNodes.length;i--;){var r=e[n].expNodes[i];t.indexOf(r)<0&&t.push(r)}return t}function mergeExpProp(e,t,n,i,r,s,a){for(var o,h=n.__expPropRoot.subProps,l=!1,c=0;c<i.length;c++){var p=i[c];if(sqbExp.test(Object.keys(h).join(","))){l=!0;break}{if(!h[p])break;o=h[p],h=h[p].subProps}}if(o){var u=[];if(l)for(var _=i.length-c-1,d=Object.keys(o.subProps),c=d.length;c--;){var v=d[c];("["===v[0]||v===p)&&findMatchProps(o.subProps[v],_,u)}else u.push(o);for(var c=u.length;c--;){var o=u[c];o.propChain=i,o.newVal=s,o.oldVal=a,o.name=t,o.type=r,o.object=e,expProps.push(o)}}}function findMatchProps(e,t,n){if(1>t)return void n.push(e);for(var i in e.subProps)findMatchProps(e.subProps[i],t-1,n)}function findExpProp(object,name,component,propChain,changeType,newVal,oldVal,depth,topComp){var toRender=!0;if(depth>0){if(!__propStr){__propStr="";for(var k=0;k<propChain.length;k++){var seg=propChain[k];__propStr+="["===seg[0]?seg:"."+seg}}var prop=void 0;try{prop=eval('impex._cs["'+component.__id+'"].data'+__propStr)}catch(e){}Util.isUndefined(prop)?__lastMatch&&__lastMatch!==topComp&&(toRender=!1):(__lastMatch=component,toRender=!1)}if(toRender&&mergeExpProp(object,name,component,propChain,changeType,newVal,oldVal),component.isolate)for(var pc0=propChain[0],i=component.isolate.length;i--;){var k=component.isolate[i];if(k.indexOf(".")>0){for(var kc=k.split("."),matchAll=!0,kci=0;kci<kc.length;kci++)kc[kci]!==propChain[kci]&&(matchAll=!1);if(matchAll)return}else if(k===pc0)return}for(var j=component.children.length;j--;){var subCtrlr=component.children[j];findExpProp(object,name,subCtrlr,propChain,changeType,newVal,oldVal,depth+1,topComp)}}function callWatchs(e){for(var t=[],n=e.length;n--;)for(var i=e[n],r=i.propChain,s=i.newVal,a=i.oldVal,o=i.name,h=i.object,l=i.type,c=i.watchs.length;c--;){var p=i.watchs[c];if(!(p.segments.length<r.length||t.indexOf(p)>-1)){for(var u=!0,_=0;_<p.segments.length&&r[_];_++)if("["!==p.segments[_][0]&&"["!==r[_][0]&&p.segments[_]!==r[_]){u=!1;break}if(u){var d=s,v=a;if(p.segments.length>r.length){for(var f=p.segments.slice(_),m="$var",_=0;_<f.length;_++){var g=f[_];m+="["===g[0]?g:"."+g}try{d=new Function("$var","return "+m)(s),v=new Function("$var","return "+m)(a)}catch(b){LOGGER.debug("error on parse watch params",b),d=null}}p.cbk&&p.cbk.call(p.ctrlScope,h,o,l,d,v,r),t.push(p)}}}}function callObserves(e){for(var t=e.length;t--;)for(var n=e[t],i=n.attrObserveNodes.length;i--;){var r=n.attrObserveNodes[i],s=Renderer.evalExp(r.directive,r.expObj);r.directive.observe(s)}}var combineChange=!1,changeQ=[],expProps=[];this.handle=function(e){combineChange?mergeChange(e):(changeQ=[],expProps=[],combineChange=!0,changeQ.push(e),setTimeout(function(){combineChange=!1,changeQ.forEach(function(e){var t=e.newVal,n=e.oldVal,i=e.pc,r=e.xpc,s=e.comp,a=e.type,o=e.name,h=e.object;handlePath(t,n,s,a,o,h,i),r.forEach(function(e){handlePath(t,n,s,a,o,h,e)})});var e=mergeExpNodes(expProps);Renderer.renderExpNode(e),callObserves(expProps),callWatchs(expProps),changeQ.forEach(function(e){var t=e.newVal,n=e.oldVal,i=e.pc.concat(),r=e.comp,s=e.type,a=e.name,o=e.object;i.push(a),r.__watcher instanceof Function&&r.__watcher(o,a,s,t,n,i)})},40))};var __propStr=null,__lastMatch=void 0,sqbExp=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNode(e){for(var t={},n=e.length;n--;){var i=e[n],r=null;if(t[i.origin]&&t[i.origin].comp===i.component?r=t[i.origin].val:(r=calcExp(i.component,i.origin,i.expMap),t[i.origin]={comp:i.component,val:r}),i.toHTML){var s=renderHTML(i,r,i.node,i.component);if(s)continue}null!==r&&updateDOM(i.node,i.attrName,r)}}function updateDOM(e,t,n){if(e.setAttribute){e.setAttribute(t,n);var i=propMap[t];i&&i.indexOf(e.tagName)>-1&&(e[t]=n)}else e.parentNode&&(e.nodeValue=n)}function clone(e){if(null===e)return null;var t=e;if(e instanceof Array){t=e.concat();for(var n=t.length;n--;)t[n]=clone(t[n])}else if(Util.isObject(e)){t={};var i=Object.keys(e);if(i.length>0)for(var n=i.length;n--;){{var r=i[n];e[r]}0!==r.indexOf("$__impex__")&&(t[r]="object"==typeof e[r]?clone(e[r]):e[r])}}return t}function calcExp(e,t,n){var i={};for(var r in n){var s=n[r],a=evalExp(e,s),o=s.filters;if(Object.keys(o).length>0){a&&Util.isObject(a)&&(a=clone(a));for(var h in o){for(var l=o[h][0],c=o[h][1],p=[],u=c.length;u--;){var _=c[u];_.varTree&&_.words&&(_=Renderer.evalExp(e,_)),p[u]=_}l.value=a,a=l.to.apply(l,p)}}i[r]=void 0===a?"":a}for(var h in i)t=t.replace(EXP_START_TAG+h+EXP_END_TAG,i[h]+"");return t}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var n=t.varTree,i={};for(var r in n){var s=n[r],a=buildVarPath(e,s,r);i[r]=a}var o=joinExpStr(t.words,i);return o}function joinExpStr(e,t){for(var n="",i=0;i<e.length;i++){var r=e[i];n+=r instanceof Array?t[r[0]]:r}return n}function keyWordsMapping(e,t){return 0===e.indexOf(".this")?e.replace(".this",t.__getPath()):void 0}function buildVarPath(e,t,n){var i={};for(var r in t.subVars){var s=t.subVars[r],a=buildVarPath(e,s,r);i[r]=a}for(var o=!1,h="",l=0;l<t.words.length;l++){var c=t.words[l];if(c instanceof Array){if(i[c[0]]){h+=i[c[0]];continue}var p=keyWordsMapping(c[0],e);p?(o=!0,h+=p):h+=c[0]}else h+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var l=0;l<t.watchPathWords.length;l++){var c=t.watchPathWords[l];u+=c instanceof Array?i[c[0]]||c[0]:c}if(o)return h;var _=")"===n[n.length-1]?"methods":"data",d=u||h;return d="data"===_?".data"+d:"."+METHOD_PREFIX+d.substr(1),e=varInCtrlScope(e,d),e?(h="data"===_?".data"+h:"."+METHOD_PREFIX+h.substr(1),e.__getPath()+h):"self"+h}function varInCtrlScope(e,t){for(var n=e;n;){if(void 0!==getVarByPath(t,n.__getPath()))return n;n=n.parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,n,i){if(e.__lastVal!==t&&3==n.nodeType){if(!e.__placeholder){var r=document.createComment("-- [html] placeholder --");n.parentNode.insertBefore(r,n),e.__lastVal=t,e.__placeholder=r,n.parentNode.removeChild(n)}var s=document.createElement("span"),a=new View(null,s,[s]);e.__lastComp&&e.__lastComp.destroy(),Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;")),e.__placeholder.parentNode.insertBefore(s,e.__placeholder);var o=i.createSubComponent(t,a);return o.template=t,o.init(),o.display(),e.__lastComp=o,e.__lastVal=t,!0}}this.render=function(e){e.children;renderExpNode(e.__expNodes)},this.recurRender=function(e){var t=e.children;renderExpNode(e.__expNodes);for(var n=t.length;n--;)Renderer.render(t[n])},this.renderExpNode=renderExpNode;var propMap={value:["INPUT"]};this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};Component.state={created:"created",inited:"inited",displayed:"displayed",suspend:"suspend"},Util.ext(Component.prototype,{d:function(path,val){if(!path)return void LOGGER.warn("invalid path '"+path+"'");var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}return this}try{return eval(evalStr)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}},m:function(e){for(var t=this;t;){if(t["$"+e]instanceof Function)return t.hasOwnProperty("$"+e)||(t["$"+e]=t["$"+e].bind(t)),t["$"+e];t=t.parent}return null},closest:function(e,t){if("d"===e){var n=lexer(t),i=Renderer.getExpEvalStr(this,n);return i.replace(/^impex\._cs\["(C_[0-9]+)"\]/,""),impex._cs[RegExp.$1]}if("m"===e){for(var r=this;r;){if(r["$"+t]instanceof Function)return r;r=r.parent}return null}},on:function(e,t){var n=this.__eventMap[e];n||(n=this.__eventMap[e]=[]),n.push(t)},emit:function(){for(var e=arguments[0],t=[this],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=this.parent;setTimeout(function(){for(;i;){var n=i.__eventMap[e];if(n){for(var r=!0,s=0;s<n.length;s++)r=!n[s].apply(i,t);if(r)return}i=i.parent}},0)},broadcast:function(){for(var e=arguments[0],t=[this],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=this;setTimeout(function(){broadcast(i.children,e,t)},0)},find:function(e,t,n){e=e.toLowerCase();for(var i=[],r=this.children.length;r--;){var s=this.children[r];if("*"===e||s.name===e){var a=!0;if(t)for(var o in t)if(s[o]!==t[o]){a=!1;break}a&&i.push(s)}if(n&&s.children.length>0){var h=s.find(e,t,!0);i&&(i=i.concat(h))}}return i},watch:function(e,t){if("*"===e)this.__watcher=t;else{var n=lexer(e),i=Object.keys(n.varTree);if(i.length<1)return;if(i.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var r=n.varTree[i[0]],s=new Watch(t,this,r.segments);Builder.buildExpModel(this,r,s)}return this},add:function(e){this.children.push(e),e.parent=this},createSubComponentOf:function(e,t){var n=ComponentFactory.newInstanceOf(e,t.__nodes?t.__nodes[0]:t);return this.children.push(n),n.parent=this,n},createSubComponent:function(e,t){var n=ComponentFactory.newInstance(e,t&&t.__nodes[0]);return this.children.push(n),n.parent=this,n},init:function(){if(this.__state===Component.state.created){if(this.templateURL){var e=this;Util.loadTemplate(this.templateURL,function(t){var n=e.view.__init(t,e);n!==!1&&(e.__init(t),e.display())})}else{if(this.template){var t=this.view.__init(this.template,this);if(t===!1)return}this.__init(this.template)}return this}},__init:function(e){Scanner.scan(this.view,this),LOGGER.log(this,"inited");var t=null;if(this.onInit&&(t=this.onInit(e)),t===!1)return void this.destroy();this.data=Observer.observe(this.data,this),Builder.build(this),this.__state=Component.state.inited;for(var n=this.children.length;n--;)this.children[n].init()},display:function(){if(this.__state!==Component.state.displayed){this.view.__display(this),Renderer.render(this),this.__state=Component.state.displayed,LOGGER.log(this,"displayed");for(var e=0;e<this.children.length;e++)this.children[e].display();this.onDisplay&&this.onDisplay()}},destroy:function(){if(null!==this.__state){if(LOGGER.log(this,"destroy"),this.parent){var e=this.parent.children.indexOf(this);e>-1&&this.parent.children.splice(e,1),this.parent=null}for(this.view.__destroy(this);this.children.length>0;)this.children[0].destroy();if(this.view=this.children=this.__expNodes=this.__expPropRoot=null,this.onDestroy&&this.onDestroy(),!CACHEABLE||!this.name||this instanceof Directive)impex._cs[this.__id]=null,delete impex._cs[this.__id],this.__state=this.__id=this.templateURL=this.template=this.restrict=this.isolate=this.methods=this.events=this.data=null;else{var t=im_compCache[this.name];t||(t=im_compCache[this.name]=[]),this.__state=Component.state.created,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,t.push(this)}}},suspend:function(e){(this instanceof Directive||this.__state===Component.state.displayed)&&(LOGGER.log(this,"suspend"),this.view.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.__state=Component.state.suspend)},__getPath:function(){return'impex._cs["'+this.__id+'"]'}}),View.prototype={__init:function(e,t){var n=this.__target.attributes,i=this.__target.innerHTML,r=tmplExpFilter(e,i,n);t.onBeforeCompile&&(r=t.onBeforeCompile(r));var s=DOMViewProvider.compile(r,this.__target,t.replace);if(!s||s.length<1)return LOGGER.error('invalid template "'+e+'" of component['+t.name+"]"),!1;if(t.replace?(this.__nodes=s,this.el=1===s.length&&1===s[0].nodeType?s[0]:null):(this.__nodes=[this.__target],this.el=this.__target),s.length>1&&LOGGER.warn("more than 1 root node of component["+t.name+"]"),n)for(var a=n.length;a--;){var o=n[a].name.toLowerCase();o.indexOf("-")>-1&&(o=o.replace(/-[a-z0-9]/g,function(e){return e[1].toUpperCase()}));var h=n[a].value;t.data[o]=h}this.__comp=t,this.__target=null},__display:function(e){if(this.__target&&this.__target.parentNode){var t=null;if(this.__nodes.length>1){t=document.createDocumentFragment();for(var n=0;n<this.__nodes.length;n++)t.appendChild(this.__nodes[n])}else t=this.__nodes[0];e.replace?this.__target.parentNode.replaceChild(t,this.__target):(this.__target.innerHTML="",this.__target.appendChild(t)),t=null,this.__target=null}},__destroy:function(e){for(var t in this.__evMap)for(var n=this.__evMap[t],i=n.length;i--;)for(var r=n[i],s=r[1],a=this.__nodes.length;a--;)1===this.__nodes[a].nodeType&&this.__nodes[a].removeEventListener(t,s,!1);var o=this.__nodes[0].parentNode;if(o){this.__nodes[0].__impex__view&&(this.__nodes[0].__impex__view=null);for(var i=this.__nodes.length;i--;)this.__nodes[i].parentNode&&o.removeChild(this.__nodes[i])}this.__target&&(this.__target.parentNode.removeChild(this.__target),this.__target=null)},__suspend:function(e,t){var n=this.__nodes[0].parentNode;if(n){t&&(this.__target=document.createComment("-- view suspended of ["+(e.name||"anonymous")+"] --"),n.insertBefore(this.__target,this.__nodes[0]));for(var i=this.__nodes.length;i--;)this.__nodes[i].parentNode&&n.removeChild(this.__nodes[i])}},on:function(e,t,n){if(this.el){var i=t,r=this.__comp,s="",a=null,o=function(t){var o=i;if(n instanceof Function&&(o=n.call(r,t,i)),o){if(s!=o){var h=lexer(o),l=Renderer.getExpEvalStr(r,h),c=l.replace("self.$event","$event");a=new Function("$event",c),s=o}try{a(t)}catch(p){LOGGER.debug("error in event '"+e+"'",p)}}};this.el.addEventListener(e,o,!1),this.__evMap[e]||(this.__evMap[e]=[]),this.__evMap[e].push([t,o])}},off:function(e,t){if(this.el)for(var n=this.__evMap[e],i=n.length;i--;){var r=n[i],s=r[0],a=r[1];s==t&&this.el.removeEventListener(e,a,!1)}},clone:function(){for(var e=[],t=this.__nodes.length;t--;){var n=this.__nodes[t].cloneNode(!0);e.unshift(n)}var i=new View(1===e.length&&1===e[0].nodeType?e[0]:null,null,e);return i},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},style:function(e,t){return arguments.length>1?(this.el.style[e]=t,this):this.el.style[e]},attr:function(e,t){return arguments.length>1?(this.el.setAttribute(e,t),this):this.el.getAttribute(e)},removeAttr:function(e){return this.el.removeAttribute(e),this},hasClass:function(e){return this.el.className.indexOf(e)>-1},addClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,""),e=e.split(" ");for(var t=this.el.className.split(" "),n="",i=e.length;i--;)t.indexOf(e[i])<0&&(n+=e[i]+" ");return this.el.className+=" "+n,this},removeClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");var t=e.split(" "),n=this.el.className;if(n){for(var i=t.length;i--;){var r=t[i],s=new RegExp("^"+r+"\\s+|\\s+"+r+"$|\\s+"+r+"\\s+","img");n=n.replace(s,"")}this.el.className=n}return this},toggleClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");for(var t=e.split(" "),n=!1,i=this.el.className,r=t.length;r--;){
var s=t[r];if(i.indexOf(s)<0){n=!0;break}}n?this.addClass(e):this.removeClass(e)}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,n){if(""===t)return new View(null,n,[document.createTextNode("")]);if(e.innerHTML=t,!e.childNodes[0])return null;for(var i=[];e.childNodes.length>0;){var r=e.removeChild(e.childNodes[0]);i.push(r)}var s=new View(null,n,i);return s},this.compile=function(e,t,n){if(n){var i=[];if(!t.insertAdjacentHTML){var r=document.createElement("span");r.style.display="none",t.parentNode.insertBefore(r,t),t.parentNode.removeChild(t),t=r}t.insertAdjacentHTML("beforebegin","<!-- c -->");var s=t.previousSibling;t.insertAdjacentHTML("afterend","<!-- c -->");var a=t.nextSibling;t.insertAdjacentHTML("afterend",e),t.parentNode.removeChild(t);for(var o=s.nextSibling;o!==a;){if(3===o.nodeType){var h=o.nodeValue.replace(/\s/gm,"");if(""===h){o=o.nextSibling;continue}}i.push(o),o=o.nextSibling}s.parentNode.removeChild(s),a.parentNode.removeChild(a)}else t.innerHTML=e;return i}},ViewManager=new function(){this.singleton=!0,this.replace=function(e,t){var n=t.__nodes[0],i=e.__nodes[0],r=t.__nodes[0].parentNode,s=i;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}if(t.__nodes.length>1){r.insertBefore(s,n);for(var a=t.__nodes.length;a--;)r.removeChild(t.__nodes[a])}else r.replaceChild(s,n)},this.insertBefore=function(e,t){var n=t.__nodes[0],i=e.__nodes[0],r=t.__nodes[0].parentNode,s=i;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}r&&r.insertBefore(s,n)},this.insertAfter=function(e,t){var n=t.__nodes[0],i=e.__nodes[0],r=t.__nodes[0].parentNode,s=r.lastChild,a=i;if(e.__nodes.length>1){a=document.createDocumentFragment();for(var o=0;o<e.__nodes.length;o++)a.appendChild(e.__nodes[o])}if(s==n)r.appendChild(a);else{var h=t.__nodes[t.__nodes.length-1].nextSibling;r.insertBefore(a,h)}},this.append=function(e,t){var n=e.__nodes[0],i=t.__nodes[0],r=n;if(e.__nodes.length>1){r=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)r.appendChild(e.__nodes[s])}i.appendChild(r)},this.prepend=function(e,t){var n=e.__nodes[0],i=t.__nodes[0],r=n;if(e.__nodes.length>1){r=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)r.appendChild(e.__nodes[s])}i.insertBefore(r,i.firstChild)},this.createPlaceholder=function(e){return new View(null,null,[document.createComment(e)])}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){var e={},t=this;this.value.replace(REG_EXP,function(n,i){var r=lexer(i),s=Renderer.evalExp(t.parent,r);e[i]={val:s}});var n=this.value;for(var i in e)n=n.replace(EXP_START_TAG+i+EXP_END_TAG,e[i].val);this.value=n,LOGGER.log(this,"inited"),this.onInit&&this.onInit(),this.__state=Component.state.inited},display:function(){if(this.observe){var e=lexer(this.value);for(var t in e.varTree){var n=e.varTree[t],i=new AttrObserveNode(this,e);this.parent&&Builder.buildExpModel(this.parent,n,i)}var r=Renderer.evalExp(this.parent,e);this.observe(r)}this.onDisplay&&this.onDisplay(),this.children&&this.children.forEach(function(e){e.display()})}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},TESTNODE;Transition.prototype={enter:function(){this.__start="enter",this.__css&&this.__view.addClass(this.__type+"-enter"),this.__comp.enter&&this.__comp.enter(),this.__hook.enter&&this.__hook.enter.call(this.__comp,this.__enterDone.bind(this)),this.__css&&(this.__view.el.offsetHeight,this.__view.removeClass(this.__type+"-enter"))},__enterDone:function(){},leave:function(){this.__start="leave",this.__css&&this.__view.addClass(this.__type+"-leave"),this.__hook.leave&&(this.__leaveDone.__trans=this,this.__hook.leave.call(this.__comp,this.__leaveDone.bind(this)))},__leaveDone:function(){this.__comp.leave&&this.__comp.leave()},__done:function(e){if(!(e.elapsedTime<this.__longest)&&this.__start){switch(this.__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.__start="",this.__view.removeClass(this.__type+"-leave")}}},Factory.prototype={register:function(e,t,n){e=e.toLowerCase();var i=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),r={},s=t.data;if(delete t.data,Util.ext(r,t),Util.inherits(i,this.baseClass),t.methods)for(var a in t.methods)i.prototype[METHOD_PREFIX+a]=t.methods[a];this.types[e]={clazz:i,props:r,services:n,data:s}},hasTypeOf:function(e){return e in this.types},createCbk:function(e,t){if(e.onCreate){var n=null;if(this.types[t].services){n=[];for(var i=0;i<this.types[t].services.length;i++){var r=ServiceFactory.newInstanceOf(this.types[t].services[i],e);n.push(r)}}n?e.onCreate.apply(e,n):e.onCreate()}}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.restrict},newInstance:function(e){var t=null;if(2===arguments.length){var n=arguments[0],i=arguments[1];t=n,Util.isString(n)?t=this.viewProvider.newInstance(n,i):t.__target=i}else t=e,Util.isDOM(e)&&(t=new View(e,null,[e]));var r=new this.baseClass(t),s=arguments[2];if(s&&Util.ext(r,s),r.methods)for(var a in r.methods)r.methods[a]instanceof Function&&(r[METHOD_PREFIX+a]=r.methods[a].bind(r));if(r.events)for(var a in r.events)r.on(a,r.events[a]);return r},newInstanceOf:function(e,t){if(!this.types[e])return null;var n=null,i=im_compCache[e];if(CACHEABLE&&i&&i.length>0)n=i.pop();else{n=new this.types[e].clazz(this.baseClass),Util.ext(n,this.types[e].props);var r=this.types[e].data;r&&Util.ext(n.data,r),n.name=e}if(n.view=new View(null,t),n.events)for(var s in n.events)n.on(s,n.events[s]);return this._super.createCbk.call(this,n,e),n}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props["final"]},hasEndTag:function(e){return this.types[e].props.endTag},priority:function(e){return this.types[e].props.priority},newInstanceOf:function(e,t,n,i,r){if(!this.types[e])return null;var s=null,a=null,o=i.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=i.substr(o+1);var h=s.indexOf(CMD_FILTER_DELIMITER);h>-1&&(a=s.substr(h+1),s=s.substring(0,h)),s=s.split(CMD_PARAM_DELIMITER)}var l=new this.types[e].clazz(this.baseClass,i,r,n);if(Util.ext(l,this.types[e].props),t.__impex__view)l.view=t.__impex__view;else{var c=t,p=[t];Util.isArray(t)&&(p=t,c=t.length>1?null:t[0]),l.view=new View(c,null,p),t.__impex__view=l.view}if(s&&(l.params=s),a&&(l.filter=a),l.view.__comp=l,n.add(l),l.view&&(l.view.__nodes[0].removeAttribute(l.name),l.endTag)){var u=l.view.__nodes[l.view.__nodes.length-1];u.removeAttribute(CMD_PREFIX+l.endTag)}if(l.events)for(var _ in l.events)l.on(_,l.events[_]);return this._super.createCbk.call(this,l,e),l}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass,t);return Util.ext(n,this.types[e].props),this._super.createCbk.call(this,n,e),n}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var n=null;return this.types[e].props.singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),n=this.types[e].singleton):n=new this.types[e].clazz(this.baseClass),Util.ext(n,this.types[e].props),n.host=t,this._super.createCbk.call(this,n,e),n}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var n=new Transition(e,t,this.hooks[e]);return n}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,METHOD_PREFIX="$",EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},CACHEABLE=!1,im_compCache={},im_counter=0,impex=new function(){function e(e){var n=e;do{if(t.indexOf(n)>-1)return!0;n=n.parentNode}while(n);return!1}this.version={v:[0,20,0],state:"beta3",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},CACHEABLE=e.cacheable||!1},this.component=function(e,t,n){return t.template||t.templateURL?(ComponentFactory.register(e,t,n),this):void LOGGER.error("can not find property 'template' or 'templateURL' of component '"+e+"'")},this.directive=function(e,t,n){return DirectiveFactory.register(e,t,n),this},this.service=function(e,t,n){return ServiceFactory.register(e,t,n),this},this.filter=function(e,t,n){return FilterFactory.register(e,t,n),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.render=function(n,i,r){if(!n)return void LOGGER.error("invalid element, can not render");var s=n.tagName.toLowerCase();if(e(n))return void LOGGER.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,n);if(a||(t.push(n),a=ComponentFactory.newInstance(n,null,i)),a.onCreate){var o=null;if(Util.isArray(r)){o=[];for(var h=0;h<r.length;h++){var l=ServiceFactory.newInstanceOf(r[h],a);o.push(l)}}o?a.onCreate.apply(a,o):a.onCreate()}return a.init(),a.display(),a};var t=[];Object.defineProperty(this,"_cs",{enumerable:!1,writable:!0,value:{}})};impex.service("ViewManager",ViewManager),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,n,i){for(var r=e.__expNodes.length;r--;){var s=e.__expNodes[r];s.node==n&&"class"===s.attrName&&(s.origin=i)}for(var a=e.children.length;a--;)t(e.children[a],n,i)}function n(){function e(e,t,n){for(var i=[],r=e;t>=r;r+=n)i.push(r);return i}function t(e){for(var n=0;n<e.children.length;n++){var i=e.children[n];i.onDisplay&&i.onDisplay(),i.children.length>0&&t(i)}}function n(e,t){if(null===e)return null;var i=e;if(e instanceof Array){i=e.concat();for(var r=i.length;r--;)i[r]=n(i[r],t)}else if(Util.isObject(e)){i={};var s=Object.keys(e);if(s.length>0)for(var a=t===!1?!1:!e.$__impex__origin,r=s.length;r--;){{var o=s[r];e[o]}0!==o.indexOf("$__impex__")&&(i[o]="object"==typeof e[o]?n(e[o],a):e[o])}t===!1||i.$__impex__origin||(i.$__impex__origin=e)}return i}function i(e){setTimeout(function(){for(var t=e.splice(0,50),n=0;n<t.length;n++)t[n].__state=Component.state.inited,t[n].display();e.length>0&&i(e)},0)}this.onCreate=function(e,t){this.eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.forExp=/^\s*(\d+|[a-zA-Z_$].+?)\s+to\s+(\d+|[a-zA-Z_$].+?)\s*$/,this.viewManager=e,this.fragment=document.createDocumentFragment(),this.expInfo=this.parseExp(this.value),this.parentComp=this.parent,this.__view=this.view,this.cache=[],this.cacheable=this.view.el?"false"===this.view.attr("cache")?!1:!0:"false"===this.view.__nodes[0].getAttribute("cache")?!1:!0,this.subComponents=[],this.cacheSize=20,this.step=this.view.el?this.view.attr("step"):this.view.__nodes[0].getAttribute("step");var n=this.view.el?this.view.attr("transition"):this.view.__nodes[0].getAttribute("transition");null!==n&&(this.trans=n,this.ts=t)},this.onInit=function(){var t=this;if(this.forExp.test(this.expInfo.ds)){var n=RegExp.$1,i=RegExp.$2,r=parseFloat(this.step);if(0>r)return void LOGGER.error("step <= 0 : "+r);r=r||1,isNaN(n)&&(this.parent.watch(n,function(n,s,a,o,h){var l=e(o>>0,i,r);t.lastDS=l,t.rebuild(l,t.expInfo.k,t.expInfo.v)}),n=this.parent.d(n)),isNaN(i)&&(this.parent.watch(i,function(i,s,a,o,h){var l=e(n,o>>0,r);t.lastDS=l,t.rebuild(l,t.expInfo.k,t.expInfo.v)}),i=this.parent.d(i)),n=parseFloat(n),i=parseFloat(i),this.ds=e(n,i,r)}else this.ds=this.parent.d(this.expInfo.ds),this.parentComp.watch(this.expInfo.ds,function(e,n,i,r){return t.ds?(t.lastDS=Util.isArray(r)?r:e,void t.rebuild(t.lastDS,t.expInfo.k,t.expInfo.v)):(t.ds=t.parentComp.d(t.expInfo.ds),t.lastDS=t.ds,void t.build(t.ds,t.expInfo.k,t.expInfo.v))});this.lastDS=this.ds,this.placeholder=this.viewManager.createPlaceholder("-- directive [each] placeholder --"),this.viewManager.insertBefore(this.placeholder,this.view),this.fragmentPlaceholder=this.viewManager.createPlaceholder("-- fragment placeholder --"),this.fragment.appendChild(this.fragmentPlaceholder.__nodes[0]),this.ds&&this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy()},this.rebuild=function(e,n,i){e=this.doFilter(e);var r=e.length-this.subComponents.length;if(0>r){var s=this.subComponents.splice(0,-1*r);if(this.cache.length<this.cacheSize){for(var a=s.length;a--;)this.cache.push(s[a]);for(var a=this.cache.length;a--;)this.trans&&!this.cache[a].__leaving&&"displayed"===this.cache[a].__state?(this.cache[a].__leaving=!0,this.cache[a].transition.leave()):this.cache[a].suspend(!1)}else for(var a=s.length;a--;)s[a].destroy()}else if(r>0){var o=r;if(this.cacheable){for(var s=this.cache.splice(0,r),a=0;a<s.length;a++)this.subComponents.push(s[a]),this.viewManager.insertBefore(s[a].view,this.placeholder);var o=r-s.length}for(;o--;)this.createSubComp()}var h=Util.isArray(e)?!0:!1,l=0;for(var c in e)if(e.hasOwnProperty(c)&&(!h||!isNaN(c))){var p=this.subComponents[l],u=e[c];if(e[c]&&e[c].$__impex__origin&&(u=e[c].$__impex__origin,e[c].$__impex__origin=null,delete e[c].$__impex__origin),"object"==typeof u){for(var a=u.__im__extPropChain.length;a--&&u.__im__extPropChain[a][0]!==this;);u.__im__extPropChain.splice(a,1),u.__im__extPropChain.push([this,i,l])}var _=p.data.__im__target||p.data;_[i]=u,_.$index=l++,n&&(_[n]=h?c>>0:c),p.__state===Component.state.created&&p.init(),p.display(),"displayed"===p.__state&&Renderer.recurRender(p),t(p)}},this.createSubComp=function(){var e=this.parentComp,t=this.__view.clone(),n=this.viewManager.createPlaceholder("");this.viewManager.insertBefore(n,this.placeholder);var i=e.createSubComponent(t,n);if(this.subComponents.push(i),this.trans){var r=this;i.onInit=function(){this.transition||(this.transition=r.ts.get(r.trans,this))},i.onDisplay=function(){this.transition.enter()},i.leave=function(){this.suspend(!1),this.__leaving=!1}}return i},this.doFilter=function(e){if(!this.filters)return e;var t=this.filters;if(Object.keys(t).length>0){e&&Util.isObject(e)&&(e=n(e));for(var i in t){for(var r=t[i][0],s=t[i][1],a=[],o=s.length;o--;){var h=s[o];h.varTree&&h.words&&(h=Renderer.evalExp(this.parentComp,h)),a[o]=h}r.value=e,e=r.to.apply(r,a)}return e}},this.build=function(e,t,n){var r=Util.isArray(e)?!0:!1,s=0;e=this.doFilter(e),e.__im__extPropChain&&e.__im__extPropChain.push([this,n]);for(var a in e)if(e.hasOwnProperty(a)&&(!r||!isNaN(a))){var o=this.createSubComp(),h=e[a];e[a]&&e[a].$__impex__origin&&(h=e[a].$__impex__origin,e[a].$__impex__origin=null,delete e[a].$__impex__origin),"object"==typeof h&&h.__im__extPropChain.push([this,n,s]);var l=o.data.__im__target||o.data;l[n]=h,l.$index=s++,t&&(l[t]=r?a>>0:a)}for(var c=this.subComponents.length;c--;)this.subComponents[c].init(),this.subComponents[c].__state=Component.state.displayed;var p=this.subComponents.concat();i(p)},this.parseExp=function(e){var t,n,i,r=this;return e.replace(this.eachExp,function(e,s,a,o){t=s;var h=a.replace(/\s/gm,""),l=h.split(",");if(l.length>1?(n=l[0],i=l[1]):i=l[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,r.parent);r.filters=c;for(var u in p)r.parent.watch(u,function(){r.lastDS&&r.rebuild(r.lastDS,r.expInfo.k,r.expInfo.v)})}}),t?{ds:t,k:n,v:i}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{"final":!0}).directive("on",{onInit:function(){for(var e=this.params.length;e--;)this.view.on(this.params[e],this.value)}}).directive("bind",{onInit:function(){(!this.params||this.params.length<1)&&LOGGER.warn("at least one attribute be binded")},observe:function(e){if(this.params&&!(this.params.length<1)){var t=null;if(this.filter&&(t=this.m(this.filter)),t){var n=t(e);if(!Util.isUndefined(n)&&!n)return}for(var i=this.params.length;i--;){var r=this.params[i];this.view.attr(r,e)}}}}).directive("show",{onCreate:function(e){var t=this.view.attr("transition");null!==t&&(this.transition=e.get(t,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&e!==this.lastRs&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){e?this.view.show():this.view.hide()}},["Transitions"]).directive("show-start",{endTag:"show-end",onCreate:function(){this.__init(),this.display()},observe:function(e){if(this.parent.__state!==Component.state.suspend){var t=this.view.__nodes;if(e)for(var n=t.length;n--;)t[n].style&&(t[n].style.display="");else for(var n=t.length;n--;)t[n].style&&(t[n].style.display="none")}}}).directive("if",{onCreate:function(e,t){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --");var n=this.view.attr("transition");null!==n&&(this.transition=t.get(n,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&(e!==this.lastRs||this.view.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.view.el.parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.el.parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager","Transitions"]).directive("if-start",{endTag:"if-end",onCreate:function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --")},onInit:function(){Scanner.scan(this.view,this)},observe:function(e){if(this.parent.__state!==Component.state.suspend)if(e){if(this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager"]).directive("cloak",{onCreate:function(){var e=this.view.attr("class");return e?(e=e.replace("x-cloak",""),void(this.__cn=e)):void LOGGER.warn("can not find attribute[class] of element["+this.view.name+"] which directive[cloak] on")},onDisplay:function(){t(this.parent,this.view.el,this.__cn);var e=this.view.attr("class").replace("x-cloak","");this.view.attr("class",e)}}).directive("model",{onCreate:function(){var e=this.view.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=this.view.attr("type");switch(t){case"radio":this.view.on("click","changeModel($event)");break;case"checkbox":this.view.on("click","changeModelCheck($event)");break;default:var n=null===document.body.onpropertychange?"propertychange":"input";this.view.on(n,"changeModel($event)")}break;case"select":var i=e.getAttribute("multiple");null!==i?this.view.on("change","changeModelSelect($event)"):this.view.on("change","changeModel($event)")}},methods:{changeModelSelect:function(e){for(var t=e.target||e.srcElement,n=(t.value,[]),i=t.options.length;i--;){var r=t.options[i];r.selected&&n.push(r.value)}this.parent.d(this.value,n)},changeModelCheck:function(e){var t=e.target||e.srcElement,n=t.value,i=this.parent.d(this.value);if(i instanceof Array||(i=[i]),t.checked)i.push(n);else{var r=i.indexOf(n);r>-1&&i.splice(r,1)}this.parent.d(this.value,i)},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)}},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.parent.d(this.value,t)}});var i=new n;i["final"]=!0,i.priority=999,e.directive("each",i,["ViewManager","Transitions"]);var r=new n;r.endTag="each-end",r.priority=999,e.directive("each-start",r,["ViewManager"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.value)}}).filter("filterBy",{to:function(e,t){var n=this.value;if(!(n instanceof Array))return LOGGER.warn("can only filter array"),this.value;var i=[];if(e instanceof Function)for(var r=n.length;r--;){var s=e.call(this,n[r]);s&&i.unshift(n[r])}else for(var r=n.length;r--;){var a=n[r];t?(!e||(a[t]+"").indexOf(e)>-1)&&i.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&i.unshift(a)}return i}}).filter("limitBy",{to:function(e,t){return this.value instanceof Array?e?this.value.splice(t||0,e):this.value:(LOGGER.warn("can only filter array"),this.value)}}).filter("orderBy",{to:function(e,t){return e||t?this.value instanceof Array?(this.value.sort(function(t,n){var i=e?t[e]:t,r=e?n[e]:n;return"string"==typeof i?i.localeCompare(r):"number"==typeof i?i-r:(i+"").localeCompare(r)}),"desc"===t&&this.value.reverse(),this.value):(LOGGER.warn("can only filter array"),this.value):this.value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);