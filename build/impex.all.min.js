/*
 * impexjs is a powerful web application engine to build 
 * reactive webUI system
 *
 *
 * Copyright 2015-2017 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://impexjs.org
 * last build: 2017-9-18
 */
!function(global){"use strict";function ExpData(e,t){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[],this.parentProp=t,HTML_EXP_COMPILING&&CURRENT_HTML_EXP_LIST.push(this)}function Change(e,t,i,n,r,s){this.name=e,this.newVal=t,this.oldVal=i,this.path=n,this.type=r,this.object=s,this.expProps=[]}function ExpNode(e,t,i,n,r,s){this.node=e,this.attrName=t,this.origin=i,this.expMap=n,this.component=r,this.toHTML=s,this.id=Math.random(),HTML_EXP_COMPILING&&CURRENT_HTML_EXP_LIST.push(this)}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,i){this.cbk=e,this.ctrlScope=t,this.segments=i}function Prop(e,t,i,n){this.subComp=e,this.name=t,this.segments=i,this.expWords=n}function CompSlot(e,t,i,n,r){var s=t;if(e){var a=lexer(t);s=Renderer.evalExp(i,a);var o=this;i.watch(t,function(e,t,i,n){o.is(n)})}this.node=n,this.cache=null==r?!1:!0,this.cacheMap=this.cache?{}:null,this.comp=i,s&&this.is(s)}function Signal(e){e&&Util.ext(this,e),this.__signalMap={}}function Event(e,t,i){this.type=e,this.e=t,this.target=t&&t.target,this.currentTarget=i}function Dispatcher(e){this.__eventMap={},this.onInit=null,Util.ext(this,e)}function Component(){var e="C_"+im_counter++;this.__id=e,this.__state=Component.state.created,Signal.call(this),this.el=null,this.compSlots={},this.comps={},this.els={},this.propTypes=null,this.name,this.parent,this.children=[],this.__expNodes=[],this.__expDataRoot=new ExpData,this.__eventMap={},this.__watchProps=[],this.directives=[],this.template,this.__url,this.restrict,this.state={},impex._cs[this.__id]=this,HTML_EXP_COMPILING&&CURRENT_HTML_EXP_LIST.push(this)}function Directive(e,t){Signal.call(this),this.el=null,this.value=t,this.name=e,this.params,this.filter,this.component,this["final"]=!1,this.priority=0,HTML_EXP_COMPILING&&CURRENT_HTML_EXP_LIST.push(this)}function Filter(e){this.component=e,this.value,this.onCreate}function Service(){this.singleton,this.host,this.onCreate}function getStyle(e,t){for(var i="",n=PREFIX.length;n--;)if(i=e[PREFIX[n]+t])return i}function Transition(e,t,i){TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE));var n=t;if(i&&i.css===!1)this.__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var r=window.getComputedStyle(TESTNODE,null),s=getStyle(r,"transition-duration").split(","),a=getStyle(r,"transition-delay").split(","),o=-1,h=s.length;h--;){var l=parseFloat(s[h]),c=parseFloat(a[h]);l+c>o&&(o=l+c)}if(o>0){var p=null,u=null;t instanceof Directive?(p=t.component.__expNodes,u=t.component):(p=t.__expNodes,u=t),p.length<1&&u.parent&&(p=u.parent.__expNodes);for(var h=p.length;h--;){var d=p[h];"class"===d.attrName&&(d.origin+=" "+e+"-transition")}n.el.className+=" "+e+"-transition",this.__longest=o;var f=null;for(var v in TRANSITIONS)if(void 0!==n.el.style[v]){f=TRANSITIONS[v];break}n.el.addEventListener(f,this.__done.bind(this),!1),this.__css=!0}}this.__direct=t,this.__view=n,this.__hook=i||{},this.__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function slotHandler(e,t){var i={},n=[];t.replace(/<(?:\s+)?([a-z](?:.+)?)[^<>]+slot(?:\s+)?=(?:\s+)?['"]([^<>]+?)?['"](?:[^<>]+)?>/gim,function(e,t,i,r){n.push([t,i,r])});for(var r=t,s=n.length;s--;){var a=n[s],o=a[2],h=a[1],l=a[0],c=0,p=-1,u=new RegExp("<(?:(?:s+)?/)?(?:s+)?"+l+"[^>]*?>","img");r.replace(u,function(e,t){o>=t||(/<(?:(?:\s+)?\/)/.test(e)?(c--,0>c&&(p=t)):c++)});var a=r.substring(o,p);i[h]=a+"</"+l+">",r=r.replace(i[h],"")}return t.trim().length>0&&(e=e.replace(/<(?:\s+)?slot(?:\s+)?>(?:[^<>]+)?<\/(?:\s+)?slot(?:\s+)?>/gim,function(e){return t})),e=e.replace(/<(?:\s+)?slot\s+name(?:\s+)?=(?:\s+)?['"]([^<>]+?)?['"](?:[^<>]+)?>(?:[^<>]+)?<\/(?:\s+)?slot(?:\s+)?>/gim,function(e,t){return i[t]||e})}function peelCSS(e){var t="";return e=e.replace(/<(?:\s+)?style(?:.+)?>([^<]+)?<\/(?:\s+)?style(?:\s+)?>/gim,function(e){return t+=e,""}),[t,e]}function cssHandler(e,t){return t=t.replace(/<(?:\s+)?style(?:.+)?>([^<]+)?<\/(?:\s+)?style(?:\s+)?>/gim,function(t,i){return"<style>"+filterStyle(e,i)+"</style>"})}function filterStyle(e,t){return t=t.replace(/\n/gim,"").trim(),t=t.replace(/(^|})(?:\s+)?[a-z:_$.>~+](?:[^{]+)?\{/gim,function(t){var i=t.trim();return/(^|}|((?:\s+)?,))(?:\s+)?:host/.test(i)||("}"===i[0]?(i=i.substr(1),i="}"+e+" "+i):i=e+" "+i),i=i.replace(/:host/gim,e)})}function checkPropType(e,t,i,n){if(i[e]&&i[e].type){var r=i[e].type;r=r instanceof Array?r:[r];var s=typeof t;t instanceof Array&&(s="array"),"undefined"!==s&&r.indexOf(s)<0&&LOGGER.error("invalid type ["+s+"] of prop ["+e+"] of component["+n.name+"];should be ["+r.join(",")+"]")}}function handleProps(e,t,i,n,r){if(e=e.replace(/-[a-z0-9]/g,function(e){return e[1].toUpperCase()}),e[0]!==PROP_TYPE_PRIFX)return n&&e in n&&(delete i[e],checkPropType(e,t,n,r)),void(r.state[e]=t);var s=e.substr(1),a=lexer(t),o=Renderer.evalExp(r.parent,a);if(Util.isObject(o)&&r.onPropBind&&(o=r.onPropBind(s,o)),PROP_SYNC_SUFX_EXP.test(s)){s=s.replace(PROP_SYNC_SUFX_EXP,"");var h=Object.keys(a.varTree);h.forEach(function(e){if(!a.varTree[e].isFunc){var t=new Prop(r,s,a.varTree[e].segments,a);r.parent.__watchProps.push(t)}})}return n&&s in n&&(delete i[s],checkPropType(s,o,n,r)),o instanceof Function?void(r[s]=o.bind(r.parent)):void(r.state[s]=o)}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function i(){if(0===this.status||this.status>=200&&this.status<300||304===this.status){var e=this.responseText;n.innerHTML=e;for(var t=n.querySelector("template").innerHTML,i=n.querySelector("script#impex").innerHTML,s=n.querySelectorAll('link[rel="impex"]'),a=s.length;a--;){var o=s[a],h=o.getAttribute("type"),l=o.getAttribute("href");impex.component(h,l)}var c=r[this.url],p=this.url;c.forEach(function(e){var n=eval;n("__impex_comp_eval = "+i),window.__impex_comp_eval||LOGGER.error("can not find component defination of : "+p);var r=window.__impex_comp_eval();e([t,r])}),r[this.url]=null}}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype._super=t.prototype},this.ext=function(e,t){for(var i=Object.keys(t),n=i.length;n--;){var r=i[n];e[r]=t[r]}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var n=document.createElement("div");this.isDOMStr=function(e){return n.innerHTML=e,n.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName};var r={};this.loadComponent=function(n,s,a){if(r[n])return void r[n].push(s);r[n]=[],r[n].push(s);var o=new XMLHttpRequest;o.open("get",n,!0),o.timeout=a||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=i:o.onreadystatechange=i,o.url=n,o.send(null)},this.immutable=function(e){if("object"==typeof e){var t=JSON.parse(JSON.stringify(e));return t}return e},this.compileViewOf=function(e,t){var i=Scanner.scan(t,e);Builder.link(e,i.exps),Renderer.renderExpNodes(i.exps);for(var n=i.comps,r=n.length;r--;)n[r].init();for(var s=i.directs,r=s.length;r--;)s[r].init();for(var r=0;r<n.length;r++)n[r].__url||n[r].mount();for(var r=s.length;r--;)s[r].active()}},Observer=null;window.Proxy&&!function(){function e(e,t,i){isNaN(t)||(e[t>>0]=i)}function t(e,t){isNaN(t)||e.splice(t,1)}function i(e,t,n,r){if(n&&n.__im__propChain)return n;var s=n instanceof Array?[]:{};for(var a in n){var o=n[a];if("object"==typeof o&&null!=o){var h=t.concat();h.push(a);var l=i(e,h,o,r);s[a]=l}else s[a]=o}Object.defineProperty(s,"__im__propChain",{enumerable:!1,writable:!1,value:t}),Object.defineProperty(s,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]});var c=new Proxy(s,e);Object.defineProperty(c,"__im__target",{enumerable:!1,writable:!1,value:s});var p=Date.now()+Math.random();return Object.defineProperty(s,"__im__oid",{enumerable:!1,writable:!1,value:p}),c}Observer={observe:function(n,r){if(n&&n.__im__propChain)return n;var s={comp:r,set:function(t,n,r){var s=!(n in t),a=t[n],o=r;if(a===o)return!0;if("object"==typeof o&&null!==o){var h=t.__im__propChain.concat();h.push(n),o=i(this,h,o,this.comp)}t instanceof Array?e(t,n,o):t[n]=o;var l=t.__im__propChain,c=t.__im__extPropChain,p={object:t,name:n,pc:l,xpc:c,oldVal:a,newVal:o,comp:this.comp,type:s?"add":"update"};return ChangeHandler.handle(p),!0},deleteProperty:function(e,i){var n=e[i];e instanceof Array?t(e,i):delete e[i];var r=e.__im__propChain,s=e.__im__extPropChain,a={object:e,name:i,pc:r,xpc:s,oldVal:n,comp:this.comp,type:"delete"};return ChangeHandler.handle(a),!0}};return i(s,[],n,r)}}}(),!window.Proxy&&!function(){function e(e){return this.__im__innerProps[e]}function t(e,t){var n=this.__im__innerProps[e];if(n&&r(n),"object"==typeof t){var a=this.__im__propChain.concat();a.push(e),t=i(a,t,this.__im__comp)}this.__im__innerProps[e]=t;this.__im__propChain,this.__im__extPropChain;s([{name:e,target:this,oldVal:n,newVal:t,type:"update"}],!0)}function i(n,r,s){if(r&&r.__im__propChain)return r;var o=r instanceof Array?[]:{};Object.defineProperty(o,"__im__innerProps",{enumerable:!1,writable:!0,value:{}});var h={},l={};for(var c in r)if(r.hasOwnProperty(c)){var p=r[c];if("object"==typeof p&&null!=p){var u=n.concat();u.push(c);var d=i(u,p,s);o.__im__innerProps[c]=d}else o.__im__innerProps[c]=p;l[c]=p,!function(i){h[i]={get:function(){return e.call(this,i)},set:function(e){t.call(this,i,e)},enumerable:!0,configurable:!0}}(c)}Object.defineProperties(o,h),Object.defineProperty(o,"__im__propChain",{enumerable:!1,writable:!1,value:n}),Object.defineProperty(o,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]}),Object.defineProperty(o,"__im__target",{enumerable:!1,writable:!1,value:o.__im__innerProps}),Object.defineProperty(o,"__im__comp",{enumerable:!1,writable:!1,value:s});var f=Date.now()+Math.random();return Object.defineProperty(o,"__im__oid",{enumerable:!1,writable:!1,value:f}),a.push({snap:l,now:o,id:f}),o}function n(){o(function(){for(var e=a.length;e--;){var t=a[e],i=t.snap,r=t.now,o=(t.id,[]);for(var h in i)if(!(h in r)){var l={};l.name=h,l.target=r,l.oldVal=i[h],l.snap=i,l.type="delete",o.push(l)}for(var h in r)if(!(h in i)){var l={};l.name=h,l.target=r,l.newVal=r[h],l.snap=i,l.type="add",o.push(l)}o.length>0&&s(o)}n()})}function r(e){for(var t=null,i=a.length;i--&&(t=a[i],t.id!==e.__im__oid););i>-1&&(a.splice(i,1),"object"==typeof t&&r(t))}function s(n,s){for(var a=n.length;a--;){var o=n[a],h=o.name,l=o.target,c=l.__im__propChain,p=l.__im__extPropChain,u=l.__im__comp,d=o.oldVal,f=o.newVal,v=o.type,_=o.snap;if("add"===v){if(_[h]=f,l.__im__innerProps[h]=f,"object"==typeof f){var m=c.concat();m.push(h),l.__im__innerProps[h]=i(m,f,u)}!function(i,n){Object.defineProperty(n,i,{get:function(){return e.call(this,i)},set:function(e){t.call(this,i,e)},enumerable:!0,configurable:!0})}(h,l)}else if("delete"===v){var g=_[h];"object"==typeof g&&r(g),delete _[h]}else if(!s){console.log("无效update");continue}var y={object:l,name:h,pc:c,xpc:p,oldVal:d,newVal:f,comp:u,type:v};ChangeHandler.handle(y)}}var a=[],o=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self);Observer={},Observer.observe=function(e,t){return e&&e.__im__propChain?e:i([],e,t)},n()}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,r){if(o.test(e)){var s=n(r,t);return c="var",s}return a.test(e)?(c="str",i(t,RegExp.$1)):(c="",e)}function i(e,t){for(var i=!1,n=t,r=1;r<e.length;r++){var s=e[r];if("\\"!==s){if(!i&&s===t)return n+t;n+=s,i=!1}else i=!0,n+=s}}function n(i,r,s,a){for(var c="",p=[],u=-1,d=-1,f=-1,v=a||e(),_=0;_<r.length;_++){var m=r[_];if(p.length>0)if(o.test(m)){var g=e(),y=n(i,r.substr(_),p[0],g);_=_+y.length-1;var b=y;o.test(y[0])&&l.indexOf(b)<0&&(v.subVars["."+y]=g,l.indexOf(b)<0&&(b=["."+b])),v.words.push(b)}else if("]"===m||")"===m){if("]"===m&&"["!==p[0])continue;if(")"===m&&"("!==p[0])continue;if(p.pop(),0===p.length){var E=r.substring(u,_+1);c+=E,v.segments.push(E),f=_}")"===m&&(v.isFunc=!0),v.words.push(m),d=_}else{var x=t(m,r.substr(_),i);_=_+x.length-1,v.words.push(x),d=_}else if(h.test(m)){if(c+=m,"."===m){var b=c.substr(f+1);b=b.replace(/\./,""),b&&(v.segments.push(b),f=_)}}else{if("["!==m&&"("!==m){if("]"===m&&"["===s||")"===m&&"("===s){var b=c;if(b[b.length-1]!==m){b=b.substring(d+1,b.length),b&&v.words.push(0===r.indexOf(b)?["."+b]:b);var T=b.lastIndexOf(".");T>0&&(b=b.substr(T)),b&&v.segments.push(b),f=_}return d=_,c}var b=c.substr(d+1);b&&("."!==b[0]&&l.indexOf(b)<0&&(b=["."+b]),v.words.push(b));var C=c.substr(f+1);return C&&(v.segments.push(C),f=_),!s&&l.indexOf(b)<0&&(i["."+c]=v),c}p.push(m),u=_,v.brakLength++;var O=c.substr(d+1);if(O){var b=O;l.indexOf(O)<0&&0>d&&(b=["."+O]),v.words.push(b)}v.words.push(m);var P="["===m?"]":")";if(c[_-1]!==P){var w=O.lastIndexOf(".");w>-1?(O=O.substr(w),v.segments.push(O)):O&&v.segments.push(O),f=_}d=_}}var N=c.substr(c.lastIndexOf("]")+1),M=c.substr(c.lastIndexOf(")")+1);if(N&&M){var R=N.length<M.length?N:M,C=c.substr(f+1);v.segments.push(C);var b="["===R[0]||"("===R[0]?R:"."===R[0]?R:"."+R;v.words.length<1&&l.indexOf(b)<0&&(b=[b]),v.words.push(b)}return s||(i["."+c]=v),c}function r(e){for(var t in e){var i=e[t],n=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,i.brakLength);var h="]"===t[t.length-1]?"[":"(",l=i.brakLength;i.watchPathWords=[];for(var c=0;c<i.words.length;c++){var p=i.words[c];if(p===h&&--l<1)break;i.watchPathWords.push(p)}}else i.watchPathWords=i.words.concat(),i.watchPathWords.splice(-1,1);n=t.substr(o),i.lastVar="("===n[0]?t:n,Object.keys(i.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),i.watchPath=a);for(var c=i.segments.length;c--;)i.segments[c]=i.segments[c].replace(/^\.|\.$/g,"");r(i.subVars)}}function s(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(("["===n||"("===n)&&--t<1)return i}}var a=/(['"])/,o=/[a-zA-Z$_]/,h=/[a-zA-Z$_0-9.]/,l=["return","as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var i=[],n={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),n);switch(s=s+o.length-1,c){case"var":i.push(l.indexOf(o)<0?["."+o]:o);break;case"str":case"":i.push(o)}}return r(n),p[e]={words:i,varTree:n},p[e]}}();ExpData.prototype={release:function(){if(null!=this.expNodes){this.expNodes.forEach(function(e){e.release()}),this.attrObserveNodes.forEach(function(e){e.release()}),this.watchs.forEach(function(e){e.release()}),this.parentProp&&(this.parentProp[this.propName]=null,delete this.parentProp[this.propName]);for(var e in this.subProps){var t=this.subProps[e];t&&t.release()}this.propName=this.subProps=this.expNodes=this.attrObserveNodes=this.watchs=this.parentProp=null}}},ExpNode.prototype={release:function(){this.node=this.attrName=this.origin=this.expMap=this.component=this.toHTML=this.id=null}},AttrObserveNode.prototype={release:function(){this.directive=this.expObj=null}},Watch.prototype={release:function(){this.cbk=this.segments=this.ctrlScope=null}},CompSlot.prototype={is:function(e){var t=this.lastComp;if(!t||t.name!==e){var i=this.node;if(t&&(i=t.el,!ComponentFactory.hasTypeOf(e)))return void LOGGER.warn("cannot find component["+e+"]");var n=document.createComment("-- placeholder --");DOMHelper.insertBefore([n],i),t?this.cache?t.unmount(!1):t.destroy():DOMHelper.detach([i]);var r=null;if(this.cache&&this.cacheMap[e])r=this.cacheMap[e],r&&(DOMHelper.replace(n,r.__nodes),r.mount());else{var s=document.createElement(e);n.parentNode.replaceChild(s,n),r=this.comp.createSubComponentOf(s),r.init().mount()}this.cache&&!this.cacheMap[e]&&(this.cacheMap[e]=r),this.lastComp=r}}};var Scanner=new function(){function e(e){if(e){var i=[],n=[];t(e,i);for(var r=i.length;r--;){var e=i[r],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,i){var n=s.substring(o,i);n&&a.push(n),a.push(e),o=i+e.length});var h=s.substring(o,s.length);if(h&&a.push(h),a.length<2)n.unshift(null);else{for(var l=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);l.appendChild(p)}n.unshift(l)}}for(var c=i.length;c--;){var u=i[c];n[c]&&n[c].childNodes.length>1&&u.parentNode&&u.parentNode.replaceChild(n[c],u)}}}function t(e,i){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var n=0,r=e.childNodes.length;r>n;n++)t(e.childNodes[n],i)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;i.push(e)}}function i(e){if(e.restrict)return e;for(var t=e.parent;t;){if(t.name&&t.restrict)return t;t=t.parent}return null}function n(e,t,s,a,o){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var h=e.tagName.toLowerCase(),l=[],c=e.attributes.length;c--;){var p=e.attributes[c];l.push([p.name,p.value])}if(h===COMP_SLOT_TAG){var u=e.getAttribute("is"),d=e.getAttribute("cache"),f=e.getAttribute("name");f||(f="compSlots_"+(Object.keys(t.compSlots).length+1));var v=!1;if(u||null==e.getAttribute(".is")||(u=e.getAttribute(".is"),v=!0),null!=u)return void(t.compSlots[f]=new CompSlot(v,u,t,e,d))}for(var _=[],c=l.length;c--;){var m=l[c][0];if(0===m.indexOf(CMD_PREFIX)){var g=m.replace(CMD_PREFIX,""),y=g.indexOf(CMD_PARAM_DELIMITER);y>-1&&(g=g.substring(0,y)),DirectiveFactory.hasTypeOf(g)&&DirectiveFactory.isFinal(g)&&_.push([g,l[c],DirectiveFactory.priority(g)||0])}}if(_.length>0){_.sort(function(e,t){return t[2]-e[2]});var g=_[0][0],b=_[0][1];if(DirectiveFactory.isFinal(g)){var E=DirectiveFactory.newInstanceOf(g,e,t,b[0],b[1]);return void s.push(E)}}if(t.name!==h&&ComponentFactory.hasTypeOf(h)){var x=i(t);if(x&&x.restrict.children){var T=x.restrict.children.split(",");if(T.indexOf(h)<0)return}var C=ComponentFactory.getRestrictOf(h);if(C&&C.parents){var O=C.parents.split(",");if(O.indexOf(x.name)<0)return}var P=t.createSubComponentOf(e);return void a.push(P)}for(var c=l.length;c--;){var w=l[c][0],N=l[c][1];if(REG_CMD.test(w)){var g=w.replace(CMD_PREFIX,""),y=g.indexOf(CMD_PARAM_DELIMITER);if(y>-1&&(g=g.substring(0,y)),DirectiveFactory.hasTypeOf(g)){var E=DirectiveFactory.newInstanceOf(g,e,t,w,N);s.push(E)}}else if(":"===w[0]){var E=DirectiveFactory.newInstanceOf("on",e,t,w,N);s.push(E)}else if(REG_EXP.test(N)){var v=r(N,t,e,w);v&&o.push(v)}}}if(e.childNodes.length>0)for(var c=0,M=e.childNodes.length;M>c;c++)n(e.childNodes[c],t,s,a,o)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;var v=r(e.nodeValue,t,e);v&&o.push(v)}}function r(e,t,i,n){var r=s(e,t,i,n);return r&&t.__expNodes.push(r),r}function s(e,t,i,n){var r={},s=!n&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);return s&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,i){var n={},s=1,o=null;FILTER_EXP.test(i)&&(o=a(lexer(RegExp.$1),n,t),s=i.indexOf(FILTER_EXP_START_TAG));var h=i;s>1&&(h=i.substring(0,s));var l=lexer(h);o&&Util.ext(l.varTree,o),r[i]={words:l.words,varTree:l.varTree,filters:n}}),Object.keys(r).length<1?void 0:new ExpNode(i,n,e,r,t,s)}function a(e,t,i){for(var n=[],r=null,s=!1,a={},o=[],h=e.words,l=0;l<h.length;l++)if(h[l]instanceof Array){var c=h[l][0],p=c.replace(/^\./,"");o.push([p])}else o.push(h[l]);for(var l=0;l<o.length;l++){var c=o[l];switch(c){case":":s=!0,null!==r&&n.push(r),r="";break;case FILTER_EXP_SPLITTER:s=!1,null!==r&&n.push(r),r="",n=[];break;default:if(c instanceof Array){var u=c[0],d=u.toLowerCase();if(!s&&d&&FilterFactory.hasTypeOf(d))r=null,t[d]=[FilterFactory.newInstanceOf(d,i),n];else{var p=lexer(u);Util.ext(a,p.varTree),n.push(p),r=null}}else{if(!s||!c.replace(/\s+/,""))continue;r+=c.replace(/^['"]|['"]$/g,"")}}}return r&&n.push(r),a}this.scan=function(t,i){for(var r=[],s=[],a=[],o=0,h=t.length;h>o;o++)e(t[o]),n(t[o],i,r,s,a);return{directs:r,comps:s,exps:a}},this.getExpNode=s,this.parseFilters=a},Builder=new function(){function e(i,n,r){for(var s in n.subVars){var a=n.subVars[s];e(i,a,r)}for(var o=t(i.__expDataRoot.subProps,n.segments[0],r),h=1;h<n.segments.length;h++)o=t(o.subProps,n.segments[h],r)}function t(e,t,i){var n=e[t];return n||(n=e[t]=new ExpData(t,e)),i instanceof ExpNode?n.expNodes.indexOf(i)<0&&n.expNodes.push(i):i instanceof AttrObserveNode?n.attrObserveNodes.indexOf(i)<0&&n.attrObserveNodes.push(i):i instanceof Watch&&n.watchs.indexOf(i)<0&&n.watchs.push(i),e[t]}this.link=function(t,i){for(var n=i.length;n--;){var r=i[n];for(var s in r.expMap){var a=r.expMap[s],o=a.varTree;for(var h in o){var l=o[h];e(t,l,r)}}}},this.buildExpModel=e,this.build=function(e){this.link(e,e.__expNodes)}},ChangeHandler=new function(){function e(e){for(var t=s.length;t--;){var i=s[t];if(i.object.__im__oid===e.object.__im__oid&&i.name===e.name)break}t>-1?s.splice(t,1,e):s.push(e)}function t(e,t,n,r,s,o,h){var l=[];if(h[0]instanceof Directive){var c=void 0===h[2]?s:h[2];n=h[0].subComponents[parseInt(c)],l.push(h[1]),Util.isUndefined(h[2])&&n instanceof Component&&n.state.__im__target&&(n.state.__im__target[h[1]]=e)}else l=h.concat(),Util.isArray(o)||l.push(s);if(n){a[n.__id]||(a[n.__id]={changes:[],comp:n});var p=new Change(s,e,t,l,r,o);a[n.__id].changes.push(p),i(n,l,p)}}function i(e,t,i){for(var r,s=e.__expDataRoot.subProps,a=!1,h=0;h<t.length;h++){var l=t[h];if(o.test(Object.keys(s).join(","))){a=!0;break}{if(!s[l])break;r=s[l],s=s[l].subProps}}if(r){var c=[];if(a)for(var p=t.length-h-1,u=Object.keys(r.subProps),h=u.length;h--;){var d=u[h];("["===d[0]||d===l)&&n(r.subProps[d],p,c)}else c.push(r);for(var h=c.length;h--;){var r=c[h];i.expProps.push(r)}}}function n(e,t,i){if(1>t)return void i.push(e);for(var r in e.subProps)n(e.subProps[r],t-1,i)}var r=!1,s=[],a={};this.handle=function(i){r?e(i):(s=[],a={},r=!0,s.push(i),setTimeout(function(){r=!1,s.forEach(function(e){var i=e.newVal,n=e.oldVal,r=e.pc,s=e.xpc,a=e.comp,o=e.type,h=e.name,l=e.object;t(i,n,a,o,h,l,r),s.forEach(function(e){t(i,n,a,o,h,l,e)})});var e=a;for(var i in e)e[i].comp.__update(e[i].changes)},20))};var o=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNodes(e){for(var t={},i=e.length;i--;){var n=e[i],r=null;if(t[n.origin]&&t[n.origin].comp===n.component?r=t[n.origin].val:(r=calcExpNode(n),t[n.origin]={comp:n.component,val:r}),n.toHTML){var s=renderHTML(n,r,n.node,n.component);if(s)continue}null!==r&&updateDOM(n.node,n.attrName,r)}}function updateDOM(e,t,i){if(e.setAttribute){e.setAttribute(t,i);var n=propMap[t];n&&n.indexOf(e.tagName)>-1&&(e[t]=i)}else e.parentNode&&(e.nodeValue=i)}function calcExpNode(e){var t=e.component,i=e.origin,n=e.expMap,r={};for(var s in n){var a=n[s],o=evalExp(t,a),h=a.filters;if(Object.keys(h).length>0){if(Util.isObject(o)){var l=o;o=Util.isArray(o)?[]:{},Util.ext(o,l)}for(var c in h){for(var p=h[c][0],u=h[c][1],d=[],f=u.length;f--;){var v=u[f];v.varTree&&v.words&&(v=Renderer.evalExp(t,v)),d[f]=v}p.value=o,o=p.to.apply(p,d)}}r[s]=void 0===o?"":o}for(var c in r)i=i.replace(EXP_START_TAG+c+EXP_END_TAG,r[c]+"");return i}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var i=t.varTree,n={};for(var r in i){var s=i[r],a=buildVarPath(e,s,r);n[r]=a}var o=joinExpStr(t.words,n);return o}function joinExpStr(e,t){for(var i="",n=0;n<e.length;n++){var r=e[n];i+=r instanceof Array?t[r[0]]:r}return i}function keyWordsMapping(e,t){return 0===e.indexOf(".this")?e.replace(".this",t.__getPath()):void 0}function buildVarPath(e,t,i){var n={};for(var r in t.subVars){var s=t.subVars[r],a=buildVarPath(e,s,r);n[r]=a}for(var o=!1,h="",l=0;l<t.words.length;l++){var c=t.words[l];if(c instanceof Array){if(n[c[0]]){h+=n[c[0]];continue}var p=keyWordsMapping(c[0],e);p?(o=!0,h+=p):h+=c[0]}else h+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var l=0;l<t.watchPathWords.length;l++){var c=t.watchPathWords[l];u+=c instanceof Array?n[c[0]]||c[0]:c}if(o||0===h.indexOf("impex._cs"))return h;var d=!0;")"===i[i.length-1]&&/^\.[^(.]+?\(/.test(i)&&(d=!1);var f=u||h,v=null,_=e;return v=d?".state"+f:"."+f.substr(1),e=varInComponent(e,v),!e&&d&&(v="."+f.substr(1),e=varInComponent(_,v),e&&(d=!1)),e?(h=d?".state"+h:"."+h.substr(1),e.__getPath()+h):(d&&(f="."+f.substr(1)),"self"+h)}function varInComponent(e,t){return void 0!==getVarByPath(t,e.__getPath())?e:null}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,i,n){if(Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;")),e.__lastVal!==t&&3==i.nodeType){if(!e.__placeholder){var r=document.createComment("-- [html] placeholder --");i.parentNode.insertBefore(r,i),e.__lastVal=t,e.__placeholder=r,i.parentNode.removeChild(i)}if(e.__lastNodes){DOMHelper.detach(e.__lastNodes);var s=HTML_EXP_MAP[e.id];s&&s.length>0&&(releaseObjs(s),CURRENT_HTML_EXP_LIST=HTML_EXP_MAP[e.id]=null,delete HTML_EXP_MAP[e.id]),e.__lastNodes=null}var a=document.createComment("-- [html] target --");e.__placeholder.parentNode.insertBefore(a,e.__placeholder);var o=DOMHelper.compile(t);if(e.__lastVal=t,!(o.length<1))return DOMHelper.replace(a,o),e.__lastNodes=o,HTML_EXP_COMPILING=!0,CURRENT_HTML_EXP_LIST=HTML_EXP_MAP[e.id]=[],Util.compileViewOf(n,o),HTML_EXP_COMPILING=!1,!0}}function releaseObjs(e){for(var t=e.length;t--;){var i=e[t];i.destroy?i.destroy():i.release&&i.release()}}this.render=function(e){renderExpNodes(e.__expNodes)},this.recurRender=function(e){var t=e.children;renderExpNodes(e.__expNodes);for(var i=t.length;i--;)Renderer.render(t[i])},this.renderExpNodes=renderExpNodes;var propMap={value:["INPUT"]};this.calcExpNode=calcExpNode,this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};Signal.prototype={on:function(e,t,i){for(var n=e.replace(/\s+/gm," ").split(" "),r=n.length;r--;){var s=n[r],a=this.__signalMap[s];a||(a=this.__signalMap[s]=[]);var o=this instanceof Component?this:this.component,h={id:Date.now()+Math.random(),el:this.el,exp:t,comp:o,context:i||this};a.push(h);for(var l=!0,c=DISPATCHERS.length;c--;){var p=DISPATCHERS[c][0];if(p.indexOf(s)>-1){l=!1;break}}l?Handler.addDefaultEvent(s,h):(DISPATCHERS[c][1].addEvent(s,h),DISPATCHERS[c][1].onInit())}},off:function(e,t,i){i=i||this;var n=null;n=e?e.replace(/\s+/gm," ").split(" "):Object.keys(this.__signalMap);for(var r=n.length;r--;){var s=this.__signalMap[n[r]];if(s){for(var a=[],o=s.length;o--;)i!==s[o].context||(t?s[o].exp!==t:0)||a.push(s[o]);a.forEach(function(t){var i=s.indexOf(t);s.splice(i,1),Handler.removeDefaultEvent(e,t),t.dispatcher&&t.dispatcher._delEvent(e,t)})}}},emit:function(){var e=arguments[0],t=this.__signalMap[e];if(t){for(var i=[],n=1;n<arguments.length;n++)i.push(arguments[n]);t.forEach(function(t){Handler.emitEventExp(t,e,i)})}}};var Handler=new function(){var e={};this.evalEventExp=function(e,t,i,n){var r=e.exp,s=e.context,a=e.comp,o=r,h=new Event(i,t,e.el);if(n&&Util.ext(h,n),r instanceof Function&&!e.componentFn){try{o=r.call(s,h)}catch(l){LOGGER.debug("error in event '"+i+"'",l)}if(!o||"string"!=typeof o)return o}if(!e.cache&&"string"==typeof o){var c=lexer(o),p=Renderer.getExpEvalStr(a,c),u=p.replace(/self\.\$event/gm,"$event");u=u.replace(/self\.arguments/gm,"arguments");var d=new Function("$event","arguments",u);e.componentFn=d,e.cache=!0}try{return e.componentFn.call(s,h,[h])}catch(l){LOGGER.debug("error in event '"+i+"'",l)}},this.emitEventExp=function(e,t,i){var n=e.exp,r=e.context,s=e.comp||r,a=n;if(n instanceof Function&&!e.componentFn){try{a=n.apply(r,i)}catch(o){LOGGER.debug("error in event '"+t+"'",o)}if(!a||"string"!=typeof a)return a}if(!e.cache&&"string"==typeof a){if(!(s instanceof Component))return void LOGGER.error("need a context to parse '"+n+"' of type '"+t+"'");var h=lexer(a),l=Renderer.getExpEvalStr(s,h),c=l.replace(/self\.arguments/gm,"arguments"),p=new Function("arguments",c);e.componentFn=p,e.cache=!0}try{e.componentFn.call(r,i)}catch(o){LOGGER.debug("error in event '"+t+"'",o)}},this.addDefaultEvent=function(t,i){e[t]||(e[t]=[]),e[t].push(i);var n=this.__defaultEventHandler.bind(this);i.ref=n,i.el&&i.el.addEventListener(t,n,!1)},this.removeDefaultEvent=function(t,i){for(var n=e[t],r=n.length;r--&&n[r].id!==i.id;);n.splice(r,1),i.el&&i.el.removeEventListener(t,i.ref,!1)},this.__defaultEventHandler=function(t){for(var i=t.type,n=t.currentTarget,r=e[i],s=r.length;s--&&r[s].el!==n;);this.evalEventExp(r[s],t,i)}};Util.ext(Dispatcher.prototype,{dispatch:function(e,t,i){var n=t.target,r=this.__eventMap[e];if(r)do{if(this.fireEvent(n,r,t,e,i)===!1)break;n=n.parentNode}while(n.tagName&&"HTML"!=n.tagName)},fireEvent:function(e,t,i,n,r){for(var s=t.length;s--&&t[s].el!==e;);if(!(0>s)){var a=Handler.evalEventExp(t[s],i,n,r);return a}},addEvent:function(e,t){var i=this.__eventMap[e];i||(i=this.__eventMap[e]=[]),i.push(t),t.dispatcher=this},_delEvent:function(e,t){for(var i=this.__eventMap[e],n=i.length;n--&&i[n].id!==t.id;);i.splice(n,1)}}),Component.state={created:"created",inited:"inited",mounted:"mounted",unmounted:"unmounted"},Util.inherits(Component,Signal),Util.ext(Component.prototype,{d:function(path,val){if(!path)return void LOGGER.warn("invalid path '"+path+"'");var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\\/gm,"\\\\").replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}return this}try{return eval(evalStr)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}},watch:function(e,t){var i=lexer(e),n=Object.keys(i.varTree);if(!(n.length<1)){if(n.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var r=i.varTree[n[0]],s=new Watch(t,this,r.segments);return Builder.buildExpModel(this,r,s),this}},compile:function(e){Scanner.scan(e,this),Builder.build(this);for(var t=this.children.length;t--;)this.children[t].init();for(var t=this.directives.length;t--;)this.directives[t].init()},add:function(e){this.children.push(e),e.parent=this},createSubComponentOf:function(e){var t=ComponentFactory.newInstanceOf(e.tagName.toLowerCase(),e);return this.children.push(t),t.parent=this,t},createSubComponent:function(e){var t=ComponentFactory.newInstance(e);return this.children.push(t),t.parent=this,t},init:function(){if(this.__state===Component.state.created){if(this.__url){var e=this;Util.loadComponent(this.__url,function(t){var i=t[0];e.template=i;var n=t[1];n.template=i,ComponentFactory.register(e.name,n),ComponentFactory.initInstanceOf(e.name,e),ComponentFactory.parse(i,e),e.__url=null,e.__init(),e.mount()})}else this.template&&ComponentFactory.parse(this.template,this),this.__init();return this}},__init:function(){if(Scanner.scan(this.__nodes,this),LOGGER.log(this,"inited"),this.state=Observer.observe(this.state,this),Builder.build(this),this.__state=Component.state.inited,this.onInit){var e=ComponentFactory.getServices(this,this.name);e?this.onInit.apply(this,e):this.onInit()}for(var t=this.children.length;t--;)this.children[t].init();for(var t=this.directives.length;t--;)this.directives[t].init()},mount:function(){if(this.__state!==Component.state.mounted&&this.__state!==Component.state.created){if(this.__state===Component.state.unmounted&&this.__target)return void DOMHelper.replace(this.__target,this.__nodes);

Renderer.render(this),this.__state=Component.state.mounted,LOGGER.log(this,"mounted"),this.__nodes.forEach(function(e){if(e.querySelectorAll)for(var t=e.querySelectorAll("*["+ATTR_REF_TAG+"]"),i=t.length;i--;){var n=t[i];this.els[n.getAttribute(ATTR_REF_TAG)]=n}},this);for(var e=0;e<this.children.length;e++)this.children[e].templateURL||this.children[e].mount();for(var e=this.directives.length;e--;)this.directives[e].active();this.onMount&&this.onMount()}},destroy:function(){if(null!==this.__state){if(LOGGER.log(this,"unmount"),this.onDestroy&&this.onDestroy(),this.parent){for(var e=-1,t=this.parent.__watchProps;;){e=-1;for(var i=t.length;i--;){var n=t[i];if(n.subComp===this){e=i;break}}{if(!(e>-1))break;t.splice(e,1)}}e=this.parent.children.indexOf(this),e>-1&&this.parent.children.splice(e,1),this.parent=null}for(DOMHelper.detach(this.__nodes);this.children.length>0;)this.children[0].destroy();for(var i=this.directives.length;i--;)this.directives[i].destroy();this.__expDataRoot.release(),this.children=this.directives=this.__expNodes=this.__expDataRoot=null,impex._cs[this.__id]=null,delete impex._cs[this.__id],this.els=this.compSlots=this.__eventMap=this.__nodes=this._signalMap=this.__watchProps=this.__state=this.__id=this.__url=this.template=this.restrict=this.state=null}},unmount:function(e){this.__state===Component.state.mounted&&(LOGGER.log(this,"unmounted"),this.__unmount(this,e===!1?!1:!0),this.onUnmount&&this.onUnmount(),this.__state=Component.state.unmounted)},__unmount:function(e,t){var i=this.__nodes[0].parentNode;t&&(this.__target=document.createComment("-- view unmounted of ["+(e.name||"anonymous")+"] --"),i&&i.insertBefore(this.__target,this.__nodes[0]));for(var n=this.__nodes.length;n--;)this.__nodes[n].parentNode&&this.__nodes[n].parentNode.removeChild(this.__nodes[n])},__getPath:function(){return'impex._cs["'+this.__id+'"]'},__update:function(e){for(var t=!0,i=[],n=[],r=[],s=e.length;s--;){var a=e[s],o=a.expProps;a.expProps=null;for(var h=o.length;h--;){for(var l=o[h].expNodes,c=l.length;c--;){var p=l[c];i.indexOf(p)<0&&i.push(p)}for(var u=o[h].attrObserveNodes,c=u.length;c--;){var d=u[c];r.indexOf(d)<0&&r.push(d)}for(var f=o[h].watchs,c=f.length;c--;){var v=f[c];n.indexOf(v)<0&&n.push([v,a])}}}this.onUpdate&&(t=this.onUpdate(e)),t!==!1&&Renderer.renderExpNodes(i),this.__updateDirective(r),this.__callWatchs(n),this.__updateChildrenProps(e)},__updateChildrenProps:function(e){for(var t={},i=e.length;i--;){var n=e[i],r=n.path;this.__watchProps.forEach(function(e){var i=this.__isVarMatch(e.segments,r);if(!(0>i)){t[e.subComp.__id]||(t[e.subComp.__id]={});var n=t[e.subComp.__id][e.name];if(void 0===n){var s=Renderer.evalExp(this,e.expWords);t[e.subComp.__id][e.name]={name:e.name,val:s}}}},this)}for(var s in t){var a=t[s];impex._cs[s].__childPropChange&&impex._cs[s].__childPropChange(a)}},__isVarMatch:function(e,t){for(var i=0;i<e.length&&t[i];i++)if("["!==e[i][0]&&"["!==t[i][0]&&e[i]!==t[i])return-1;return i},__callWatchs:function(e){for(var t=[],i=e.length;i--;){var n=e[i][1],r=e[i][0],s=n.newVal,a=n.oldVal,o=n.name,h=n.object,l=n.path.concat();Util.isArray(h)||n.path.pop();var c=n.type;if(!(r.segments.length<l.length||t.indexOf(r)>-1)){var p=this.__isVarMatch(r.segments,l);if(p>-1){var u=n.path.length+1-r.segments.length;r.cbk&&r.cbk.call(r.ctrlScope,h,o,c,s,a,n.path,u),t.push(r)}}}},__updateDirective:function(e){for(var t=e.length;t--;){var i=e[t],n=Renderer.evalExp(i.directive.component,i.expObj);i.directive.onUpdate(n)}},__childPropChange:function(e){this.onPropChange&&this.onPropChange(e);var t={};for(var i in e){{var n=e[i];n.name}this.__watchProps.forEach(function(e){t[e.subComp.__id]||(t[e.subComp.__id]={});var i=t[e.subComp.__id][e.name];if(void 0===i){var n=Renderer.evalExp(this,e.expWords);t[e.subComp.__id][e.name]={name:e.name,val:n}}},this)}for(var i in t){var r=t[i];impex._cs[i].__childPropChange&&impex._cs[i].__childPropChange(r)}}});var DOMHelper=new function(){this.singleton=!0;var e=document.createElement("div");this.compile=function(t){var i=[];for(e.innerHTML=t;e.childNodes.length>0;){var n=e.removeChild(e.childNodes[0]);i.push(n)}return i},this.detach=function(e){var t=e[0].parentNode;if(t)for(var i=e.length;i--;)e[i].parentNode&&t.removeChild(e[i])},this.attach=function(e,t){var i=null;if(t.length>1){i=document.createDocumentFragment();for(var n=0;n<t.length;n++)i.appendChild(t[n])}else i=t[0];e.appendChild(i),i=null},this.replace=function(e,t){var i=null;if(t.length>1){i=document.createDocumentFragment();for(var n=0;n<t.length;n++)i.appendChild(t[n])}else i=t[0];e.parentNode.replaceChild(i,e),i=null},this.insertBefore=function(e,t){var i=t.parentNode,n=e[0];if(e.length>1){n=document.createDocumentFragment();for(var r=0;r<e.length;r++)n.appendChild(e[r])}i&&i.insertBefore(n,t)}};Util.inherits(Directive,Signal),Util.ext(Directive.prototype,{init:function(){if(this.__state!=Component.state.inited){var e=Scanner.getExpNode(this.value,this.component),t=e&&Renderer.calcExpNode(e);void 0!==t&&(this.value=t),LOGGER.log(this,"inited"),this.onInit&&this.onInit(),this.__state=Component.state.inited}},active:function(){if(this.onUpdate){var e=lexer(this.value);for(var t in e.varTree){var i=e.varTree[t],n=new AttrObserveNode(this,e);this.component&&Builder.buildExpModel(this.component,i,n)}var r=Renderer.evalExp(this.component,e);this.onUpdate(r)}this.onActive&&this.onActive(r)},destroy:function(){LOGGER.log(this,"destroy"),DOMHelper.detach(this.__nodes),this.component=this.params=this.filter=this.onUpdate=null,this.onDestroy&&this.onDestroy()}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},PREFIX=["-webkit-","-moz-","-o-","-ms-",""],TESTNODE;Transition.prototype={enter:function(){this.__start="enter";var e=this.__view.el.className.replace(this.__type+"-leave","");if(this.__view.el.className=e,this.__css&&(e+=" "+this.__type+"-enter",this.__view.el.className=e),this.__direct.enter&&this.__direct.enter(),this.__hook.enter&&this.__hook.enter.call(this.__direct,this.__done.bind(this)),this.__css){this.__view.el.offsetHeight;var e=this.__view.el.className.replace(this.__type+"-enter","");this.__view.el.className=e}},__enterDone:function(){this.__direct.postEnter&&this.__direct.postEnter(),this.__hook.postEnter&&this.__hook.postEnter.call(this.__direct,this.__done.bind(this))},leave:function(){this.__start="leave";var e=this.__view.el.className.replace(this.__type+"-leave","");this.__view.el.className=e,this.__css&&(e+=" "+this.__type+"-leave",this.__view.el.className=e),this.__direct.leave&&this.__direct.leave(),this.__hook.leave&&this.__hook.leave.call(this.__direct,this.__done.bind(this))},__leaveDone:function(){if(this.__direct.postLeave&&this.__direct.postLeave(),this.__hook.postLeave&&this.__hook.postLeave.call(this.__direct,this.__done.bind(this)),this.__css){this.__view.el.offsetHeight;var e=this.__view.el.className.replace(this.__type+"-leave","");this.__view.el.className=e}},__done:function(e){if(!(e&&e.elapsedTime<this.__longest)&&this.__start){switch(this.__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.__start=""}}},Factory.prototype={register:function(e,t,i){e=e.toLowerCase();var n=t.state;delete t.state;var r={};if("string"==typeof t?n=t:Util.ext(r,t),this.types[e])return this.types[e].state=n,void(this.types[e].props=r);var s=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)");Util.inherits(s,this.baseClass),this.types[e]={clazz:s,props:r,services:i,state:n}},hasTypeOf:function(e){return e in this.types},getServices:function(e,t){var i=null;if(this.types[t]&&this.types[t].services){i=[];for(var n=0;n<this.types[t].services.length;n++){var r=ServiceFactory.newInstanceOf(this.types[t].services[n],e);i.push(r)}}return i},createCbk:function(e,t){if(e.onCreate){var i=this.getServices(e,t);i?e.onCreate.apply(e,i):e.onCreate()}}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.restrict},parse:function(e,t){var i=t.el,n=i.attributes,r=i.innerHTML,s=null,a=null;if(this.types[t.name].tmplCache)a=this.types[t.name].tmplCache;else{var o=peelCSS(e);if(a=o[1],s=o[0],s=cssHandler(t.name,s),this.types[t.name].tmplCache=a,s.trim().length>0){var h=document.head.children[0];if(h){var l=DOMHelper.compile(s);DOMHelper.insertBefore(l,h)}else document.head.innerHTML=s}}a=slotHandler(a,r),t.onBeforeCompile&&(a=t.onBeforeCompile(a));var l=DOMHelper.compile(a);i.innerHTML="",DOMHelper.attach(i,l);var c={},p=t.propTypes;if(p)for(var u in p){var d=p[u];d.require&&(c[u]=d)}if(n)for(var f=n.length;f--;){var u=n[f].name.toLowerCase(),v=n[f].value;if(u!=ATTR_REF_TAG){var _=null;if(REG_CMD.test(u)){var m=u.replace(CMD_PREFIX,""),g=m.indexOf(CMD_PARAM_DELIMITER);g>-1&&(m=m.substring(0,g)),DirectiveFactory.hasTypeOf(m)&&(_=DirectiveFactory.newInstanceOf(m,t.el,t,u,v))}else 0===u.indexOf(CMD_PARAM_DELIMITER)?_=DirectiveFactory.newInstanceOf("on",t.el,t,u,v):handleProps(u,v,c,p,t);_&&_.init()}else{var y=Scanner.getExpNode(v,t),b=y&&Renderer.calcExpNode(y);t.parent.comps[b||v]=t}}var E=Object.keys(c);return E.length>0?void LOGGER.error("props ["+E.join(",")+"] of component["+t.name+"] are required"):void 0},newInstance:function(e,t){var i=null;1===e.length&&(i=e[0]);var n=new this.baseClass;return n.el=i,n.__nodes=e,t&&(Util.ext(n,t),t.state instanceof Function&&(n.state=t.state.call(n))),n},newInstanceOf:function(e,t){if(!this.types[e])return null;var i=new this.types[e].clazz(this.baseClass);i.name=e,i.el=t,i.__nodes=[t];var n=this.types[e].state;return"string"==typeof n?i.__url=n:this.initInstanceOf(e,i),this._super.createCbk.call(this,i,e),i},initInstanceOf:function(e,t){if(!this.types[e])return null;Util.ext(t,this.types[e].props);var i=this.types[e].state;i&&(i instanceof Function&&(i=i.call(t)),Util.ext(t.state,i))}});var ComponentFactory=new _ComponentFactory(DOMHelper);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props["final"]},priority:function(e){return this.types[e].props.priority},newInstanceOf:function(e,t,i,n,r){if(!this.types[e])return null;var s=null,a=null,o=n.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=n.substr(o+1);var h=s.indexOf(CMD_FILTER_DELIMITER);h>-1&&(a=s.substr(h+1),s=s.substring(0,h)),s=s.split(CMD_PARAM_DELIMITER)}var l=new this.types[e].clazz(this.baseClass,n,r,i);if(Util.ext(l,this.types[e].props),l.el=t,l.__nodes=[t],"TEMPLATE"===t.tagName){var c=[],p=t,u=t.childNodes;for(t.content&&11===t.content.nodeType&&(p=t.content,u=p.childNodes);u.length;){var d=p.removeChild(u[0]);3===d.nodeType&&d.nodeValue.trim().length<1||c.push(d)}l.__nodes=c}return s&&(l.params=s),a&&(l.filter=a),i.directives.push(l),l.component=i,"TEMPLATE"!==t.tagName&&l.__nodes[0].removeAttribute(l.name),this._super.createCbk.call(this,l,e),l}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var i=new this.types[e].clazz(this.baseClass,t);return Util.ext(i,this.types[e].props),this._super.createCbk.call(this,i,e),i}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var i=null;return this.types[e].props.singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),i=this.types[e].singleton):i=new this.types[e].clazz(this.baseClass),Util.ext(i,this.types[e].props),i.host=t,this._super.createCbk.call(this,i,e),i}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var i=new Transition(e,t,this.hooks[e]);return i}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_CMD=/x-.*/,ATTR_REF_TAG="ref",COMP_SLOT_TAG="component",PROP_TYPE_PRIFX=".",PROP_SYNC_SUFX=":sync",PROP_SYNC_SUFX_EXP=/:sync$/,EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",FILTER_EXP_SPLITTER="|",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},im_counter=0,DISPATCHERS=[],HTML_EXP_COMPILING=!1,HTML_EXP_MAP={},CURRENT_HTML_EXP_LIST=null,impex=new function(){function e(e){var i=e;do{if(t.indexOf(i)>-1)return!0;i=i.parentNode}while(i);return!1}this.global={},this.events={registerDispatcher:function(e,t){"string"==typeof e&&(e=e.split(" ")),DISPATCHERS.push([e,t])}},this.version={v:[0,56,1],state:"",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},this.logger=LOGGER},this.component=function(e,t,i){return"string"==typeof t||t.template||LOGGER.warn("can not find property 'template' of component '"+e+"'"),ComponentFactory.register(e,t,i),this},this.directive=function(e,t,i){return DirectiveFactory.register(e,t,i),this},this.service=function(e,t,i){return ServiceFactory.register(e,t,i),this},this.filter=function(e,t,i){return FilterFactory.register(e,t,i),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.unitTest=function(e,t,i){window.onload=function(){var n=component(),r=document.querySelector("template");n.template=r.innerHTML,impex.component(e,n);for(var s=document.querySelectorAll('link[rel="impex"]'),a=s.length;a--;){var o=s[a],h=o.getAttribute("type"),l=o.getAttribute("href"),c=o.getAttribute("services");c&&(c=c.split(",")),impex.component(h,l,c)}impex.render(document.querySelector(t),i)}},this.render=function(i,n,r){if(!i)return void LOGGER.error("invalid element, can not render");var s=i.tagName.toLowerCase();if(e(i))return void LOGGER.warn("element ["+s+"] has been rendered");for(var a=document.querySelectorAll('link[rel="impex"]'),o=a.length;o--;){var h=a[o],l=h.getAttribute("type"),c=h.getAttribute("href"),r=h.getAttribute("services");r&&(r=r.split(",")),impex.component(l,c,r)}var p=ComponentFactory.newInstanceOf(s,i);if(p||(t.push(i),p=ComponentFactory.newInstance([i],n)),p.onCreate){var u=null;if(Util.isArray(r)){u=[];for(var o=0;o<r.length;o++){var d=ServiceFactory.newInstanceOf(r[o],p);u.push(d)}}u?p.onCreate.apply(p,u):p.onCreate()}return p.init(),p.mount(),p};var t=[];Object.defineProperty(this,"_cs",{enumerable:!1,writable:!0,value:{}}),this.logger=LOGGER,this.util=Util,this.Component=Component,this.Signal=Signal,this.useBasicRender=function(){Util.ext(Component.prototype,{onPropChange:function(e){for(var t in e){var i=e[t],n=this.state[i.name];i.val!==n&&(this.state[i.name]=i.val)}}})}};impex.service("DOMHelper",DOMHelper),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,i,n){for(var r=e.__expNodes.length;r--;){var s=e.__expNodes[r];s.node==i&&"class"===s.attrName&&(s.origin=n)}for(var a=e.children.length;a--;)t(e.children[a],i,n)}function i(){function e(e,t){for(var i={str:{},type:{},sync:{}},n=["cache","over","step","transition"],r=e.attributes.length;r--;){var s=e.attributes[r],a=s.nodeName;if(!(n.indexOf(a)>-1)){a=a.replace(/-[a-z0-9]/g,function(e){return e[1].toUpperCase()});var o=s.nodeValue;if(a[0]===PROP_TYPE_PRIFX){var h=lexer(o),l=Renderer.evalExp(t,h),c=a.substr(1);if(PROP_SYNC_SUFX_EXP.test(c)){var p=Object.keys(h.varTree),u=c.replace(PROP_SYNC_SUFX_EXP,"");i.sync[u]=[h,l,p]}else i.type[c]=l}else i.str[a]=o}}return i}function t(e,t,i){for(var n=[],r=e;t>=r;r+=i)n.push(r);return n}function i(e,t,n){e.length<1||setTimeout(function(){for(var r=e.splice(0,50),s=0;s<r.length;s++){var a=r[s],o=a[0],h=a[1];o.__state!==Component.state.unmounted&&(t.DOMHelper.replace(h,o.__nodes),o.init(),o.mount(),n&&o.__state===Component.state.mounted&&Renderer.recurRender(o))}e.length>0?i(e,t):t.over&&t.over()},0)}this.onCreate=function(e,t){this.eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.forExp=/^\s*(\d+|[a-zA-Z_$](.+)?)\s+to\s+(\d+|[a-zA-Z_$](.+)?)\s*$/,this.DOMHelper=e,this.expInfo=this.parseExp(this.value),this.cache=[],this.__comp=this.component,this.placeholder=document.createComment("-- directive [each] placeholder --"),this.el.parentNode.replaceChild(this.placeholder,this.el),"TEMPLATE"!==this.el.tagName&&(this.__tagName=this.el.tagName.toLowerCase(),this.__isComp=ComponentFactory.hasTypeOf(this.__tagName)),this.subComponents=[],this.cacheSize=20,this.step=this.el?this.el.getAttribute("step"):this.__nodes[0].getAttribute("step"),this.over=this.el?this.el.getAttribute("over"):this.__nodes[0].getAttribute("over");var i="TEMPLATE"!==this.el.tagName?this.el.getAttribute("transition"):this.__nodes[0].getAttribute("transition");null!==i&&(this.trans=i,this.ts=t)},this.onInit=function(){var i=this;if(this.forExp.test(this.expInfo.ds)){var n=RegExp.$1,r=RegExp.$3,s=parseFloat(this.step);if(0>s)return void LOGGER.error("step <= 0 : "+s);if(s=s||1,isNaN(n)){var a=n;this.component.watch(n,function(e,n,o,h,l){isNaN(h)&&(h=this.d(a));var c=t(h>>0,r,s);i.lastDS=c,i.rebuild(c,i.expInfo.k,i.expInfo.v)}),n=this.component.d(n)}if(isNaN(r)){var a=r;this.component.watch(r,function(e,r,o,h,l){isNaN(h)&&(h=this.d(a));var c=t(n,h>>0,s);i.lastDS=c,i.rebuild(c,i.expInfo.k,i.expInfo.v)}),r=this.component.d(r)}n=parseFloat(n),r=parseFloat(r),this.ds=t(n,r,s)}else this.ds=this.component.d(this.expInfo.ds),this.component.watch(this.expInfo.ds,function(e,t,n,r,s,a,o){if(!i.ds)return i.ds=i.__comp.d(i.expInfo.ds),i.lastDS=i.ds,void i.build(i.ds,i.expInfo.k,i.expInfo.v);var h=i.__comp.d(i.expInfo.ds);i.lastDS=h,i.rebuild(i.lastDS,i.expInfo.k,i.expInfo.v)});if(this.over){var o=lexer(this.over),h=Renderer.evalExp(this.__comp,o);this.over=h}this.lastDS=this.ds,this.__props=e(this.el,this.component),this.ds&&this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy()},this.rebuild=function(e,t,n){e=this.doFilter(e);var r=0;e&&(r=e instanceof Array?e.length:Object.keys(e).length);var s=r-this.subComponents.length,a={};if(0>s){var o=-1*s,h=this.subComponents.splice(this.subComponents.length-o,o);if(this.cache.length<this.cacheSize){for(var l=h.length;l--;)this.cache.push(h[l]);for(var l=this.cache.length;l--;)this.trans&&!this.cache[l].__leaving&&this.cache[l].__state===Component.state.mounted?(this.cache[l].__leaving=!0,this.cache[l].transition.leave()):this.cache[l].unmount(!1)}else for(var l=h.length;l--;)h[l].destroy()}else if(s>0)for(var c=s;c--;){var p=this.createSubComp();a[p[0].__id]=p}var u=Util.isArray(e)?!0:!1,d=0,f=[];for(var v in e)if(e.hasOwnProperty(v)&&(!u||!isNaN(v))){var _=this.subComponents[d],m=e[v];if("object"==typeof m&&null!=m){for(var l=m.__im__extPropChain.length;l--&&m.__im__extPropChain[l][0]!==this;);m.__im__extPropChain.splice(l,1),m.__im__extPropChain.push([this,n,d])}var g=_.state;g[n]=m,g.$index=d++,t&&(g[t]=u?v>>0:v),a[_.__id]&&f.push(a[_.__id])}i(f,this,!0)},this.createSubComp=function(){for(var e=this.__comp,t=null,i=this.placeholder.parentNode,n=document.createComment("-- directive [each] component --"),r=[],s=this.__nodes.length;s--;){var a=this.__nodes[s].cloneNode(!0);r.unshift(a)}i.insertBefore(n,this.placeholder),t=this.__isComp?e.createSubComponentOf(r[0]):e.createSubComponent(r),this.subComponents.push(t);for(var o in this.__props.type){var h=this.__props.type[o];h instanceof Function&&(t[o]=h.bind(this.__comp))}for(var o in this.__props.sync){var l=this.__props.sync[o],c=l[0],p=l[1];Util.isObject(p)&&t.onPropBind&&(p=t.onPropBind(o,p));var u=l[2];u.forEach(function(i){if(!c.varTree[i].isFunc){var n=new Prop(t,o,c.varTree[i].segments,c);e.__watchProps.push(n)}}),t.state[o]=p}for(var o in this.__props.str)t.state[o]=this.__props.str[o];for(var o in this.__props.type){var h=this.__props.type[o];h instanceof Function||(Util.isObject(h)&&t.onPropBind&&(h=t.onPropBind(o,h)),t.state[o]=h)}if(this.trans){var d=this;t.onInit=function(){this.transition||(this.transition=d.ts.get(d.trans,this))},t.onMount=function(){this.transition.enter()},t.postLeave=function(){this.unmount(!1),this.__leaving=!1}}return[t,n]},this.doFilter=function(e){if(!this.filters)return e;var t=this.filters;if(Object.keys(t).length>0&&e){var i=e;Util.isObject(e)&&(i=Util.isArray(e)?[]:{},Util.ext(i,e));for(var n in t){for(var r=t[n][0],s=t[n][1],a=[],o=s.length;o--;){var h=s[o];h.varTree&&h.words&&(h=Renderer.evalExp(this.__comp,h)),a[o]=h}r.value=i,i=r.to.apply(r,a)}return i}},this.build=function(e,t,n){var r=Util.isArray(e)?!0:!1,s=0;e=this.doFilter(e),e.__im__extPropChain&&e.__im__extPropChain.push([this,n]);var a=[];for(var o in e)if(e.hasOwnProperty(o)&&(!r||!isNaN(o))){var h=this.createSubComp();a.push(h);var l=e[o];"object"==typeof l&&null!=l&&l.__im__extPropChain.push([this,n,s]);var c=h[0].state.__im__target||h[0].state;c[n]=l,c.$index=s++,t&&(c[t]=r?o>>0:o)}i(a,this)},this.parseExp=function(e){var t,i,n,r=this;return e.replace(this.eachExp,function(e,s,a,o){t=s;var h=a.replace(/\s/gm,""),l=h.split(",");if(l.length>1?(i=l[0],n=l[1]):n=l[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,r.parent);r.filters=c;for(var u in p)r.component.watch(u,function(){r.lastDS&&r.rebuild(r.lastDS,r.expInfo.k,r.expInfo.v)})}}),t?{ds:t,k:i,v:n}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{"final":!0,priority:999}),e.directive("global",{onCreate:function(){var t=this.value;return e.global[t]?void LOGGER.warn('duplicate name "'+t+'" exists in global'):void(e.global[t]=this.component)}}).directive("style",{onCreate:function(){"{"===this.value.trim()[0]&&(this.value="("+this.value+")")},onUpdate:function(e){if("string"==typeof e){for(var t={},i=e.split(";"),n=i.length;n--;)if(i[n]){var r=i[n].split(":");t[r[0]]=r[1]}e=t}var s=this.el.style;for(var a in e){var o=this.filterName(a),h=e[a];h.indexOf("!important")?(h=h.replace(/!important\s*;?$/,""),o=o.replace(/[A-Z]/gm,function(e){return"-"+e.toLowerCase()}),s.setProperty(o,h,"important")):s[o]=h}},filterName:function(e){return e.replace(/-([a-z])/gim,function(e,t){return t.toUpperCase()})}}).directive("class",{onCreate:function(){"{"===this.value.trim()[0]&&(this.value="("+this.value+")")},onUpdate:function(e){var t="";if(e instanceof Array)e.forEach(function(e){t+=" "+e});else if("string"==typeof e)t=e;else for(var i in e){var n=e[i];n&&(t+=" "+i)}this.lastClassStr&&(this.el.className=this.el.className.replace(this.lastClassStr,"")),this.el.className+=" "+t,this.lastClassStr=t}}).directive("on",{onInit:function(){for(var e=this.params.length;e--;)this.on(this.params[e],this.value)}}).directive("text",{onUpdate:function(e){this.el.innerText=e}}).directive("bind",{onInit:function(){(!this.params||this.params.length<1)&&LOGGER.warn("at least one attribute be binded")},onUpdate:function(e){if(this.params&&!(this.params.length<1)){var t=null;if(this.filter&&(t=this.component[this.filter]),t){var i=t(e);if(!Util.isUndefined(i)&&!i)return}for(var n=this.params.length;n--;){var r=this.params[n];this.el.setAttribute(r,e)}}}}).directive("show",{onCreate:function(e,t){"TEMPLATE"===this.el.tagName&&t.replace(this.el,this.__nodes);var i=this.el.getAttribute("transition");null!==i&&"TEMPLATE"!==this.el.tagName&&(this.transition=e.get(i,this)),this.lastRs=!0,this.compiled=!1},onUpdate:function(e){this.component.__state!==Component.state.unmounted&&e!==this.lastRs&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},postLeave:function(){this.exec(this.lastRs)},exec:function(e){if(e)for(var t=this.__nodes.length;t--;)this.__nodes[t].style.display="";else for(var t=this.__nodes.length;t--;)this.__nodes[t].style.display="none"}},["Transitions","DOMHelper"]).directive("if",{"final":!0,onCreate:function(e,t){this.DOMHelper=t,this.placeholder=document.createComment("-- directive [if] placeholder --");var i=this.el.getAttribute("transition");null!==i&&"TEMPLATE"!==this.el.tagName&&(this.transition=e.get(i,this)),this.lastRs=!1,this.compiled=!1,this.el.parentNode&&this.el.parentNode.replaceChild(this.placeholder,this.el)},onUpdate:function(e){e&&!this.compiled&&(Util.compileViewOf(this.component,this.__nodes),this.compiled=!0),this.elseD&&this.elseD.doUpdate(!e),this.component.__state!==Component.state.unmounted&&(e!==this.lastRs||this.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},postLeave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.__nodes[0].parentNode)return;this.DOMHelper.replace(this.placeholder,this.__nodes)}else{if(!this.__nodes[0].parentNode)return;var t=this.__nodes[0].parentNode;t.insertBefore(this.placeholder,this.__nodes[0]),this.DOMHelper.detach(this.__nodes)}}},["Transitions","DOMHelper"]).directive("else",{onCreate:function(e,t){this.DOMHelper=t,this.placeholder=document.createComment("-- directive [else] placeholder --"),this.el.parentNode.replaceChild(this.placeholder,this.el);var i=this.component.directives[this.component.directives.length-2];if("x-if"!==i.name)return void LOGGER.warn("can not find directive[x-if] to make a pair");i.elseD=this;var n=this.el.getAttribute("transition");null!==n&&"TEMPLATE"!==this.el.tagName&&(this.transition=e.get(n,this)),this.lastRs=!1,this.compiled=!1},doUpdate:function(e){e&&!this.compiled&&(Util.compileViewOf(this.component,this.__nodes),this.compiled=!0),this.component.__state!==Component.state.unmounted&&(e!==this.lastRs||this.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},postLeave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.__nodes[0].parentNode)return;this.DOMHelper.replace(this.placeholder,this.__nodes)}else{if(!this.__nodes[0].parentNode)return;var t=this.__nodes[0].parentNode;t.insertBefore(this.placeholder,this.__nodes[0]),this.DOMHelper.detach(this.__nodes)}}},["Transitions","DOMHelper"]).directive("cloak",{onCreate:function(){var e=this.el.getAttribute("class");return e?(e=e.replace("x-cloak",""),void(this.__cn=e)):void LOGGER.warn("can not find attribute[class] of element["+this.el.tagName+"] which directive[cloak] on")},onActive:function(){t(this.component,this.el,this.__cn);var e=this.el.getAttribute("class").replace("x-cloak","");this.el.setAttribute("class",e)}}).directive("model",{onActive:function(){var e=this.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=e.getAttribute("type");switch(t){case"radio":this.on("change",this.changeModel);break;case"checkbox":this.on("change",this.changeModelCheck);break;default:var i=null===document.body.onpropertychange?"propertychange":"input";this.on(i,this.changeModel)}break;case"select":var n=e.getAttribute("multiple");null!==n?this.on("change",this.changeModelSelect):this.on("change",this.changeModel)}},changeModelSelect:function(e){for(var t=e.target||e.srcElement,i=(t.value,[]),n=t.options.length;n--;){var r=t.options[n];r.selected&&i.push(r.value)}this.component.d(this.value,i)},changeModelCheck:function(e){var t=e.target||e.srcElement,i=t.value,n=this.component.d(this.value);if(n instanceof Array||(n=[n]),t.checked)n.push(i);else{var r=n.indexOf(i);r>-1&&n.splice(r,1)}},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.component.d(this.value,t)}});var n=new i;n["final"]=!0,n.priority=998,e.directive("each",n,["DOMHelper","Transitions"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.value)}}).filter("filterBy",{to:function(e,t){var i=this.value;if(!(i instanceof Array))return LOGGER.warn("can only filter array"),this.value;var n=[];if(e instanceof Function)for(var r=i.length;r--;){var s=e.call(this,i[r]);s&&n.unshift(i[r])}else for(var r=i.length;r--;){var a=i[r];t?(!e||(a[t]+"").indexOf(e)>-1)&&n.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&n.unshift(a)}return n}}).filter("limitBy",{to:function(e,t){return this.value instanceof Array?e?this.value.splice(t||0,e):this.value:(LOGGER.warn("can only filter array"),this.value)}}).filter("orderBy",{to:function(e,t){return e||t?this.value instanceof Array?(this.value.sort(function(t,i){var n=e?t[e]:t,r=e?i[e]:i;return"string"==typeof n?n.localeCompare(r):"number"==typeof n?n-r:(n+"").localeCompare(r)}),"desc"===t&&this.value.reverse(),this.value):(LOGGER.warn("can only filter array"),this.value):this.value}}),!function(e){var t=self.navigator.userAgent.toLowerCase(),i=t.indexOf("android")>0?!0:!1,n=t.indexOf("iphone")>0?!0:!1,r=t.indexOf("ipad")>0?!0:!1,s=t.indexOf("windows phone")>0?!0:!1,a=n||r||i||s;if(a){var o=new Dispatcher({onInit:function(){this.inited||(document.addEventListener("touchstart",this.doStart.bind(this),!0),document.addEventListener("touchmove",this.doMove.bind(this),!0),document.addEventListener("touchend",this.doEnd.bind(this),!0),document.addEventListener("touchcancel",this.doCancel.bind(this),!0),this.inited=!0,this.lastTapTime=0,this.FLING_INTERVAL=200)},doStart:function(e){this.dispatch("touchstart",e),this.dispatch("pointerdown",e);var t=this;this.timer=setTimeout(function(){t.dispatch("press",e)},800),this.hasMoved=!1,this.canceled=!1;var i=e.touches[0];this.fling_data={x:i.clientX,y:i.clientY,t:Date.now()}},doMove:function(e){clearTimeout(this.timer),this.dispatch("touchmove",e),this.dispatch("pointermove",e),this.hasMoved=!0},doCancel:function(e){clearTimeout(this.timer),this.canceled=!0,this.dispatch("touchcancel",e),this.dispatch("pointercancel",e)},doEnd:function(e){if(clearTimeout(this.timer),this.dispatch("touchend",e),this.dispatch("pointerup",e),!this.canceled)if(this.hasMoved){var t=e.changedTouches[0],i=t.clientX,n=t.clientY,r=this.fling_data,s=r.x,a=r.y,o=r.t,h=Date.now()-o,l=Math.sqrt((i-s)*(i-s)+(n-a)*(n-a))>>0;if(h<=this.FLING_INTERVAL&&l>20){var c=Math.atan2(n-a,i-s),p={slope:c,interval:h,distance:l};this.dispatch("fling",e,p)}}else this.dispatch("tap",e),Date.now()-this.lastTapTime<300&&this.dispatch("dbltap",e),this.lastTapTime=Date.now()}});e.events.registerDispatcher("touchstart touchend touchcancel touchmove flingpointerdown pointerup pointermove pointercancel press tap dbltap",o)}else{var h=new Dispatcher({listeningEventMap:{},onInit:function(){if(!this.inited){document.addEventListener("mousedown",this.doMousedown.bind(this),!0),document.addEventListener("mousemove",this.doMousemove.bind(this),!0),document.addEventListener("mouseup",this.doMouseup.bind(this),!0),window.addEventListener("blur",this.doMouseCancel.bind(this),!0);var e=null==document.body.onmousewheel?"mousewheel":"DOMMouseScroll";document.addEventListener(e,this.doMousewheel.bind(this),!0),document.addEventListener("mouseout",this.doMouseout.bind(this),!0),this.inited=!0,this.lastClickTime=0}},doMousedown:function(e){this.dispatch("mousedown",e),this.dispatch("pointerdown",e);var t=this;this.timer=setTimeout(function(){t.dispatch("press",e)},800)},doMousemove:function(e){clearTimeout(this.timer),this.dispatch("mousemove",e),
this.dispatch("pointermove",e)},doMouseup:function(e){clearTimeout(this.timer),this.dispatch("mouseup",e),this.dispatch("pointerup",e),0===e.button&&(this.dispatch("click",e),this.dispatch("tap",e),Date.now()-this.lastClickTime<300&&(this.dispatch("dblclick",e),this.dispatch("dbltap",e)),this.lastClickTime=Date.now())},doMouseCancel:function(e){clearTimeout(this.timer),this.dispatch("pointercancel",e)},doMouseout:function(e){this.dispatch("mouseout",e);var t=e.target,i=this.__eventMap.mouseleave;if(i)do{if(this.fireMouseleave(t,i,e)===!1)break;t=t.parentNode}while(t.tagName&&"HTML"!=t.tagName)},fireMouseleave:function(e,t,i){for(var n=t.length;n--&&t[n].el!==e;);if(!(0>n)){var r=e,s=i.target;if(this.contains(r,s)){var a=i.toElement||i.relatedTarget;if(!this.contains(r,a))return this.fireEvent(e,t,i,"mouseleave")}}},contains:function(e,t){if(e.contains)return e.contains(t);do{if(e==t)return!0;t=t.parentNode}while(t&&"BODY"!=t.tagName);return!1},doMousewheel:function(e){this.dispatch("mousewheel",e)}});e.events.registerDispatcher("mousedown mouseup click dblclick mousemove mousewheel mouseout mouseleavepointerdown pointerup pointermove pointercancel press tap dbltap",h)}}(impex),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);