/*
 * impexjs is a powerful web application engine to build 
 * reactive webUI system
 *
 *
 * Copyright 2015-2016 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://impexjs.org
 * last build: 2016-11-14
 */
!function(global){"use strict";function ExpData(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function Change(e,t,i,n,r,s){this.name=e,this.newVal=t,this.oldVal=i,this.path=n,this.type=r,this.object=s,this.expProps=[]}function ExpNode(e,t,i,n,r,s){this.node=e,this.attrName=t,this.origin=i,this.expMap=n,this.component=r,this.toHTML=s,this.id=Math.random()}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,i){this.cbk=e,this.ctrlScope=t,this.segments=i}function Prop(e,t,i,n,r,s){this.subComp=e,this.name=t,this.segments=i,this.expWords=n,this.oldVal=r,this.fromPropKey=s}function Component(e){var t="C_"+im_counter++;this.__id=t,this.__state=Component.state.created,this.view=e,this.refs={},this.props={},this.propTypes=null,this.name,this.parent,this.children=[],this.__expNodes=[],this.__expDataRoot=new ExpData,this.__expWithProps={"*":[]},this.__watchWithProps={"*":[]},this.__directiveWithProps={"*":[]},this.__eventMap={},this.__watchProps=[],this.directives=[],this.template,this.__url,this.restrict,this.data={},this.events={},impex._cs[this.__id]=this}function broadcast(e,t,i){for(var n=0;n<e.length;n++){var r=e[n],s=r.__eventMap[t],a=!0;if(s){a=!1;for(var o=0;o<s.length;o++)a=s[o].apply(r,i)}a&&r.children.length>0&&broadcast(r.children,t,i)}}function View(e,t,i,n){this.el=e,this.__nodes=i,this.__evMap={},this.__target=t,this.__placeholder=n||t,this.refs={}}function tmplExpFilter(e,t,i){return e=e.replace(REG_TMPL_EXP,function(e,i){var i=i.replace(/\s/gm,"");return"CONTENT"===i?t||"":""})}function Directive(e,t){this.value=t,this.name=e,this.params,this.filter,this.component,this.view,this["final"]=!1,this.endTag=null,this.priority=0}function Filter(e){this.component=e,this.value,this.onCreate}function Service(){this.singleton,this.host,this.onCreate}function Transition(e,t,i){if(TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE)),i&&i.css===!1)this.__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var n=window.getComputedStyle(TESTNODE,null),r=n["transition-duration"].split(","),s=n["transition-delay"].split(","),a=-1,o=r.length;o--;){var h=parseFloat(r[o]),l=parseFloat(s[o]);h+l>a&&(a=h+l)}if(a>0){var c=t.view,p=null,_=null;t instanceof Directive?(p=t.component.__expNodes,_=t.component):(p=t.__expNodes,_=t),p.length<1&&_.parent&&(p=_.parent.__expNodes);for(var o=p.length;o--;){var u=p[o];"class"===u.attrName&&(u.origin+=" "+e+"-transition")}c.addClass(e+"-transition"),this.__longest=a;var d=null;for(var v in TRANSITIONS)if(void 0!==c.el.style[v]){d=TRANSITIONS[v];break}c.el.addEventListener(d,this.__done.bind(this),!1),this.__css=!0}}this.__direct=t,this.__view=c,this.__hook=i||{},this.__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function i(){if(0===this.status||this.status>=200&&this.status<300||304===this.status){var e=this.responseText;n.innerHTML=e;var t=n.querySelector("template").innerHTML,i=n.querySelector('script[type="javascript/impex-component"]').innerHTML;i=window.eval(i),this.cbk([t,i])}}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype._super=t.prototype},this.ext=function(e,t){for(var i=Object.keys(t),n=i.length;n--;){var r=i[n];e[r]=t[r]}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var n=document.createElement("div");this.isDOMStr=function(e){return n.innerHTML=e,n.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName},this.loadComponent=function(n,r,s){var a=new XMLHttpRequest;a.open("get",n,!0),a.timeout=s||5e3,a.ontimeout=t,a.onerror=e,null===a.onload?a.onload=i:a.onreadystatechange=i,a.cbk=r,a.url=n,a.send(null)}},Observer=null;window.Proxy&&!function(){function e(e,t,i){isNaN(t)||(e[t>>0]=i)}function t(e,t){isNaN(t)||e.splice(t,1)}function i(e,t,n,r){if(n&&n.__im__propChain)return n;var s=n instanceof Array?[]:{};for(var a in n){var o=n[a];if("object"==typeof o){var h=t.concat();h.push(a);var l=i(e,h,o,r);s[a]=l}else s[a]=o}Object.defineProperty(s,"__im__propChain",{enumerable:!1,writable:!1,value:t}),Object.defineProperty(s,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]});var c=new Proxy(s,e);Object.defineProperty(c,"__im__target",{enumerable:!1,writable:!1,value:s});var p=Date.now()+Math.random();return Object.defineProperty(s,"__im__oid",{enumerable:!1,writable:!1,value:p}),c}Observer={observe:function(n,r){if(n&&n.__im__propChain)return n;var s={comp:r,set:function(t,n,r){var s=!(n in t),a=t[n],o=r;if(a===o)return!0;if("object"==typeof o){var h=t.__im__propChain.concat();h.push(n),o=i(this,h,o,this.comp)}t instanceof Array?e(t,n,o):t[n]=o;var l=t.__im__propChain,c=t.__im__extPropChain,p={object:t,name:n,pc:l,xpc:c,oldVal:a,newVal:o,comp:this.comp,type:s?"add":"update"};return ChangeHandler.handle(p),!0},deleteProperty:function(e,i){var n=e[i];e instanceof Array?t(e,i):delete e[i];var r=e.__im__propChain,s=e.__im__extPropChain,a={object:e,name:i,pc:r,xpc:s,oldVal:n,comp:this.comp,type:"delete"};return ChangeHandler.handle(a),!0}};return i(s,[],n,r)}}}(),!window.Proxy&&!function(){function e(e){return this.__im__innerProps[e]}function t(e,t){var n=this.__im__innerProps[e];if(r(n),"object"==typeof t){var a=this.__im__propChain.concat();a.push(e),t=i(a,t,this.__im__comp)}this.__im__innerProps[e]=t;this.__im__propChain,this.__im__extPropChain;s([{name:e,target:this,oldVal:n,newVal:t,type:"update"}],!0)}function i(n,r,s){if(r&&r.__im__propChain)return r;var o=r instanceof Array?[]:{};Object.defineProperty(o,"__im__innerProps",{enumerable:!1,writable:!0,value:{}});var h={},l={};for(var c in r)if(r.hasOwnProperty(c)){var p=r[c];if("object"==typeof p){var _=n.concat();_.push(c);var u=i(_,p,s);o.__im__innerProps[c]=u}else o.__im__innerProps[c]=p;l[c]=p,!function(i){h[i]={get:function(){return e.call(this,i)},set:function(e){t.call(this,i,e)},enumerable:!0,configurable:!0}}(c)}Object.defineProperties(o,h),Object.defineProperty(o,"__im__propChain",{enumerable:!1,writable:!1,value:n}),Object.defineProperty(o,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]}),Object.defineProperty(o,"__im__target",{enumerable:!1,writable:!1,value:o.__im__innerProps}),Object.defineProperty(o,"__im__comp",{enumerable:!1,writable:!1,value:s});var d=Date.now()+Math.random();return Object.defineProperty(o,"__im__oid",{enumerable:!1,writable:!1,value:d}),a.push({snap:l,now:o,id:d}),o}function n(){o(function(){for(var e=a.length;e--;){var t=a[e],i=t.snap,r=t.now,o=(t.id,[]);for(var h in i)if(!(h in r)){var l={};l.name=h,l.target=r,l.oldVal=i[h],l.snap=i,l.type="delete",l.id=o.push(l)}for(var h in r)if(!(h in i)){var l={};l.name=h,l.target=r,l.newVal=r[h],l.snap=i,l.type="add",o.push(l)}o.length>0&&s(o)}n()})}function r(e){for(var t=null,i=a.length;i--&&(t=a[i],t.id!==e.__im__oid););i>-1&&(a.splice(i,1),"object"==typeof t&&r(t))}function s(n,s){for(var a=n.length;a--;){var o=n[a],h=o.name,l=o.target,c=l.__im__propChain,p=l.__im__extPropChain,_=l.__im__comp,u=o.oldVal,d=o.newVal,v=o.type,f=o.snap;if("add"===v){if(f[h]=d,l.__im__innerProps[h]=d,"object"==typeof d){var m=c.concat();m.push(h),l.__im__innerProps[h]=i(m,d,_)}!function(i,n){Object.defineProperty(n,i,{get:function(){return e.call(this,i)},set:function(e){t.call(this,i,e)},enumerable:!0,configurable:!0})}(h,l)}else if("delete"===v){var g=f[h];"object"==typeof g&&r(g),delete f[h]}else if(!s){console.log("无效update");continue}var y={object:l,name:h,pc:c,xpc:p,oldVal:u,newVal:d,comp:_,type:v};ChangeHandler.handle(y)}}var a=[],o=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self);Observer={},Observer.observe=function(e,t){return e&&e.__im__propChain?e:i([],e,t)},n()}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,r){if(o.test(e)){var s=n(r,t);return c="var",s}return a.test(e)?(c="str",i(t,RegExp.$1)):(c="",e)}function i(e,t){for(var i=!1,n=t,r=1;r<e.length;r++){var s=e[r];if("\\"!==s){if(!i&&s===t)return n+t;n+=s,i=!1}else i=!0,n+=s}}function n(i,r,s,a){for(var c="",p=[],_=-1,u=-1,d=-1,v=a||e(),f=0;f<r.length;f++){var m=r[f];if(p.length>0)if(o.test(m)){var g=e(),y=n(i,r.substr(f),!0,g);f=f+y.length-1;var w=y;o.test(y[0])&&l.indexOf(w)<0&&(v.subVars["."+y]=g,l.indexOf(w)<0&&(w=["."+w])),v.words.push(w)}else if("]"===m||")"===m){if(p.pop(),0===p.length){var b=r.substring(_,f+1);c+=b,v.segments.push(b),d=f}")"===m&&(v.isFunc=!0),v.words.push(m),u=f}else{var x=t(m,r.substr(f),i);f=f+x.length-1,v.words.push(x),u=f}else if(h.test(m)){if(c+=m,"."===m){var w=c.substr(d+1);w=w.replace(/\./,""),w&&(v.segments.push(w),d=f)}}else{if("["!==m&&"("!==m){if("]"!==m&&")"!==m||!s){var w=c.substr(u+1);w&&("."!==w[0]&&l.indexOf(w)<0&&(w=["."+w]),v.words.push(w));var E=c.substr(d+1);return E&&(v.segments.push(E),d=f),!s&&l.indexOf(w)<0&&(i["."+c]=v),c}var w=c;if(w[w.length-1]!==m){w=w.substring(u+1,w.length),w&&v.words.push(0===r.indexOf(w)?["."+w]:w);var C=w.lastIndexOf(".");C>0&&(w=w.substr(C)),w&&v.segments.push(w),d=f}return u=f,c}p.push(m),_=f,v.brakLength++;var T=c.substr(u+1);if(T){var w=T;l.indexOf(T)<0&&0>u&&(w=["."+T]),v.words.push(w)}v.words.push(m);var O="["===m?"]":")";if(c[f-1]!==O){var P=T.lastIndexOf(".");P>-1?(T=T.substr(P),v.segments.push(T)):T&&v.segments.push(T),d=f}u=f}}var R=c.substr(c.lastIndexOf("]")+1),N=c.substr(c.lastIndexOf(")")+1);if(R&&N){var F=R.length<N.length?R:N,E=c.substr(d+1);v.segments.push(E);var w="["===F[0]||"("===F[0]?F:"."===F[0]?F:"."+F;v.words.length<1&&l.indexOf(w)<0&&(w=[w]),v.words.push(w)}return s||(i["."+c]=v),c}function r(e){for(var t in e){var i=e[t],n=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,i.brakLength);var h="]"===t[t.length-1]?"[":"(",l=i.brakLength;i.watchPathWords=[];for(var c=0;c<i.words.length;c++){var p=i.words[c];if(p===h&&--l<1)break;i.watchPathWords.push(p)}}else i.watchPathWords=i.words.concat(),i.watchPathWords.splice(-1,1);n=t.substr(o),i.lastVar="("===n[0]?t:n,Object.keys(i.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),i.watchPath=a);for(var c=i.segments.length;c--;)i.segments[c]=i.segments[c].replace(/^\.|\.$/g,"");r(i.subVars)}}function s(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(("["===n||"("===n)&&--t<1)return i}}var a=/(['"])/,o=/[a-zA-Z$_]/,h=/[a-zA-Z$_0-9.]/,l=["as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var i=[],n={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),n);switch(s=s+o.length-1,c){case"var":i.push(l.indexOf(o)<0?["."+o]:o);break;case"str":case"":i.push(o)}}return r(n),p[e]={words:i,varTree:n},p[e]}}(),Scanner=new function(){function e(e){var i=[],n=[];t(e,i);for(var r=i.length;r--;){var e=i[r],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,i){var n=s.substring(o,i);n&&a.push(n),a.push(e),o=i+e.length});var h=s.substring(o,s.length);if(h&&a.push(h),a.length<2)n.unshift(null);else{for(var l=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);l.appendChild(p)}n.unshift(l)}}for(var c=i.length;c--;){var _=i[c];n[c]&&n[c].childNodes.length>1&&_.parentNode&&_.parentNode.replaceChild(n[c],_)}}function t(e,i){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var n=0,r=e.childNodes.length;r>n;n++)t(e.childNodes[n],i)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;i.push(e)}}function i(e){if(e.restrict)return e;for(var t=e.parent;t;){if(t.name&&t.restrict)return t;t=t.parent}return null}function n(e,t){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var s=e.tagName.toLowerCase(),a=[],o=e.attributes.length;o--;){var h=e.attributes[o];a.push([h.name,h.value])}for(var l=[],o=a.length;o--;){var c=a[o][0];if(0===c.indexOf(CMD_PREFIX)){var p=c.replace(CMD_PREFIX,""),_=p.indexOf(CMD_PARAM_DELIMITER);_>-1&&(p=p.substring(0,_)),DirectiveFactory.hasTypeOf(p)&&(DirectiveFactory.isFinal(p)||DirectiveFactory.hasEndTag(p))&&l.push([p,a[o],DirectiveFactory.priority(p)||0])}}if(l.length>0){l.sort(function(e,t){return t[2]-e[2]});var p=l[0][0],u=l[0][1];if(DirectiveFactory.isFinal(p))return void DirectiveFactory.newInstanceOf(p,e,t,u[0],u[1]);if(DirectiveFactory.hasEndTag(p))return[p,u[1]]}if(ComponentFactory.hasTypeOf(s)){var d=i(t);if(d&&d.restrict.children){var v=d.restrict.children.split(",");if(v.indexOf(s)<0)return}var f=ComponentFactory.getRestrictOf(s);if(f&&f.parents){var m=f.parents.split(",");if(m.indexOf(d.name)<0)return}{t.createSubComponentOf(s,e)}return}for(var o=a.length;o--;){var g=a[o][0],y=a[o][1];if(REG_CMD.test(g)){var p=g.replace(CMD_PREFIX,""),_=p.indexOf(CMD_PARAM_DELIMITER);_>-1&&(p=p.substring(0,_)),DirectiveFactory.hasTypeOf(p)&&DirectiveFactory.newInstanceOf(p,e,t,g,y)}else":"===g[0]?DirectiveFactory.newInstanceOf("on",e,t,g,y):REG_EXP.test(y)&&r(y,t,e,g)}}if(e.childNodes.length>0){for(var w=null,b=[],o=0,x=e.childNodes.length;x>o;o++)if(w){b.push(e.childNodes[o]);var E=DirectiveFactory.hasEndTag(w[0]),h=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+E);Util.isString(h)&&(DirectiveFactory.newInstanceOf(w[0],b,t,CMD_PREFIX+w[0],w[1]),w=null,b=[])}else w=n(e.childNodes[o],t),w&&b.push(e.childNodes[o]);w&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+w[0]+"]")}}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,t,e)}}function r(e,t,i,n){var r=s(e,t,i,n);return r&&t.__expNodes.push(r),r}function s(e,t,i,n){var r={},s=!n&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);return s&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,i){var n={},s=1,o=null;FILTER_EXP.test(i)&&(o=a(lexer(RegExp.$1),n,t),s=i.indexOf(FILTER_EXP_START_TAG));var h=i;s>1&&(h=i.substring(0,s));var l=lexer(h);o&&Util.ext(l.varTree,o),r[i]={words:l.words,varTree:l.varTree,filters:n}}),Object.keys(r).length<1?void 0:new ExpNode(i,n,e,r,t,s)}function a(e,t,i){for(var n=[],r=null,s=!1,a={},o=[],h=e.words,l=0;l<h.length;l++)if(h[l]instanceof Array)for(var c=h[l][0],p=c.split("."),_=1;_<p.length;_++)o.push([p[_]]);else o.push(h[l]);for(var l=0;l<o.length;l++){var c=o[l];switch(c){case":":s=!0,null!==r&&n.push(r),r="";break;case".":s=!1,null!==r&&n.push(r),r="",n=[];break;default:if(c instanceof Array){var u=c[0],d=u.toLowerCase();if(!s&&d&&FilterFactory.hasTypeOf(d))r=null,t[d]=[FilterFactory.newInstanceOf(d,i),n];else{var p=lexer(u);Util.ext(a,p.varTree),n.push(p),r=null}}else{if(!s||!c.replace(/\s+/,""))continue;r+=c.replace(/^['"]|['"]$/g,"")}}}return r&&n.push(r),a}this.scan=function(t,i){for(var r=t.__nodes?t.__nodes:[t.el],s=null,a=[],o=0,h=r.length;h>o;o++)if(e(r[o]),s){a.push(r[o]);var l=DirectiveFactory.hasEndTag(s[0]),c=r[o].getAttribute&&r[o].getAttribute(CMD_PREFIX+l);Util.isString(c)&&(DirectiveFactory.newInstanceOf(s[0],a,i,CMD_PREFIX+s[0],s[1]),s=null,a=[])}else s=n(r[o],i),s&&a.push(r[o]);s&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")},this.getExpNode=s,this.parseFilters=a},Builder=new function(){function e(e){for(var i=e.__expNodes.length;i--;){var n=e.__expNodes[i];for(var r in n.expMap){var s=n.expMap[r],a=s.varTree;for(var o in a){var h=a[o];t(e,h,n)}}}}function t(e,n,r){for(var s in n.subVars){var a=n.subVars[s];t(e,a,r)}if("this"===n.segments[0]&&"props"===n.segments[1]){var o=n.segments[2];if(!o)return;return void("["===o[0]?r instanceof ExpNode?e.__expWithProps["*"].push(r):r instanceof AttrObserveNode?e.__directiveWithProps["*"].push(r):r instanceof Watch&&e.__watchWithProps["*"].push(r):r instanceof ExpNode?(e.__expWithProps[o]||(e.__expWithProps[o]=[]),e.__expWithProps[o].push(r)):r instanceof AttrObserveNode?(e.__directiveWithProps[o]||(e.__directiveWithProps[o]=[]),e.__directiveWithProps[o].push(r)):r instanceof Watch&&(e.__watchWithProps[o]||(e.__watchWithProps[o]=[]),e.__watchWithProps[o].push(r)))}for(var h=i(e.__expDataRoot.subProps,n.segments[0],r),l=1;l<n.segments.length;l++)h=i(h.subProps,n.segments[l],r)}function i(e,t,i){var n=e[t];return n||(n=e[t]=new ExpData(t)),i instanceof ExpNode?n.expNodes.indexOf(i)<0&&n.expNodes.push(i):i instanceof AttrObserveNode?n.attrObserveNodes.indexOf(i)<0&&n.attrObserveNodes.push(i):i instanceof Watch&&n.watchs.indexOf(i)<0&&n.watchs.push(i),e[t]}this.buildExpModel=t,this.build=function(t){e(t)}},ChangeHandler=new function(){function e(e){for(var t=s.length;t--;){var i=s[t];if(i.object.__im__oid===e.object.__im__oid&&i.name===e.name)break}t>-1?s.splice(t,1,e):s.push(e)}function t(e,t,n,r,s,o,h){var l=[];if(h[0]instanceof Directive){var c=void 0===h[2]?s:h[2];n=h[0].subComponents[parseInt(c)],l.push(h[1]),Util.isUndefined(h[2])&&n instanceof Component&&(n.data.__im__target[h[1]]=e)}else l=h.concat(),Util.isArray(o)||l.push(s);if(n){a[n.__id]||(a[n.__id]={changes:[],comp:n});var p=new Change(s,e,t,l,r,o);a[n.__id].changes.push(p),i(n,l,p)}}function i(e,t,i){for(var r,s=e.__expDataRoot.subProps,a=!1,h=0;h<t.length;h++){var l=t[h];if(o.test(Object.keys(s).join(","))){a=!0;break}{if(!s[l])break;r=s[l],s=s[l].subProps}}if(r){var c=[];if(a)for(var p=t.length-h-1,_=Object.keys(r.subProps),h=_.length;h--;){var u=_[h];("["===u[0]||u===l)&&n(r.subProps[u],p,c)}else c.push(r);for(var h=c.length;h--;){var r=c[h];i.expProps.push(r)}}}function n(e,t,i){if(1>t)return void i.push(e);for(var r in e.subProps)n(e.subProps[r],t-1,i)}var r=!1,s=[],a={};this.handle=function(i){r?e(i):(s=[],a={},r=!0,s.push(i),setTimeout(function(){r=!1,s.forEach(function(e){var i=e.newVal,n=e.oldVal,r=e.pc,s=e.xpc,a=e.comp,o=e.type,h=e.name,l=e.object;t(i,n,a,o,h,l,r),s.forEach(function(e){t(i,n,a,o,h,l,e)})});for(var e in a)a[e].comp.__update(a[e].changes)},20))};var o=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNodes(e){for(var t={},i=e.length;i--;){var n=e[i],r=null;if(t[n.origin]&&t[n.origin].comp===n.component?r=t[n.origin].val:(r=calcExpNode(n),t[n.origin]={comp:n.component,val:r}),n.toHTML){var s=renderHTML(n,r,n.node,n.component);if(s)continue}null!==r&&updateDOM(n.node,n.attrName,r)}}function updateDOM(e,t,i){if(e.setAttribute){e.setAttribute(t,i);var n=propMap[t];n&&n.indexOf(e.tagName)>-1&&(e[t]=i)}else e.parentNode&&(e.nodeValue=i)}function clone(e){if(null===e)return null;var t=e;if(e instanceof Array){t=e.concat();for(var i=t.length;i--;)t[i]=clone(t[i])}else if(Util.isObject(e)){t={};var n=Object.keys(e);if(n.length>0)for(var i=n.length;i--;){{var r=n[i];e[r]}0!==r.indexOf("__im__")&&(t[r]="object"==typeof e[r]?clone(e[r]):e[r])}}return t}function calcExpNode(e){var t=e.component,i=e.origin,n=e.expMap,r={};for(var s in n){var a=n[s],o=evalExp(t,a),h=a.filters;if(Object.keys(h).length>0){o&&Util.isObject(o)&&(o=clone(o));for(var l in h){for(var c=h[l][0],p=h[l][1],_=[],u=p.length;u--;){var d=p[u];d.varTree&&d.words&&(d=Renderer.evalExp(t,d)),_[u]=d}c.value=o,o=c.to.apply(c,_)}}r[s]=void 0===o?"":o}for(var l in r)i=i.replace(EXP_START_TAG+l+EXP_END_TAG,r[l]+"");return i}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var i=t.varTree,n={};for(var r in i){var s=i[r],a=buildVarPath(e,s,r);n[r]=a}var o=joinExpStr(t.words,n);return o}function joinExpStr(e,t){for(var i="",n=0;n<e.length;n++){var r=e[n];i+=r instanceof Array?t[r[0]]:r}return i}function keyWordsMapping(e,t){return 0===e.indexOf(".this")?e.replace(".this",t.__getPath()):void 0}function buildVarPath(e,t,i){var n={};for(var r in t.subVars){var s=t.subVars[r],a=buildVarPath(e,s,r);n[r]=a}for(var o=!1,h="",l=0;l<t.words.length;l++){var c=t.words[l];if(c instanceof Array){if(n[c[0]]){h+=n[c[0]];continue}var p=keyWordsMapping(c[0],e);p?(o=!0,h+=p):h+=c[0]}else h+=c}var _="";if(t.watchPath)_=t.watchPath;else for(var l=0;l<t.watchPathWords.length;l++){var c=t.watchPathWords[l];_+=c instanceof Array?n[c[0]]||c[0]:c}if(o||0===h.indexOf("impex._cs"))return h;var u=")"===i[i.length-1]?!1:!0,d=_||h;return d=u?".data"+d:"."+d.substr(1),e=varInComponent(e,d),e?(h=u?".data"+h:"."+h.substr(1),e.__getPath()+h):"self"+h}function varInComponent(e,t){return void 0!==getVarByPath(t,e.__getPath())?e:null}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,i,n){if(Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;")),e.__lastVal!==t&&3==i.nodeType){if(!e.__placeholder){var r=document.createComment("-- [html] placeholder --");i.parentNode.insertBefore(r,i),e.__lastVal=t,e.__placeholder=r,i.parentNode.removeChild(i)}e.__lastView&&e.__lastView.__destroy();var s=document.createComment("-- [html] target --");e.__placeholder.parentNode.insertBefore(s,e.__placeholder);var a=DOMViewProvider.compile(t,s),o=1===a.length&&1===a[0].nodeType?a[0]:null,h=null;a.length>0&&(h=new View(o,s,a),h.__display()),e.__lastView=h,e.__lastVal=t,h&&Scanner.scan(h,n),Builder.build(n),Renderer.render(n);for(var l=n.children.length;l--;)n.children[l].init();for(var l=n.directives.length;l--;)n.directives[l].init();for(var l=0;l<n.children.length;l++)n.children[l].templateURL||n.children[l].display();for(var l=n.directives.length;l--;)n.directives[l].active();return!0}}this.render=function(e){renderExpNodes(e.__expNodes)},this.recurRender=function(e){var t=e.children;renderExpNodes(e.__expNodes);for(var i=t.length;i--;)Renderer.render(t[i])},this.renderExpNodes=renderExpNodes;var propMap={value:["INPUT"]};this.calcExpNode=calcExpNode,this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};Component.state={created:"created",inited:"inited",displayed:"displayed",suspend:"suspend"},Util.ext(Component.prototype,{d:function(path,val){if(!path)return void LOGGER.warn("invalid path '"+path+"'");var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}return this}try{return eval(evalStr)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}},on:function(e,t){var i=this.__eventMap[e];i||(i=this.__eventMap[e]=[]),i.push(t)},emit:function(){for(var e=arguments[0],t=[this],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=this.parent;setTimeout(function(){for(;n;){var i=n.__eventMap[e];if(i){for(var r=!0,s=0;s<i.length;s++)r=!i[s].apply(n,t);if(r)return}n=n.parent}},0)},broadcast:function(){for(var e=arguments[0],t=[this],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=this;setTimeout(function(){broadcast(n.children,e,t)},0)},watch:function(e,t){var i=lexer(e),n=Object.keys(i.varTree);if(!(n.length<1)){if(n.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var r=i.varTree[n[0]],s=new Watch(t,this,r.segments);return Builder.buildExpModel(this,r,s),this}},add:function(e){this.children.push(e),e.parent=this},createSubComponentOf:function(e,t,i){var n=ComponentFactory.newInstanceOf(e,t.__nodes?t.__nodes[0]:t,i&&i.__nodes?i.__nodes[0]:i);return this.children.push(n),n.parent=this,n},createSubComponent:function(e,t){var i=ComponentFactory.newInstance(e,t&&t.__nodes[0]);return this.children.push(i),i.parent=this,i},init:function(){if(this.__state===Component.state.created){if(this.__url){var e=this;Util.loadComponent(this.__url,function(t){var i=t[0];ComponentFactory.register(e.name,t[1]),e.template=i,e.view.__init(i,e),e.__url=null,e.__init(i),e.display()})}else{if(this.template){var t=this.view.__init(this.template,this);if(t===!1)return}this.__init(this.template)}return this}},__init:function(e){Scanner.scan(this.view,this),LOGGER.log(this,"inited"),ComponentFactory.initInstanceOf(this),this.data=Observer.observe(this.data,this),Builder.build(this),this.__state=Component.state.inited,this.onInit&&this.onInit(e);for(var t=this.children.length;t--;)this.children[t].init();for(var t=this.directives.length;t--;)this.directives[t].init()},display:function(){if(this.__state!==Component.state.displayed&&this.__state!==Component.state.created){this.view.__display(this),Renderer.render(this),this.view.__nodes.forEach(function(e){if(e.querySelectorAll)for(var t=e.querySelectorAll("*["+ATTR_REF_TAG+"]"),i=t.length;i--;){var n=t[i];this.view.refs[n.getAttribute(ATTR_REF_TAG)]=n}},this),this.__state=Component.state.displayed,LOGGER.log(this,"displayed");for(var e=0;e<this.children.length;e++)this.children[e].templateURL||this.children[e].display();for(var e=this.directives.length;e--;)this.directives[e].active();this.onDisplay&&this.onDisplay()}},destroy:function(){if(null!==this.__state){if(LOGGER.log(this,"destroy"),this.onDestroy&&this.onDestroy(),this.parent){var e=this.parent.children.indexOf(this);e>-1&&this.parent.children.splice(e,1),this.parent=null}for(this.view.__destroy(this);this.children.length>0;)this.children[0].destroy();for(var e=this.directives.length;e--;)this.directives[e].destroy();this.view=this.children=this.directives=this.__expNodes=this.__expDataRoot=null,impex._cs[this.__id]=null,delete impex._cs[this.__id],this.__state=this.__id=this.templateURL=this.template=this.restrict=this.events=this.data=null}},suspend:function(e){(this instanceof Directive||this.__state===Component.state.displayed)&&(LOGGER.log(this,"suspend"),this.view.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.__state=Component.state.suspend)},__getPath:function(){return'impex._cs["'+this.__id+'"]'},__update:function(e){for(var t=!0,i=[],n=[],r=[],s=[],a=e.length;a--;){var o=e[a],h={name:o.name,newVal:o.newVal,oldVal:o.oldVal,type:o.type,path:o.path,object:o.object};i.push(h);for(var l=o.expProps,c=l.length;c--;){for(var p=l[c].expNodes,_=p.length;_--;){var u=p[_];n.indexOf(u)<0&&n.push(u)}for(var d=l[c].attrObserveNodes,_=d.length;_--;){var v=d[_];s.indexOf(v)<0&&s.push(v)}for(var f=l[c].watchs,_=f.length;_--;){var m=f[_];r.indexOf(m)<0&&r.push([m,h])}}}this.onUpdate&&(t=this.onUpdate(i)),t!==!1&&Renderer.renderExpNodes(n),this.__updateDirective(s),this.__callWatchs(r),this.__updateChildrenProps(i)},__updateChildrenProps:function(e){for(var t={},i=e.length;i--;){var n=e[i],r=n.path;this.__watchProps.forEach(function(e){var i=this.__isVarMatch(e.segments,r);if(i){t[e.subComp.__id]||(t[e.subComp.__id]=[]);var n=Renderer.evalExp(this,e.expWords);t[e.subComp.__id].push({name:e.name,oldVal:e.oldVal,newVal:n}),e.oldVal=n}},this)}for(var s in t){var a=t[s];impex._cs[s].__propChange&&impex._cs[s].__propChange(a)}},__isVarMatch:function(e,t){if(e.length<t.length)return!1;for(var i=0;i<e.length&&t[i];i++)if("["!==e[i][0]&&"["!==t[i][0]&&e[i]!==t[i])return!1;return!0},__callWatchs:function(e){for(var t=[],i=e.length;i--;){var n=e[i][1],r=e[i][0],s=n.path,a=n.newVal,o=n.oldVal,h=n.name,l=n.object,c=n.type;if(!(r.segments.length<s.length||t.indexOf(r)>-1)){var p=this.__isVarMatch(r.segments,s);if(p){var _=a,u=o;if(r.segments.length>s.length){for(var d=r.segments.slice(f),v="$var",f=0;f<d.length;f++){var m=d[f];v+="["===m[0]?m:"."+m}try{_=new Function("$var","return "+v)(a),u=new Function("$var","return "+v)(o)}catch(g){LOGGER.debug("error on parse watch params",g),_=null}}r.cbk&&r.cbk.call(r.ctrlScope,l,h,c,_,u,s),t.push(r)}}}},__updateDirective:function(e){for(var t=e.length;t--;){var i=e[t],n=Renderer.evalExp(i.directive.component,i.expObj);i.directive.onUpdate(n)}},__propChange:function(e){for(var t={},i=e.length;i--;){var n=e[i],r=n.name;this.props[r]=n.newVal,this.__watchProps.forEach(function(e){var i=e.fromPropKey;if(i||reutnr,"["===i[0]||i===r){t[e.subComp.__id]||(t[e.subComp.__id]=[]);var n=Renderer.evalExp(this,e.expWords);t[e.subComp.__id].push({name:e.name,oldVal:e.oldVal,newVal:n}),e.oldVal=n}},this)}var s=!0;if(this.onPropUpdate&&(s=this.onPropUpdate(e)),s!==!1){for(var a=null,o=null,h=null,l=!1,c=!1,p=!1,i=e.length;i--;){var n=e[i],r=n.name;this.__expWithProps[r]?a=this.__expWithProps[r].concat():l=!0,this.__directiveWithProps[r]?o=this.__directiveWithProps[r].concat():c=!0,this.__watchWithProps[r]?h=this.__watchWithProps[r].concat():p=!0}l&&this.__expWithProps["*"].length>0&&(a=a.concat(this.__expWithProps["*"])),a&&Renderer.renderExpNodes(a),c&&this.__directiveWithProps["*"].length>0&&(o=o.concat(this.__directiveWithProps["*"])),o&&this.__updateDirective(o),p&&this.__watchWithProps["*"].length>0&&(h=h.concat(this.__watchWithProps["*"])),h&&this.__callWatchs(h)}for(var _ in t){var u=t[_];impex._cs[_].__propChange&&impex._cs[_].__propChange(u)}}}),View.prototype={__init:function(e,t){var i=this.__target.attributes,n=this.__target.innerHTML,r=tmplExpFilter(e,n,i);t.onBeforeCompile&&(r=t.onBeforeCompile(r));var s=DOMViewProvider.compile(r,this.__placeholder);if(this.__nodes=s,this.el=1===s.length&&1===s[0].nodeType?s[0]:null,!s||s.length<1)return LOGGER.error('invalid template "'+e+'" of component['+t.name+"]"),!1;s.length>1&&LOGGER.warn("more than 1 root node of component["+t.name+"]");var a={},o=t.propTypes;if(o)for(var h in o){var l=o[h];l.require&&(a[h]=l)}if(i)for(var c=i.length;c--;){var h=i[c].name.toLowerCase(),p=i[c].value;if(h!=ATTR_REF_TAG){var _=null;if(REG_CMD.test(h)){var u=h.replace(CMD_PREFIX,""),d=u.indexOf(CMD_PARAM_DELIMITER);d>-1&&(u=u.substring(0,d)),DirectiveFactory.hasTypeOf(u)&&(_=DirectiveFactory.newInstanceOf(u,this.el,t,h,p))}else if(0===h.indexOf(CMD_PARAM_DELIMITER))_=DirectiveFactory.newInstanceOf("on",this.el,t,h,p);else{if(!t.parent)continue;var v=lexer(p),f=Renderer.evalExp(t.parent,v),m=Object.keys(v.varTree);m.forEach(function(e){if(!v.varTree[e].isFunc){var i=new Prop(t,h,v.varTree[e].segments,v,f);t.parent.__watchProps.push(i)}}),o&&(delete a[h],this.__checkPropType(h,f,o,t)),t.props[h]=f}_&&_.init()}else{var g=Scanner.getExpNode(p,t),y=g&&Renderer.calcExpNode(g);t.parent.refs[y||p]=t}}var w=Object.keys(a);return w.length>0?void LOGGER.error("props ["+w.join(",")+"] of component["+t.name+"] are required"):(this.__comp=t,void(this.__placeholder=null))},__checkPropType:function(e,t,i,n){if(i[e]){var r=i[e].type;r=r instanceof Array?r:[r];var s=typeof t;r.indexOf(s)<0&&LOGGER.error("invalid type ["+s+"] of prop ["+e+"] of component["+n.name+"];should be ["+r.join(",")+"]")}},__display:function(e){if(this.__placeholder&&this.__placeholder.parentNode){var t=null;if(this.__nodes.length>1){t=document.createDocumentFragment();for(var i=0;i<this.__nodes.length;i++)t.appendChild(this.__nodes[i])}else t=this.__nodes[0];this.__placeholder.parentNode.replaceChild(t,this.__placeholder),t=null,this.__placeholder=null}},__destroy:function(e){for(var t in this.__evMap)for(var i=this.__evMap[t],n=i.length;n--;)for(var r=i[n],s=r[1],a=this.__nodes.length;a--;)1===this.__nodes[a].nodeType&&this.__nodes[a].removeEventListener(t,s,!1);var o=this.__nodes[0].parentNode;if(o){this.__nodes[0].__impex__view&&(this.__nodes[0].__impex__view=null);for(var n=this.__nodes.length;n--;)this.__nodes[n].parentNode&&o.removeChild(this.__nodes[n])}this.__target&&(this.__target.parentNode&&this.__target.parentNode.removeChild(this.__target),
this.__target=null)},__suspend:function(e,t){var i=this.__nodes[0].parentNode;if(i){t&&(this.__target=document.createComment("-- view suspended of ["+(e.name||"anonymous")+"] --"),i.insertBefore(this.__target,this.__nodes[0]));for(var n=this.__nodes.length;n--;)this.__nodes[n].parentNode&&i.removeChild(this.__nodes[n])}},on:function(e,t,i){if(this.el){var n=t,r=this.__comp,s="",a=null,o=function(t){var o=n;if(i instanceof Function&&(o=i.call(r,t,n)),o){if(s!=o){var h=lexer(o),l=Renderer.getExpEvalStr(r,h),c=l.replace("self.$event","$event");a=new Function("$event",c),s=o}try{a(t)}catch(p){LOGGER.debug("error in event '"+e+"'",p)}}};this.el.addEventListener(e,o,!1),this.__evMap[e]||(this.__evMap[e]=[]),this.__evMap[e].push([t,o])}},off:function(e,t){if(this.el)for(var i=this.__evMap[e],n=i.length;n--;){var r=i[n],s=r[0],a=r[1];s==t&&this.el.removeEventListener(e,a,!1)}},clone:function(){for(var e=[],t=this.__nodes.length;t--;){var i=this.__nodes[t].cloneNode(!0);e.unshift(i)}var n=new View(1===e.length&&1===e[0].nodeType?e[0]:null,null,e);return n},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},style:function(e,t){return arguments.length>1?(this.el.style[e]=t,this):this.el.style[e]},attr:function(e,t){return arguments.length>1?(this.el.setAttribute(e,t),this):this.el.getAttribute(e)},removeAttr:function(e){return this.el.removeAttribute(e),this},hasClass:function(e){return this.el.className.indexOf(e)>-1},addClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,""),e=e.split(" ");for(var t=this.el.className.split(" "),i="",n=e.length;n--;)t.indexOf(e[n])<0&&(i+=e[n]+" ");return this.el.className+=" "+i,this},removeClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");var t=e.split(" "),i=this.el.className;if(i){for(var n=t.length;n--;){var r=t[n],s=new RegExp("^"+r+"\\s+|\\s+"+r+"$|\\s+"+r+"\\s+","img");i=i.replace(s,"")}this.el.className=i}return this},toggleClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");for(var t=e.split(" "),i=!1,n=this.el.className,r=t.length;r--;){var s=t[r];if(n.indexOf(s)<0){i=!0;break}}i?this.addClass(e):this.removeClass(e)}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,i){if(""===t)return new View(null,i,[document.createTextNode("")]);if(e.innerHTML=t,!e.childNodes[0])return null;for(var n=[];e.childNodes.length>0;){var r=e.removeChild(e.childNodes[0]);n.push(r)}var s=new View(null,i,n);return s},this.compile=function(e,t){var i=[];if(!t.insertAdjacentHTML){var n=document.createElement("span");n.style.display="none",t.parentNode.insertBefore(n,t),t.parentNode.removeChild(t),t=n}t.insertAdjacentHTML("beforebegin","<!-- c -->");var r=t.previousSibling;t.insertAdjacentHTML("afterend","<!-- c -->");var s=t.nextSibling;t.insertAdjacentHTML("afterend",e),t.parentNode.removeChild(t);for(var a=r.nextSibling;a!==s;){if(3===a.nodeType){var o=a.nodeValue.replace(/\s/gm,"");if(""===o){a=a.nextSibling;continue}}i.push(a),a=a.nextSibling}return r.parentNode.removeChild(r),s.parentNode.removeChild(s),i}},ViewManager=new function(){this.singleton=!0,this.replace=function(e,t){var i=t.__nodes[0],n=e.__nodes[0],r=t.__nodes[0].parentNode,s=n;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}if(t.__nodes.length>1){r.insertBefore(s,i);for(var a=t.__nodes.length;a--;)r.removeChild(t.__nodes[a])}else r.replaceChild(s,i)},this.insertBefore=function(e,t){var i=t.__nodes[0],n=e.__nodes[0],r=t.__nodes[0].parentNode,s=n;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}r&&r.insertBefore(s,i)},this.insertAfter=function(e,t){var i=t.__nodes[0],n=e.__nodes[0],r=t.__nodes[0].parentNode,s=r.lastChild,a=n;if(e.__nodes.length>1){a=document.createDocumentFragment();for(var o=0;o<e.__nodes.length;o++)a.appendChild(e.__nodes[o])}if(s==i)r.appendChild(a);else{var h=t.__nodes[t.__nodes.length-1].nextSibling;r.insertBefore(a,h)}},this.append=function(e,t){var i=e.__nodes[0],n=t.__nodes[0],r=i;if(e.__nodes.length>1){r=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)r.appendChild(e.__nodes[s])}n.appendChild(r)},this.prepend=function(e,t){var i=e.__nodes[0],n=t.__nodes[0],r=i;if(e.__nodes.length>1){r=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)r.appendChild(e.__nodes[s])}n.insertBefore(r,n.firstChild)},this.createPlaceholder=function(e){return new View(null,null,[document.createComment(e)])}};Util.ext(Directive.prototype,{init:function(){if(this.__state!=Component.state.inited){var e=Scanner.getExpNode(this.value,this.component),t=e&&Renderer.calcExpNode(e);t&&(this.value=t),LOGGER.log(this,"inited"),this.onInit&&this.onInit(),this.__state=Component.state.inited}},active:function(){if(this.onUpdate){var e=lexer(this.value);for(var t in e.varTree){var i=e.varTree[t],n=new AttrObserveNode(this,e);this.component&&Builder.buildExpModel(this.component,i,n)}var r=Renderer.evalExp(this.component,e);this.onUpdate(r)}this.onActive&&this.onActive()},destroy:function(){LOGGER.log(this,"destroy"),this.view.__destroy(this),this.view=this.component=this.params=this.filter=this.onUpdate=null,this.onDestroy&&this.onDestroy()}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},TESTNODE;Transition.prototype={enter:function(){this.__start="enter",this.__css&&this.__view.addClass(this.__type+"-enter"),this.__direct.enter&&this.__direct.enter(),this.__hook.enter&&this.__hook.enter.call(this.__direct,this.__enterDone.bind(this)),this.__css&&(this.__view.el.offsetHeight,this.__view.removeClass(this.__type+"-enter"))},__enterDone:function(){},leave:function(){this.__start="leave",this.__css&&this.__view.addClass(this.__type+"-leave"),this.__hook.leave&&(this.__leaveDone.__trans=this,this.__hook.leave.call(this.__direct,this.__leaveDone.bind(this)))},__leaveDone:function(){this.__direct.leave&&this.__direct.leave()},__done:function(e){if(!(e.elapsedTime<this.__longest)&&this.__start){switch(this.__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.__start="",this.__view.removeClass(this.__type+"-leave")}}},Factory.prototype={register:function(e,t,i){e=e.toLowerCase();var n=t.data;delete t.data;var r={};if("string"==typeof t?n=t:Util.ext(r,t),this.types[e])return this.types[e].data=n,void(this.types[e].props=r);var s=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)");Util.inherits(s,this.baseClass),this.types[e]={clazz:s,props:r,services:i,data:n}},hasTypeOf:function(e){return e in this.types},createCbk:function(e,t){if(e.onCreate){var i=null;if(this.types[t].services){i=[];for(var n=0;n<this.types[t].services.length;n++){var r=ServiceFactory.newInstanceOf(this.types[t].services[n],e);i.push(r)}}i?e.onCreate.apply(e,i):e.onCreate()}}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.restrict},newInstance:function(e){var t=null;if(2===arguments.length){var i=arguments[0],n=arguments[1];t=i,Util.isString(i)?t=this.viewProvider.newInstance(i,n):t.__placeholder=t.__target=n}else t=e,Util.isDOM(e)&&(t=new View(e,null,[e]));var r=new this.baseClass(t),s=arguments[2];if(s&&Util.ext(r,s),r.events)for(var a in r.events)r.on(a,r.events[a]);return r},newInstanceOf:function(e,t,i){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass);n.name=e,n.view=new View(null,t,null,i);var r=this.types[e].data;return"string"==typeof r&&(n.__url=r),this._super.createCbk.call(this,n,e),n},initInstanceOf:function(e){var t=e.name;if(!this.types[t])return null;Util.ext(e,this.types[t].props);var i=this.types[t].data;if(i&&Util.ext(e.data,i),e.events)for(var n in e.events)e.on(n,e.events[n])}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props["final"]},hasEndTag:function(e){return this.types[e].props.endTag},priority:function(e){return this.types[e].props.priority},newInstanceOf:function(e,t,i,n,r){if(!this.types[e])return null;var s=null,a=null,o=n.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=n.substr(o+1);var h=s.indexOf(CMD_FILTER_DELIMITER);h>-1&&(a=s.substr(h+1),s=s.substring(0,h)),s=s.split(CMD_PARAM_DELIMITER)}var l=new this.types[e].clazz(this.baseClass,n,r,i);if(Util.ext(l,this.types[e].props),t.__impex__view)l.view=t.__impex__view;else{var c=t,p=[t];Util.isArray(t)&&(p=t,c=t.length>1?null:t[0]),l.view=new View(c,null,p),t.__impex__view=l.view}if(s&&(l.params=s),a&&(l.filter=a),l.view.__comp=i,i.directives.push(l),l.component=i,l.view&&(l.view.__nodes[0].removeAttribute(l.name),l.endTag)){var _=l.view.__nodes[l.view.__nodes.length-1];_.removeAttribute(CMD_PREFIX+l.endTag)}if(l.events)for(var u in l.events)l.on(u,l.events[u]);return this._super.createCbk.call(this,l,e),l}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var i=new this.types[e].clazz(this.baseClass,t);return Util.ext(i,this.types[e].props),this._super.createCbk.call(this,i,e),i}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var i=null;return this.types[e].props.singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),i=this.types[e].singleton):i=new this.types[e].clazz(this.baseClass),Util.ext(i,this.types[e].props),i.host=t,this._super.createCbk.call(this,i,e),i}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var i=new Transition(e,t,this.hooks[e]);return i}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,ATTR_REF_TAG="ref",ATTR_ANONY_COMP_PROP_PREFIX="props:",EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},im_counter=0,impex=new function(){function e(e){var i=e;do{if(t.indexOf(i)>-1)return!0;i=i.parentNode}while(i);return!1}this.version={v:[0,30,0],state:"beta2",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},this.logger=LOGGER},this.component=function(e,t,i){return"string"==typeof t||t.template||t.templateURL?(ComponentFactory.register(e,t,i),this):void LOGGER.error("can not find property 'template' or 'templateURL' of component '"+e+"'")},this.directive=function(e,t,i){return DirectiveFactory.register(e,t,i),this},this.service=function(e,t,i){return ServiceFactory.register(e,t,i),this},this.filter=function(e,t,i){return FilterFactory.register(e,t,i),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.unitTest=function(e){window.onload=function(){var t=document.querySelector('script[type="javascript/impex-component"]');t=window.eval(t.innerText);var i=document.getElementById(e);document.body.innerHTML+=i.innerHTML,impex.render(document.body,t)}},this.render=function(i,n,r){if(!i)return void LOGGER.error("invalid element, can not render");var s=i.tagName.toLowerCase();if(e(i))return void LOGGER.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,i);if(a||(t.push(i),a=ComponentFactory.newInstance(i,null,n)),a.onCreate){var o=null;if(Util.isArray(r)){o=[];for(var h=0;h<r.length;h++){var l=ServiceFactory.newInstanceOf(r[h],a);o.push(l)}}o?a.onCreate.apply(a,o):a.onCreate()}return a.init(),a.display(),a};var t=[];Object.defineProperty(this,"_cs",{enumerable:!1,writable:!0,value:{}}),this.logger=LOGGER};impex.service("ViewManager",ViewManager),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,i,n){for(var r=e.__expNodes.length;r--;){var s=e.__expNodes[r];s.node==i&&"class"===s.attrName&&(s.origin=n)}for(var a=e.children.length;a--;)t(e.children[a],i,n)}function i(){function e(e,t){for(var i={},n=e.__nodes[0],r=n.attributes.length;r--;){var s=n.attributes[r],a=s.nodeName,o=s.nodeValue;if(0===a.indexOf(ATTR_ANONY_COMP_PROP_PREFIX)){var h=a.replace(ATTR_ANONY_COMP_PROP_PREFIX,""),l=lexer(o),c=Renderer.evalExp(t,l),p=Object.keys(l.varTree);i[h]=[l,c,p]}}return i}function t(e,t,i){for(var n=[],r=e;t>=r;r+=i)n.push(r);return n}function i(e){for(var t=0;t<e.children.length;t++){var n=e.children[t];n.onDisplay&&n.onDisplay(),n.children.length>0&&i(n)}}function n(e,t){if(null===e)return null;var i=e;if(e instanceof Array){i=e.concat();for(var r=i.length;r--;)i[r]=n(i[r],t)}else if(Util.isObject(e)){i={};var s=Object.keys(e);if(s.length>0)for(var a=t===!1?!1:!e.__im__origin,r=s.length;r--;){{var o=s[r];e[o]}0!==o.indexOf("__im__")&&(i[o]="object"==typeof e[o]?n(e[o],a):e[o])}t===!1||i.__im__origin||(i.__im__origin=e)}return i}function r(e,t){setTimeout(function(){for(var i=e.splice(0,50),n=0;n<i.length;n++)i[n].__state!==Component.state.suspend&&(i[n].__state=Component.state.inited,i[n].display());e.length>0?r(e,t):t.over&&t.over()},0)}this.onCreate=function(e,t){this.eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.forExp=/^\s*(\d+|[a-zA-Z_$](.+)?)\s+to\s+(\d+|[a-zA-Z_$](.+)?)\s*$/,this.viewManager=e,this.fragment=document.createDocumentFragment(),this.expInfo=this.parseExp(this.value),this.__view=this.view,this.cache=[],this.__comp=this.component,this.view.el?(this.__tagName=this.view.el.tagName.toLowerCase(),this.__isComp=ComponentFactory.hasTypeOf(this.__tagName),this.cacheable="false"===this.view.attr("cache")?!1:!0):this.cacheable="false"===this.view.__nodes[0].getAttribute("cache")?!1:!0,this.subComponents=[],this.cacheSize=20,this.step=this.view.el?this.view.attr("step"):this.view.__nodes[0].getAttribute("step"),this.over=this.view.el?this.view.attr("over"):this.view.__nodes[0].getAttribute("over");var i=this.view.el?this.view.attr("transition"):this.view.__nodes[0].getAttribute("transition");null!==i&&(this.trans=i,this.ts=t)},this.onInit=function(){var i=this;if(this.forExp.test(this.expInfo.ds)){var n=RegExp.$1,r=RegExp.$3,s=parseFloat(this.step);if(0>s)return void LOGGER.error("step <= 0 : "+s);s=s||1,isNaN(n)&&(this.component.watch(n,function(e,n,a,o,h){var l=t(o>>0,r,s);i.lastDS=l,i.rebuild(l,i.expInfo.k,i.expInfo.v)}),n=this.component.d(n)),isNaN(r)&&(this.component.watch(r,function(e,r,a,o,h){var l=t(n,o>>0,s);i.lastDS=l,i.rebuild(l,i.expInfo.k,i.expInfo.v)}),r=this.component.d(r)),n=parseFloat(n),r=parseFloat(r),this.ds=t(n,r,s)}else this.ds=this.component.d(this.expInfo.ds),this.component.watch(this.expInfo.ds,function(e,t,n,r){return i.ds?(i.lastDS=Util.isArray(r)?r:e,void i.rebuild(i.lastDS,i.expInfo.k,i.expInfo.v)):(i.ds=i.component.d(i.expInfo.ds),i.lastDS=i.ds,void i.build(i.ds,i.expInfo.k,i.expInfo.v))});if(this.over){var a=lexer(this.over),o=Renderer.evalExp(this.__comp,a);this.over=o}this.lastDS=this.ds,this.placeholder=this.viewManager.createPlaceholder("-- directive [each] placeholder --"),this.viewManager.insertBefore(this.placeholder,this.view),this.fragmentPlaceholder=this.viewManager.createPlaceholder("-- fragment placeholder --"),this.fragment.appendChild(this.fragmentPlaceholder.__nodes[0]),this.__props=e(this.__view,this.component),this.ds&&this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy()},this.rebuild=function(e,t,n){e=this.doFilter(e);var r=e.length-this.subComponents.length;if(0>r){var s=this.subComponents.splice(0,-1*r);if(this.cache.length<this.cacheSize){for(var a=s.length;a--;)this.cache.push(s[a]);for(var a=this.cache.length;a--;)this.trans&&!this.cache[a].__leaving&&"displayed"===this.cache[a].__state?(this.cache[a].__leaving=!0,this.cache[a].transition.leave()):this.cache[a].suspend(!1)}else for(var a=s.length;a--;)s[a].destroy()}else if(r>0){var o=r;if(this.cacheable){for(var s=this.cache.splice(0,r),a=0;a<s.length;a++)this.subComponents.push(s[a]),this.viewManager.insertBefore(s[a].view,this.placeholder);var o=r-s.length}for(;o--;)this.createSubComp()}var h=Util.isArray(e)?!0:!1,l=0;for(var c in e)if(e.hasOwnProperty(c)&&(!h||!isNaN(c))){var p=this.subComponents[l],_=e[c];if(e[c]&&e[c].__im__origin&&(_=e[c].__im__origin,e[c].__im__origin=null,delete e[c].__im__origin),"object"==typeof _){for(var a=_.__im__extPropChain.length;a--&&_.__im__extPropChain[a][0]!==this;);_.__im__extPropChain.splice(a,1),_.__im__extPropChain.push([this,n,l])}var u=p.data.__im__target||p.data;u[n]=_,u.$index=l++,t&&(u[t]=h?c>>0:c),p.__state===Component.state.created&&p.init(),p.display(),"displayed"===p.__state&&Renderer.recurRender(p),i(p)}},this.createSubComp=function(){var e=this.__comp,t=null,i=this.viewManager.createPlaceholder("");this.viewManager.insertBefore(i,this.placeholder);var n=this.__view.clone();t=this.__isComp?e.createSubComponentOf(this.__tagName,n,i):e.createSubComponent(n,i),this.subComponents.push(t);for(var r in this.__props){var s=this.__props[r],a=s[0],o=s[1],h=s[2];h.forEach(function(i){if(!a.varTree[i].isFunc){var n=!1;0===i.indexOf(".this.props")&&(n=i.replace(/^\.this\.props\.?/,""));var s=new Prop(t,r,a.varTree[i].segments,a,o,n);e.__watchProps.push(s)}}),t.props[r]=o}if(this.trans){var l=this;t.onInit=function(){this.transition||(this.transition=l.ts.get(l.trans,this))},t.onDisplay=function(){this.transition.enter()},t.leave=function(){this.suspend(!1),this.__leaving=!1}}return t},this.doFilter=function(e){if(!this.filters)return e;var t=this.filters;if(Object.keys(t).length>0){e&&Util.isObject(e)&&(e=n(e));for(var i in t){for(var r=t[i][0],s=t[i][1],a=[],o=s.length;o--;){var h=s[o];h.varTree&&h.words&&(h=Renderer.evalExp(this.__comp,h)),a[o]=h}r.value=e,e=r.to.apply(r,a)}return e}},this.build=function(e,t,i){var n=Util.isArray(e)?!0:!1,s=0;e=this.doFilter(e),e.__im__extPropChain&&e.__im__extPropChain.push([this,i]);for(var a in e)if(e.hasOwnProperty(a)&&(!n||!isNaN(a))){var o=this.createSubComp(),h=e[a];e[a]&&e[a].__im__origin&&(h=e[a].__im__origin,e[a].__im__origin=null,delete e[a].__im__origin),"object"==typeof h&&h.__im__extPropChain.push([this,i,s]);var l=o.data.__im__target||o.data;l[i]=h,l.$index=s++,t&&(l[t]=n?a>>0:a)}for(var c=this.subComponents.length;c--;)this.subComponents[c].init(),this.subComponents[c].__state=Component.state.displayed;var p=this.subComponents.concat();r(p,this)},this.over=function(){alert("sdfdsf")},this.parseExp=function(e){var t,i,n,r=this;return e.replace(this.eachExp,function(e,s,a,o){t=s;var h=a.replace(/\s/gm,""),l=h.split(",");if(l.length>1?(i=l[0],n=l[1]):n=l[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,r.parent);r.filters=c;for(var _ in p)r.component.watch(_,function(){r.lastDS&&r.rebuild(r.lastDS,r.expInfo.k,r.expInfo.v)})}}),t?{ds:t,k:i,v:n}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{"final":!0}).directive("on",{onInit:function(){for(var e=this.params.length;e--;)this.view.on(this.params[e],this.value)}}).directive("text",{onUpdate:function(e){this.view.el.innerText=e}}).directive("bind",{onInit:function(){(!this.params||this.params.length<1)&&LOGGER.warn("at least one attribute be binded")},onUpdate:function(e){if(this.params&&!(this.params.length<1)){var t=null;if(this.filter&&(t=this.component[this.filter]),t){var i=t(e);if(!Util.isUndefined(i)&&!i)return}for(var n=this.params.length;n--;){var r=this.params[n];this.view.attr(r,e)}}}}).directive("show",{onCreate:function(e){var t=this.view.attr("transition");null!==t&&(this.transition=e.get(t,this)),this.lastRs=!1,this.exec(!1)},onUpdate:function(e){this.component.__state!==Component.state.suspend&&e!==this.lastRs&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){e?this.view.show():this.view.hide()}},["Transitions"]).directive("show-start",{endTag:"show-end",onInit:function(){Scanner.scan(this.view,this.component)},onUpdate:function(e){if(this.component.__state!==Component.state.suspend){var t=this.view.__nodes;if(e)for(var i=t.length;i--;)t[i].style&&(t[i].style.display="");else for(var i=t.length;i--;)t[i].style&&(t[i].style.display="none")}}}).directive("if",{onCreate:function(e,t){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --");var i=this.view.attr("transition");null!==i&&(this.transition=t.get(i,this)),this.lastRs=!1,this.exec(!1)},onUpdate:function(e){this.component.__state!==Component.state.suspend&&(e!==this.lastRs||this.view.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.view.el.parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.el.parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager","Transitions"]).directive("if-start",{endTag:"if-end",onCreate:function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --")},onInit:function(){Scanner.scan(this.view,this.component)},onUpdate:function(e){if(this.component.__state!==Component.state.suspend)if(e){if(this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager"]).directive("cloak",{onCreate:function(){var e=this.view.attr("class");return e?(e=e.replace("x-cloak",""),void(this.__cn=e)):void LOGGER.warn("can not find attribute[class] of element["+this.view.name+"] which directive[cloak] on")},onActive:function(){t(this.component,this.view.el,this.__cn);var e=this.view.attr("class").replace("x-cloak","");this.view.attr("class",e)}}).directive("model",{onCreate:function(){var e=this.view.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=this.view.attr("type");switch(t){case"radio":this.view.on("click",null,this.changeModel.bind(this));break;case"checkbox":this.view.on("click",null,this.changeModelCheck.bind(this));break;default:var i=null===document.body.onpropertychange?"propertychange":"input";this.view.on(i,null,this.changeModel.bind(this))}break;case"select":var n=e.getAttribute("multiple");null!==n?this.view.on("change",null,this.changeModelSelect.bind(this)):this.view.on("change",null,this.changeModel.bind(this))}},changeModelSelect:function(e){for(var t=e.target||e.srcElement,i=(t.value,[]),n=t.options.length;n--;){var r=t.options[n];r.selected&&i.push(r.value)}this.component.d(this.value,i)},changeModelCheck:function(e){var t=e.target||e.srcElement,i=t.value,n=this.component.d(this.value);if(n instanceof Array||(n=[n]),t.checked)n.push(i);else{var r=n.indexOf(i);r>-1&&n.splice(r,1)}this.component.d(this.value,n)},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.component.d(this.value,t)}});var n=new i;n["final"]=!0,n.priority=999,e.directive("each",n,["ViewManager","Transitions"]);var r=new i;r.endTag="each-end",r.priority=999,e.directive("each-start",r,["ViewManager"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.value)}}).filter("filterBy",{to:function(e,t){var i=this.value;if(!(i instanceof Array))return LOGGER.warn("can only filter array"),this.value;var n=[];if(e instanceof Function)for(var r=i.length;r--;){var s=e.call(this,i[r]);s&&n.unshift(i[r])}else for(var r=i.length;r--;){var a=i[r];t?(!e||(a[t]+"").indexOf(e)>-1)&&n.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&n.unshift(a)}return n}}).filter("limitBy",{to:function(e,t){return this.value instanceof Array?e?this.value.splice(t||0,e):this.value:(LOGGER.warn("can only filter array"),this.value)}}).filter("orderBy",{to:function(e,t){return e||t?this.value instanceof Array?(this.value.sort(function(t,i){var n=e?t[e]:t,r=e?i[e]:i;return"string"==typeof n?n.localeCompare(r):"number"==typeof n?n-r:(n+"").localeCompare(r)}),"desc"===t&&this.value.reverse(),this.value):(LOGGER.warn("can only filter array"),this.value):this.value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);