/*
 * impexjs is a powerful web application engine to build 
 * reactive webUI system
 *
 *
 * Copyright 2015-2016 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://impexjs.org
 * last build: 2016-11-22
 */
!function(global){"use strict";function ExpData(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function Change(e,t,n,i,r,s){this.name=e,this.newVal=t,this.oldVal=n,this.path=i,this.type=r,this.object=s,this.expProps=[]}function ExpNode(e,t,n,i,r,s){this.node=e,this.attrName=t,this.origin=n,this.expMap=i,this.component=r,this.toHTML=s,this.id=Math.random()}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,n){this.cbk=e,this.ctrlScope=t,this.segments=n}function Prop(e,t,n,i,r,s){this.subComp=e,this.name=t,this.segments=n,this.expWords=i,this.oldVal=r}function View(){this.__evMap={},this.el=null}function Component(){var e="C_"+im_counter++;this.__id=e,this.__state=Component.state.created,View.call(this),this.comps={},this.els={},this.propTypes=null,this.name,this.parent,this.children=[],this.__expNodes=[],this.__expDataRoot=new ExpData,this.__eventMap={},this.__watchProps=[],this.__props={},this.directives=[],this.template,this.__url,this.restrict,this.state={},impex._cs[this.__id]=this}function Directive(e,t){View.call(this),this.value=t,this.name=e,this.params,this.filter,this.component,this["final"]=!1,this.endTag=null,this.priority=0}function Filter(e){this.component=e,this.value,this.onCreate}function Service(){this.singleton,this.host,this.onCreate}function Transition(e,t,n){if(TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE)),n&&n.css===!1)this.__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var i=window.getComputedStyle(TESTNODE,null),r=i["transition-duration"].split(","),s=i["transition-delay"].split(","),a=-1,o=r.length;o--;){var l=parseFloat(r[o]),h=parseFloat(s[o]);l+h>a&&(a=l+h)}if(a>0){var c=t,p=null,u=null;t instanceof Directive?(p=t.component.__expNodes,u=t.component):(p=t.__expNodes,u=t),p.length<1&&u.parent&&(p=u.parent.__expNodes);for(var o=p.length;o--;){var f=p[o];"class"===f.attrName&&(f.origin+=" "+e+"-transition")}c.addClass(e+"-transition"),this.__longest=a;var _=null;for(var d in TRANSITIONS)if(void 0!==c.el.style[d]){_=TRANSITIONS[d];break}c.el.addEventListener(_,this.__done.bind(this),!1),this.__css=!0}}this.__direct=t,this.__view=c,this.__hook=n||{},this.__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function slotHandler(e,t){var n={};return t.replace(/<(?:\s+)?([a-z](?:.+)?)\s+slot(?:\s+)?=(?:\s+)?['"]([^<>]+?)?['"](?:[^<>]+)?>(?:[^<>]+)?<\/(?:\s+)?\1(?:\s+)?>/gim,function(e,t,i){n[i]=e}),t.trim().length>0&&(e=e.replace(/<(?:\s+)?slot(?:\s+)?>(?:[^<>]+)?<\/(?:\s+)?slot(?:\s+)?>/gim,function(e){return t})),e=e.replace(/<(?:\s+)?slot\s+name(?:\s+)?=(?:\s+)?['"]([^<>]+?)?['"](?:[^<>]+)?>(?:[^<>]+)?<\/(?:\s+)?slot(?:\s+)?>/gim,function(e,t){return n[t]||e})}function peelCSS(e){var t="";return e=e.replace(/<(?:\s+)?style(?:.+)?>([^<>]+)?<\/(?:\s+)?style(?:\s+)?>/gim,function(e){return t+=e,""}),[t,e]}function cssHandler(e,t){return t=t.replace(/<(?:\s+)?style(?:.+)?>([^<>]+)?<\/(?:\s+)?style(?:\s+)?>/gim,function(t,n){return"<style>"+filterStyle(e,n)+"</style>"})}function filterStyle(e,t){return t=t.replace(/\n/gim,"").trim(),t=t.replace(/(^|})(?:\s+)?[a-z:_$](?:[^{]+)?\{/gim,function(t){var n=t.trim();return/(^|}|((?:\s+)?,))(?:\s+)?:host/.test(n)||("}"===n[0]?(n=n.substr(1),n="}"+e+" "+n):n=e+" "+n),n=n.replace(/:host/gim,e)})}function checkPropType(e,t,n,i){if(n[e]){var r=n[e].type;r=r instanceof Array?r:[r];var s=typeof t;r.indexOf(s)<0&&LOGGER.error("invalid type ["+s+"] of prop ["+e+"] of component["+i.name+"];should be ["+r.join(",")+"]")}}function handleProps(e,t,n,i,r){if(e[0]!==PROP_TYPE_PRIFX)return i&&(delete n[e],checkPropType(e,t,i,r)),void(r.state[e]=t);var s=e.substr(1),a=lexer(t),o=Renderer.evalExp(r.parent,a);if(PROP_SYNC_SUFX_EXP.test(s)){s=s.replace(PROP_SYNC_SUFX_EXP,"");var l=Object.keys(a.varTree);l.forEach(function(e){if(!a.varTree[e].isFunc){var t=new Prop(r,s,a.varTree[e].segments,a,o);r.parent.__watchProps.push(t)}})}if(i&&(delete n[s],checkPropType(s,o,i,r)),o instanceof Function)return void(r[s]=o);var h=Util.immutable(o);r.state[s]=h}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function n(){if(0===this.status||this.status>=200&&this.status<300||304===this.status){var e=this.responseText;i.innerHTML=e;var t=i.querySelector("template").innerHTML,n=i.querySelector('script[type="javascript/impex-component"]').innerHTML,s=r[this.url];s.forEach(function(e){var i=window.eval(n);e([t,i])}),r[this.url]=null}}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype._super=t.prototype},this.ext=function(e,t){for(var n=Object.keys(t),i=n.length;i--;){var r=n[i];e[r]=t[r]}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var i=document.createElement("div");this.isDOMStr=function(e){return i.innerHTML=e,i.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName};var r={};this.loadComponent=function(i,s,a){if(r[i])return void r[i].push(s);r[i]=[],r[i].push(s);var o=new XMLHttpRequest;o.open("get",i,!0),o.timeout=a||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=n:o.onreadystatechange=n,o.url=i,o.send(null)},this.immutable=function(e){if("object"==typeof e){var t=JSON.parse(JSON.stringify(e));return t}return e}},Observer=null;window.Proxy&&!function(){function e(e,t,n){isNaN(t)||(e[t>>0]=n)}function t(e,t){isNaN(t)||e.splice(t,1)}function n(e,t,i,r){if(i&&i.__im__propChain)return i;var s=i instanceof Array?[]:{};for(var a in i){var o=i[a];if("object"==typeof o){var l=t.concat();l.push(a);var h=n(e,l,o,r);s[a]=h}else s[a]=o}Object.defineProperty(s,"__im__propChain",{enumerable:!1,writable:!1,value:t}),Object.defineProperty(s,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]});var c=new Proxy(s,e);Object.defineProperty(c,"__im__target",{enumerable:!1,writable:!1,value:s});var p=Date.now()+Math.random();return Object.defineProperty(s,"__im__oid",{enumerable:!1,writable:!1,value:p}),c}Observer={observe:function(i,r){if(i&&i.__im__propChain)return i;var s={comp:r,set:function(t,i,r){var s=!(i in t),a=t[i],o=r;if(a===o)return!0;if("object"==typeof o){var l=t.__im__propChain.concat();l.push(i),o=n(this,l,o,this.comp)}t instanceof Array?e(t,i,o):t[i]=o;var h=t.__im__propChain,c=t.__im__extPropChain,p={object:t,name:i,pc:h,xpc:c,oldVal:a,newVal:o,comp:this.comp,type:s?"add":"update"};return ChangeHandler.handle(p),!0},deleteProperty:function(e,n){var i=e[n];e instanceof Array?t(e,n):delete e[n];var r=e.__im__propChain,s=e.__im__extPropChain,a={object:e,name:n,pc:r,xpc:s,oldVal:i,comp:this.comp,type:"delete"};return ChangeHandler.handle(a),!0}};return n(s,[],i,r)}}}(),!window.Proxy&&!function(){function e(e){return this.__im__innerProps[e]}function t(e,t){var i=this.__im__innerProps[e];if(r(i),"object"==typeof t){var a=this.__im__propChain.concat();a.push(e),t=n(a,t,this.__im__comp)}this.__im__innerProps[e]=t;this.__im__propChain,this.__im__extPropChain;s([{name:e,target:this,oldVal:i,newVal:t,type:"update"}],!0)}function n(i,r,s){if(r&&r.__im__propChain)return r;var o=r instanceof Array?[]:{};Object.defineProperty(o,"__im__innerProps",{enumerable:!1,writable:!0,value:{}});var l={},h={};for(var c in r)if(r.hasOwnProperty(c)){var p=r[c];if("object"==typeof p){var u=i.concat();u.push(c);var f=n(u,p,s);o.__im__innerProps[c]=f}else o.__im__innerProps[c]=p;h[c]=p,!function(n){l[n]={get:function(){return e.call(this,n)},set:function(e){t.call(this,n,e)},enumerable:!0,configurable:!0}}(c)}Object.defineProperties(o,l),Object.defineProperty(o,"__im__propChain",{enumerable:!1,writable:!1,value:i}),Object.defineProperty(o,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]}),Object.defineProperty(o,"__im__target",{enumerable:!1,writable:!1,value:o.__im__innerProps}),Object.defineProperty(o,"__im__comp",{enumerable:!1,writable:!1,value:s});var _=Date.now()+Math.random();return Object.defineProperty(o,"__im__oid",{enumerable:!1,writable:!1,value:_}),a.push({snap:h,now:o,id:_}),o}function i(){o(function(){for(var e=a.length;e--;){var t=a[e],n=t.snap,r=t.now,o=(t.id,[]);for(var l in n)if(!(l in r)){var h={};h.name=l,h.target=r,h.oldVal=n[l],h.snap=n,h.type="delete",h.id=o.push(h)}for(var l in r)if(!(l in n)){var h={};h.name=l,h.target=r,h.newVal=r[l],h.snap=n,h.type="add",o.push(h)}o.length>0&&s(o)}i()})}function r(e){for(var t=null,n=a.length;n--&&(t=a[n],t.id!==e.__im__oid););n>-1&&(a.splice(n,1),"object"==typeof t&&r(t))}function s(i,s){for(var a=i.length;a--;){var o=i[a],l=o.name,h=o.target,c=h.__im__propChain,p=h.__im__extPropChain,u=h.__im__comp,f=o.oldVal,_=o.newVal,d=o.type,v=o.snap;if("add"===d){if(v[l]=_,h.__im__innerProps[l]=_,"object"==typeof _){var m=c.concat();m.push(l),h.__im__innerProps[l]=n(m,_,u)}!function(n,i){Object.defineProperty(i,n,{get:function(){return e.call(this,n)},set:function(e){t.call(this,n,e)},enumerable:!0,configurable:!0})}(l,h)}else if("delete"===d){var g=v[l];"object"==typeof g&&r(g),delete v[l]}else if(!s){console.log("无效update");continue}var y={object:h,name:l,pc:c,xpc:p,oldVal:f,newVal:_,comp:u,type:d};ChangeHandler.handle(y)}}var a=[],o=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self);Observer={},Observer.observe=function(e,t){return e&&e.__im__propChain?e:n([],e,t)},i()}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,r){if(o.test(e)){var s=i(r,t);return c="var",s}return a.test(e)?(c="str",n(t,RegExp.$1)):(c="",e)}function n(e,t){for(var n=!1,i=t,r=1;r<e.length;r++){var s=e[r];if("\\"!==s){if(!n&&s===t)return i+t;i+=s,n=!1}else n=!0,i+=s}}function i(n,r,s,a){for(var c="",p=[],u=-1,f=-1,_=-1,d=a||e(),v=0;v<r.length;v++){var m=r[v];if(p.length>0)if(o.test(m)){var g=e(),y=i(n,r.substr(v),!0,g);v=v+y.length-1;var b=y;o.test(y[0])&&h.indexOf(b)<0&&(d.subVars["."+y]=g,h.indexOf(b)<0&&(b=["."+b])),d.words.push(b)}else if("]"===m||")"===m){if(p.pop(),0===p.length){var x=r.substring(u,v+1);c+=x,d.segments.push(x),_=v}")"===m&&(d.isFunc=!0),d.words.push(m),f=v}else{var E=t(m,r.substr(v),n);v=v+E.length-1,d.words.push(E),f=v}else if(l.test(m)){if(c+=m,"."===m){var b=c.substr(_+1);b=b.replace(/\./,""),b&&(d.segments.push(b),_=v)}}else{if("["!==m&&"("!==m){if("]"!==m&&")"!==m||!s){var b=c.substr(f+1);b&&("."!==b[0]&&h.indexOf(b)<0&&(b=["."+b]),d.words.push(b));var C=c.substr(_+1);return C&&(d.segments.push(C),_=v),!s&&h.indexOf(b)<0&&(n["."+c]=d),c}var b=c;if(b[b.length-1]!==m){b=b.substring(f+1,b.length),b&&d.words.push(0===r.indexOf(b)?["."+b]:b);var O=b.lastIndexOf(".");O>0&&(b=b.substr(O)),b&&d.segments.push(b),_=v}return f=v,c}p.push(m),u=v,d.brakLength++;var w=c.substr(f+1);if(w){var b=w;h.indexOf(w)<0&&0>f&&(b=["."+w]),d.words.push(b)}d.words.push(m);var T="["===m?"]":")";if(c[v-1]!==T){var P=w.lastIndexOf(".");P>-1?(w=w.substr(P),d.segments.push(w)):w&&d.segments.push(w),_=v}f=v}}var R=c.substr(c.lastIndexOf("]")+1),F=c.substr(c.lastIndexOf(")")+1);if(R&&F){var N=R.length<F.length?R:F,C=c.substr(_+1);d.segments.push(C);var b="["===N[0]||"("===N[0]?N:"."===N[0]?N:"."+N;d.words.length<1&&h.indexOf(b)<0&&(b=[b]),d.words.push(b)}return s||(n["."+c]=d),c}function r(e){for(var t in e){var n=e[t],i=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,n.brakLength);var l="]"===t[t.length-1]?"[":"(",h=n.brakLength;n.watchPathWords=[];for(var c=0;c<n.words.length;c++){var p=n.words[c];if(p===l&&--h<1)break;n.watchPathWords.push(p)}}else n.watchPathWords=n.words.concat(),n.watchPathWords.splice(-1,1);i=t.substr(o),n.lastVar="("===i[0]?t:i,Object.keys(n.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),n.watchPath=a);for(var c=n.segments.length;c--;)n.segments[c]=n.segments[c].replace(/^\.|\.$/g,"");r(n.subVars)}}function s(e,t){for(var n=0;n<e.length;n++){var i=e[n];if(("["===i||"("===i)&&--t<1)return n}}var a=/(['"])/,o=/[a-zA-Z$_]/,l=/[a-zA-Z$_0-9.]/,h=["as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var n=[],i={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),i);switch(s=s+o.length-1,c){case"var":n.push(h.indexOf(o)<0?["."+o]:o);break;case"str":case"":n.push(o)}}return r(i),p[e]={words:n,varTree:i},p[e]}}(),Scanner=new function(){function e(e){if(e){var n=[],i=[];t(e,n);for(var r=n.length;r--;){var e=n[r],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,n){var i=s.substring(o,n);i&&a.push(i),a.push(e),o=n+e.length});var l=s.substring(o,s.length);if(l&&a.push(l),a.length<2)i.unshift(null);else{for(var h=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);h.appendChild(p)}i.unshift(h)}}for(var c=n.length;c--;){var u=n[c];i[c]&&i[c].childNodes.length>1&&u.parentNode&&u.parentNode.replaceChild(i[c],u)}}}function t(e,n){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var i=0,r=e.childNodes.length;r>i;i++)t(e.childNodes[i],n)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n.push(e)}}function n(e){if(e.restrict)return e;for(var t=e.parent;t;){if(t.name&&t.restrict)return t;t=t.parent}return null}function i(e,t){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var s=e.tagName.toLowerCase(),a=[],o=e.attributes.length;o--;){var l=e.attributes[o];a.push([l.name,l.value])}for(var h=[],o=a.length;o--;){var c=a[o][0];if(0===c.indexOf(CMD_PREFIX)){var p=c.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&(DirectiveFactory.isFinal(p)||DirectiveFactory.hasEndTag(p))&&h.push([p,a[o],DirectiveFactory.priority(p)||0])}}if(h.length>0){h.sort(function(e,t){return t[2]-e[2]});var p=h[0][0],f=h[0][1];if(DirectiveFactory.isFinal(p))return void DirectiveFactory.newInstanceOf(p,e,t,f[0],f[1]);if(DirectiveFactory.hasEndTag(p))return[p,f[1]]}if(ComponentFactory.hasTypeOf(s)){var _=n(t);if(_&&_.restrict.children){var d=_.restrict.children.split(",");if(d.indexOf(s)<0)return}var v=ComponentFactory.getRestrictOf(s);if(v&&v.parents){var m=v.parents.split(",");if(m.indexOf(_.name)<0)return}{t.createSubComponentOf(e)}return}for(var o=a.length;o--;){var g=a[o][0],y=a[o][1];if(REG_CMD.test(g)){var p=g.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&DirectiveFactory.newInstanceOf(p,e,t,g,y)}else":"===g[0]?DirectiveFactory.newInstanceOf("on",e,t,g,y):REG_EXP.test(y)&&r(y,t,e,g)}}if(e.childNodes.length>0){for(var b=null,x=[],o=0,E=e.childNodes.length;E>o;o++)if(b){x.push(e.childNodes[o]);var C=DirectiveFactory.hasEndTag(b[0]),l=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+C);Util.isString(l)&&(DirectiveFactory.newInstanceOf(b[0],x,t,CMD_PREFIX+b[0],b[1]),b=null,x=[])}else b=i(e.childNodes[o],t),b&&x.push(e.childNodes[o]);b&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+b[0]+"]")}}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,t,e)}}function r(e,t,n,i){var r=s(e,t,n,i);return r&&t.__expNodes.push(r),r}function s(e,t,n,i){var r={},s=!i&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);return s&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,n){var i={},s=1,o=null;FILTER_EXP.test(n)&&(o=a(lexer(RegExp.$1),i,t),s=n.indexOf(FILTER_EXP_START_TAG));var l=n;s>1&&(l=n.substring(0,s));var h=lexer(l);o&&Util.ext(h.varTree,o),r[n]={words:h.words,varTree:h.varTree,filters:i}}),Object.keys(r).length<1?void 0:new ExpNode(n,i,e,r,t,s)}function a(e,t,n){for(var i=[],r=null,s=!1,a={},o=[],l=e.words,h=0;h<l.length;h++)if(l[h]instanceof Array)for(var c=l[h][0],p=c.split("."),u=1;u<p.length;u++)o.push([p[u]]);else o.push(l[h]);for(var h=0;h<o.length;h++){var c=o[h];switch(c){case":":s=!0,null!==r&&i.push(r),r="";break;case".":s=!1,null!==r&&i.push(r),r="",i=[];break;default:if(c instanceof Array){var f=c[0],_=f.toLowerCase();if(!s&&_&&FilterFactory.hasTypeOf(_))r=null,t[_]=[FilterFactory.newInstanceOf(_,n),i];else{var p=lexer(f);Util.ext(a,p.varTree),i.push(p),r=null}}else{if(!s||!c.replace(/\s+/,""))continue;r+=c.replace(/^['"]|['"]$/g,"")}}}return r&&i.push(r),a}this.scan=function(t,n){for(var r=null,s=[],a=0,o=t.length;o>a;a++)if(e(t[a]),r){s.push(t[a]);var l=DirectiveFactory.hasEndTag(r[0]),h=t[a].getAttribute&&t[a].getAttribute(CMD_PREFIX+l);Util.isString(h)&&(DirectiveFactory.newInstanceOf(r[0],s,n,CMD_PREFIX+r[0],r[1]),r=null,s=[])}else r=i(t[a],n),r&&s.push(t[a]);r&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+r[0]+"]")},this.getExpNode=s,this.parseFilters=a},Builder=new function(){function e(e){for(var n=e.__expNodes.length;n--;){var i=e.__expNodes[n];for(var r in i.expMap){var s=i.expMap[r],a=s.varTree;for(var o in a){var l=a[o];t(e,l,i)}}}}function t(e,i,r){for(var s in i.subVars){var a=i.subVars[s];t(e,a,r)}for(var o=n(e.__expDataRoot.subProps,i.segments[0],r),l=1;l<i.segments.length;l++)o=n(o.subProps,i.segments[l],r)}function n(e,t,n){var i=e[t];return i||(i=e[t]=new ExpData(t)),n instanceof ExpNode?i.expNodes.indexOf(n)<0&&i.expNodes.push(n):n instanceof AttrObserveNode?i.attrObserveNodes.indexOf(n)<0&&i.attrObserveNodes.push(n):n instanceof Watch&&i.watchs.indexOf(n)<0&&i.watchs.push(n),e[t]}this.buildExpModel=t,this.build=function(t){e(t)}},ChangeHandler=new function(){function e(e){for(var t=s.length;t--;){var n=s[t];if(n.object.__im__oid===e.object.__im__oid&&n.name===e.name)break}t>-1?s.splice(t,1,e):s.push(e)}function t(e,t,i,r,s,o,l){var h=[];if(l[0]instanceof Directive){var c=void 0===l[2]?s:l[2];i=l[0].subComponents[parseInt(c)],h.push(l[1]),Util.isUndefined(l[2])&&i instanceof Component&&(i.state.__im__target[l[1]]=e)}else h=l.concat(),Util.isArray(o)||h.push(s);if(i){a[i.__id]||(a[i.__id]={changes:[],comp:i});var p=new Change(s,e,t,h,r,o);a[i.__id].changes.push(p),n(i,h,p)}}function n(e,t,n){for(var r,s=e.__expDataRoot.subProps,a=!1,l=0;l<t.length;l++){var h=t[l];if(o.test(Object.keys(s).join(","))){a=!0;break}{if(!s[h])break;r=s[h],s=s[h].subProps}}if(r){var c=[];if(a)for(var p=t.length-l-1,u=Object.keys(r.subProps),l=u.length;l--;){var f=u[l];("["===f[0]||f===h)&&i(r.subProps[f],p,c)}else c.push(r);for(var l=c.length;l--;){var r=c[l];n.expProps.push(r)}}}function i(e,t,n){if(1>t)return void n.push(e);for(var r in e.subProps)i(e.subProps[r],t-1,n)}var r=!1,s=[],a={};this.handle=function(n){r?e(n):(s=[],a={},r=!0,s.push(n),setTimeout(function(){r=!1,s.forEach(function(e){var n=e.newVal,i=e.oldVal,r=e.pc,s=e.xpc,a=e.comp,o=e.type,l=e.name,h=e.object;t(n,i,a,o,l,h,r),s.forEach(function(e){t(n,i,a,o,l,h,e)})});var e=a;for(var n in e)e[n].comp.__update(e[n].changes)},20))};var o=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNodes(e){for(var t={},n=e.length;n--;){var i=e[n],r=null;if(t[i.origin]&&t[i.origin].comp===i.component?r=t[i.origin].val:(r=calcExpNode(i),t[i.origin]={comp:i.component,val:r}),i.toHTML){var s=renderHTML(i,r,i.node,i.component);if(s)continue}null!==r&&updateDOM(i.node,i.attrName,r)}}function updateDOM(e,t,n){if(e.setAttribute){e.setAttribute(t,n);var i=propMap[t];i&&i.indexOf(e.tagName)>-1&&(e[t]=n)}else e.parentNode&&(e.nodeValue=n)}function clone(e){if(null===e)return null;var t=e;if(e instanceof Array){t=e.concat();for(var n=t.length;n--;)t[n]=clone(t[n])}else if(Util.isObject(e)){t={};var i=Object.keys(e);if(i.length>0)for(var n=i.length;n--;){{var r=i[n];e[r]}0!==r.indexOf("__im__")&&(t[r]="object"==typeof e[r]?clone(e[r]):e[r])}}return t}function calcExpNode(e){var t=e.component,n=e.origin,i=e.expMap,r={};for(var s in i){var a=i[s],o=evalExp(t,a),l=a.filters;if(Object.keys(l).length>0){o&&Util.isObject(o)&&(o=clone(o));for(var h in l){for(var c=l[h][0],p=l[h][1],u=[],f=p.length;f--;){var _=p[f];_.varTree&&_.words&&(_=Renderer.evalExp(t,_)),u[f]=_}c.value=o,o=c.to.apply(c,u)}}r[s]=void 0===o?"":o}for(var h in r)n=n.replace(EXP_START_TAG+h+EXP_END_TAG,r[h]+"");return n}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var n=t.varTree,i={};for(var r in n){var s=n[r],a=buildVarPath(e,s,r);i[r]=a}var o=joinExpStr(t.words,i);return o}function joinExpStr(e,t){for(var n="",i=0;i<e.length;i++){var r=e[i];n+=r instanceof Array?t[r[0]]:r}return n}function keyWordsMapping(e,t){return 0===e.indexOf(".this")?e.replace(".this",t.__getPath()):void 0}function buildVarPath(e,t,n){var i={};for(var r in t.subVars){var s=t.subVars[r],a=buildVarPath(e,s,r);i[r]=a}for(var o=!1,l="",h=0;h<t.words.length;h++){var c=t.words[h];if(c instanceof Array){if(i[c[0]]){l+=i[c[0]];continue}var p=keyWordsMapping(c[0],e);p?(o=!0,l+=p):l+=c[0]}else l+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var h=0;h<t.watchPathWords.length;h++){var c=t.watchPathWords[h];u+=c instanceof Array?i[c[0]]||c[0]:c}if(o||0===l.indexOf("impex._cs"))return l;var f=")"===n[n.length-1]?!1:!0,_=u||l;return _=f?".state"+_:"."+_.substr(1),e=varInComponent(e,_),e?(l=f?".state"+l:"."+l.substr(1),e.__getPath()+l):"self"+l}function varInComponent(e,t){return void 0!==getVarByPath(t,e.__getPath())?e:null}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,n,i){if(Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;")),e.__lastVal!==t&&3==n.nodeType){if(!e.__placeholder){var r=document.createComment("-- [html] placeholder --");n.parentNode.insertBefore(r,n),e.__lastVal=t,e.__placeholder=r,n.parentNode.removeChild(n)}e.__lastNodes&&DOMHelper.detach(e.__lastNodes);var s=document.createComment("-- [html] target --");e.__placeholder.parentNode.insertBefore(s,e.__placeholder);var a=DOMHelper.compile(t);if(!(a.length<1)){DOMHelper.replace(s,a),e.__lastNodes=a,e.__lastVal=t,a&&Scanner.scan(a,i),Builder.build(i),Renderer.render(i);for(var o=i.children.length;o--;)i.children[o].init();for(var o=i.directives.length;o--;)i.directives[o].init();for(var o=0;o<i.children.length;o++)i.children[o].__url||i.children[o].display();for(var o=i.directives.length;o--;)i.directives[o].active();return!0}}}this.render=function(e){renderExpNodes(e.__expNodes)},this.recurRender=function(e){var t=e.children;renderExpNodes(e.__expNodes);for(var n=t.length;n--;)Renderer.render(t[n])},this.renderExpNodes=renderExpNodes;var propMap={value:["INPUT"]};this.calcExpNode=calcExpNode,this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};View.prototype={__destroy:function(){for(var e in this.__evMap)for(var t=this.__evMap[e],n=t.length;n--;){var i=t[n],r=i[1];this.el.removeEventListener(e,r,!1)}DOMHelper.detach(this.__nodes)},__suspend:function(e,t){var n=this.__nodes[0].parentNode;if(n){t&&(this.__target=document.createComment("-- view suspended of ["+(e.name||"anonymous")+"] --"),n.insertBefore(this.__target,this.__nodes[0]));for(var i=this.__nodes.length;i--;)this.__nodes[i].parentNode&&n.removeChild(this.__nodes[i])}},on:function(e,t,n){if(this.el){var i=t,r=this instanceof Component?this:this.component,s="",a=null,o=function(t){var o=i;if(n instanceof Function&&(o=n.call(r,t,i)),o){if(s!=o){var l=lexer(o),h=Renderer.getExpEvalStr(r,l),c=h.replace("self.$event","$event");a=new Function("$event",c),s=o}try{a(t)}catch(p){LOGGER.debug("error in event '"+e+"'",p)}}};this.el.addEventListener(e,o,!1),this.__evMap[e]||(this.__evMap[e]=[]),this.__evMap[e].push([t,o])}},off:function(e,t){if(this.el)for(var n=this.__evMap[e],i=n.length;i--;){var r=n[i],s=r[0],a=r[1];s==t&&this.el.removeEventListener(e,a,!1)}},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},style:function(e,t){return arguments.length>1?(this.el.style[e]=t,this):this.el.style[e]},attr:function(e,t){return arguments.length>1?(this.el.setAttribute(e,t),this):this.el.getAttribute(e)},removeAttr:function(e){return this.el.removeAttribute(e),this},hasClass:function(e){return this.el.className.indexOf(e)>-1},addClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,""),e=e.split(" ");for(var t=this.el.className.split(" "),n="",i=e.length;i--;)t.indexOf(e[i])<0&&(n+=e[i]+" ");return this.el.className+=" "+n,this},removeClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");var t=e.split(" "),n=this.el.className;if(n){for(var i=t.length;i--;){var r=t[i],s=new RegExp("^"+r+"\\s+|\\s+"+r+"$|\\s+"+r+"\\s+","img");n=n.replace(s,"")}this.el.className=n}return this},toggleClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");for(var t=e.split(" "),n=!1,i=this.el.className,r=t.length;r--;){var s=t[r];if(i.indexOf(s)<0){n=!0;break}}n?this.addClass(e):this.removeClass(e)}},Component.state={created:"created",inited:"inited",displayed:"displayed",suspend:"suspend"},Util.inherits(Component,View),Util.ext(Component.prototype,{d:function(path,val){if(!path)return void LOGGER.warn("invalid path '"+path+"'");var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}return this}try{return eval(evalStr)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}},watch:function(e,t){var n=lexer(e),i=Object.keys(n.varTree);if(!(i.length<1)){if(i.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var r=n.varTree[i[0]],s=new Watch(t,this,r.segments);return Builder.buildExpModel(this,r,s),this}},add:function(e){this.children.push(e),e.parent=this},createSubComponentOf:function(e){var t=ComponentFactory.newInstanceOf(e.tagName.toLowerCase(),e);return this.children.push(t),t.parent=this,t},createSubComponent:function(e){var t=ComponentFactory.newInstance(e);return this.children.push(t),t.parent=this,t},init:function(){if(this.__state===Component.state.created){if(this.__url){var e=this;Util.loadComponent(this.__url,function(t){var n=t[0];ComponentFactory.register(e.name,t[1]),e.template=n,ComponentFactory.initInstanceOf(e.name,e),ComponentFactory.parse(n,e),e.__url=null,e.__init(n),e.display()})}else this.template&&ComponentFactory.parse(this.template,this),this.__init(this.template);return this}},__init:function(e){Scanner.scan(this.__nodes,this),LOGGER.log(this,"inited"),this.state=Observer.observe(this.state,this),Builder.build(this),this.__state=Component.state.inited,this.onInit&&this.onInit(e);for(var t=this.children.length;t--;)this.children[t].init();for(var t=this.directives.length;t--;)this.directives[t].init()},display:function(){if(this.__state!==Component.state.displayed&&this.__state!==Component.state.created){this.name&&(this.el.innerHTML="",DOMHelper.attach(this.el,this.__nodes)),Renderer.render(this),this.__nodes.forEach(function(e){if(e.querySelectorAll)for(var t=e.querySelectorAll("*["+ATTR_REF_TAG+"]"),n=t.length;n--;){var i=t[n];this.els[i.getAttribute(ATTR_REF_TAG)]=i}},this),this.__state=Component.state.displayed,LOGGER.log(this,"displayed");for(var e=0;e<this.children.length;e++)this.children[e].templateURL||this.children[e].display();for(var e=this.directives.length;e--;)this.directives[e].active();this.onDisplay&&this.onDisplay()}},destroy:function(){if(null!==this.__state){if(LOGGER.log(this,"destroy"),this.onDestroy&&this.onDestroy(),this.parent){var e=this.parent.children.indexOf(this);e>-1&&this.parent.children.splice(e,1),this.parent=null}for(this.__destroy(this);this.children.length>0;)this.children[0].destroy();for(var e=this.directives.length;e--;)this.directives[e].destroy();this.children=this.directives=this.__expNodes=this.__expDataRoot=null,impex._cs[this.__id]=null,delete impex._cs[this.__id],this.__state=this.__id=this.__url=this.template=this.restrict=this.events=this.state=null}},suspend:function(e){this.__state===Component.state.displayed&&(LOGGER.log(this,"suspend"),this.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.__state=Component.state.suspend)},__getPath:function(){return'impex._cs["'+this.__id+'"]'},__update:function(e){for(var t=!0,n=[],i=[],r=[],s=[],a=e.length;a--;){var o=e[a],l={name:o.name,newVal:o.newVal,oldVal:o.oldVal,type:o.type,path:o.path,object:o.object};n.push(l);for(var h=o.expProps,c=h.length;c--;){for(var p=h[c].expNodes,u=p.length;u--;){var f=p[u];i.indexOf(f)<0&&i.push(f)}for(var _=h[c].attrObserveNodes,u=_.length;u--;){var d=_[u];s.indexOf(d)<0&&s.push(d)}for(var v=h[c].watchs,u=v.length;u--;){var m=v[u];r.indexOf(m)<0&&r.push([m,l])}}}this.onUpdate&&(t=this.onUpdate(n)),t!==!1&&Renderer.renderExpNodes(i),this.__updateDirective(s),this.__callWatchs(r),this.__updateChildrenProps(n)},__updateChildrenProps:function(e){for(var t={},n=e.length;n--;){var i=e[n],r=i.path;this.__watchProps.forEach(function(e){var n=this.__isVarMatch(e.segments,r);if(n){t[e.subComp.__id]||(t[e.subComp.__id]=[]);var i=Renderer.evalExp(this,e.expWords);t[e.subComp.__id].push({name:e.name,oldVal:e.oldVal,newVal:i}),e.oldVal=i}},this)}for(var s in t){var a=t[s];impex._cs[s].__propChange&&impex._cs[s].__propChange(a)}},__isVarMatch:function(e,t){if(e.length<t.length)return!1;for(var n=0;n<e.length&&t[n];n++)if("["!==e[n][0]&&"["!==t[n][0]&&e[n]!==t[n])return!1;return!0},__callWatchs:function(e){for(var t=[],n=e.length;n--;){var i=e[n][1],r=e[n][0],s=i.path,a=i.newVal,o=i.oldVal,l=i.name,h=i.object,c=i.type;if(!(r.segments.length<s.length||t.indexOf(r)>-1)){var p=this.__isVarMatch(r.segments,s);if(p){var u=a,f=o;if(r.segments.length>s.length){for(var _=r.segments.slice(v),d="$var",v=0;v<_.length;v++){var m=_[v];d+="["===m[0]?m:"."+m}try{u=new Function("$var","return "+d)(a),f=new Function("$var","return "+d)(o)}catch(g){LOGGER.debug("error on parse watch params",g),u=null}}r.cbk&&r.cbk.call(r.ctrlScope,h,l,c,u,f,s),t.push(r)}}}},__updateDirective:function(e){for(var t=e.length;t--;){var n=e[t],i=Renderer.evalExp(n.directive.component,n.expObj);n.directive.onUpdate(i)}},__propChange:function(e){for(var t={},n={},i=e.length;i--;){var r=e[i],s=r.name;this.__props[s]=r.newVal,n[s]=r.newVal,this.__watchProps.forEach(function(e){var n=e.fromPropKey;if(n&&("["===n[0]||n===s)){t[e.subComp.__id]||(t[e.subComp.__id]=[]);var i=Renderer.evalExp(this,e.expWords);t[e.subComp.__id].push({name:e.name,oldVal:e.oldVal,newVal:i}),e.oldVal=i}},this)}var a=!0;if(this.onPropUpdate&&(a=this.onPropUpdate(e)),a!==!1)for(var o in n)this.state[o]=n[o];for(var o in t){var l=t[o];impex._cs[o].__propChange&&impex._cs[o].__propChange(l)}}});var DOMHelper=new function(){this.singleton=!0;var e=document.createElement("div");this.compile=function(t){var n=[];for(e.innerHTML=t;e.childNodes.length>0;){var i=e.removeChild(e.childNodes[0]);n.push(i)}return n},this.detach=function(e){var t=e[0].parentNode;if(t){e[0].__impex__view&&(e[0].__impex__view=null);for(var n=e.length;n--;)e[n].parentNode&&t.removeChild(e[n])}},this.attach=function(e,t){var n=null;if(t.length>1){n=document.createDocumentFragment();for(var i=0;i<t.length;i++)n.appendChild(t[i])}else n=t[0];

e.appendChild(n),n=null},this.replace=function(e,t){var n=null;if(t.length>1){n=document.createDocumentFragment();for(var i=0;i<t.length;i++)n.appendChild(t[i])}else n=t[0];e.parentNode.replaceChild(n,e),n=null},this.insertBefore=function(e,t){var n=t.parentNode,i=e[0];if(e.length>1){i=document.createDocumentFragment();for(var r=0;r<e.length;r++)i.appendChild(e[r])}n&&n.insertBefore(i,t)}};Util.inherits(Directive,View),Util.ext(Directive.prototype,{init:function(){if(this.__state!=Component.state.inited){var e=Scanner.getExpNode(this.value,this.component),t=e&&Renderer.calcExpNode(e);t&&(this.value=t),LOGGER.log(this,"inited"),this.onInit&&this.onInit(),this.__state=Component.state.inited}},active:function(){if(this.onUpdate){var e=lexer(this.value);for(var t in e.varTree){var n=e.varTree[t],i=new AttrObserveNode(this,e);this.component&&Builder.buildExpModel(this.component,n,i)}var r=Renderer.evalExp(this.component,e);this.onUpdate(r)}this.onActive&&this.onActive()},destroy:function(){LOGGER.log(this,"destroy"),this.__destroy(this),this.component=this.params=this.filter=this.onUpdate=null,this.onDestroy&&this.onDestroy()}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},TESTNODE;Transition.prototype={enter:function(){this.__start="enter",this.__css&&this.__view.addClass(this.__type+"-enter"),this.__direct.enter&&this.__direct.enter(),this.__hook.enter&&this.__hook.enter.call(this.__direct,this.__enterDone.bind(this)),this.__css&&(this.__view.el.offsetHeight,this.__view.removeClass(this.__type+"-enter"))},__enterDone:function(){},leave:function(){this.__start="leave",this.__css&&this.__view.addClass(this.__type+"-leave"),this.__hook.leave&&(this.__leaveDone.__trans=this,this.__hook.leave.call(this.__direct,this.__leaveDone.bind(this)))},__leaveDone:function(){this.__direct.leave&&this.__direct.leave()},__done:function(e){if(!(e.elapsedTime<this.__longest)&&this.__start){switch(this.__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.__start="",this.__view.removeClass(this.__type+"-leave")}}},Factory.prototype={register:function(e,t,n){e=e.toLowerCase();var i=t.state;delete t.state;var r={};if("string"==typeof t?i=t:Util.ext(r,t),this.types[e])return this.types[e].state=i,void(this.types[e].props=r);var s=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)");Util.inherits(s,this.baseClass),this.types[e]={clazz:s,props:r,services:n,state:i}},hasTypeOf:function(e){return e in this.types},createCbk:function(e,t){if(e.onCreate){var n=null;if(this.types[t].services){n=[];for(var i=0;i<this.types[t].services.length;i++){var r=ServiceFactory.newInstanceOf(this.types[t].services[i],e);n.push(r)}}n?e.onCreate.apply(e,n):e.onCreate()}}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.restrict},parse:function(e,t){var n=t.el.attributes,i=t.el.innerHTML,r=slotHandler(e,i),s=null;if(this.types[t.name].parseCache)r=this.types[t.name].parseCache;else{var a=peelCSS(r);if(r=a[1],s=a[0],s=cssHandler(t.name,s),this.types[t.name].parseCache=r,s.trim().length>0){var o=document.head.children[0];if(o){var l=DOMHelper.compile(s);DOMHelper.insertBefore(l,o)}else document.head.innerHTML=s}}var l=DOMHelper.compile(r);t.__nodes=l;var h={},c=t.propTypes;if(c)for(var p in c){var u=c[p];u.require&&(h[p]=u)}if(n)for(var f=n.length;f--;){var p=n[f].name.toLowerCase(),_=n[f].value;if(p!=ATTR_REF_TAG){var d=null;if(REG_CMD.test(p)){var v=p.replace(CMD_PREFIX,""),m=v.indexOf(CMD_PARAM_DELIMITER);m>-1&&(v=v.substring(0,m)),DirectiveFactory.hasTypeOf(v)&&(d=DirectiveFactory.newInstanceOf(v,t.el,t,p,_))}else if(0===p.indexOf(CMD_PARAM_DELIMITER))d=DirectiveFactory.newInstanceOf("on",t.el,t,p,_);else{if(!t.parent)continue;handleProps(p,_,h,c,t)}d&&d.init()}else{var g=Scanner.getExpNode(_,t),y=g&&Renderer.calcExpNode(g);t.parent.refs[y||_]=t}}var b=Object.keys(h);return b.length>0?void LOGGER.error("props ["+b.join(",")+"] of component["+t.name+"] are required"):void 0},newInstance:function(e,t){var n=null;1===e.length&&(n=e[0]);var i=new this.baseClass;return i.el=n,i.__nodes=e,t&&Util.ext(i,t),i},newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass);n.name=e,n.el=t;var i=this.types[e].state;return"string"==typeof i?n.__url=i:this.initInstanceOf(e,n),this._super.createCbk.call(this,n,e),n},initInstanceOf:function(e,t){if(!this.types[e])return null;Util.ext(t,this.types[e].props);var n=this.types[e].state;n&&Util.ext(t.state,n)}});var ComponentFactory=new _ComponentFactory(DOMHelper);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props["final"]},hasEndTag:function(e){return this.types[e].props.endTag},priority:function(e){return this.types[e].props.priority},newInstanceOf:function(e,t,n,i,r){if(!this.types[e])return null;var s=null,a=null,o=i.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=i.substr(o+1);var l=s.indexOf(CMD_FILTER_DELIMITER);l>-1&&(a=s.substr(l+1),s=s.substring(0,l)),s=s.split(CMD_PARAM_DELIMITER)}var h=new this.types[e].clazz(this.baseClass,i,r,n);if(Util.ext(h,this.types[e].props),t.__impex__view){var c=t.__impex__view;h.el=c[0],h.__nodes=c[1]}else{var p=t,u=[t];Util.isArray(t)&&(u=t,p=t.length>1?null:t[0]),h.el=p,h.__nodes=u,t.__impex__view=[p,u]}if(s&&(h.params=s),a&&(h.filter=a),n.directives.push(h),h.component=n,h.__nodes[0].removeAttribute(h.name),h.endTag){var f=h.__nodes[h.__nodes.length-1];f.removeAttribute(CMD_PREFIX+h.endTag)}return this._super.createCbk.call(this,h,e),h}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass,t);return Util.ext(n,this.types[e].props),this._super.createCbk.call(this,n,e),n}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var n=null;return this.types[e].props.singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),n=this.types[e].singleton):n=new this.types[e].clazz(this.baseClass),Util.ext(n,this.types[e].props),n.host=t,this._super.createCbk.call(this,n,e),n}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var n=new Transition(e,t,this.hooks[e]);return n}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_CMD=/x-.*/,ATTR_REF_TAG="ref",PROP_TYPE_PRIFX=".",PROP_SYNC_SUFX=":sync",PROP_SYNC_SUFX_EXP=/:sync$/,EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},im_counter=0,impex=new function(){function e(e){var n=e;do{if(t.indexOf(n)>-1)return!0;n=n.parentNode}while(n);return!1}this.version={v:[0,31,0],state:"beta",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},this.logger=LOGGER},this.component=function(e,t,n){return"string"==typeof t||t.template?(ComponentFactory.register(e,t,n),this):void LOGGER.error("can not find property 'template' of component '"+e+"'")},this.directive=function(e,t,n){return DirectiveFactory.register(e,t,n),this},this.service=function(e,t,n){return ServiceFactory.register(e,t,n),this},this.filter=function(e,t,n){return FilterFactory.register(e,t,n),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.unitTest=function(e,t){window.onload=function(){var n=location.href.substr(location.href.lastIndexOf("/"));impex.component(e,"."+n),impex.render(document.querySelector(t))}},this.render=function(n,i,r){if(!n)return void LOGGER.error("invalid element, can not render");var s=n.tagName.toLowerCase();if(e(n))return void LOGGER.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,n);if(a||(t.push(n),a=ComponentFactory.newInstance([n],i)),a.onCreate){var o=null;if(Util.isArray(r)){o=[];for(var l=0;l<r.length;l++){var h=ServiceFactory.newInstanceOf(r[l],a);o.push(h)}}o?a.onCreate.apply(a,o):a.onCreate()}return a.init(),a.display(),a};var t=[];Object.defineProperty(this,"_cs",{enumerable:!1,writable:!0,value:{}}),this.logger=LOGGER};impex.service("DOMHelper",DOMHelper),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,n,i){for(var r=e.__expNodes.length;r--;){var s=e.__expNodes[r];s.node==n&&"class"===s.attrName&&(s.origin=i)}for(var a=e.children.length;a--;)t(e.children[a],n,i)}function n(){function e(e,t){for(var n={str:{},type:{},sync:{}},i=["cache","over","step","transition"],r=e[0],s=r.attributes.length;s--;){var a=r.attributes[s],o=a.nodeName;if(!(i.indexOf(o)>-1)){var l=a.nodeValue;if(o[0]===PROP_TYPE_PRIFX){var h=lexer(l),c=Renderer.evalExp(t,h),p=o.substr(1);if(PROP_SYNC_SUFX_EXP.test(p)){var u=Object.keys(h.varTree),f=p.replace(PROP_SYNC_SUFX_EXP,"");n.sync[f]=[h,c,u]}else n.type[p]=Util.immutable(c)}else n.str[o]=l}}return n}function t(e,t,n){for(var i=[],r=e;t>=r;r+=n)i.push(r);return i}function n(e){for(var t=0;t<e.children.length;t++){var i=e.children[t];i.onDisplay&&i.onDisplay(),i.children.length>0&&n(i)}}function i(e,t){if(null===e)return null;var n=e;if(e instanceof Array){n=e.concat();for(var r=n.length;r--;)n[r]=i(n[r],t)}else if(Util.isObject(e)){n={};var s=Object.keys(e);if(s.length>0)for(var a=t===!1?!1:!e.__im__origin,r=s.length;r--;){{var o=s[r];e[o]}0!==o.indexOf("__im__")&&(n[o]="object"==typeof e[o]?i(e[o],a):e[o])}t===!1||n.__im__origin||(n.__im__origin=e)}return n}function r(e,t){setTimeout(function(){for(var n=e.splice(0,50),i=0;i<n.length;i++)n[i].__state!==Component.state.suspend&&(n[i].__state=Component.state.inited,n[i].display());e.length>0?r(e,t):t.over&&t.over()},0)}this.onCreate=function(e,t){this.eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.forExp=/^\s*(\d+|[a-zA-Z_$](.+)?)\s+to\s+(\d+|[a-zA-Z_$](.+)?)\s*$/,this.DOMHelper=e,this.fragment=document.createDocumentFragment(),this.expInfo=this.parseExp(this.value),this.cache=[],this.__comp=this.component,this.el?(this.__tagName=this.el.tagName.toLowerCase(),this.__isComp=ComponentFactory.hasTypeOf(this.__tagName),this.cacheable="false"===this.attr("cache")?!1:!0):this.cacheable="false"===this.__nodes[0].getAttribute("cache")?!1:!0,this.subComponents=[],this.cacheSize=20,this.step=this.el?this.attr("step"):this.__nodes[0].getAttribute("step"),this.over=this.el?this.attr("over"):this.__nodes[0].getAttribute("over");var n=this.el?this.attr("transition"):this.__nodes[0].getAttribute("transition");null!==n&&(this.trans=n,this.ts=t)},this.onInit=function(){var n=this;if(this.forExp.test(this.expInfo.ds)){var i=RegExp.$1,r=RegExp.$3,s=parseFloat(this.step);if(0>s)return void LOGGER.error("step <= 0 : "+s);s=s||1,isNaN(i)&&(this.component.watch(i,function(e,i,a,o,l){var h=t(o>>0,r,s);n.lastDS=h,n.rebuild(h,n.expInfo.k,n.expInfo.v)}),i=this.component.d(i)),isNaN(r)&&(this.component.watch(r,function(e,r,a,o,l){var h=t(i,o>>0,s);n.lastDS=h,n.rebuild(h,n.expInfo.k,n.expInfo.v)}),r=this.component.d(r)),i=parseFloat(i),r=parseFloat(r),this.ds=t(i,r,s)}else this.ds=this.component.d(this.expInfo.ds),this.component.watch(this.expInfo.ds,function(e,t,i,r){return n.ds?(n.lastDS=Util.isArray(r)?r:e,void n.rebuild(n.lastDS,n.expInfo.k,n.expInfo.v)):(n.ds=n.component.d(n.expInfo.ds),n.lastDS=n.ds,void n.build(n.ds,n.expInfo.k,n.expInfo.v))});if(this.over){var a=lexer(this.over),o=Renderer.evalExp(this.__comp,a);this.over=o}this.lastDS=this.ds,this.placeholder=document.createComment("-- directive [each] placeholder --"),this.DOMHelper.insertBefore([this.placeholder],this.__nodes[0]),this.fragmentPlaceholder=document.createComment("-- fragment placeholder --"),this.fragment.appendChild(this.fragmentPlaceholder),this.__props=e(this.__nodes,this.component),this.ds&&this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy()},this.rebuild=function(e,t,i){e=this.doFilter(e);var r=e.length-this.subComponents.length;if(0>r){var s=this.subComponents.splice(0,-1*r);if(this.cache.length<this.cacheSize){for(var a=s.length;a--;)this.cache.push(s[a]);for(var a=this.cache.length;a--;)this.trans&&!this.cache[a].__leaving&&"displayed"===this.cache[a].__state?(this.cache[a].__leaving=!0,this.cache[a].transition.leave()):this.cache[a].suspend(!1)}else for(var a=s.length;a--;)s[a].destroy()}else if(r>0){var o=r;if(this.cacheable){for(var s=this.cache.splice(0,r),a=0;a<s.length;a++)this.subComponents.push(s[a]),this.DOMHelper.insertBefore(s[a].__nodes,this.placeholder);var o=r-s.length}for(;o--;)this.createSubComp()}var l=Util.isArray(e)?!0:!1,h=0;for(var c in e)if(e.hasOwnProperty(c)&&(!l||!isNaN(c))){var p=this.subComponents[h],u=e[c];if(e[c]&&e[c].__im__origin&&(u=e[c].__im__origin,e[c].__im__origin=null,delete e[c].__im__origin),"object"==typeof u){for(var a=u.__im__extPropChain.length;a--&&u.__im__extPropChain[a][0]!==this;);u.__im__extPropChain.splice(a,1),u.__im__extPropChain.push([this,i,h])}var f=p.state.__im__target||p.state;f[i]=u,f.$index=h++,t&&(f[t]=l?c>>0:c),p.__state===Component.state.created&&p.init(),p.display(),"displayed"===p.__state&&Renderer.recurRender(p),n(p)}},this.createSubComp=function(){for(var e=this.__comp,t=null,n=[],i=this.__nodes.length;i--;){var r=this.__nodes[i].cloneNode(!0);n.unshift(r)}this.__isComp?(this.DOMHelper.insertBefore(n,this.placeholder),t=e.createSubComponentOf(n[0])):(this.DOMHelper.insertBefore(n,this.placeholder),t=e.createSubComponent(n)),t.suspend(!0),this.subComponents.push(t);for(var s in this.__props.sync){var a=this.__props.sync[s],o=a[0],l=a[1],h=a[2];h.forEach(function(n){if(!o.varTree[n].isFunc){var i=new Prop(t,s,o.varTree[n].segments,o,l);e.__watchProps.push(i)}}),t.state[s]=l}for(var s in this.__props.str)t.state[s]=this.__props.str[s];for(var s in this.__props.type){var c=this.__props.type[s];c instanceof Function?t[s]=c:t.state[s]=c}if(this.trans){var p=this;t.onInit=function(){this.transition||(this.transition=p.ts.get(p.trans,this))},t.onDisplay=function(){this.transition.enter()},t.leave=function(){this.suspend(!1),this.__leaving=!1}}return t},this.doFilter=function(e){if(!this.filters)return e;var t=this.filters;if(Object.keys(t).length>0){e&&Util.isObject(e)&&(e=i(e));for(var n in t){for(var r=t[n][0],s=t[n][1],a=[],o=s.length;o--;){var l=s[o];l.varTree&&l.words&&(l=Renderer.evalExp(this.__comp,l)),a[o]=l}r.value=e,e=r.to.apply(r,a)}return e}},this.build=function(e,t,n){var i=Util.isArray(e)?!0:!1,s=0;e=this.doFilter(e),e.__im__extPropChain&&e.__im__extPropChain.push([this,n]);for(var a in e)if(e.hasOwnProperty(a)&&(!i||!isNaN(a))){var o=this.createSubComp(),l=e[a];e[a]&&e[a].__im__origin&&(l=e[a].__im__origin,e[a].__im__origin=null,delete e[a].__im__origin),"object"==typeof l&&l.__im__extPropChain.push([this,n,s]);var h=o.state.__im__target||o.state;h[n]=l,h.$index=s++,t&&(h[t]=i?a>>0:a)}for(var c=this.subComponents.length;c--;)this.subComponents[c].init(),this.subComponents[c].__state=Component.state.displayed;var p=this.subComponents.concat();r(p,this)},this.over=function(){alert("sdfdsf")},this.parseExp=function(e){var t,n,i,r=this;return e.replace(this.eachExp,function(e,s,a,o){t=s;var l=a.replace(/\s/gm,""),h=l.split(",");if(h.length>1?(n=h[0],i=h[1]):i=h[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,r.parent);r.filters=c;for(var u in p)r.component.watch(u,function(){r.lastDS&&r.rebuild(r.lastDS,r.expInfo.k,r.expInfo.v)})}}),t?{ds:t,k:n,v:i}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{"final":!0}).directive("on",{onInit:function(){for(var e=this.params.length;e--;)this.on(this.params[e],this.value)}}).directive("text",{onUpdate:function(e){this.el.innerText=e}}).directive("bind",{onInit:function(){(!this.params||this.params.length<1)&&LOGGER.warn("at least one attribute be binded")},onUpdate:function(e){if(this.params&&!(this.params.length<1)){var t=null;if(this.filter&&(t=this.component[this.filter]),t){var n=t(e);if(!Util.isUndefined(n)&&!n)return}for(var i=this.params.length;i--;){var r=this.params[i];this.attr(r,e)}}}}).directive("show",{onCreate:function(e){var t=this.attr("transition");null!==t&&(this.transition=e.get(t,this)),this.lastRs=!1,this.exec(!1)},onUpdate:function(e){this.component.__state!==Component.state.suspend&&e!==this.lastRs&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){e?this.show():this.hide()}},["Transitions"]).directive("show-start",{endTag:"show-end",onInit:function(){Scanner.scan(this.__nodes,this.component)},onUpdate:function(e){if(this.component.__state!==Component.state.suspend){var t=this.__nodes;if(e)for(var n=t.length;n--;)t[n].style&&(t[n].style.display="");else for(var n=t.length;n--;)t[n].style&&(t[n].style.display="none")}}}).directive("if",{onCreate:function(e,t){this.DOMHelper=e,this.placeholder=document.createComment("-- directive [if] placeholder --");var n=this.attr("transition");null!==n&&(this.transition=t.get(n,this)),this.lastRs=!1,this.exec(!1)},onUpdate:function(e){this.component.__state!==Component.state.suspend&&(e!==this.lastRs||this.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.el.parentNode)return;this.placeholder.parentNode.replaceChild(this.el,this.placeholder)}else{if(!this.el.parentNode)return;this.el.parentNode.replaceChild(this.placeholder,this.el)}}},["DOMHelper","Transitions"]).directive("if-start",{endTag:"if-end",onCreate:function(e){this.DOMHelper=e,this.placeholder=document.createComment("-- directive [if] placeholder --")},onInit:function(){Scanner.scan(this.__nodes,this.component)},onUpdate:function(e){if(this.component.__state!==Component.state.suspend)if(e){if(this.__nodes[0].parentNode)return;this.DOMHelper.replace(this.placeholder,this.__nodes)}else{if(!this.__nodes[0].parentNode)return;var t=this.__nodes[0].parentNode;t.insertBefore(this.placeholder,this.__nodes[0]),this.DOMHelper.detach(this.__nodes)}}},["DOMHelper"]).directive("cloak",{onCreate:function(){var e=this.attr("class");return e?(e=e.replace("x-cloak",""),void(this.__cn=e)):void LOGGER.warn("can not find attribute[class] of element["+this.el.tagName+"] which directive[cloak] on")},onActive:function(){t(this.component,this.el,this.__cn);var e=this.attr("class").replace("x-cloak","");this.attr("class",e)}}).directive("model",{onCreate:function(){var e=this.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=this.attr("type");switch(t){case"radio":this.on("click",null,this.changeModel.bind(this));break;case"checkbox":this.on("click",null,this.changeModelCheck.bind(this));break;default:var n=null===document.body.onpropertychange?"propertychange":"input";this.on(n,null,this.changeModel.bind(this))}break;case"select":var i=e.getAttribute("multiple");null!==i?this.on("change",null,this.changeModelSelect.bind(this)):this.on("change",null,this.changeModel.bind(this))}},changeModelSelect:function(e){for(var t=e.target||e.srcElement,n=(t.value,[]),i=t.options.length;i--;){var r=t.options[i];r.selected&&n.push(r.value)}this.component.d(this.value,n)},changeModelCheck:function(e){var t=e.target||e.srcElement,n=t.value,i=this.component.d(this.value);if(i instanceof Array||(i=[i]),t.checked)i.push(n);else{var r=i.indexOf(n);r>-1&&i.splice(r,1)}this.component.d(this.value,i)},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.component.d(this.value,t)}});var i=new n;i["final"]=!0,i.priority=999,e.directive("each",i,["DOMHelper","Transitions"]);var r=new n;r.endTag="each-end",r.priority=999,e.directive("each-start",r,["DOMHelper"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.value)}}).filter("filterBy",{to:function(e,t){var n=this.value;if(!(n instanceof Array))return LOGGER.warn("can only filter array"),this.value;var i=[];if(e instanceof Function)for(var r=n.length;r--;){var s=e.call(this,n[r]);s&&i.unshift(n[r])}else for(var r=n.length;r--;){var a=n[r];t?(!e||(a[t]+"").indexOf(e)>-1)&&i.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&i.unshift(a)}return i}}).filter("limitBy",{to:function(e,t){return this.value instanceof Array?e?this.value.splice(t||0,e):this.value:(LOGGER.warn("can only filter array"),this.value)}}).filter("orderBy",{to:function(e,t){return e||t?this.value instanceof Array?(this.value.sort(function(t,n){var i=e?t[e]:t,r=e?n[e]:n;return"string"==typeof i?i.localeCompare(r):"number"==typeof i?i-r:(i+"").localeCompare(r)}),"desc"===t&&this.value.reverse(),this.value):(LOGGER.warn("can only filter array"),this.value):this.value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);