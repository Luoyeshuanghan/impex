/*
 * impexjs is a powerful web application engine to build 
 * reactive webUI system
 *
 *
 * Copyright 2015-2016 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://impexjs.org
 * last build: 2016-07-11
 */
!function(global){"use strict";function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,r,i,n,s){this.node=e,this.attrName=t,this.origin=r,this.expMap=i,this.component=n,this.toHTML=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,r){this.cbk=e,this.ctrlScope=t,this.segments=r}function Component(e){var t="C_"+im_counter++;this.__id=t,this.__state=Component.state.created,this.view=e,this.name,this.parent,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,this.__watcher,this.__eventMap={},this.template,this.templateURL,this.replace=!0,this.restrict,this.isolate,this.data={},this.methods={},this.events={}}function broadcast(e,t,r){for(var i=0;i<e.length;i++){var n=e[i],s=n.__eventMap[t],a=!0;if(s){a=!1;for(var o=0;o<s.length;o++)a=s[o].apply(n,r)}a&&n.children.length>0&&broadcast(n.children,t,r)}}function View(e,t,r){this.el=e,this.__nodes=r,this.__evMap={},this.__target=t}function tmplExpFilter(e,t,r){return e=e.replace(REG_TMPL_EXP,function(e,i){var i=i.replace(/\s/gm,"");if("CONTENT"===i)return t;if("BINDPROPS"===i){for(var n="",s=Object.keys(r),a=s.length;a--;)n+=r[s[a]].nodeName+'="'+r[s[a]].nodeValue+'" ';return n}var o=r[i]&&r[i].nodeValue;return o||""})}function Directive(e,t){Component.call(this),this.value=t,this.name=e,this.params,this.filter,this["final"]=!1,this.endTag=null,this.priority=0,this.observe}function Filter(e){this.component=e,this.value,this.onCreate}function Service(){this.singleton,this.host,this.onCreate}function Transition(e,t,r){if(TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE)),r&&r.css===!1)this.__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var i=window.getComputedStyle(TESTNODE,null),n=i["transition-duration"].split(","),s=i["transition-delay"].split(","),a=-1,o=n.length;o--;){var l=parseFloat(n[o]),h=parseFloat(s[o]);l+h>a&&(a=l+h)}if(a>0){var c=t.view,p=t.__expNodes;p.length<1&&t.parent&&(p=t.parent.__expNodes);for(var o=p.length;o--;){var u=p[o];"class"===u.attrName&&(u.origin+=" "+e+"-transition")}c.addClass(e+"-transition"),this.__longest=a;var v=null;for(var d in TRANSITIONS)if(void 0!==c.el.style[d]){v=TRANSITIONS[d];break}c.el.addEventListener(v,this.__done.bind(this),!1),this.__css=!0}}this.__comp=t,this.__view=c,this.__hook=r||{},this.__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function r(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&(n[this.url]||(n[this.url]=this.responseText),this.cbk&&this.cbk(this.responseText))}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype._super=t.prototype},this.ext=function(e,t){for(var r=Object.keys(t),i=r.length;i--;){var n=r[i];e[n]=t[n]}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var i=document.createElement("div");this.isDOMStr=function(e){return i.innerHTML=e,i.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName};var n={};this.loadTemplate=function(i,s,a){if(n[i])return void(s&&s(n[i]));var o=new XMLHttpRequest;o.open("get",i,!0),o.timeout=a||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=r:o.onreadystatechange=r,o.cbk=s,o.url=i,o.send(null)}},RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),fallback=Object.observe?!1:!0,observedObjects=[],observedOldObjects=[],observedArys=[],observedOldArys=[],Object_observe=Object.observe||function(e,t){var r={};for(var i in e){var n=e[i];r[i]=n}observedOldObjects.push(e),observedObjects.push({oldVer:r,newVer:e,handler:t})},Object_unobserve=Object.unobserve||function(e,t){var r=observedOldObjects.indexOf(e);r>-1&&(observedObjects.splice(r,1),observedOldObjects.splice(r,1))},Array_observe=Array.observe||function(e,t){var r=[];if(!(e instanceof Array))throw new Error("Array.observe cannot observe non-array");for(var i=e.length;i--;)r.unshift(e[i]);observedOldArys.push(e),observedArys.push({oldVer:r,newVer:e,handler:t})},Array_unobserve=Array.unobserve||function(e,t){var r=observedOldArys.indexOf(e);r>-1&&(observedArys.splice(r,1),observedOldArys.splice(r,1))};fallback&&function e(){RAF(function(){for(var t=observedObjects.length;t--;){var r=observedObjects[t],i=r.oldVer,n=r.newVer,s=r.handler,a=[];for(var o in i){if(void 0===n[o]){var l={};l.name=o,l.oldValue=i[o],l.object=n,l.type="delete",a.push(l)}if(n[o]!==i[o]){var l={};l.name=o,l.oldValue=i[o],l.object=n,l.type="update",a.push(l)}}for(var o in n)if(void 0===i[o]){var l={};l.name=o,l.oldValue=i[o],l.object=n,l.type="add",a.push(l)}if(a.length>0){s(a),r.oldVer={};for(var o in n){var h=n[o];r.oldVer[o]=h}}}for(var t=observedArys.length;t--;){var r=observedArys[t],i=r.oldVer,n=r.newVer,s=r.handler,l=null;if(i.length===n.length){for(var c=i.length;c--;)if(n[c]!==i[c]){l={},l.type="update";break}}else if(i.length>n.length)l={},l.type="delete";else{var l={};l.type="add"}if(l){l.object=n,l.oldValue=i,s([l]),r.oldVer=[];for(var p=0;p<n.length;p++)r.oldVer.push(n[p])}}e()})}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,n){if(o.test(e)){var s=i(n,t);return c="var",s}return a.test(e)?(c="str",r(t,RegExp.$1)):(c="",e)}function r(e,t){for(var r=!1,i=t,n=1;n<e.length;n++){var s=e[n];if("\\"!==s){if(!r&&s===t)return i+t;i+=s,r=!1}else r=!0,i+=s}}function i(r,n,s,a){for(var c="",p=[],u=-1,v=-1,d=-1,f=a||e(),_=0;_<n.length;_++){var g=n[_];if(p.length>0)if(o.test(g)){var m=e(),b=i(r,n.substr(_),!0,m);_=_+b.length-1;var y=b;o.test(b[0])&&h.indexOf(y)<0&&(f.subVars["."+b]=m,h.indexOf(y)<0&&(y=["."+y])),f.words.push(y)}else if("]"===g||")"===g){if(p.pop(),0===p.length){var w=n.substring(u,_+1);c+=w,f.segments.push(w),d=_}")"===g&&(f.isFunc=!0),f.words.push(g),v=_}else{var x=t(g,n.substr(_),r);_=_+x.length-1,f.words.push(x),v=_}else if(l.test(g)){if(c+=g,"."===g){var y=c.substr(d+1);y=y.replace(/\./,""),y&&(f.segments.push(y),d=_)}}else{if("["!==g&&"("!==g){if("]"!==g&&")"!==g||!s){var y=c.substr(v+1);y&&("."!==y[0]&&h.indexOf(y)<0&&(y=["."+y]),f.words.push(y));var E=c.substr(d+1);return E&&(f.segments.push(E),d=_),!s&&h.indexOf(y)<0&&(r["."+c]=f),c}var y=c;if(y[y.length-1]!==g){y=y.substring(v+1,y.length),y&&f.words.push(0===n.indexOf(y)?["."+y]:y);var C=y.lastIndexOf(".");C>0&&(y=y.substr(C)),y&&f.segments.push(y),d=_}return v=_,c}p.push(g),u=_,f.brakLength++;var O=c.substr(v+1);if(O){var y=O;h.indexOf(O)<0&&0>v&&(y=["."+O]),f.words.push(y)}f.words.push(g);var T="["===g?"]":")";if(c[_-1]!==T){var R=O.lastIndexOf(".");R>-1?(O=O.substr(R),f.segments.push(O)):O&&f.segments.push(O),d=_}v=_}}var F=c.substr(c.lastIndexOf("]")+1),M=c.substr(c.lastIndexOf(")")+1);if(F&&M){var A=F.length<M.length?F:M,E=c.substr(d+1);f.segments.push(E);var y="["===A[0]||"("===A[0]?A:"."===A[0]?A:"."+A;f.words.length<1&&h.indexOf(y)<0&&(y=[y]),f.words.push(y)}return s||(r["."+c]=f),c}function n(e){for(var t in e){var r=e[t],i=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,r.brakLength);var l="]"===t[t.length-1]?"[":"(",h=r.brakLength;r.watchPathWords=[];for(var c=0;c<r.words.length;c++){var p=r.words[c];if(p===l&&--h<1)break;r.watchPathWords.push(p)}}else r.watchPathWords=r.words.concat(),r.watchPathWords.splice(-1,1);i=t.substr(o),r.lastVar="("===i[0]?t:i,Object.keys(r.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),r.watchPath=a);for(var c=r.segments.length;c--;)r.segments[c]=r.segments[c].replace(/^\.|\.$/g,"");n(r.subVars)}}function s(e,t){for(var r=0;r<e.length;r++){var i=e[r];if(("["===i||"("===i)&&--t<1)return r}}var a=/(['"])/,o=/[a-zA-Z$_]/,l=/[a-zA-Z$_0-9.]/,h=["as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var r=[],i={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),i);switch(s=s+o.length-1,c){case"var":r.push(h.indexOf(o)<0?["."+o]:o);break;case"str":case"":r.push(o)}}return n(i),console.log("输入",e),console.log("校验",r.join("")),console.log("分词",JSON.stringify(r)),console.log("变量tree",i),p[e]={words:r,varTree:i},p[e]}}(),Scanner=new function(){function e(e){var r=[],i=[];t(e,r);for(var n=r.length;n--;){var e=r[n],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,r){var i=s.substring(o,r);i&&a.push(i),a.push(e),o=r+e.length});var l=s.substring(o,s.length);if(l&&a.push(l),a.length<2)i.unshift(null);else{for(var h=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);h.appendChild(p)}i.unshift(h)}}for(var c=r.length;c--;){var u=r[c];i[c]&&i[c].childNodes.length>1&&u.parentNode&&u.parentNode.replaceChild(i[c],u)}}function t(e,r){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var i=0,n=e.childNodes.length;n>i;i++)t(e.childNodes[i],r)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r.push(e)}}function r(e){if(e.restrict)return e;for(var t=e.parent;t;){if(t.name&&t.restrict)return t;t=t.parent}return null}function i(e,t){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var s=e.tagName.toLowerCase(),a=[],o=e.attributes.length;o--;){var l=e.attributes[o];a.push([l.name,l.value])}for(var h=[],o=a.length;o--;){var c=a[o][0];if(0===c.indexOf(CMD_PREFIX)){var p=c.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&(DirectiveFactory.isFinal(p)||DirectiveFactory.hasEndTag(p))&&h.push([p,a[o],DirectiveFactory.priority(p)||0])}}if(h.length>0){h.sort(function(e,t){return t[2]-e[2]});var p=h[0][0],v=h[0][1];if(DirectiveFactory.isFinal(p))return void DirectiveFactory.newInstanceOf(p,e,t,v[0],v[1]);if(DirectiveFactory.hasEndTag(p))return[p,v[1]]}if(ComponentFactory.hasTypeOf(s)){var d=r(t);if(d&&d.restrict.children){var f=d.restrict.children.split(",");if(f.indexOf(s)<0)return}var _=ComponentFactory.getRestrictOf(s);if(_&&_.parents){var g=_.parents.split(",");if(g.indexOf(d.name)<0)return}return void t.createSubComponentOf(s,e)}for(var o=a.length;o--;){var m=a[o][0],b=a[o][1];if(REG_CMD.test(m)){var p=m.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&DirectiveFactory.newInstanceOf(p,e,t,m,b)}else":"===m[0]?DirectiveFactory.newInstanceOf("on",e,t,m,b):REG_EXP.test(b)&&n(b,e,t,m)}}if(e.childNodes.length>0){for(var y=null,w=[],o=0,x=e.childNodes.length;x>o;o++)if(y){w.push(e.childNodes[o]);var E=DirectiveFactory.hasEndTag(y[0]),l=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+E);Util.isString(l)&&(DirectiveFactory.newInstanceOf(y[0],w,t,CMD_PREFIX+y[0],y[1]),y=null,w=[])}else y=i(e.childNodes[o],t),y&&w.push(e.childNodes[o]);y&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+y[0]+"]")}}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n(e.nodeValue,e,t)}}function n(e,t,r,i){var n={},a=!i&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);if(a&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,t){var i={},a=1,o=null;FILTER_EXP.test(t)&&(o=s(lexer(RegExp.$1),i,r),a=t.indexOf(FILTER_EXP_START_TAG));var l=t;a>1&&(l=t.substring(0,a));var h=lexer(l);o&&Util.ext(h.varTree,o),n[t]={words:h.words,varTree:h.varTree,filters:i}}),!(Object.keys(n).length<1)){var o=new ExpNode(t,i,e,n,r,a);r.__expNodes.push(o)}}function s(e,t,r){for(var i=[],n=null,s=!1,a={},o=[],l=e.words,h=0;h<l.length;h++)if(l[h]instanceof Array)for(var c=l[h][0],p=c.split("."),u=1;u<p.length;u++)o.push([p[u]]);else o.push(l[h]);for(var h=0;h<o.length;h++){var c=o[h];switch(c){case":":s=!0,null!==n&&i.push(n),n="";break;case".":s=!1,null!==n&&i.push(n),n="",i=[];break;default:if(c instanceof Array){var v=c[0],d=v.toLowerCase();if(!s&&d&&FilterFactory.hasTypeOf(d))n=null,t[d]=[FilterFactory.newInstanceOf(d,r),i];else{var p=lexer(v);Util.ext(a,p.varTree),i.push(p),n=null}}else{if(!s||!c.replace(/\s+/,""))continue;n+=c.replace(/^['"]|['"]$/g,"")}}}return n&&i.push(n),a}this.scan=function(t,r){for(var n=t.__nodes?t.__nodes:[t.el],s=null,a=[],o=0,l=n.length;l>o;o++)if(e(n[o]),s){a.push(n[o]);var h=DirectiveFactory.hasEndTag(s[0]),c=n[o].getAttribute&&n[o].getAttribute(CMD_PREFIX+h);Util.isString(c)&&(DirectiveFactory.newInstanceOf(s[0],a,r,CMD_PREFIX+s[0],s[1]),s=null,a=[])}else s=i(n[o],r),s&&a.push(n[o]);s&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")},this.parseFilters=s},Builder=new function(){function prelink(e){for(var t=e.__expNodes.length;t--;){var r=e.__expNodes[t];for(var i in r.expMap){var n=r.expMap[i],s=n.varTree;for(var a in s){var o=s[a];o.isFunc||buildExpModel(e,o,r)}}}for(var t=e.children.length;t--;){var l=e.children[t];l instanceof Directive||(l.init(),l.display())}for(var t=e.children.length;t--;){var l=e.children[t];l instanceof Directive&&l.init()}}function buildExpModel(e,t,r){for(var i in t.subVars){var n=t.subVars[i];buildExpModel(e,n,r)}for(var s=walkPropTree(e.__expPropRoot.subProps,t.segments[0],r),a=1;a<t.segments.length;a++)s=walkPropTree(s.subProps,t.segments[a],r)}function walkPropTree(e,t,r){var i=e[t];return i||(i=e[t]=new ExpProp(t)),r instanceof ExpNode?i.expNodes.indexOf(r)<0&&i.expNodes.push(r):r instanceof AttrObserveNode?i.attrObserveNodes.indexOf(r)<0&&i.attrObserveNodes.push(r):r instanceof Watch&&i.watchs.indexOf(r)<0&&i.watchs.push(r),e[t]}function observerProp(e,t,r){function i(e){r.__state!==Component.state.suspend&&null!==r.__state&&changeHandler(e)}var n=Util.isArray(e),s=Util.isObject(e);if(e&&(n||s)){if(e.$__impex__observer){var a=t.join(".");if(e.$__impex__propChains[a]){for(var o=e.$__impex__propChains[a],l=o.length;l--;)if(o[l][1]===r)return;return void o.push([t,r])}return void(e.$__impex__propChains[t.join(".")]=[[t,r]])}if(Object.defineProperty(e,"$__impex__observer",{enumerable:!1,writable:!0,value:i}),Object.defineProperty(e,"$__impex__propChains",{enumerable:!1,writable:!0,value:{}}),e.$__impex__propChains[t.join(".")]=[[t,r]],n)Object.defineProperty(e,"$__impex__oldVal",{enumerable:!1,writable:!0,value:e.concat()}),Array_observe(e,i);else if(s){if(Util.isDOM(e))return;Object_observe(e,i)}for(var h=Object.keys(e),l=h.length;l--;){var a=h[l],c=t.concat();c.push(a),observerProp(e[a],c,r)}}}function changeHandler(e){if(!Util.isString(e))for(var t=e.length;t--;){var r=e[t],i=r.name;if(!i||0!==i.indexOf("$")||"$index"===i){var n=r.object[i],s=r.oldValue;Util.isArray(r.object)&&(n=r.object,s=r.object.$__impex__oldVal);for(var a=r.object.$__impex__propChains,o=Object.keys(a),l=o.length;l--;)for(var h=o[l],c=a[h],p=c.length;p--;){var u=c[p][0],v=c[p][1],d=u.concat();i&&!Util.isArray(r.object)&&d.push(i),__propStr=null,__lastMatch=void 0,recurRender(v,d,r.type,n,s,0,v),v.$__watcher instanceof Function&&v.$__watcher(r.type,n,s,d),observerProp(n,d,v)}if(!Util.isArray(r.object)&&Util.isArray(r.oldValue))Array_unobserve(r.oldValue,r.oldValue.$__impex__observer);else{if(Util.isArray(r.object))return void(r.object.$__impex__oldVal=r.object.concat());if(Util.isObject(r.oldValue)){var f=r.oldValue.$__impex__observer;f&&(Object_unobserve(r.oldValue,f),r.oldValue.$__impex__observer=null,r.oldValue.$__impex__propChains=null)}}}}}function rerender(e,t,r,i,n){for(var s,a=e.__expPropRoot.subProps,o=!1,l=0;l<t.length;l++){var h=t[l];if(sqbExp.test(Object.keys(a).join(","))){o=!0;break}{if(!a[h])break;s=a[h],a=a[h].subProps}}if(s){var c=[];if(o)for(var p=t.length-l-1,u=Object.keys(s.subProps),l=u.length;l--;){var v=u[l];("["===v[0]||v===h)&&findMatchProps(s.subProps[v],p,c)}else c.push(s);for(var d=[],l=c.length;l--;){Renderer.renderExpNode(c[l].expNodes);for(var f=c[l].attrObserveNodes.length;f--;){var _=c[l].attrObserveNodes[f],g=Renderer.evalExp(_.directive,_.expObj);_.directive.observe(g)}for(var f=c[l].watchs.length;f--;){var m=c[l].watchs[f];if(!(m.segments.length<t.length||d.indexOf(m)>-1)){for(var b=!0,v=0;v<m.segments.length&&t[v];v++)if("["!==m.segments[v][0]&&"["!==t[v][0]&&m.segments[v]!==t[v]){b=!1;break}if(b){var y=i,w=n;if(m.segments.length>t.length){for(var x=m.segments.slice(v),E="$var",v=0;v<x.length;v++){var C=x[v];E+="["===C[0]?C:"."+C}try{y=new Function("$var","return "+E)(i),w=new Function("$var","return "+E)(n)}catch(O){LOGGER.debug("error on parse watch params"),y=null}}m.cbk&&m.cbk.call(m.ctrlScope,r,y,w,t),d.push(m)}}}}}}function findMatchProps(e,t,r){if(1>t)return void r.push(e);for(var i in e.subProps)findMatchProps(e.subProps[i],t-1,r)}function recurRender(component,propChain,changeType,newVal,oldVal,depth,topComp){var toRender=!0;if(depth>0){if(!__propStr){__propStr="";for(var k=0;k<propChain.length;k++){var seg=propChain[k];__propStr+="["===seg[0]?seg:"."+seg}}var prop=void 0;try{prop=eval('impex._cs["'+component.$__id+'"]'+__propStr)}catch(e){}Util.isUndefined(prop)?__lastMatch&&__lastMatch!==topComp&&(toRender=!1):(__lastMatch=component,toRender=!1)}if(toRender&&rerender(component,propChain,changeType,newVal,oldVal),component.isolate)for(var pc0=propChain[0],i=component.isolate.length;i--;){var k=component.isolate[i];if(k.indexOf(".")>0){for(var kc=k.split("."),matchAll=!0,kci=0;kci<kc.length;kci++)kc[kci]!==propChain[kci]&&(matchAll=!1);if(matchAll)return}else if(k===pc0)return}for(var j=component.children.length;j--;){var subCtrlr=component.children[j];recurRender(subCtrlr,propChain,changeType,newVal,oldVal,depth+1,topComp)}}this.buildExpModel=buildExpModel,this.build=function(e){prelink(e),observerProp(e.data,[],e)};var __propStr=null,__lastMatch=void 0,sqbExp=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNode(e){for(var t={},r=e.length;r--;){var i=e[r],n=null;if(t[i.origin]&&t[i.origin].comp===i.component?n=t[i.origin].val:(n=calcExp(i.component,i.origin,i.expMap),t[i.origin]={comp:i.component,val:n}),i.toHTML){var s=renderHTML(i,n,i.node,i.component);if(s)continue}null!==n&&updateDOM(i.node,i.attrName,n)}}function updateDOM(e,t,r){if(e.setAttribute){e.setAttribute(t,r);var i=propMap[t];i&&i.indexOf(e.tagName)>-1&&(e[t]=r)}else e.parentNode&&(e.nodeValue=r)}function clone(e){if(null===e)return null;var t=e;if(e instanceof Array){t=e.concat();for(var r=t.length;r--;)t[r]=clone(t[r])}else if(Util.isObject(e)){t={};var i=Object.keys(e);if(i.length>0)for(var r=i.length;r--;){{var n=i[r];e[n]}0!==n.indexOf("$__impex__")&&(t[n]="object"==typeof e[n]?clone(e[n]):e[n])}}return t}function calcExp(e,t,r){var i={};for(var n in r){var s=r[n],a=evalExp(e,s),o=s.filters;if(Object.keys(o).length>0){a&&Util.isObject(a)&&(a=clone(a));for(var l in o){for(var h=o[l][0],c=o[l][1],p=[],u=c.length;u--;){var v=c[u];v.varTree&&v.words&&(v=Renderer.evalExp(e,v)),p[u]=v}h.value=a,a=h.to.apply(h,p)}}i[n]=void 0===a?"":a}for(var l in i)t=t.replace(EXP_START_TAG+l+EXP_END_TAG,i[l]);return t}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var r=t.varTree,i={};for(var n in r){var s=r[n],a=buildVarPath(e,s,n);i[n]=a}var o=joinExpStr(t.words,i);return o}function joinExpStr(e,t){for(var r="",i=0;i<e.length;i++){var n=e[i];r+=n instanceof Array?t[n[0]]:n}return r}function keyWordsMapping(e,t){return 0===e.indexOf(".this")?e.replace(".this",t.__getPath()):void 0}function buildVarPath(e,t,r){var i={};for(var n in t.subVars){var s=t.subVars[n],a=buildVarPath(e,s,n);i[n]=a}for(var o=!1,l="",h=0;h<t.words.length;h++){var c=t.words[h];if(c instanceof Array){var p=keyWordsMapping(c[0],e);p?(o=!0,l+=p):l+=i[c[0]]||c[0]}else l+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var h=0;h<t.watchPathWords.length;h++){var c=t.watchPathWords[h];u+=c instanceof Array?i[c[0]]||c[0]:c}var v=")"===r[r.length-1]?"methods":"data",d=u||l;return d="data"===v?".data"+d:"."+METHOD_PREFIX+d.substr(1),e=varInCtrlScope(e,d),o?l:e?(l="data"===v?".data"+l:"."+METHOD_PREFIX+l.substr(1),e.__getPath()+l):"self"+l}function varInCtrlScope(e,t){for(var r=e;r;){if(void 0!==getVarByPath(t,r.__getPath()))return r;r=r.parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,r,i){if(e.__lastVal!==t&&3==r.nodeType){var n=new View(null,null,[r]);if(Util.isUndefined(e.__lastVal)){var s=ViewManager.createPlaceholder("-- [html] placeholder --");ViewManager.insertBefore(s,n),e.__lastVal=t,e.__placeholder=s}e.__lastComp&&(e.__lastComp.destroy(),n=ViewManager.createPlaceholder(""),ViewManager.insertAfter(n,e.__placeholder)),Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;"));var a=i.createSubComponent(t,n);return a.init(),a.display(),e.__lastComp=a,e.__lastVal=t,!0}}this.render=function(e){renderExpNode(e.__expNodes);for(var t=e.children.length;t--;)Renderer.render(e.children[t])},this.renderExpNode=renderExpNode;var propMap={value:["INPUT"]};this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};Component.state={created:"created",inited:"inited",displayed:"displayed",suspend:"suspend"},Util.ext(Component.prototype,{d:function(path,val){var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug(e.message+"eval error on data("+evalStr+"= "+val+")")}return this}try{return eval(evalStr)}catch(e){LOGGER.debug(e.message+"eval error on data("+evalStr+")")}},m:function(e){for(var t=this;t;){if(t["$"+e]instanceof Function)return t["$"+e];t=t.parent}return null},on:function(e,t){var r=this.__eventMap[e];r||(r=this.__eventMap[e]=[]),r.push(t)},emit:function(){for(var e=arguments[0],t=[this],r=1;r<arguments.length;r++)t.push(arguments[r]);var i=this.parent;setTimeout(function(){for(;i;){var r=i.__eventMap[e];if(r){for(var n=!0,s=0;s<r.length;s++)n=!r[s].apply(i,t);if(n)return}i=i.parent}},0)},broadcast:function(){for(var e=arguments[0],t=[this],r=1;r<arguments.length;r++)t.push(arguments[r]);var i=this;setTimeout(function(){broadcast(i.children,e,t)},0)},find:function(e,t,r){e=e.toLowerCase();for(var i=[],n=this.children.length;n--;){var s=this.children[n];if("*"===e||s.name===e){var a=!0;if(t)for(var o in t)if(s[o]!==t[o]){a=!1;break}a&&i.push(s)}if(r&&s.children.length>0){var l=s.find(e,t,!0);i&&(i=i.concat(l))}}return i},watch:function(e,t){if("*"===e)this.__watcher=t;else{var r=lexer(e),i=Object.keys(r.varTree);if(i.length<1)return;if(i.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var n=r.varTree[i[0]],s=new Watch(t,this,n.segments);Builder.buildExpModel(this,n,s)}return this},add:function(e){this.children.push(e),e.parent=this},createSubComponentOf:function(e,t){var r=ComponentFactory.newInstanceOf(e,t.__nodes?t.__nodes[0]:t);return this.children.push(r),r.parent=this,r},createSubComponent:function(e,t){var r=ComponentFactory.newInstance(e,t&&t.__nodes[0]);return this.children.push(r),r.parent=this,r},init:function(){if(this.__state===Component.state.created){if(impex._cs[this.__id]=this,this.templateURL){var e=this;Util.loadTemplate(this.templateURL,function(t){var r=e.view.__init(t,e);r!==!1&&(e.__init(t),e.display())})}else{if(this.template){var t=this.view.__init(this.template,this);if(t===!1)return}this.__init(this.template)}return this}},__init:function(e){Scanner.scan(this.view,this),LOGGER.log(this,"inited");var t=null;return this.onInit&&(t=this.onInit(e)),t===!1?void this.destroy():void(this.__state=Component.state.inited)},display:function(){(this.__state===Component.state.inited||this.__state===Component.state.suspend)&&(this.view.__display(this),this.__state!==Component.state.suspend&&(Renderer.render(this),Builder.build(this)),this.__state=Component.state.displayed,LOGGER.log(this,"displayed"),this.onDisplay&&this.onDisplay())},destroy:function(){if(null!==this.__state){if(LOGGER.log(this,"destroy"),this.parent){var e=this.parent.children.indexOf(this);e>-1&&this.parent.children.splice(e,1),this.parent=null}for(this.view.__destroy(this);this.children.length>0;)this.children[0].destroy();if(this.view=this.children=this.__expNodes=this.__expPropRoot=null,this.onDestroy&&this.onDestroy(),!CACHEABLE||!this.name||this instanceof Directive)impex._cs[this.__id]=null,delete impex._cs[this.__id],this.__impex__observer=this.__impex__propChains=this.__state=this.__id=this.templateURL=this.template=this.restrict=this.isolate=this.methods=this.events=this.data=null;else{var t=im_compCache[this.name];t||(t=im_compCache[this.name]=[]),this.__state=Component.state.created,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,t.push(this)}}},suspend:function(e){(this instanceof Directive||this.__state===Component.state.displayed)&&(LOGGER.log(this,"suspend"),this.view.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.__state=Component.state.suspend)},__getPath:function(){return'impex._cs["'+this.__id+'"]'}}),View.prototype={__init:function(e,t){var r=this.__target.attributes,i=this.__target.innerHTML,n=tmplExpFilter(e,i,r);t.onBeforeCompile&&(n=t.onBeforeCompile(n));var s=DOMViewProvider.compile(n);if(!s||s.length<1)return LOGGER.error('invalid template "'+e+'" of component['+t.name+"]"),!1;if(this.__nodes=s,this.el=t.replace?1===s.length&&1===s[0].nodeType?s[0]:null:this.__target,s.length>1&&LOGGER.warn("more than 1 root node of component["+t.name+"]"),r)for(var a=r.length;a--;){var o=r[a].name.toLowerCase();o.indexOf("-")>-1&&(o=o.replace(/-[a-z0-9]/g,function(e){return e[1].toUpperCase()}));var l=r[a].value;t.data[o]=l}this.__comp=t},__display:function(e){if(this.__target&&this.__target.parentNode){var t=null;if(this.__nodes.length>1){t=document.createDocumentFragment();for(var r=0;r<this.__nodes.length;r++)t.appendChild(this.__nodes[r])}else t=this.__nodes[0];e.replace?this.__target.parentNode.replaceChild(t,this.__target):(this.__target.innerHTML="",this.__target.appendChild(t)),t=null,this.__target=null}},__destroy:function(e){for(var t in this.__evMap)for(var r=this.__evMap[t],i=r.length;i--;)for(var n=r[i],s=n[1],a=this.__nodes.length;a--;)1===this.__nodes[a].nodeType&&this.__nodes[a].removeEventListener(t,s,!1);var o=this.__nodes[0].parentNode;if(o){this.__nodes[0].__impex__view&&(this.__nodes[0].__impex__view=null);for(var i=this.__nodes.length;i--;)this.__nodes[i].parentNode&&o.removeChild(this.__nodes[i])}this.__target&&(this.__target.parentNode.removeChild(this.__target),this.__target=null)},__suspend:function(e,t){var r=this.__nodes[0].parentNode;if(r){t&&(this.__target=document.createComment("-- view suspended of ["+(e.name||"anonymous")+"] --"),r.insertBefore(this.__target,this.__nodes[0]));for(var i=this.__nodes.length;i--;)this.__nodes[i].parentNode&&r.removeChild(this.__nodes[i])}},on:function(e,t,r){if(this.el){var i=t,n=this.__comp,s="",a=null,o=function(t){var o=i;if(r instanceof Function&&(o=r.call(n,t,i)),o){if(s!=o){var l=lexer(o),h=Renderer.getExpEvalStr(n,l),c=h.replace("self.$event","$event");a=new Function("$event",c),s=o}try{a(t)}catch(p){LOGGER.debug(p.message+" on event "+e+"("+c+")")}}};this.el.addEventListener(e,o,!1),this.__evMap[e]||(this.__evMap[e]=[]),this.__evMap[e].push([t,o])}},off:function(e,t){if(this.el)for(var r=this.__evMap[e],i=r.length;i--;){var n=r[i],s=n[0],a=n[1];s==t&&this.el.removeEventListener(e,a,!1)}},clone:function(){for(var e=[],t=this.__nodes.length;t--;){var r=this.__nodes[t].cloneNode(!0);e.unshift(r)}var i=new View(1===e.length&&1===e[0].nodeType?e[0]:null,null,e);return i},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},style:function(e,t){return arguments.length>1?(this.el.style[e]=t,this):this.el.style[e]},attr:function(e,t){return arguments.length>1?(this.el.setAttribute(e,t),this):this.el.getAttribute(e)},removeAttr:function(e){return this.el.removeAttribute(e),this},hasClass:function(e){return this.el.className.indexOf(e)>-1},addClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,""),e=e.split(" ");for(var t=this.el.className.split(" "),r="",i=e.length;i--;)t.indexOf(e[i])<0&&(r+=e[i]+" ");return this.el.className+=" "+r,this},removeClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");var t=e.split(" "),r=this.el.className;if(r){for(var i=t.length;i--;){var n=t[i],s=new RegExp("^"+n+"\\s+|\\s+"+n+"$|\\s+"+n+"\\s+","img");r=r.replace(s,"")}this.el.className=r}return this},toggleClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");for(var t=e.split(" "),r=!1,i=this.el.className,n=t.length;n--;){var s=t[n];if(i.indexOf(s)<0){r=!0;break}}r?this.addClass(e):this.removeClass(e)}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,r){if(""===t)return new View(null,r,[document.createTextNode("")]);if(e.innerHTML=t,!e.childNodes[0])return null;for(var i=[];e.childNodes.length>0;){var n=e.removeChild(e.childNodes[0]);i.push(n)}var s=new View(null,r,i);return s},this.compile=function(t){e.innerHTML=t;for(var r=[];e.childNodes.length>0;){{var i=e.removeChild(e.childNodes[0]);i.nodeName.toLowerCase()}if(3===i.nodeType){var n=i.nodeValue.replace(/\s/gm,"");if(""===n)continue}r.push(i)}return r}},ViewManager=new function(){this.singleton=!0,this.replace=function(e,t){var r=t.__nodes[0],i=e.__nodes[0],n=t.__nodes[0].parentNode,s=i;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}if(t.__nodes.length>1){n.insertBefore(s,r);for(var a=t.__nodes.length;a--;)n.removeChild(t.__nodes[a])}else n.replaceChild(s,r)},this.insertBefore=function(e,t){var r=t.__nodes[0],i=e.__nodes[0],n=t.__nodes[0].parentNode,s=i;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}n&&n.insertBefore(s,r)},this.insertAfter=function(e,t){var r=t.__nodes[0],i=e.__nodes[0],n=t.__nodes[0].parentNode,s=n.lastChild,a=i;if(e.__nodes.length>1){a=document.createDocumentFragment();for(var o=0;o<e.__nodes.length;o++)a.appendChild(e.__nodes[o])}if(s==r)n.appendChild(a);else{var l=t.__nodes[t.__nodes.length-1].nextSibling;n.insertBefore(a,l)}},this.append=function(e,t){var r=e.__nodes[0],i=t.__nodes[0],n=r;if(e.__nodes.length>1){n=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)n.appendChild(e.__nodes[s])}i.appendChild(n)},this.prepend=function(e,t){var r=e.__nodes[0],i=t.__nodes[0],n=r;if(e.__nodes.length>1){n=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)n.appendChild(e.__nodes[s])}i.insertBefore(n,i.firstChild)},this.createPlaceholder=function(e){return new View(null,null,[document.createComment(e)])}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){impex._cs[this.__id]=this;var e={},t=this;this.value.replace(REG_EXP,function(r,i){var n=lexer(i),s=Renderer.evalExp(t.parent,n);e[i]={val:s}});var r=this.value;for(var i in e)r=r.replace(EXP_START_TAG+i+EXP_END_TAG,e[i].val);if(this.value=r,
LOGGER.log(this,"inited"),this.onInit&&(l=this.onInit()),this.__state=Component.state.inited,this.observe){var n=lexer(r);for(var s in n.varTree){var a=n.varTree[s],o=new AttrObserveNode(this,n);this.parent&&Builder.buildExpModel(this.parent,a,o)}var l=Renderer.evalExp(this.parent,n);this.observe(l)}}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},TESTNODE;Transition.prototype={enter:function(){this.__start="enter",this.__css&&this.__view.addClass(this.__type+"-enter"),this.__comp.enter&&this.__comp.enter(),this.__hook.enter&&this.__hook.enter.call(this.__comp,this.__enterDone.bind(this)),this.__css&&(this.__view.el.offsetHeight,this.__view.removeClass(this.__type+"-enter"))},__enterDone:function(){},leave:function(){this.__start="leave",this.__css&&this.__view.addClass(this.__type+"-leave"),this.__hook.leave&&(this.__leaveDone.__trans=this,this.__hook.leave.call(this.__comp,this.__leaveDone.bind(this)))},__leaveDone:function(){this.__comp.leave&&this.__comp.leave()},__done:function(e){if(!(e.elapsedTime<this.__longest)&&this.__start){switch(this.__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.__start="",this.__view.removeClass(this.__type+"-leave")}}},Factory.prototype={register:function(e,t,r){e=e.toLowerCase();var i=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),n={},s=t.data;if(delete t.data,Util.ext(n,t),Util.inherits(i,this.baseClass),t.methods)for(var a in t.methods)i.prototype[METHOD_PREFIX+a]=t.methods[a];this.types[e]={clazz:i,props:n,services:r,data:s}},hasTypeOf:function(e){return e in this.types},createCbk:function(e,t){if(e.onCreate){var r=null;if(this.types[t].services){r=[];for(var i=0;i<this.types[t].services.length;i++){var n=ServiceFactory.newInstanceOf(this.types[t].services[i],e);r.push(n)}}r?e.onCreate.apply(e,r):e.onCreate()}}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.restrict},newInstance:function(e){var t=null;if(2===arguments.length){var r=arguments[0],i=arguments[1];t=r,Util.isString(r)?t=this.viewProvider.newInstance(r,i):t.__target=i}else t=e,Util.isDOM(e)&&(t=new View(e,null,[e]));var n=new this.baseClass(t),s=arguments[2];if(s&&Util.ext(n,s),n.methods)for(var a in n.methods)n[METHOD_PREFIX+a]=n.methods[a];if(n.events)for(var a in n.events)n.on(a,n.events[a]);return n},newInstanceOf:function(e,t){if(!this.types[e])return null;var r=null,i=im_compCache[e];if(CACHEABLE&&i&&i.length>0)r=i.pop();else{r=new this.types[e].clazz(this.baseClass),Util.ext(r,this.types[e].props);var n=this.types[e].data;n&&Util.ext(r.data,n),r.name=e}if(r.view=new View(null,t),r.events)for(var s in r.events)r.on(s,r.events[s]);return this._super.createCbk.call(this,r,e),r}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props["final"]},hasEndTag:function(e){return this.types[e].props.endTag},priority:function(e){return this.types[e].props.priority},newInstanceOf:function(e,t,r,i,n){if(!this.types[e])return null;var s=null,a=null,o=i.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=i.substr(o+1);var l=s.indexOf(CMD_FILTER_DELIMITER);l>-1&&(a=s.substr(l+1),s=s.substring(0,l)),s=s.split(CMD_PARAM_DELIMITER)}var h=new this.types[e].clazz(this.baseClass,i,n,r);if(Util.ext(h,this.types[e].props),t.__impex__view)h.view=t.__impex__view;else{var c=t,p=[t];Util.isArray(t)&&(p=t,c=t.length>1?null:t[0]),h.view=new View(c,null,p),t.__impex__view=h.view}if(s&&(h.params=s),a&&(h.filter=a),h.view.__comp=h,r.add(h),h.view&&(h.view.__nodes[0].removeAttribute(h.name),h.endTag)){var u=h.view.__nodes[h.view.__nodes.length-1];u.removeAttribute(CMD_PREFIX+h.endTag)}if(h.events)for(var v in h.events)h.on(v,h.events[v]);return this._super.createCbk.call(this,h,e),h}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var r=new this.types[e].clazz(this.baseClass,t);return Util.ext(r,this.types[e].props),this._super.createCbk.call(this,r,e),r}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var r=null;return this.types[e].props.singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),r=this.types[e].singleton):r=new this.types[e].clazz(this.baseClass),Util.ext(r,this.types[e].props),r.host=t,this._super.createCbk.call(this,r,e),r}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var r=new Transition(e,t,this.hooks[e]);return r}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,METHOD_PREFIX="$",EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},CACHEABLE=!1,im_compCache={},im_counter=0,impex=new function(){function e(e){var r=e;do{if(t.indexOf(r)>-1)return!0;r=r.parentNode}while(r);return!1}this.version={v:[0,20,0],state:"beta",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},CACHEABLE=e.cacheable||!1},this.component=function(e,t,r){return t.template||t.templateURL?(ComponentFactory.register(e,t,r),this):void LOGGER.error("can not find property 'template' or 'templateURL' of component '"+e+"'")},this.directive=function(e,t,r){return DirectiveFactory.register(e,t,r),this},this.service=function(e,t,r){return ServiceFactory.register(e,t,r),this},this.filter=function(e,t,r){return FilterFactory.register(e,t,r),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.render=function(r,i,n){if(!r)return void LOGGER.error("invalid element, can not render");var s=r.tagName.toLowerCase();if(e(r))return void LOGGER.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,r);if(a||(t.push(r),a=ComponentFactory.newInstance(r,null,i)),a.onCreate){var o=null;if(Util.isArray(n)){o=[];for(var l=0;l<n.length;l++){var h=ServiceFactory.newInstanceOf(n[l],a);o.push(h)}}o?a.onCreate.apply(a,o):a.onCreate()}return a.init(),a.display(),a};var t=[];Object.defineProperty(this,"_cs",{enumerable:!1,writable:!0,value:{}})};impex.service("ViewManager",ViewManager),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,r,i){for(var n=e.__expNodes.length;n--;){var s=e.__expNodes[n];s.node==r&&"class"===s.attrName&&(s.origin=i)}for(var a=e.children.length;a--;)t(e.children[a],r,i)}function r(){function e(e,t,r){for(var i=[],n=e;t>=n;n+=r)i.push(n);return i}function t(e){for(var r=0;r<e.children.length;r++){var i=e.children[r];i.onDisplay&&i.onDisplay(),i.children.length>0&&t(i)}}function r(e,t){if(null===e)return null;var i=e;if(e instanceof Array){i=e.concat();for(var n=i.length;n--;)i[n]=r(i[n],t)}else if(Util.isObject(e)){i={};var s=Object.keys(e);if(s.length>0)for(var a=t===!1?!1:!e.$__impex__origin,n=s.length;n--;){{var o=s[n];e[o]}0!==o.indexOf("$__impex__")&&(i[o]="object"==typeof e[o]?r(e[o],a):e[o])}t===!1||i.$__impex__origin||(i.$__impex__origin=e)}return i}this.onCreate=function(e,t){this.eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.forExp=/^\s*(\d+|[a-zA-Z_$].+?)\s+to\s+(\d+|[a-zA-Z_$].+?)\s*$/,this.viewManager=e,this.expInfo=this.parseExp(this.value),this.parentComp=this.parent,this.__view=this.view,this.cache=[],this.cacheable=this.view.el?"false"===this.view.attr("cache")?!1:!0:"false"===this.view.__nodes[0].getAttribute("cache")?!1:!0,this.subComponents=[],this.cacheSize=20,this.step=this.view.el?this.view.attr("step"):this.view.__nodes[0].getAttribute("step");var r=this.view.el?this.view.attr("transition"):this.view.__nodes[0].getAttribute("transition");null!==r&&(this.trans=r,this.ts=t)},this.onInit=function(){if(this.__state!==Component.state.inited){var t=this;if(this.forExp.test(this.expInfo.ds)){var r=RegExp.$1,i=RegExp.$2,n=parseFloat(this.step);if(0>n)return void LOGGER.error("step <=0 : "+n);n=n||1,isNaN(r)&&(this.parent.watch(r,function(r,s,a){var o=e(s,i,n);t.lastDS=o,t.rebuild(o,t.expInfo.k,t.expInfo.v)}),r=this.parent.d(r)),isNaN(i)&&(this.parent.watch(i,function(i,s,a){var o=e(r,s,n);t.lastDS=o,t.rebuild(o,t.expInfo.k,t.expInfo.v)}),i=this.parent.d(i)),r=parseFloat(r),i=parseFloat(i),this.ds=e(r,i,n)}else this.ds=this.parent.d(this.expInfo.ds),this.parentComp.watch(this.expInfo.ds,function(e,r,i){return t.ds?(t.lastDS=r,void t.rebuild(r,t.expInfo.k,t.expInfo.v)):(t.ds=t.parentComp.d(t.expInfo.ds),t.lastDS=t.ds,void t.build(t.ds,t.expInfo.k,t.expInfo.v))});this.lastDS=this.ds,this.placeholder=this.viewManager.createPlaceholder("-- directive [each] placeholder --"),this.viewManager.insertBefore(this.placeholder,this.view),this.ds&&this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy()}},this.rebuild=function(e,r,i){e=this.doFilter(e);var n=e.length-this.subComponents.length;if(0>n){var s=this.subComponents.splice(0,-1*n);if(this.cache.length<this.cacheSize){for(var a=s.length;a--;)this.cache.push(s[a]);for(var a=this.cache.length;a--;)this.trans&&!this.cache[a].__leaving&&"displayed"===this.cache[a].__state?(this.cache[a].__leaving=!0,this.cache[a].transition.leave()):this.cache[a].suspend(!1)}else for(var a=s.length;a--;)s[a].destroy()}else if(n>0){var o=n;if(this.cacheable){for(var s=this.cache.splice(0,n),a=0;a<s.length;a++)this.subComponents.push(s[a]),this.viewManager.insertBefore(s[a].view,this.placeholder);var o=n-s.length}for(;o--;)this.createSubComp()}var l=Util.isArray(e)?!0:!1,h=0;for(var c in e)if(e.hasOwnProperty(c)&&!(l&&isNaN(c)||0===c.indexOf("$__"))){var p=this.subComponents[h],u=e[c];e[c]&&e[c].$__impex__origin&&(u=e[c].$__impex__origin,e[c].$__impex__origin=null,delete e[c].$__impex__origin),p.data[i]=u,p.data.$index=h++,r&&(p.data[r]=l?c>>0:c),p.init(),p.display(),Builder.build(p),t(p)}},this.createSubComp=function(){var e=this.parentComp,t=this.viewManager.createPlaceholder("");this.viewManager.insertBefore(t,this.placeholder);var r=this.__view.clone(),i=e.createSubComponent(r,t);if(this.subComponents.push(i),this.trans){var n=this;i.onInit=function(){this.transition||(this.transition=n.ts.get(n.trans,this))},i.onDisplay=function(){this.transition.enter()},i.leave=function(){this.suspend(!1),this.__leaving=!1}}return i},this.doFilter=function(e){if(!this.filters)return e;var t=this.filters;if(Object.keys(t).length>0){e&&Util.isObject(e)&&(e=r(e));for(var i in t){for(var n=t[i][0],s=t[i][1],a=[],o=s.length;o--;){var l=s[o];l.varTree&&l.words&&(l=Renderer.evalExp(this.parentComp,l)),a[o]=l}n.value=e,e=n.to.apply(n,a)}return e}},this.build=function(e,t,r){var i=Util.isArray(e)?!0:!1,n=0;e=this.doFilter(e);for(var s in e)if(e.hasOwnProperty(s)&&!(i&&isNaN(s)||0===s.indexOf("$__"))){var a=this.createSubComp(),o=e[s];e[s]&&e[s].$__impex__origin&&(o=e[s].$__impex__origin,e[s].$__impex__origin=null,delete e[s].$__impex__origin),a.data[r]=o,a.data.$index=n++,t&&(a.data[t]=i?s>>0:s)}for(var l=this.subComponents.length;l--;)this.subComponents[l].init(),this.subComponents[l].display()},this.parseExp=function(e){var t,r,i,n=this;return e.replace(this.eachExp,function(e,s,a,o){t=s;var l=a.replace(/\s/gm,""),h=l.split(",");if(h.length>1?(r=h[0],i=h[1]):i=h[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,n.parent);n.filters=c;for(var u in p)n.parent.watch(u,function(e,t,r){n.lastDS&&n.rebuild(n.lastDS,n.expInfo.k,n.expInfo.v)})}}),t?{ds:t,k:r,v:i}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{"final":!0}).directive("on",{onInit:function(){for(var e=this.params.length;e--;)this.view.on(this.params[e],this.value)}}).directive("bind",{onInit:function(){(!this.params||this.params.length<1)&&LOGGER.warn("at least one attribute be binded")},observe:function(e){if(this.params&&!(this.params.length<1)){var t=null;if(this.filter&&(t=this.m(this.filter)),t){var r=t(e);if(!Util.isUndefined(r)&&!r)return}for(var i=this.params.length;i--;){var n=this.params[i];this.view.attr(n,e)}}}}).directive("show",{onCreate:function(e){var t=this.view.attr("transition");null!==t&&(this.transition=e.get(t,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&e!==this.lastRs&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){e?this.view.show():this.view.hide()}},["Transitions"]).directive("show-start",{endTag:"show-end",onCreate:function(){this.__init(),this.display()},observe:function(e){if(this.parent.__state!==Component.state.suspend){var t=this.view.__nodes;if(e)for(var r=t.length;r--;)t[r].style&&(t[r].style.display="");else for(var r=t.length;r--;)t[r].style&&(t[r].style.display="none")}}}).directive("if",{onCreate:function(e,t){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --");var r=this.view.attr("transition");null!==r&&(this.transition=t.get(r,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&(e!==this.lastRs||this.view.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.view.el.parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.el.parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager","Transitions"]).directive("if-start",{endTag:"if-end",onCreate:function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --"),this.__init(),this.display()},observe:function(e){if(this.parent.__state!==Component.state.suspend)if(e){if(this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager"]).directive("cloak",{onCreate:function(){var e=this.view.attr("class");if(!e)return void LOGGER.warn("can not find attribute[class] of element["+this.view.name+"] which directive[cloak] on");e=e.replace("x-cloak","");var r=this;setTimeout(function(){t(r.parent,r.view.el,e);var i=r.view.attr("class").replace("x-cloak","");r.view.attr("class",i)},0)}}).directive("model",{onCreate:function(){var e=this.view.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=this.view.attr("type");switch(t){case"radio":this.view.on("click","changeModel($event)");break;case"checkbox":this.view.on("click","changeModelCheck($event)");break;default:var r=null===document.body.onpropertychange?"propertychange":"input";this.view.on(r,"changeModel($event)")}break;case"select":var i=e.getAttribute("multiple");null!==i?this.view.on("change","changeModelSelect($event)"):this.view.on("change","changeModel($event)")}},methods:{changeModelSelect:function(e){for(var t=e.target||e.srcElement,r=(t.value,[]),i=t.options.length;i--;){var n=t.options[i];n.selected&&r.push(n.value)}this.parent.d(this.value,r)},changeModelCheck:function(e){var t=e.target||e.srcElement,r=t.value,i=this.parent.d(this.value);if(i instanceof Array||(i=[i]),t.checked)i.push(r);else{var n=i.indexOf(r);n>-1&&i.splice(n,1)}this.parent.d(this.value,i)},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)}},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.parent.d(this.value,t)}});var i=new r;i["final"]=!0,i.priority=999,e.directive("each",i,["ViewManager","Transitions"]);var n=new r;n.endTag="each-end",n.priority=999,e.directive("each-start",n,["ViewManager"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.value)}}).filter("filterBy",{to:function(e,t){var r=this.value;if(!(r instanceof Array))return LOGGER.warn("can only filter array"),this.value;var i=[];if(e instanceof Function)for(var n=r.length;n--;){var s=e.call(this,r[n]);s&&i.unshift(r[n])}else for(var n=r.length;n--;){var a=r[n];t?(!e||(a[t]+"").indexOf(e)>-1)&&i.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&i.unshift(a)}return i}}).filter("limitBy",{to:function(e,t){return this.value instanceof Array?e?this.value.splice(t||0,e):this.value:(LOGGER.warn("can only filter array"),this.value)}}).filter("orderBy",{to:function(e,t){return e||t?this.value instanceof Array?(this.value.sort(function(t,r){var i=e?t[e]:t,n=e?r[e]:r;return"string"==typeof i?i.localeCompare(n):"number"==typeof i?i-n:(i+"").localeCompare(n)}),"desc"===t&&this.value.reverse(),this.value):(LOGGER.warn("can only filter array"),this.value):this.value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);