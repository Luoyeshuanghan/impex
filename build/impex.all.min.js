/*
 * impexjs is a powerful web application engine to build 
 * reactive webUI system
 *
 *
 * Copyright 2015-2016 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://impexjs.org
 * last build: 2016-07-12
 */
!function(global){"use strict";function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,r,n,i,s){this.node=e,this.attrName=t,this.origin=r,this.expMap=n,this.component=i,this.toHTML=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,r){this.cbk=e,this.ctrlScope=t,this.segments=r}function Component(e){var t="C_"+im_counter++;this.__id=t,this.__state=Component.state.created,this.view=e,this.name,this.parent,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,this.__watcher,this.__eventMap={},this.template,this.templateURL,this.replace=!0,this.restrict,this.isolate,this.data={},this.methods={},this.events={}}function broadcast(e,t,r){for(var n=0;n<e.length;n++){var i=e[n],s=i.__eventMap[t],a=!0;if(s){a=!1;for(var o=0;o<s.length;o++)a=s[o].apply(i,r)}a&&i.children.length>0&&broadcast(i.children,t,r)}}function View(e,t,r){this.el=e,this.__nodes=r,this.__evMap={},this.__target=t}function tmplExpFilter(e,t,r){return e=e.replace(REG_TMPL_EXP,function(e,n){var n=n.replace(/\s/gm,"");if("CONTENT"===n)return t;if("BINDPROPS"===n){for(var i="",s=Object.keys(r),a=s.length;a--;)i+=r[s[a]].nodeName+'="'+r[s[a]].nodeValue+'" ';return i}var o=r[n]&&r[n].nodeValue;return o||""})}function Directive(e,t){Component.call(this),this.value=t,this.name=e,this.params,this.filter,this["final"]=!1,this.endTag=null,this.priority=0,this.observe}function Filter(e){this.component=e,this.value,this.onCreate}function Service(){this.singleton,this.host,this.onCreate}function Transition(e,t,r){if(TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE)),r&&r.css===!1)this.__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var n=window.getComputedStyle(TESTNODE,null),i=n["transition-duration"].split(","),s=n["transition-delay"].split(","),a=-1,o=i.length;o--;){var l=parseFloat(i[o]),h=parseFloat(s[o]);l+h>a&&(a=l+h)}if(a>0){var c=t.view,p=t.__expNodes;p.length<1&&t.parent&&(p=t.parent.__expNodes);for(var o=p.length;o--;){var u=p[o];"class"===u.attrName&&(u.origin+=" "+e+"-transition")}c.addClass(e+"-transition"),this.__longest=a;var d=null;for(var v in TRANSITIONS)if(void 0!==c.el.style[v]){d=TRANSITIONS[v];break}c.el.addEventListener(d,this.__done.bind(this),!1),this.__css=!0}}this.__comp=t,this.__view=c,this.__hook=r||{},this.__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function r(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&(i[this.url]||(i[this.url]=this.responseText),this.cbk&&this.cbk(this.responseText))}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype._super=t.prototype},this.ext=function(e,t){for(var r=Object.keys(t),n=r.length;n--;){var i=r[n];e[i]=t[i]}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var n=document.createElement("div");this.isDOMStr=function(e){return n.innerHTML=e,n.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName};var i={};this.loadTemplate=function(n,s,a){if(i[n])return void(s&&s(i[n]));var o=new XMLHttpRequest;o.open("get",n,!0),o.timeout=a||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=r:o.onreadystatechange=r,o.cbk=s,o.url=n,o.send(null)}},RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),fallback=Object.observe?!1:!0,observedObjects=[],observedOldObjects=[],observedArys=[],observedOldArys=[],Object_observe=Object.observe||function(e,t){var r={};for(var n in e){var i=e[n];r[n]=i}observedOldObjects.push(e),observedObjects.push({oldVer:r,newVer:e,handler:t})},Object_unobserve=Object.unobserve||function(e,t){var r=observedOldObjects.indexOf(e);r>-1&&(observedObjects.splice(r,1),observedOldObjects.splice(r,1))},Array_observe=Array.observe||function(e,t){var r=[];if(!(e instanceof Array))throw new Error("Array.observe cannot observe non-array");for(var n=e.length;n--;)r.unshift(e[n]);observedOldArys.push(e),observedArys.push({oldVer:r,newVer:e,handler:t})},Array_unobserve=Array.unobserve||function(e,t){var r=observedOldArys.indexOf(e);r>-1&&(observedArys.splice(r,1),observedOldArys.splice(r,1))};fallback&&function e(){RAF(function(){for(var t=observedObjects.length;t--;){var r=observedObjects[t],n=r.oldVer,i=r.newVer,s=r.handler,a=[];for(var o in n){if(void 0===i[o]){var l={};l.name=o,l.oldValue=n[o],l.object=i,l.type="delete",a.push(l)}if(i[o]!==n[o]){var l={};l.name=o,l.oldValue=n[o],l.object=i,l.type="update",a.push(l)}}for(var o in i)if(void 0===n[o]){var l={};l.name=o,l.oldValue=n[o],l.object=i,l.type="add",a.push(l)}if(a.length>0){s(a),r.oldVer={};for(var o in i){var h=i[o];r.oldVer[o]=h}}}for(var t=observedArys.length;t--;){var r=observedArys[t],n=r.oldVer,i=r.newVer,s=r.handler,l=null;if(n.length===i.length){for(var c=n.length;c--;)if(i[c]!==n[c]){l={},l.type="update";break}}else if(n.length>i.length)l={},l.type="delete";else{var l={};l.type="add"}if(l){l.object=i,l.oldValue=n,s([l]),r.oldVer=[];for(var p=0;p<i.length;p++)r.oldVer.push(i[p])}}e()})}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,i){if(o.test(e)){var s=n(i,t);return c="var",s}return a.test(e)?(c="str",r(t,RegExp.$1)):(c="",e)}function r(e,t){for(var r=!1,n=t,i=1;i<e.length;i++){var s=e[i];if("\\"!==s){if(!r&&s===t)return n+t;n+=s,r=!1}else r=!0,n+=s}}function n(r,i,s,a){for(var c="",p=[],u=-1,d=-1,v=-1,f=a||e(),_=0;_<i.length;_++){var g=i[_];if(p.length>0)if(o.test(g)){var m=e(),b=n(r,i.substr(_),!0,m);_=_+b.length-1;var y=b;o.test(b[0])&&h.indexOf(y)<0&&(f.subVars["."+b]=m,h.indexOf(y)<0&&(y=["."+y])),f.words.push(y)}else if("]"===g||")"===g){if(p.pop(),0===p.length){var w=i.substring(u,_+1);c+=w,f.segments.push(w),v=_}")"===g&&(f.isFunc=!0),f.words.push(g),d=_}else{var x=t(g,i.substr(_),r);_=_+x.length-1,f.words.push(x),d=_}else if(l.test(g)){if(c+=g,"."===g){var y=c.substr(v+1);y=y.replace(/\./,""),y&&(f.segments.push(y),v=_)}}else{if("["!==g&&"("!==g){if("]"!==g&&")"!==g||!s){var y=c.substr(d+1);y&&("."!==y[0]&&h.indexOf(y)<0&&(y=["."+y]),f.words.push(y));var E=c.substr(v+1);return E&&(f.segments.push(E),v=_),!s&&h.indexOf(y)<0&&(r["."+c]=f),c}var y=c;if(y[y.length-1]!==g){y=y.substring(d+1,y.length),y&&f.words.push(0===i.indexOf(y)?["."+y]:y);var C=y.lastIndexOf(".");C>0&&(y=y.substr(C)),y&&f.segments.push(y),v=_}return d=_,c}p.push(g),u=_,f.brakLength++;var O=c.substr(d+1);if(O){var y=O;h.indexOf(O)<0&&0>d&&(y=["."+O]),f.words.push(y)}f.words.push(g);var T="["===g?"]":")";if(c[_-1]!==T){var R=O.lastIndexOf(".");R>-1?(O=O.substr(R),f.segments.push(O)):O&&f.segments.push(O),v=_}d=_}}var F=c.substr(c.lastIndexOf("]")+1),M=c.substr(c.lastIndexOf(")")+1);if(F&&M){var A=F.length<M.length?F:M,E=c.substr(v+1);f.segments.push(E);var y="["===A[0]||"("===A[0]?A:"."===A[0]?A:"."+A;f.words.length<1&&h.indexOf(y)<0&&(y=[y]),f.words.push(y)}return s||(r["."+c]=f),c}function i(e){for(var t in e){var r=e[t],n=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,r.brakLength);var l="]"===t[t.length-1]?"[":"(",h=r.brakLength;r.watchPathWords=[];for(var c=0;c<r.words.length;c++){var p=r.words[c];if(p===l&&--h<1)break;r.watchPathWords.push(p)}}else r.watchPathWords=r.words.concat(),r.watchPathWords.splice(-1,1);n=t.substr(o),r.lastVar="("===n[0]?t:n,Object.keys(r.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),r.watchPath=a);for(var c=r.segments.length;c--;)r.segments[c]=r.segments[c].replace(/^\.|\.$/g,"");i(r.subVars)}}function s(e,t){for(var r=0;r<e.length;r++){var n=e[r];if(("["===n||"("===n)&&--t<1)return r}}var a=/(['"])/,o=/[a-zA-Z$_]/,l=/[a-zA-Z$_0-9.]/,h=["as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var r=[],n={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),n);switch(s=s+o.length-1,c){case"var":r.push(h.indexOf(o)<0?["."+o]:o);break;case"str":case"":r.push(o)}}return i(n),p[e]={words:r,varTree:n},p[e]}}(),Scanner=new function(){function e(e){var r=[],n=[];t(e,r);for(var i=r.length;i--;){var e=r[i],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,r){var n=s.substring(o,r);n&&a.push(n),a.push(e),o=r+e.length});var l=s.substring(o,s.length);if(l&&a.push(l),a.length<2)n.unshift(null);else{for(var h=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);h.appendChild(p)}n.unshift(h)}}for(var c=r.length;c--;){var u=r[c];n[c]&&n[c].childNodes.length>1&&u.parentNode&&u.parentNode.replaceChild(n[c],u)}}function t(e,r){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var n=0,i=e.childNodes.length;i>n;n++)t(e.childNodes[n],r)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r.push(e)}}function r(e){if(e.restrict)return e;for(var t=e.parent;t;){if(t.name&&t.restrict)return t;t=t.parent}return null}function n(e,t){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var s=e.tagName.toLowerCase(),a=[],o=e.attributes.length;o--;){var l=e.attributes[o];a.push([l.name,l.value])}for(var h=[],o=a.length;o--;){var c=a[o][0];if(0===c.indexOf(CMD_PREFIX)){var p=c.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&(DirectiveFactory.isFinal(p)||DirectiveFactory.hasEndTag(p))&&h.push([p,a[o],DirectiveFactory.priority(p)||0])}}if(h.length>0){h.sort(function(e,t){return t[2]-e[2]});var p=h[0][0],d=h[0][1];if(DirectiveFactory.isFinal(p))return void DirectiveFactory.newInstanceOf(p,e,t,d[0],d[1]);if(DirectiveFactory.hasEndTag(p))return[p,d[1]]}if(ComponentFactory.hasTypeOf(s)){var v=r(t);if(v&&v.restrict.children){var f=v.restrict.children.split(",");if(f.indexOf(s)<0)return}var _=ComponentFactory.getRestrictOf(s);if(_&&_.parents){var g=_.parents.split(",");if(g.indexOf(v.name)<0)return}return void t.createSubComponentOf(s,e)}for(var o=a.length;o--;){var m=a[o][0],b=a[o][1];if(REG_CMD.test(m)){var p=m.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&DirectiveFactory.newInstanceOf(p,e,t,m,b)}else":"===m[0]?DirectiveFactory.newInstanceOf("on",e,t,m,b):REG_EXP.test(b)&&i(b,e,t,m)}}if(e.childNodes.length>0){for(var y=null,w=[],o=0,x=e.childNodes.length;x>o;o++)if(y){w.push(e.childNodes[o]);var E=DirectiveFactory.hasEndTag(y[0]),l=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+E);Util.isString(l)&&(DirectiveFactory.newInstanceOf(y[0],w,t,CMD_PREFIX+y[0],y[1]),y=null,w=[])}else y=n(e.childNodes[o],t),y&&w.push(e.childNodes[o]);y&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+y[0]+"]")}}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;i(e.nodeValue,e,t)}}function i(e,t,r,n){var i={},a=!n&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);if(a&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,t){var n={},a=1,o=null;FILTER_EXP.test(t)&&(o=s(lexer(RegExp.$1),n,r),a=t.indexOf(FILTER_EXP_START_TAG));var l=t;a>1&&(l=t.substring(0,a));var h=lexer(l);o&&Util.ext(h.varTree,o),i[t]={words:h.words,varTree:h.varTree,filters:n}}),!(Object.keys(i).length<1)){var o=new ExpNode(t,n,e,i,r,a);r.__expNodes.push(o)}}function s(e,t,r){for(var n=[],i=null,s=!1,a={},o=[],l=e.words,h=0;h<l.length;h++)if(l[h]instanceof Array)for(var c=l[h][0],p=c.split("."),u=1;u<p.length;u++)o.push([p[u]]);else o.push(l[h]);for(var h=0;h<o.length;h++){var c=o[h];switch(c){case":":s=!0,null!==i&&n.push(i),i="";break;case".":s=!1,null!==i&&n.push(i),i="",n=[];break;default:if(c instanceof Array){var d=c[0],v=d.toLowerCase();if(!s&&v&&FilterFactory.hasTypeOf(v))i=null,t[v]=[FilterFactory.newInstanceOf(v,r),n];else{var p=lexer(d);Util.ext(a,p.varTree),n.push(p),i=null}}else{if(!s||!c.replace(/\s+/,""))continue;i+=c.replace(/^['"]|['"]$/g,"")}}}return i&&n.push(i),a}this.scan=function(t,r){for(var i=t.__nodes?t.__nodes:[t.el],s=null,a=[],o=0,l=i.length;l>o;o++)if(e(i[o]),s){a.push(i[o]);var h=DirectiveFactory.hasEndTag(s[0]),c=i[o].getAttribute&&i[o].getAttribute(CMD_PREFIX+h);Util.isString(c)&&(DirectiveFactory.newInstanceOf(s[0],a,r,CMD_PREFIX+s[0],s[1]),s=null,a=[])}else s=n(i[o],r),s&&a.push(i[o]);s&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")},this.parseFilters=s},Builder=new function(){function prelink(e){for(var t=e.__expNodes.length;t--;){var r=e.__expNodes[t];for(var n in r.expMap){var i=r.expMap[n],s=i.varTree;for(var a in s){var o=s[a];buildExpModel(e,o,r)}}}for(var t=e.children.length;t--;){var l=e.children[t];l instanceof Directive||(l.init(),l.display())}for(var t=e.children.length;t--;){var l=e.children[t];l instanceof Directive&&l.init()}}function buildExpModel(e,t,r){for(var n in t.subVars){var i=t.subVars[n];buildExpModel(e,i,r)}for(var s=walkPropTree(e.__expPropRoot.subProps,t.segments[0],r),a=1;a<t.segments.length;a++)s=walkPropTree(s.subProps,t.segments[a],r)}function walkPropTree(e,t,r){var n=e[t];return n||(n=e[t]=new ExpProp(t)),r instanceof ExpNode?n.expNodes.indexOf(r)<0&&n.expNodes.push(r):r instanceof AttrObserveNode?n.attrObserveNodes.indexOf(r)<0&&n.attrObserveNodes.push(r):r instanceof Watch&&n.watchs.indexOf(r)<0&&n.watchs.push(r),e[t]}function observerProp(e,t,r){function n(e){r.__state!==Component.state.suspend&&null!==r.__state&&changeHandler(e)}var i=Util.isArray(e),s=Util.isObject(e);if(e&&(i||s)){if(e.$__impex__observer){var a=t.join(".");if(e.$__impex__propChains[a]){for(var o=e.$__impex__propChains[a],l=o.length;l--;)if(o[l][1]===r)return;return void o.push([t,r])}return void(e.$__impex__propChains[t.join(".")]=[[t,r]])}if(Object.defineProperty(e,"$__impex__observer",{enumerable:!1,writable:!0,value:n}),Object.defineProperty(e,"$__impex__propChains",{enumerable:!1,writable:!0,value:{}}),e.$__impex__propChains[t.join(".")]=[[t,r]],i)Object.defineProperty(e,"$__impex__oldVal",{enumerable:!1,writable:!0,value:e.concat()}),Array_observe(e,n);else if(s){if(Util.isDOM(e))return;Object_observe(e,n)}for(var h=Object.keys(e),l=h.length;l--;){var a=h[l],c=t.concat();c.push(a),observerProp(e[a],c,r)}}}function changeHandler(e){if(!Util.isString(e))for(var t=e.length;t--;){var r=e[t],n=r.name;if(!n||0!==n.indexOf("$")||"$index"===n){var i=r.object[n],s=r.oldValue;Util.isArray(r.object)&&(i=r.object,s=r.object.$__impex__oldVal);for(var a=r.object.$__impex__propChains,o=Object.keys(a),l=o.length;l--;)for(var h=o[l],c=a[h],p=c.length;p--;){var u=c[p][0],d=c[p][1],v=u.concat();n&&!Util.isArray(r.object)&&v.push(n),__propStr=null,__lastMatch=void 0,recurRender(d,v,r.type,i,s,0,d),d.__watcher instanceof Function&&d.__watcher(r.type,i,s,v),observerProp(i,v,d)}if(!Util.isArray(r.object)&&Util.isArray(r.oldValue))Array_unobserve(r.oldValue,r.oldValue.$__impex__observer);else{if(Util.isArray(r.object))return void(r.object.$__impex__oldVal=r.object.concat());if(Util.isObject(r.oldValue)){var f=r.oldValue.$__impex__observer;f&&(Object_unobserve(r.oldValue,f),r.oldValue.$__impex__observer=null,r.oldValue.$__impex__propChains=null)}}}}}function rerender(e,t,r,n,i){for(var s,a=e.__expPropRoot.subProps,o=!1,l=0;l<t.length;l++){var h=t[l];if(sqbExp.test(Object.keys(a).join(","))){o=!0;break}{if(!a[h])break;s=a[h],a=a[h].subProps}}if(s){var c=[];if(o)for(var p=t.length-l-1,u=Object.keys(s.subProps),l=u.length;l--;){var d=u[l];("["===d[0]||d===h)&&findMatchProps(s.subProps[d],p,c)}else c.push(s);for(var v=[],l=c.length;l--;){Renderer.renderExpNode(c[l].expNodes);for(var f=c[l].attrObserveNodes.length;f--;){var _=c[l].attrObserveNodes[f],g=Renderer.evalExp(_.directive,_.expObj);_.directive.observe(g)}for(var f=c[l].watchs.length;f--;){var m=c[l].watchs[f];if(!(m.segments.length<t.length||v.indexOf(m)>-1)){for(var b=!0,d=0;d<m.segments.length&&t[d];d++)if("["!==m.segments[d][0]&&"["!==t[d][0]&&m.segments[d]!==t[d]){b=!1;break}if(b){var y=n,w=i;if(m.segments.length>t.length){for(var x=m.segments.slice(d),E="$var",d=0;d<x.length;d++){var C=x[d];E+="["===C[0]?C:"."+C}try{y=new Function("$var","return "+E)(n),w=new Function("$var","return "+E)(i)}catch(O){LOGGER.debug("error on parse watch params"),y=null}}m.cbk&&m.cbk.call(m.ctrlScope,r,y,w,t),v.push(m)}}}}}}function findMatchProps(e,t,r){if(1>t)return void r.push(e);for(var n in e.subProps)findMatchProps(e.subProps[n],t-1,r)}function recurRender(component,propChain,changeType,newVal,oldVal,depth,topComp){var toRender=!0;if(depth>0){if(!__propStr){__propStr="";for(var k=0;k<propChain.length;k++){var seg=propChain[k];__propStr+="["===seg[0]?seg:"."+seg}}var prop=void 0;try{prop=eval('impex._cs["'+component.__id+'"]'+__propStr)}catch(e){}Util.isUndefined(prop)?__lastMatch&&__lastMatch!==topComp&&(toRender=!1):(__lastMatch=component,toRender=!1)}if(toRender&&rerender(component,propChain,changeType,newVal,oldVal),component.isolate)for(var pc0=propChain[0],i=component.isolate.length;i--;){var k=component.isolate[i];if(k.indexOf(".")>0){for(var kc=k.split("."),matchAll=!0,kci=0;kci<kc.length;kci++)kc[kci]!==propChain[kci]&&(matchAll=!1);if(matchAll)return}else if(k===pc0)return}for(var j=component.children.length;j--;){var subCtrlr=component.children[j];recurRender(subCtrlr,propChain,changeType,newVal,oldVal,depth+1,topComp)}}this.buildExpModel=buildExpModel,this.build=function(e){prelink(e),observerProp(e.data,[],e)};var __propStr=null,__lastMatch=void 0,sqbExp=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNode(e){for(var t={},r=e.length;r--;){var n=e[r],i=null;if(t[n.origin]&&t[n.origin].comp===n.component?i=t[n.origin].val:(i=calcExp(n.component,n.origin,n.expMap),t[n.origin]={comp:n.component,val:i}),n.toHTML){var s=renderHTML(n,i,n.node,n.component);if(s)continue}null!==i&&updateDOM(n.node,n.attrName,i)}}function updateDOM(e,t,r){if(e.setAttribute){e.setAttribute(t,r);var n=propMap[t];n&&n.indexOf(e.tagName)>-1&&(e[t]=r)}else e.parentNode&&(e.nodeValue=r)}function clone(e){if(null===e)return null;var t=e;if(e instanceof Array){t=e.concat();for(var r=t.length;r--;)t[r]=clone(t[r])}else if(Util.isObject(e)){t={};var n=Object.keys(e);if(n.length>0)for(var r=n.length;r--;){{var i=n[r];e[i]}0!==i.indexOf("$__impex__")&&(t[i]="object"==typeof e[i]?clone(e[i]):e[i])}}return t}function calcExp(e,t,r){var n={};for(var i in r){var s=r[i],a=evalExp(e,s),o=s.filters;if(Object.keys(o).length>0){a&&Util.isObject(a)&&(a=clone(a));for(var l in o){for(var h=o[l][0],c=o[l][1],p=[],u=c.length;u--;){var d=c[u];d.varTree&&d.words&&(d=Renderer.evalExp(e,d)),p[u]=d}h.value=a,a=h.to.apply(h,p)}}n[i]=void 0===a?"":a}for(var l in n)t=t.replace(EXP_START_TAG+l+EXP_END_TAG,n[l]);return t}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var r=t.varTree,n={};for(var i in r){var s=r[i],a=buildVarPath(e,s,i);n[i]=a}var o=joinExpStr(t.words,n);return o}function joinExpStr(e,t){for(var r="",n=0;n<e.length;n++){var i=e[n];r+=i instanceof Array?t[i[0]]:i}return r}function keyWordsMapping(e,t){return 0===e.indexOf(".this")?e.replace(".this",t.__getPath()):void 0}function buildVarPath(e,t,r){var n={};for(var i in t.subVars){var s=t.subVars[i],a=buildVarPath(e,s,i);n[i]=a}for(var o=!1,l="",h=0;h<t.words.length;h++){var c=t.words[h];if(c instanceof Array){if(n[c[0]]){l+=n[c[0]];continue}var p=keyWordsMapping(c[0],e);p?(o=!0,l+=p):l+=c[0]}else l+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var h=0;h<t.watchPathWords.length;h++){var c=t.watchPathWords[h];u+=c instanceof Array?n[c[0]]||c[0]:c}if(o)return l;var d=")"===r[r.length-1]?"methods":"data",v=u||l;return v="data"===d?".data"+v:"."+METHOD_PREFIX+v.substr(1),e=varInCtrlScope(e,v),e?(l="data"===d?".data"+l:"."+METHOD_PREFIX+l.substr(1),e.__getPath()+l):"self"+l}function varInCtrlScope(e,t){for(var r=e;r;){if(void 0!==getVarByPath(t,r.__getPath()))return r;r=r.parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,r,n){if(e.__lastVal!==t&&3==r.nodeType){var i=new View(null,null,[r]);if(Util.isUndefined(e.__lastVal)){var s=ViewManager.createPlaceholder("-- [html] placeholder --");ViewManager.insertBefore(s,i),e.__lastVal=t,e.__placeholder=s}e.__lastComp&&(e.__lastComp.destroy(),i=ViewManager.createPlaceholder(""),ViewManager.insertAfter(i,e.__placeholder)),Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;"));var a=n.createSubComponent(t,i);return a.init(),a.display(),e.__lastComp=a,e.__lastVal=t,!0}}this.render=function(e){renderExpNode(e.__expNodes);for(var t=e.children.length;t--;)Renderer.render(e.children[t])},this.renderExpNode=renderExpNode;var propMap={value:["INPUT"]};this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};Component.state={created:"created",inited:"inited",displayed:"displayed",suspend:"suspend"},Util.ext(Component.prototype,{d:function(path,val){var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug(e.message+"eval error on data("+evalStr+"= "+val+")")}return this}try{return eval(evalStr)}catch(e){LOGGER.debug(e.message+"eval error on data("+evalStr+")")}},m:function(e){for(var t=this;t;){if(t["$"+e]instanceof Function)return t["$"+e];t=t.parent}return null},on:function(e,t){var r=this.__eventMap[e];r||(r=this.__eventMap[e]=[]),r.push(t)},emit:function(){for(var e=arguments[0],t=[this],r=1;r<arguments.length;r++)t.push(arguments[r]);var n=this.parent;setTimeout(function(){for(;n;){var r=n.__eventMap[e];if(r){for(var i=!0,s=0;s<r.length;s++)i=!r[s].apply(n,t);if(i)return}n=n.parent}},0)},broadcast:function(){for(var e=arguments[0],t=[this],r=1;r<arguments.length;r++)t.push(arguments[r]);var n=this;setTimeout(function(){broadcast(n.children,e,t)},0)},find:function(e,t,r){e=e.toLowerCase();for(var n=[],i=this.children.length;i--;){var s=this.children[i];if("*"===e||s.name===e){var a=!0;if(t)for(var o in t)if(s[o]!==t[o]){a=!1;break}a&&n.push(s)}if(r&&s.children.length>0){var l=s.find(e,t,!0);n&&(n=n.concat(l))}}return n},watch:function(e,t){if("*"===e)this.__watcher=t;else{var r=lexer(e),n=Object.keys(r.varTree);if(n.length<1)return;if(n.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var i=r.varTree[n[0]],s=new Watch(t,this,i.segments);Builder.buildExpModel(this,i,s)}return this},add:function(e){this.children.push(e),e.parent=this},createSubComponentOf:function(e,t){var r=ComponentFactory.newInstanceOf(e,t.__nodes?t.__nodes[0]:t);return this.children.push(r),r.parent=this,r},createSubComponent:function(e,t){var r=ComponentFactory.newInstance(e,t&&t.__nodes[0]);return this.children.push(r),r.parent=this,r},init:function(){if(this.__state===Component.state.created){if(impex._cs[this.__id]=this,this.templateURL){var e=this;Util.loadTemplate(this.templateURL,function(t){var r=e.view.__init(t,e);r!==!1&&(e.__init(t),e.display())})}else{if(this.template){var t=this.view.__init(this.template,this);if(t===!1)return}this.__init(this.template)}return this}},__init:function(e){Scanner.scan(this.view,this),LOGGER.log(this,"inited");var t=null;return this.onInit&&(t=this.onInit(e)),t===!1?void this.destroy():void(this.__state=Component.state.inited)},display:function(){(this.__state===Component.state.inited||this.__state===Component.state.suspend)&&(this.view.__display(this),this.__state!==Component.state.suspend&&(Renderer.render(this),Builder.build(this)),this.__state=Component.state.displayed,LOGGER.log(this,"displayed"),this.onDisplay&&this.onDisplay())},destroy:function(){if(null!==this.__state){if(LOGGER.log(this,"destroy"),this.parent){var e=this.parent.children.indexOf(this);e>-1&&this.parent.children.splice(e,1),this.parent=null}for(this.view.__destroy(this);this.children.length>0;)this.children[0].destroy();if(this.view=this.children=this.__expNodes=this.__expPropRoot=null,this.onDestroy&&this.onDestroy(),!CACHEABLE||!this.name||this instanceof Directive)impex._cs[this.__id]=null,delete impex._cs[this.__id],this.__impex__observer=this.__impex__propChains=this.__state=this.__id=this.templateURL=this.template=this.restrict=this.isolate=this.methods=this.events=this.data=null;else{var t=im_compCache[this.name];t||(t=im_compCache[this.name]=[]),this.__state=Component.state.created,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,t.push(this)}}},suspend:function(e){(this instanceof Directive||this.__state===Component.state.displayed)&&(LOGGER.log(this,"suspend"),this.view.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.__state=Component.state.suspend)},__getPath:function(){return'impex._cs["'+this.__id+'"]'}}),View.prototype={__init:function(e,t){var r=this.__target.attributes,n=this.__target.innerHTML,i=tmplExpFilter(e,n,r);t.onBeforeCompile&&(i=t.onBeforeCompile(i));var s=DOMViewProvider.compile(i);if(!s||s.length<1)return LOGGER.error('invalid template "'+e+'" of component['+t.name+"]"),!1;if(this.__nodes=s,this.el=t.replace?1===s.length&&1===s[0].nodeType?s[0]:null:this.__target,s.length>1&&LOGGER.warn("more than 1 root node of component["+t.name+"]"),r)for(var a=r.length;a--;){var o=r[a].name.toLowerCase();o.indexOf("-")>-1&&(o=o.replace(/-[a-z0-9]/g,function(e){return e[1].toUpperCase()}));var l=r[a].value;t.data[o]=l}this.__comp=t},__display:function(e){if(this.__target&&this.__target.parentNode){var t=null;if(this.__nodes.length>1){t=document.createDocumentFragment();for(var r=0;r<this.__nodes.length;r++)t.appendChild(this.__nodes[r])}else t=this.__nodes[0];e.replace?this.__target.parentNode.replaceChild(t,this.__target):(this.__target.innerHTML="",this.__target.appendChild(t)),t=null,this.__target=null}},__destroy:function(e){for(var t in this.__evMap)for(var r=this.__evMap[t],n=r.length;n--;)for(var i=r[n],s=i[1],a=this.__nodes.length;a--;)1===this.__nodes[a].nodeType&&this.__nodes[a].removeEventListener(t,s,!1);var o=this.__nodes[0].parentNode;if(o){this.__nodes[0].__impex__view&&(this.__nodes[0].__impex__view=null);for(var n=this.__nodes.length;n--;)this.__nodes[n].parentNode&&o.removeChild(this.__nodes[n])}this.__target&&(this.__target.parentNode.removeChild(this.__target),this.__target=null)},__suspend:function(e,t){var r=this.__nodes[0].parentNode;if(r){t&&(this.__target=document.createComment("-- view suspended of ["+(e.name||"anonymous")+"] --"),r.insertBefore(this.__target,this.__nodes[0]));for(var n=this.__nodes.length;n--;)this.__nodes[n].parentNode&&r.removeChild(this.__nodes[n])}},on:function(e,t,r){if(this.el){var n=t,i=this.__comp,s="",a=null,o=function(t){var o=n;if(r instanceof Function&&(o=r.call(i,t,n)),o){if(s!=o){var l=lexer(o),h=Renderer.getExpEvalStr(i,l),c=h.replace("self.$event","$event");a=new Function("$event",c),s=o}try{a(t)}catch(p){LOGGER.debug(p.message+" on event "+e+"("+c+")")}}};this.el.addEventListener(e,o,!1),this.__evMap[e]||(this.__evMap[e]=[]),this.__evMap[e].push([t,o])}},off:function(e,t){if(this.el)for(var r=this.__evMap[e],n=r.length;n--;){var i=r[n],s=i[0],a=i[1];s==t&&this.el.removeEventListener(e,a,!1)}},clone:function(){for(var e=[],t=this.__nodes.length;t--;){var r=this.__nodes[t].cloneNode(!0);e.unshift(r)}var n=new View(1===e.length&&1===e[0].nodeType?e[0]:null,null,e);return n},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},style:function(e,t){return arguments.length>1?(this.el.style[e]=t,this):this.el.style[e]},attr:function(e,t){return arguments.length>1?(this.el.setAttribute(e,t),this):this.el.getAttribute(e)},removeAttr:function(e){return this.el.removeAttribute(e),this},hasClass:function(e){return this.el.className.indexOf(e)>-1},addClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,""),e=e.split(" ");for(var t=this.el.className.split(" "),r="",n=e.length;n--;)t.indexOf(e[n])<0&&(r+=e[n]+" ");return this.el.className+=" "+r,this},removeClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");var t=e.split(" "),r=this.el.className;if(r){for(var n=t.length;n--;){var i=t[n],s=new RegExp("^"+i+"\\s+|\\s+"+i+"$|\\s+"+i+"\\s+","img");r=r.replace(s,"")}this.el.className=r}return this},toggleClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");for(var t=e.split(" "),r=!1,n=this.el.className,i=t.length;i--;){var s=t[i];if(n.indexOf(s)<0){r=!0;break}}r?this.addClass(e):this.removeClass(e)}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,r){if(""===t)return new View(null,r,[document.createTextNode("")]);if(e.innerHTML=t,!e.childNodes[0])return null;for(var n=[];e.childNodes.length>0;){var i=e.removeChild(e.childNodes[0]);n.push(i)}var s=new View(null,r,n);return s},this.compile=function(t){e.innerHTML=t;for(var r=[];e.childNodes.length>0;){{var n=e.removeChild(e.childNodes[0]);n.nodeName.toLowerCase()}if(3===n.nodeType){var i=n.nodeValue.replace(/\s/gm,"");if(""===i)continue}r.push(n)}return r}},ViewManager=new function(){this.singleton=!0,this.replace=function(e,t){var r=t.__nodes[0],n=e.__nodes[0],i=t.__nodes[0].parentNode,s=n;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}if(t.__nodes.length>1){i.insertBefore(s,r);for(var a=t.__nodes.length;a--;)i.removeChild(t.__nodes[a])}else i.replaceChild(s,r)},this.insertBefore=function(e,t){var r=t.__nodes[0],n=e.__nodes[0],i=t.__nodes[0].parentNode,s=n;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}i&&i.insertBefore(s,r)},this.insertAfter=function(e,t){var r=t.__nodes[0],n=e.__nodes[0],i=t.__nodes[0].parentNode,s=i.lastChild,a=n;if(e.__nodes.length>1){a=document.createDocumentFragment();for(var o=0;o<e.__nodes.length;o++)a.appendChild(e.__nodes[o])}if(s==r)i.appendChild(a);else{var l=t.__nodes[t.__nodes.length-1].nextSibling;i.insertBefore(a,l)}},this.append=function(e,t){var r=e.__nodes[0],n=t.__nodes[0],i=r;if(e.__nodes.length>1){i=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)i.appendChild(e.__nodes[s])}n.appendChild(i)},this.prepend=function(e,t){var r=e.__nodes[0],n=t.__nodes[0],i=r;if(e.__nodes.length>1){i=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)i.appendChild(e.__nodes[s])}n.insertBefore(i,n.firstChild)},this.createPlaceholder=function(e){return new View(null,null,[document.createComment(e)])}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){impex._cs[this.__id]=this;var e={},t=this;this.value.replace(REG_EXP,function(r,n){var i=lexer(n),s=Renderer.evalExp(t.parent,i);e[n]={val:s}});var r=this.value;for(var n in e)r=r.replace(EXP_START_TAG+n+EXP_END_TAG,e[n].val);if(this.value=r,LOGGER.log(this,"inited"),this.onInit&&(l=this.onInit()),this.__state=Component.state.inited,
this.observe){var i=lexer(r);for(var s in i.varTree){var a=i.varTree[s],o=new AttrObserveNode(this,i);this.parent&&Builder.buildExpModel(this.parent,a,o)}var l=Renderer.evalExp(this.parent,i);this.observe(l)}}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},TESTNODE;Transition.prototype={enter:function(){this.__start="enter",this.__css&&this.__view.addClass(this.__type+"-enter"),this.__comp.enter&&this.__comp.enter(),this.__hook.enter&&this.__hook.enter.call(this.__comp,this.__enterDone.bind(this)),this.__css&&(this.__view.el.offsetHeight,this.__view.removeClass(this.__type+"-enter"))},__enterDone:function(){},leave:function(){this.__start="leave",this.__css&&this.__view.addClass(this.__type+"-leave"),this.__hook.leave&&(this.__leaveDone.__trans=this,this.__hook.leave.call(this.__comp,this.__leaveDone.bind(this)))},__leaveDone:function(){this.__comp.leave&&this.__comp.leave()},__done:function(e){if(!(e.elapsedTime<this.__longest)&&this.__start){switch(this.__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.__start="",this.__view.removeClass(this.__type+"-leave")}}},Factory.prototype={register:function(e,t,r){e=e.toLowerCase();var n=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),i={},s=t.data;if(delete t.data,Util.ext(i,t),Util.inherits(n,this.baseClass),t.methods)for(var a in t.methods)n.prototype[METHOD_PREFIX+a]=t.methods[a];this.types[e]={clazz:n,props:i,services:r,data:s}},hasTypeOf:function(e){return e in this.types},createCbk:function(e,t){if(e.onCreate){var r=null;if(this.types[t].services){r=[];for(var n=0;n<this.types[t].services.length;n++){var i=ServiceFactory.newInstanceOf(this.types[t].services[n],e);r.push(i)}}r?e.onCreate.apply(e,r):e.onCreate()}}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.restrict},newInstance:function(e){var t=null;if(2===arguments.length){var r=arguments[0],n=arguments[1];t=r,Util.isString(r)?t=this.viewProvider.newInstance(r,n):t.__target=n}else t=e,Util.isDOM(e)&&(t=new View(e,null,[e]));var i=new this.baseClass(t),s=arguments[2];if(s&&Util.ext(i,s),i.methods)for(var a in i.methods)i[METHOD_PREFIX+a]=i.methods[a];if(i.events)for(var a in i.events)i.on(a,i.events[a]);return i},newInstanceOf:function(e,t){if(!this.types[e])return null;var r=null,n=im_compCache[e];if(CACHEABLE&&n&&n.length>0)r=n.pop();else{r=new this.types[e].clazz(this.baseClass),Util.ext(r,this.types[e].props);var i=this.types[e].data;i&&Util.ext(r.data,i),r.name=e}if(r.view=new View(null,t),r.events)for(var s in r.events)r.on(s,r.events[s]);return this._super.createCbk.call(this,r,e),r}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props["final"]},hasEndTag:function(e){return this.types[e].props.endTag},priority:function(e){return this.types[e].props.priority},newInstanceOf:function(e,t,r,n,i){if(!this.types[e])return null;var s=null,a=null,o=n.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=n.substr(o+1);var l=s.indexOf(CMD_FILTER_DELIMITER);l>-1&&(a=s.substr(l+1),s=s.substring(0,l)),s=s.split(CMD_PARAM_DELIMITER)}var h=new this.types[e].clazz(this.baseClass,n,i,r);if(Util.ext(h,this.types[e].props),t.__impex__view)h.view=t.__impex__view;else{var c=t,p=[t];Util.isArray(t)&&(p=t,c=t.length>1?null:t[0]),h.view=new View(c,null,p),t.__impex__view=h.view}if(s&&(h.params=s),a&&(h.filter=a),h.view.__comp=h,r.add(h),h.view&&(h.view.__nodes[0].removeAttribute(h.name),h.endTag)){var u=h.view.__nodes[h.view.__nodes.length-1];u.removeAttribute(CMD_PREFIX+h.endTag)}if(h.events)for(var d in h.events)h.on(d,h.events[d]);return this._super.createCbk.call(this,h,e),h}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var r=new this.types[e].clazz(this.baseClass,t);return Util.ext(r,this.types[e].props),this._super.createCbk.call(this,r,e),r}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var r=null;return this.types[e].props.singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),r=this.types[e].singleton):r=new this.types[e].clazz(this.baseClass),Util.ext(r,this.types[e].props),r.host=t,this._super.createCbk.call(this,r,e),r}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var r=new Transition(e,t,this.hooks[e]);return r}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,METHOD_PREFIX="$",EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},CACHEABLE=!1,im_compCache={},im_counter=0,impex=new function(){function e(e){var r=e;do{if(t.indexOf(r)>-1)return!0;r=r.parentNode}while(r);return!1}this.version={v:[0,20,0],state:"beta",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},CACHEABLE=e.cacheable||!1},this.component=function(e,t,r){return t.template||t.templateURL?(ComponentFactory.register(e,t,r),this):void LOGGER.error("can not find property 'template' or 'templateURL' of component '"+e+"'")},this.directive=function(e,t,r){return DirectiveFactory.register(e,t,r),this},this.service=function(e,t,r){return ServiceFactory.register(e,t,r),this},this.filter=function(e,t,r){return FilterFactory.register(e,t,r),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.render=function(r,n,i){if(!r)return void LOGGER.error("invalid element, can not render");var s=r.tagName.toLowerCase();if(e(r))return void LOGGER.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,r);if(a||(t.push(r),a=ComponentFactory.newInstance(r,null,n)),a.onCreate){var o=null;if(Util.isArray(i)){o=[];for(var l=0;l<i.length;l++){var h=ServiceFactory.newInstanceOf(i[l],a);o.push(h)}}o?a.onCreate.apply(a,o):a.onCreate()}return a.init(),a.display(),a};var t=[];Object.defineProperty(this,"_cs",{enumerable:!1,writable:!0,value:{}})};impex.service("ViewManager",ViewManager),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,r,n){for(var i=e.__expNodes.length;i--;){var s=e.__expNodes[i];s.node==r&&"class"===s.attrName&&(s.origin=n)}for(var a=e.children.length;a--;)t(e.children[a],r,n)}function r(){function e(e,t,r){for(var n=[],i=e;t>=i;i+=r)n.push(i);return n}function t(e){for(var r=0;r<e.children.length;r++){var n=e.children[r];n.onDisplay&&n.onDisplay(),n.children.length>0&&t(n)}}function r(e,t){if(null===e)return null;var n=e;if(e instanceof Array){n=e.concat();for(var i=n.length;i--;)n[i]=r(n[i],t)}else if(Util.isObject(e)){n={};var s=Object.keys(e);if(s.length>0)for(var a=t===!1?!1:!e.$__impex__origin,i=s.length;i--;){{var o=s[i];e[o]}0!==o.indexOf("$__impex__")&&(n[o]="object"==typeof e[o]?r(e[o],a):e[o])}t===!1||n.$__impex__origin||(n.$__impex__origin=e)}return n}this.onCreate=function(e,t){this.eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.forExp=/^\s*(\d+|[a-zA-Z_$].+?)\s+to\s+(\d+|[a-zA-Z_$].+?)\s*$/,this.viewManager=e,this.expInfo=this.parseExp(this.value),this.parentComp=this.parent,this.__view=this.view,this.cache=[],this.cacheable=this.view.el?"false"===this.view.attr("cache")?!1:!0:"false"===this.view.__nodes[0].getAttribute("cache")?!1:!0,this.subComponents=[],this.cacheSize=20,this.step=this.view.el?this.view.attr("step"):this.view.__nodes[0].getAttribute("step");var r=this.view.el?this.view.attr("transition"):this.view.__nodes[0].getAttribute("transition");null!==r&&(this.trans=r,this.ts=t)},this.onInit=function(){if(this.__state!==Component.state.inited){var t=this;if(this.forExp.test(this.expInfo.ds)){var r=RegExp.$1,n=RegExp.$2,i=parseFloat(this.step);if(0>i)return void LOGGER.error("step <=0 : "+i);i=i||1,isNaN(r)&&(this.parent.watch(r,function(r,s,a){var o=e(s,n,i);t.lastDS=o,t.rebuild(o,t.expInfo.k,t.expInfo.v)}),r=this.parent.d(r)),isNaN(n)&&(this.parent.watch(n,function(n,s,a){var o=e(r,s,i);t.lastDS=o,t.rebuild(o,t.expInfo.k,t.expInfo.v)}),n=this.parent.d(n)),r=parseFloat(r),n=parseFloat(n),this.ds=e(r,n,i)}else this.ds=this.parent.d(this.expInfo.ds),this.parentComp.watch(this.expInfo.ds,function(e,r,n){return t.ds?(t.lastDS=r,void t.rebuild(r,t.expInfo.k,t.expInfo.v)):(t.ds=t.parentComp.d(t.expInfo.ds),t.lastDS=t.ds,void t.build(t.ds,t.expInfo.k,t.expInfo.v))});this.lastDS=this.ds,this.placeholder=this.viewManager.createPlaceholder("-- directive [each] placeholder --"),this.viewManager.insertBefore(this.placeholder,this.view),this.ds&&this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy()}},this.rebuild=function(e,r,n){e=this.doFilter(e);for(var i=this.subComponents.length;i--;)this.subComponents[i].destroy();this.subComponents=[];for(var s=e.length;s--;)this.createSubComp();var a=Util.isArray(e)?!0:!1,o=0;for(var l in e)if(e.hasOwnProperty(l)&&!(a&&isNaN(l)||0===l.indexOf("$__"))){var h=this.subComponents[o],c=e[l];e[l]&&e[l].$__impex__origin&&(c=e[l].$__impex__origin,e[l].$__impex__origin=null,delete e[l].$__impex__origin),h.data[n]=c,h.data.$index=o++,r&&(h.data[r]=a?l>>0:l),h.init();var p="suspend"===h.__state?!0:!1;h.display(),p&&Builder.build(h),t(h)}},this.createSubComp=function(){var e=this.parentComp,t=this.viewManager.createPlaceholder("");this.viewManager.insertBefore(t,this.placeholder);var r=this.__view.clone(),n=e.createSubComponent(r,t);if(this.subComponents.push(n),this.trans){var i=this;n.onInit=function(){this.transition||(this.transition=i.ts.get(i.trans,this))},n.onDisplay=function(){this.transition.enter()},n.leave=function(){this.suspend(!1),this.__leaving=!1}}return n},this.doFilter=function(e){if(!this.filters)return e;var t=this.filters;if(Object.keys(t).length>0){e&&Util.isObject(e)&&(e=r(e));for(var n in t){for(var i=t[n][0],s=t[n][1],a=[],o=s.length;o--;){var l=s[o];l.varTree&&l.words&&(l=Renderer.evalExp(this.parentComp,l)),a[o]=l}i.value=e,e=i.to.apply(i,a)}return e}},this.build=function(e,t,r){var n=Util.isArray(e)?!0:!1,i=0;e=this.doFilter(e);for(var s in e)if(e.hasOwnProperty(s)&&!(n&&isNaN(s)||0===s.indexOf("$__"))){var a=this.createSubComp(),o=e[s];e[s]&&e[s].$__impex__origin&&(o=e[s].$__impex__origin,e[s].$__impex__origin=null,delete e[s].$__impex__origin),a.data[r]=o,a.data.$index=i++,t&&(a.data[t]=n?s>>0:s)}for(var l=this.subComponents.length;l--;)this.subComponents[l].init(),this.subComponents[l].display()},this.parseExp=function(e){var t,r,n,i=this;return e.replace(this.eachExp,function(e,s,a,o){t=s;var l=a.replace(/\s/gm,""),h=l.split(",");if(h.length>1?(r=h[0],n=h[1]):n=h[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,i.parent);i.filters=c;for(var u in p)i.parent.watch(u,function(e,t,r){i.lastDS&&i.rebuild(i.lastDS,i.expInfo.k,i.expInfo.v)})}}),t?{ds:t,k:r,v:n}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{"final":!0}).directive("on",{onInit:function(){for(var e=this.params.length;e--;)this.view.on(this.params[e],this.value)}}).directive("bind",{onInit:function(){(!this.params||this.params.length<1)&&LOGGER.warn("at least one attribute be binded")},observe:function(e){if(this.params&&!(this.params.length<1)){var t=null;if(this.filter&&(t=this.m(this.filter)),t){var r=t(e);if(!Util.isUndefined(r)&&!r)return}for(var n=this.params.length;n--;){var i=this.params[n];this.view.attr(i,e)}}}}).directive("show",{onCreate:function(e){var t=this.view.attr("transition");null!==t&&(this.transition=e.get(t,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&e!==this.lastRs&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){e?this.view.show():this.view.hide()}},["Transitions"]).directive("show-start",{endTag:"show-end",onCreate:function(){this.__init(),this.display()},observe:function(e){if(this.parent.__state!==Component.state.suspend){var t=this.view.__nodes;if(e)for(var r=t.length;r--;)t[r].style&&(t[r].style.display="");else for(var r=t.length;r--;)t[r].style&&(t[r].style.display="none")}}}).directive("if",{onCreate:function(e,t){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --");var r=this.view.attr("transition");null!==r&&(this.transition=t.get(r,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&(e!==this.lastRs||this.view.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.view.el.parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.el.parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager","Transitions"]).directive("if-start",{endTag:"if-end",onCreate:function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --"),this.__init(),this.display()},observe:function(e){if(this.parent.__state!==Component.state.suspend)if(e){if(this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager"]).directive("cloak",{onCreate:function(){var e=this.view.attr("class");if(!e)return void LOGGER.warn("can not find attribute[class] of element["+this.view.name+"] which directive[cloak] on");e=e.replace("x-cloak","");var r=this;setTimeout(function(){t(r.parent,r.view.el,e);var n=r.view.attr("class").replace("x-cloak","");r.view.attr("class",n)},0)}}).directive("model",{onCreate:function(){var e=this.view.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=this.view.attr("type");switch(t){case"radio":this.view.on("click","changeModel($event)");break;case"checkbox":this.view.on("click","changeModelCheck($event)");break;default:var r=null===document.body.onpropertychange?"propertychange":"input";this.view.on(r,"changeModel($event)")}break;case"select":var n=e.getAttribute("multiple");null!==n?this.view.on("change","changeModelSelect($event)"):this.view.on("change","changeModel($event)")}},methods:{changeModelSelect:function(e){for(var t=e.target||e.srcElement,r=(t.value,[]),n=t.options.length;n--;){var i=t.options[n];i.selected&&r.push(i.value)}this.parent.d(this.value,r)},changeModelCheck:function(e){var t=e.target||e.srcElement,r=t.value,n=this.parent.d(this.value);if(n instanceof Array||(n=[n]),t.checked)n.push(r);else{var i=n.indexOf(r);i>-1&&n.splice(i,1)}this.parent.d(this.value,n)},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)}},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.parent.d(this.value,t)}});var n=new r;n["final"]=!0,n.priority=999,e.directive("each",n,["ViewManager","Transitions"]);var i=new r;i.endTag="each-end",i.priority=999,e.directive("each-start",i,["ViewManager"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.value)}}).filter("filterBy",{to:function(e,t){var r=this.value;if(!(r instanceof Array))return LOGGER.warn("can only filter array"),this.value;var n=[];if(e instanceof Function)for(var i=r.length;i--;){var s=e.call(this,r[i]);s&&n.unshift(r[i])}else for(var i=r.length;i--;){var a=r[i];t?(!e||(a[t]+"").indexOf(e)>-1)&&n.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&n.unshift(a)}return n}}).filter("limitBy",{to:function(e,t){return this.value instanceof Array?e?this.value.splice(t||0,e):this.value:(LOGGER.warn("can only filter array"),this.value)}}).filter("orderBy",{to:function(e,t){return e||t?this.value instanceof Array?(this.value.sort(function(t,r){var n=e?t[e]:t,i=e?r[e]:r;return"string"==typeof n?n.localeCompare(i):"number"==typeof n?n-i:(n+"").localeCompare(i)}),"desc"===t&&this.value.reverse(),this.value):(LOGGER.warn("can only filter array"),this.value):this.value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);