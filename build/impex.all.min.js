/*
 * impexjs is a powerful web application engine to build 
 * reactive webUI system
 *
 *
 * Copyright 2015-2016 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://impexjs.org
 * last build: 2016-07-19
 */
!function(global){"use strict";function setArray(e,t,i){isNaN(t)||(e[t>>0]=i)}function delArray(e,t){isNaN(t)||e.splice(t,1)}function observeData(e,t,i,n){if(i&&i.__im__propChain)return i;var r=i instanceof Array?[]:{};for(var s in i){var a=i[s];if("object"==typeof a){var o=t.concat();o.push(s);var l=observeData(e,o,a,n);r[s]=l}else r[s]=a}Object.defineProperty(r,"__im__propChain",{enumerable:!1,writable:!1,value:t}),Object.defineProperty(r,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]});var h=new Proxy(r,e);return Object.defineProperty(h,"__im__target",{enumerable:!1,writable:!1,value:r}),h}function getter(e){return this.__im__innerProps[e]}function setter(e,t){var i=this.__im__innerProps[e];if("object"==typeof t){var n=this.__im__propChain.concat();n.push(e),t=observeData(n,t,this.__im__comp)}this.__im__innerProps[e]=t;this.__im__propChain,this.__im__extPropChain;handler([{name:e,target:this,oldVal:i,newVal:t,type:"update"}])}function observeData(e,t,i){var n=t instanceof Array?[]:{};Object.defineProperty(n,"__im__innerProps",{enumerable:!1,writable:!0,value:{}});var r={},s={};for(var a in t)if(t.hasOwnProperty(a)){var o=t[a];if("object"==typeof o){var l=e.concat();l.push(a);var h=observeData(l,o,i);n.__im__innerProps[a]=h}else n.__im__innerProps[a]=o;s[a]=o,!function(e){r[e]={get:function(){return getter.call(this,e)},set:function(t){setter.call(this,e,t)},enumerable:!0,configurable:!0}}(a)}Object.defineProperties(n,r),Object.defineProperty(n,"__im__propChain",{enumerable:!1,writable:!1,value:e}),Object.defineProperty(n,"__im__extPropChain",{enumerable:!1,writable:!0,value:[]}),Object.defineProperty(n,"__im__target",{enumerable:!1,writable:!1,value:n.__im__innerProps}),Object.defineProperty(n,"__im__comp",{enumerable:!1,writable:!1,value:i});var c=Date.now()+Math.random();return Object.defineProperty(n,"__im__oid",{enumerable:!1,writable:!1,value:c}),observedObjects.push({snap:s,now:n,id:c}),n}function dirtyCheck(){RAF(function(){for(var e=observedObjects.length;e--;){var t=observedObjects[e],i=t.snap,n=t.now,r=(t.id,[]);for(var s in i)if(!(s in n)){var a={};a.name=s,a.target=n,a.oldVal=i[s],a.snap=i,a.type="delete",a.id=r.push(a)}for(var s in n)if(!(s in i)){var a={};a.name=s,a.target=n,a.newVal=n[s],a.snap=i,a.type="add",r.push(a)}r.length>0&&handler(r)}dirtyCheck()})}function clearObserve(e){for(var t=observedObjects.length;t--;){var i=observedObjects[t];if("object"==typeof i&&clearObserve(i),i.id===e.__im__oid)break}observedObjects.splice(t,1)}function handler(e){for(var t=e.length;t--;){var i=e[t],n=i.name,r=i.target,s=r.__im__propChain,a=r.__im__extPropChain,o=r.__im__comp,l=i.oldVal,h=i.newVal,c=i.type,p=i.snap;if("add"===c&&(p[n]=h,"object"==typeof h)){var u=s.concat();u.push(n),r.__im__innerProps[n]=observeData(u,h,o),Object.defineProperty(r,n,{get:function(){return getter.call(this,n)},set:function(e){setter.call(this,n,e)},enumerable:!0,configurable:!0})}if("delete"===c){{p[n]}delete p[n]}var v={object:r,name:n,pc:s,xpc:a,oldVal:l,newVal:h,comp:o,type:c};Builder.handleChange(v)}}function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,i,n,r,s){this.node=e,this.attrName=t,this.origin=i,this.expMap=n,this.component=r,this.toHTML=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,i){this.cbk=e,this.ctrlScope=t,this.segments=i}function Component(e){var t="C_"+im_counter++;this.__id=t,this.__state=Component.state.created,this.view=e,this.name,this.parent,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,this.__watcher,this.__eventMap={},this.template,this.templateURL,this.replace=!0,this.restrict,this.isolate,this.data={},this.methods={},this.events={},impex._cs[this.__id]=this}function broadcast(e,t,i){for(var n=0;n<e.length;n++){var r=e[n],s=r.__eventMap[t],a=!0;if(s){a=!1;for(var o=0;o<s.length;o++)a=s[o].apply(r,i)}a&&r.children.length>0&&broadcast(r.children,t,i)}}function View(e,t,i){this.el=e,this.__nodes=i,this.__evMap={},this.__target=t}function tmplExpFilter(e,t,i){return e=e.replace(REG_TMPL_EXP,function(e,n){var n=n.replace(/\s/gm,"");if("CONTENT"===n)return t;if("BINDPROPS"===n){for(var r="",s=Object.keys(i),a=s.length;a--;)r+=i[s[a]].nodeName+'="'+i[s[a]].nodeValue+'" ';return r}var o=i[n]&&i[n].nodeValue;return o||""})}function Directive(e,t){Component.call(this),this.value=t,this.name=e,this.params,this.filter,this["final"]=!1,this.endTag=null,this.priority=0,this.observe}function Filter(e){this.component=e,this.value,this.onCreate}function Service(){this.singleton,this.host,this.onCreate}function Transition(e,t,i){if(TESTNODE||(TESTNODE=document.createElement("div"),document.body.appendChild(TESTNODE)),i&&i.css===!1)this.__css=!1;else{TESTNODE.className=e+"-transition",TESTNODE.style.left="-9999px";for(var n=window.getComputedStyle(TESTNODE,null),r=n["transition-duration"].split(","),s=n["transition-delay"].split(","),a=-1,o=r.length;o--;){var l=parseFloat(r[o]),h=parseFloat(s[o]);l+h>a&&(a=l+h)}if(a>0){var c=t.view,p=t.__expNodes;p.length<1&&t.parent&&(p=t.parent.__expNodes);for(var o=p.length;o--;){var u=p[o];"class"===u.attrName&&(u.origin+=" "+e+"-transition")}c.addClass(e+"-transition"),this.__longest=a;var v=null;for(var _ in TRANSITIONS)if(void 0!==c.el.style[_]){v=TRANSITIONS[_];break}c.el.addEventListener(v,this.__done.bind(this),!1),this.__css=!0}}this.__comp=t,this.__view=c,this.__hook=i||{},this.__type=e}function Factory(e){this.types={},this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _FilterFactory(){Factory.call(this,Filter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){LOGGER.error("can not fetch remote data of : "+this.url)}function t(){LOGGER.error("load timeout : "+this.url)}function i(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&(r[this.url]||(r[this.url]=this.responseText),this.cbk&&this.cbk(this.responseText))}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype._super=t.prototype},this.ext=function(e,t){for(var i=Object.keys(t),n=i.length;n--;){var r=i[n];e[r]=t[r]}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function};var n=document.createElement("div");this.isDOMStr=function(e){return n.innerHTML=e,n.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName};var r={};this.loadTemplate=function(n,s,a){if(r[n])return void(s&&s(r[n]));var o=new XMLHttpRequest;o.open("get",n,!0),o.timeout=a||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=i:o.onreadystatechange=i,o.cbk=s,o.url=n,o.send(null)}},Observer={observe:function(e,t){if(e&&e.__im__propChain)return e;var i={comp:t,set:function(e,t,i){var n=!(t in e),r=e[t],s=i;if(r===s)return!0;if("object"==typeof s){var a=e.__im__propChain.concat();a.push(t),s=observeData(this,a,s,this.comp)}e instanceof Array?setArray(e,t,s):e[t]=s;var o=e.__im__propChain,l=e.__im__extPropChain,h={object:e,name:t,pc:o,xpc:l,oldVal:r,newVal:s,comp:this.comp,type:n?"add":"update"};return Builder.handleChange(h),!0},deleteProperty:function(e,t){var i=e[t];e instanceof Array?delArray(e,t):delete e[t];var n=e.__im__propChain,r=e.__im__extPropChain,s={object:e,name:t,pc:n,xpc:r,oldVal:i,comp:this.comp,type:"delete"};return Builder.handleChange(s),!0}};return observeData(i,[],e,t)}};if(!window.Proxy){var RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),observedObjects=[],observedArys=[],Observer={};Observer.observe=function(e,t){return e&&e.__im__propChain?e:observeData([],e,t)},dirtyCheck()}var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,r){if(o.test(e)){var s=n(r,t);return c="var",s}return a.test(e)?(c="str",i(t,RegExp.$1)):(c="",e)}function i(e,t){for(var i=!1,n=t,r=1;r<e.length;r++){var s=e[r];if("\\"!==s){if(!i&&s===t)return n+t;n+=s,i=!1}else i=!0,n+=s}}function n(i,r,s,a){for(var c="",p=[],u=-1,v=-1,_=-1,d=a||e(),f=0;f<r.length;f++){var m=r[f];if(p.length>0)if(o.test(m)){var g=e(),b=n(i,r.substr(f),!0,g);f=f+b.length-1;var y=b;o.test(b[0])&&h.indexOf(y)<0&&(d.subVars["."+b]=g,h.indexOf(y)<0&&(y=["."+y])),d.words.push(y)}else if("]"===m||")"===m){if(p.pop(),0===p.length){var w=r.substring(u,f+1);c+=w,d.segments.push(w),_=f}")"===m&&(d.isFunc=!0),d.words.push(m),v=f}else{var x=t(m,r.substr(f),i);f=f+x.length-1,d.words.push(x),v=f}else if(l.test(m)){if(c+=m,"."===m){var y=c.substr(_+1);y=y.replace(/\./,""),y&&(d.segments.push(y),_=f)}}else{if("["!==m&&"("!==m){if("]"!==m&&")"!==m||!s){var y=c.substr(v+1);y&&("."!==y[0]&&h.indexOf(y)<0&&(y=["."+y]),d.words.push(y));var E=c.substr(_+1);return E&&(d.segments.push(E),_=f),!s&&h.indexOf(y)<0&&(i["."+c]=d),c}var y=c;if(y[y.length-1]!==m){y=y.substring(v+1,y.length),y&&d.words.push(0===r.indexOf(y)?["."+y]:y);var C=y.lastIndexOf(".");C>0&&(y=y.substr(C)),y&&d.segments.push(y),_=f}return v=f,c}p.push(m),u=f,d.brakLength++;var O=c.substr(v+1);if(O){var y=O;h.indexOf(O)<0&&0>v&&(y=["."+O]),d.words.push(y)}d.words.push(m);var T="["===m?"]":")";if(c[f-1]!==T){var P=O.lastIndexOf(".");P>-1?(O=O.substr(P),d.segments.push(O)):O&&d.segments.push(O),_=f}v=f}}var R=c.substr(c.lastIndexOf("]")+1),F=c.substr(c.lastIndexOf(")")+1);if(R&&F){var M=R.length<F.length?R:F,E=c.substr(_+1);d.segments.push(E);var y="["===M[0]||"("===M[0]?M:"."===M[0]?M:"."+M;d.words.length<1&&h.indexOf(y)<0&&(y=[y]),d.words.push(y)}return s||(i["."+c]=d),c}function r(e){for(var t in e){var i=e[t],n=null,a=null,o=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){o=s(t,i.brakLength);var l="]"===t[t.length-1]?"[":"(",h=i.brakLength;i.watchPathWords=[];for(var c=0;c<i.words.length;c++){var p=i.words[c];if(p===l&&--h<1)break;i.watchPathWords.push(p)}}else i.watchPathWords=i.words.concat(),i.watchPathWords.splice(-1,1);n=t.substr(o),i.lastVar="("===n[0]?t:n,Object.keys(i.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),i.watchPath=a);for(var c=i.segments.length;c--;)i.segments[c]=i.segments[c].replace(/^\.|\.$/g,"");r(i.subVars)}}function s(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(("["===n||"("===n)&&--t<1)return i}}var a=/(['"])/,o=/[a-zA-Z$_]/,l=/[a-zA-Z$_0-9.]/,h=["as","instanceof","typeof","in","true","false"],c="",p={};return function(e){if(p[e])return p[e];for(var i=[],n={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),n);switch(s=s+o.length-1,c){case"var":i.push(h.indexOf(o)<0?["."+o]:o);break;case"str":case"":i.push(o)}}return r(n),p[e]={words:i,varTree:n},p[e]}}(),Scanner=new function(){function e(e){var i=[],n=[];t(e,i);for(var r=i.length;r--;){var e=i[r],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,i){var n=s.substring(o,i);n&&a.push(n),a.push(e),o=i+e.length});var l=s.substring(o,s.length);if(l&&a.push(l),a.length<2)n.unshift(null);else{for(var h=document.createDocumentFragment(),c=0;c<a.length;c++){var p=document.createTextNode(a[c]);h.appendChild(p)}n.unshift(h)}}for(var c=i.length;c--;){var u=i[c];n[c]&&n[c].childNodes.length>1&&u.parentNode&&u.parentNode.replaceChild(n[c],u)}}function t(e,i){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.childNodes.length>0)for(var n=0,r=e.childNodes.length;r>n;n++)t(e.childNodes[n],i)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;i.push(e)}}function i(e){if(e.restrict)return e;for(var t=e.parent;t;){if(t.name&&t.restrict)return t;t=t.parent}return null}function n(e,t){if("SCRIPT"!==e.tagName)if(e.attributes||11===e.nodeType){if(e.tagName){for(var s=e.tagName.toLowerCase(),a=[],o=e.attributes.length;o--;){var l=e.attributes[o];a.push([l.name,l.value])}for(var h=[],o=a.length;o--;){var c=a[o][0];if(0===c.indexOf(CMD_PREFIX)){var p=c.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&(DirectiveFactory.isFinal(p)||DirectiveFactory.hasEndTag(p))&&h.push([p,a[o],DirectiveFactory.priority(p)||0])}}if(h.length>0){h.sort(function(e,t){return t[2]-e[2]});var p=h[0][0],v=h[0][1];if(DirectiveFactory.isFinal(p))return void DirectiveFactory.newInstanceOf(p,e,t,v[0],v[1]);if(DirectiveFactory.hasEndTag(p))return[p,v[1]]}if(ComponentFactory.hasTypeOf(s)){var _=i(t);if(_&&_.restrict.children){var d=_.restrict.children.split(",");if(d.indexOf(s)<0)return}var f=ComponentFactory.getRestrictOf(s);if(f&&f.parents){var m=f.parents.split(",");if(m.indexOf(_.name)<0)return}return void t.createSubComponentOf(s,e)}for(var o=a.length;o--;){var g=a[o][0],b=a[o][1];if(REG_CMD.test(g)){var p=g.replace(CMD_PREFIX,""),u=p.indexOf(CMD_PARAM_DELIMITER);u>-1&&(p=p.substring(0,u)),DirectiveFactory.hasTypeOf(p)&&DirectiveFactory.newInstanceOf(p,e,t,g,b)}else":"===g[0]?DirectiveFactory.newInstanceOf("on",e,t,g,b):REG_EXP.test(b)&&r(b,e,t,g)}}if(e.childNodes.length>0){for(var y=null,w=[],o=0,x=e.childNodes.length;x>o;o++)if(y){w.push(e.childNodes[o]);var E=DirectiveFactory.hasEndTag(y[0]),l=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+E);Util.isString(l)&&(DirectiveFactory.newInstanceOf(y[0],w,t,CMD_PREFIX+y[0],y[1]),y=null,w=[])}else y=n(e.childNodes[o],t),y&&w.push(e.childNodes[o]);y&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+y[0]+"]")}}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,e,t)}}function r(e,t,i,n){var r={},a=!n&&0===e.replace(/\s*/gm,"").indexOf(EXP_START_TAG+EXP2HTML_EXP_TAG);if(a&&(e=e.replace(EXP2HTML_EXP_TAG,"")),e.replace(REG_EXP,function(e,t){var n={},a=1,o=null;FILTER_EXP.test(t)&&(o=s(lexer(RegExp.$1),n,i),a=t.indexOf(FILTER_EXP_START_TAG));var l=t;a>1&&(l=t.substring(0,a));var h=lexer(l);o&&Util.ext(h.varTree,o),r[t]={words:h.words,varTree:h.varTree,filters:n}}),!(Object.keys(r).length<1)){var o=new ExpNode(t,n,e,r,i,a);i.__expNodes.push(o)}}function s(e,t,i){for(var n=[],r=null,s=!1,a={},o=[],l=e.words,h=0;h<l.length;h++)if(l[h]instanceof Array)for(var c=l[h][0],p=c.split("."),u=1;u<p.length;u++)o.push([p[u]]);else o.push(l[h]);for(var h=0;h<o.length;h++){var c=o[h];switch(c){case":":s=!0,null!==r&&n.push(r),r="";break;case".":s=!1,null!==r&&n.push(r),r="",n=[];break;default:if(c instanceof Array){var v=c[0],_=v.toLowerCase();if(!s&&_&&FilterFactory.hasTypeOf(_))r=null,t[_]=[FilterFactory.newInstanceOf(_,i),n];else{var p=lexer(v);Util.ext(a,p.varTree),n.push(p),r=null}}else{if(!s||!c.replace(/\s+/,""))continue;r+=c.replace(/^['"]|['"]$/g,"")}}}return r&&n.push(r),a}this.scan=function(t,i){for(var r=t.__nodes?t.__nodes:[t.el],s=null,a=[],o=0,l=r.length;l>o;o++)if(e(r[o]),s){a.push(r[o]);var h=DirectiveFactory.hasEndTag(s[0]),c=r[o].getAttribute&&r[o].getAttribute(CMD_PREFIX+h);Util.isString(c)&&(DirectiveFactory.newInstanceOf(s[0],a,i,CMD_PREFIX+s[0],s[1]),s=null,a=[])}else s=n(r[o],i),s&&a.push(r[o]);s&&LOGGER.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")},this.parseFilters=s},Builder=new function(){function prelink(e){for(var t=e.__expNodes.length;t--;){var i=e.__expNodes[t];for(var n in i.expMap){var r=i.expMap[n],s=r.varTree;for(var a in s){var o=s[a];buildExpModel(e,o,i)}}}}function buildExpModel(e,t,i){for(var n in t.subVars){var r=t.subVars[n];buildExpModel(e,r,i)}for(var s=walkPropTree(e.__expPropRoot.subProps,t.segments[0],i),a=1;a<t.segments.length;a++)s=walkPropTree(s.subProps,t.segments[a],i)}function walkPropTree(e,t,i){var n=e[t];return n||(n=e[t]=new ExpProp(t)),i instanceof ExpNode?n.expNodes.indexOf(i)<0&&n.expNodes.push(i):i instanceof AttrObserveNode?n.attrObserveNodes.indexOf(i)<0&&n.attrObserveNodes.push(i):i instanceof Watch&&n.watchs.indexOf(i)<0&&n.watchs.push(i),e[t]}function changeHandler(e){var t=e.newVal,i=e.oldVal,n=e.pc,r=e.xpc,s=e.comp,a=e.type,o=e.name,l=e.object;handlePath(t,i,s,a,o,l,n),r.forEach(function(e){handlePath(t,i,s,a,o,l,e)})}function handlePath(e,t,i,n,r,s,a){__propStr=null,__lastMatch=void 0;var o=[];if(a[0]instanceof Directive){var l=void 0===a[2]?r:a[2];i=a[0].subComponents[parseInt(l)],o.push(a[1]),Util.isUndefined(a[2])&&i instanceof Component&&(i.data[a[1]]=e)}else o=a.concat(),Util.isArray(s)||o.push(r);i&&(recurRender(s,r,i,o,n,e,t,0,i),i.__watcher instanceof Function&&i.__watcher(n,e,t,o))}function rerender(e,t,i,n,r,s,a){for(var o,l=i.__expPropRoot.subProps,h=!1,c=0;c<n.length;c++){var p=n[c];if(sqbExp.test(Object.keys(l).join(","))){h=!0;break}{if(!l[p])break;o=l[p],l=l[p].subProps}}if(o){var u=[];if(h)for(var v=n.length-c-1,_=Object.keys(o.subProps),c=_.length;c--;){var d=_[c];("["===d[0]||d===p)&&findMatchProps(o.subProps[d],v,u)}else u.push(o);for(var f=[],c=u.length;c--;){Renderer.renderExpNode(u[c].expNodes);for(var m=u[c].attrObserveNodes.length;m--;){var g=u[c].attrObserveNodes[m],b=Renderer.evalExp(g.directive,g.expObj);g.directive.observe(b)}for(var m=u[c].watchs.length;m--;){var y=u[c].watchs[m];if(!(y.segments.length<n.length||f.indexOf(y)>-1)){for(var w=!0,d=0;d<y.segments.length&&n[d];d++)if("["!==y.segments[d][0]&&"["!==n[d][0]&&y.segments[d]!==n[d]){w=!1;break}if(w){var x=s,E=a;if(y.segments.length>n.length){for(var C=y.segments.slice(d),O="$var",d=0;d<C.length;d++){var T=C[d];O+="["===T[0]?T:"."+T}try{x=new Function("$var","return "+O)(s),E=new Function("$var","return "+O)(a)}catch(P){LOGGER.debug("error on parse watch params"),x=null}}y.cbk&&y.cbk.call(y.ctrlScope,e,t,r,x,E,n),f.push(y)}}}}}}function findMatchProps(e,t,i){if(1>t)return void i.push(e);for(var n in e.subProps)findMatchProps(e.subProps[n],t-1,i)}function recurRender(object,name,component,propChain,changeType,newVal,oldVal,depth,topComp){var toRender=!0;if(depth>0){if(!__propStr){__propStr="";for(var k=0;k<propChain.length;k++){var seg=propChain[k];__propStr+="["===seg[0]?seg:"."+seg}}var prop=void 0;try{prop=eval('impex._cs["'+component.__id+'"].data'+__propStr)}catch(e){}Util.isUndefined(prop)?__lastMatch&&__lastMatch!==topComp&&(toRender=!1):(__lastMatch=component,toRender=!1)}if(toRender&&rerender(object,name,component,propChain,changeType,newVal,oldVal),component.isolate)for(var pc0=propChain[0],i=component.isolate.length;i--;){var k=component.isolate[i];if(k.indexOf(".")>0){for(var kc=k.split("."),matchAll=!0,kci=0;kci<kc.length;kci++)kc[kci]!==propChain[kci]&&(matchAll=!1);if(matchAll)return}else if(k===pc0)return}for(var j=component.children.length;j--;){var subCtrlr=component.children[j];recurRender(object,name,subCtrlr,propChain,changeType,newVal,oldVal,depth+1,topComp)}}this.buildExpModel=buildExpModel,this.build=function(e){prelink(e)};var __propStr=null,__lastMatch=void 0;this.handleChange=changeHandler;var sqbExp=/(^\[)|(,\[)/},Renderer=new function(){function renderExpNode(e){for(var t={},i=e.length;i--;){var n=e[i],r=null;if(t[n.origin]&&t[n.origin].comp===n.component?r=t[n.origin].val:(r=calcExp(n.component,n.origin,n.expMap),t[n.origin]={comp:n.component,val:r}),n.toHTML){var s=renderHTML(n,r,n.node,n.component);if(s)continue}null!==r&&updateDOM(n.node,n.attrName,r)}}function updateDOM(e,t,i){if(e.setAttribute){e.setAttribute(t,i);var n=propMap[t];n&&n.indexOf(e.tagName)>-1&&(e[t]=i)}else e.parentNode&&(e.nodeValue=i)}function clone(e){if(null===e)return null;var t=e;if(e instanceof Array){t=e.concat();for(var i=t.length;i--;)t[i]=clone(t[i])}else if(Util.isObject(e)){t={};var n=Object.keys(e);if(n.length>0)for(var i=n.length;i--;){{var r=n[i];e[r]}0!==r.indexOf("$__impex__")&&(t[r]="object"==typeof e[r]?clone(e[r]):e[r])}}return t}function calcExp(e,t,i){var n={};for(var r in i){var s=i[r],a=evalExp(e,s),o=s.filters;if(Object.keys(o).length>0){a&&Util.isObject(a)&&(a=clone(a));for(var l in o){for(var h=o[l][0],c=o[l][1],p=[],u=c.length;u--;){var v=c[u];v.varTree&&v.words&&(v=Renderer.evalExp(e,v)),p[u]=v}h.value=a,a=h.to.apply(h,p)}}n[r]=void 0===a?"":a}for(var l in n)t=t.replace(EXP_START_TAG+l+EXP_END_TAG,n[l]+"");return t}function evalExp(component,expObj){var evalExp=getExpEvalStr(component,expObj),rs="";try{rs=eval(evalExp)}catch(e){LOGGER.debug(e.message+' when eval "'+evalExp+'"')}return rs}function getExpEvalStr(e,t){var i=t.varTree,n={};for(var r in i){var s=i[r],a=buildVarPath(e,s,r);n[r]=a}var o=joinExpStr(t.words,n);return o}function joinExpStr(e,t){for(var i="",n=0;n<e.length;n++){var r=e[n];i+=r instanceof Array?t[r[0]]:r}return i}function keyWordsMapping(e,t){return 0===e.indexOf(".this")?e.replace(".this",t.__getPath()):void 0}function buildVarPath(e,t,i){var n={};for(var r in t.subVars){var s=t.subVars[r],a=buildVarPath(e,s,r);n[r]=a}for(var o=!1,l="",h=0;h<t.words.length;h++){var c=t.words[h];if(c instanceof Array){if(n[c[0]]){l+=n[c[0]];continue}var p=keyWordsMapping(c[0],e);p?(o=!0,l+=p):l+=c[0]}else l+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var h=0;h<t.watchPathWords.length;h++){var c=t.watchPathWords[h];u+=c instanceof Array?n[c[0]]||c[0]:c}if(o)return l;var v=")"===i[i.length-1]?"methods":"data",_=u||l;return _="data"===v?".data"+_:"."+METHOD_PREFIX+_.substr(1),e=varInCtrlScope(e,_),e?(l="data"===v?".data"+l:"."+METHOD_PREFIX+l.substr(1),e.__getPath()+l):"self"+l}function varInCtrlScope(e,t){for(var i=e;i;){if(void 0!==getVarByPath(t,i.__getPath()))return i;i=i.parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,i,n){if(e.__lastVal!==t&&3==i.nodeType){var r=new View(null,null,[i]);if(Util.isUndefined(e.__lastVal)){var s=ViewManager.createPlaceholder("-- [html] placeholder --");ViewManager.insertBefore(s,r),e.__lastVal=t,e.__placeholder=s}e.__lastComp&&(e.__lastComp.destroy(),r=ViewManager.createPlaceholder(""),ViewManager.insertAfter(r,e.__placeholder)),Util.isDOMStr(t)||(t=t.replace(/</gm,"&lt;").replace(/>/gm,"&gt;"));var a=n.createSubComponent(t,r);return a.init(),a.display(),e.__lastComp=a,e.__lastVal=t,!0}}this.render=function(e){var t=e.children;renderExpNode(e.__expNodes);for(var i=t.length;i--;)Renderer.render(t[i])},this.renderExpNode=renderExpNode;var propMap={value:["INPUT"]};this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};Component.state={created:"created",inited:"inited",displayed:"displayed",suspend:"suspend"},Util.ext(Component.prototype,{d:function(path,val){if(!path)return void LOGGER.warn("invalid path '"+path+"'");var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);if(arguments.length>1){Util.isObject(val)||Util.isArray(val)?val=JSON.stringify(val):Util.isString(val)&&(val='"'+val.replace(/\r\n|\n/gm,"\\n").replace(/"/gm,'\\"')+'"');try{eval(evalStr+"= "+val)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}return this}try{return eval(evalStr)}catch(e){LOGGER.debug("error in eval '"+evalStr+"= "+val+"'",e)}},m:function(e){for(var t=this;t;){if(t["$"+e]instanceof Function)return t.hasOwnProperty("$"+e)||(t["$"+e]=t["$"+e].bind(t)),t["$"+e];t=t.parent}return null},closest:function(e,t){if("d"===e){var i=lexer(t),n=Renderer.getExpEvalStr(this,i);return n.replace(/^impex\._cs\["(C_[0-9]+)"\]/,""),impex._cs[RegExp.$1]}if("m"===e){for(var r=this;r;){if(r["$"+t]instanceof Function)return r;r=r.parent}return null}},on:function(e,t){var i=this.__eventMap[e];i||(i=this.__eventMap[e]=[]),i.push(t)},emit:function(){for(var e=arguments[0],t=[this],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=this.parent;setTimeout(function(){for(;n;){var i=n.__eventMap[e];if(i){for(var r=!0,s=0;s<i.length;s++)r=!i[s].apply(n,t);if(r)return}n=n.parent}},0)},broadcast:function(){for(var e=arguments[0],t=[this],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=this;setTimeout(function(){broadcast(n.children,e,t)},0)},find:function(e,t,i){e=e.toLowerCase();for(var n=[],r=this.children.length;r--;){var s=this.children[r];if("*"===e||s.name===e){var a=!0;if(t)for(var o in t)if(s[o]!==t[o]){a=!1;break}a&&n.push(s)}if(i&&s.children.length>0){var l=s.find(e,t,!0);n&&(n=n.concat(l))}}return n},watch:function(e,t){if("*"===e)this.__watcher=t;else{var i=lexer(e),n=Object.keys(i.varTree);if(n.length<1)return;if(n.length>1)return void LOGGER.warn("error on parsing watch expression["+e+"], only one property can be watched at the same time");var r=i.varTree[n[0]],s=new Watch(t,this,r.segments);Builder.buildExpModel(this,r,s)}return this},add:function(e){this.children.push(e),e.parent=this},createSubComponentOf:function(e,t){var i=ComponentFactory.newInstanceOf(e,t.__nodes?t.__nodes[0]:t);return this.children.push(i),i.parent=this,i},createSubComponent:function(e,t){var i=ComponentFactory.newInstance(e,t&&t.__nodes[0]);return this.children.push(i),i.parent=this,i},init:function(){if(this.__state===Component.state.created){if(this.templateURL){var e=this;Util.loadTemplate(this.templateURL,function(t){var i=e.view.__init(t,e);i!==!1&&(e.__init(t),e.display())})}else{if(this.template){var t=this.view.__init(this.template,this);if(t===!1)return}this.__init(this.template)}return this}},__init:function(e){Scanner.scan(this.view,this),LOGGER.log(this,"inited");var t=null;if(this.onInit&&(t=this.onInit(e)),t===!1)return void this.destroy();this.data=Observer.observe(this.data,this),Builder.build(this),this.__state=Component.state.inited;for(var i=this.children.length;i--;)this.children[i].init()},display:function(){if(this.__state!==Component.state.displayed){this.view.__display(this),Renderer.render(this),this.__state=Component.state.displayed,LOGGER.log(this,"displayed");for(var e=0;e<this.children.length;e++)this.children[e].display();this.onDisplay&&this.onDisplay()}},destroy:function(){if(null!==this.__state){if(LOGGER.log(this,"destroy"),this.parent){var e=this.parent.children.indexOf(this);e>-1&&this.parent.children.splice(e,1),this.parent=null}for(this.view.__destroy(this);this.children.length>0;)this.children[0].destroy();if(this.view=this.children=this.__expNodes=this.__expPropRoot=null,this.onDestroy&&this.onDestroy(),!CACHEABLE||!this.name||this instanceof Directive)impex._cs[this.__id]=null,delete impex._cs[this.__id],this.__state=this.__id=this.templateURL=this.template=this.restrict=this.isolate=this.methods=this.events=this.data=null;else{var t=im_compCache[this.name];t||(t=im_compCache[this.name]=[]),this.__state=Component.state.created,this.children=[],this.__expNodes=[],this.__expPropRoot=new ExpProp,t.push(this)}}},suspend:function(e){(this instanceof Directive||this.__state===Component.state.displayed)&&(LOGGER.log(this,"suspend"),this.view.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.__state=Component.state.suspend)},__getPath:function(){return'impex._cs["'+this.__id+'"]'}}),View.prototype={__init:function(e,t){var i=this.__target.attributes,n=this.__target.innerHTML,r=tmplExpFilter(e,n,i);t.onBeforeCompile&&(r=t.onBeforeCompile(r));var s=DOMViewProvider.compile(r);if(!s||s.length<1)return LOGGER.error('invalid template "'+e+'" of component['+t.name+"]"),!1;if(this.__nodes=s,this.el=t.replace?1===s.length&&1===s[0].nodeType?s[0]:null:this.__target,s.length>1&&LOGGER.warn("more than 1 root node of component["+t.name+"]"),i)for(var a=i.length;a--;){var o=i[a].name.toLowerCase();o.indexOf("-")>-1&&(o=o.replace(/-[a-z0-9]/g,function(e){return e[1].toUpperCase()}));var l=i[a].value;t.data[o]=l}this.__comp=t},__display:function(e){if(this.__target&&this.__target.parentNode){var t=null;if(this.__nodes.length>1){t=document.createDocumentFragment();for(var i=0;i<this.__nodes.length;i++)t.appendChild(this.__nodes[i])}else t=this.__nodes[0];e.replace?this.__target.parentNode.replaceChild(t,this.__target):(this.__target.innerHTML="",this.__target.appendChild(t)),t=null,this.__target=null}},__destroy:function(e){for(var t in this.__evMap)for(var i=this.__evMap[t],n=i.length;n--;)for(var r=i[n],s=r[1],a=this.__nodes.length;a--;)1===this.__nodes[a].nodeType&&this.__nodes[a].removeEventListener(t,s,!1);var o=this.__nodes[0].parentNode;if(o){this.__nodes[0].__impex__view&&(this.__nodes[0].__impex__view=null);for(var n=this.__nodes.length;n--;)this.__nodes[n].parentNode&&o.removeChild(this.__nodes[n])}this.__target&&(this.__target.parentNode.removeChild(this.__target),this.__target=null)},__suspend:function(e,t){var i=this.__nodes[0].parentNode;if(i){t&&(this.__target=document.createComment("-- view suspended of ["+(e.name||"anonymous")+"] --"),i.insertBefore(this.__target,this.__nodes[0]));for(var n=this.__nodes.length;n--;)this.__nodes[n].parentNode&&i.removeChild(this.__nodes[n])}},on:function(e,t,i){if(this.el){var n=t,r=this.__comp,s="",a=null,o=function(t){var o=n;if(i instanceof Function&&(o=i.call(r,t,n)),o){if(s!=o){var l=lexer(o),h=Renderer.getExpEvalStr(r,l),c=h.replace("self.$event","$event");a=new Function("$event",c),s=o}try{a(t)}catch(p){LOGGER.debug("error in event '"+e+"'",p)}}};this.el.addEventListener(e,o,!1),this.__evMap[e]||(this.__evMap[e]=[]),this.__evMap[e].push([t,o])}},off:function(e,t){if(this.el)for(var i=this.__evMap[e],n=i.length;n--;){var r=i[n],s=r[0],a=r[1];s==t&&this.el.removeEventListener(e,a,!1)}},clone:function(){for(var e=[],t=this.__nodes.length;t--;){var i=this.__nodes[t].cloneNode(!0);e.unshift(i)}var n=new View(1===e.length&&1===e[0].nodeType?e[0]:null,null,e);return n},show:function(){return this.el.style.display="",this},hide:function(){return this.el.style.display="none",this},style:function(e,t){return arguments.length>1?(this.el.style[e]=t,this):this.el.style[e]},attr:function(e,t){return arguments.length>1?(this.el.setAttribute(e,t),this):this.el.getAttribute(e)},removeAttr:function(e){return this.el.removeAttribute(e),this},hasClass:function(e){return this.el.className.indexOf(e)>-1},addClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,""),e=e.split(" ");for(var t=this.el.className.split(" "),i="",n=e.length;n--;)t.indexOf(e[n])<0&&(i+=e[n]+" ");return this.el.className+=" "+i,this},removeClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");var t=e.split(" "),i=this.el.className;if(i){for(var n=t.length;n--;){var r=t[n],s=new RegExp("^"+r+"\\s+|\\s+"+r+"$|\\s+"+r+"\\s+","img");i=i.replace(s,"")}this.el.className=i}return this},toggleClass:function(e){e=e.replace(/\s+/gm," ").replace(/^\s*|\s*$/gm,"");for(var t=e.split(" "),i=!1,n=this.el.className,r=t.length;r--;){var s=t[r];if(n.indexOf(s)<0){i=!0;break}}i?this.addClass(e):this.removeClass(e)}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,i){if(""===t)return new View(null,i,[document.createTextNode("")]);if(e.innerHTML=t,!e.childNodes[0])return null;for(var n=[];e.childNodes.length>0;){var r=e.removeChild(e.childNodes[0]);n.push(r)}var s=new View(null,i,n);return s},this.compile=function(t){e.innerHTML=t;for(var i=[];e.childNodes.length>0;){{var n=e.removeChild(e.childNodes[0]);n.nodeName.toLowerCase()}if(3===n.nodeType){var r=n.nodeValue.replace(/\s/gm,"");if(""===r)continue}i.push(n)}return i}},ViewManager=new function(){this.singleton=!0,this.replace=function(e,t){var i=t.__nodes[0],n=e.__nodes[0],r=t.__nodes[0].parentNode,s=n;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}if(t.__nodes.length>1){r.insertBefore(s,i);for(var a=t.__nodes.length;a--;)r.removeChild(t.__nodes[a])}else r.replaceChild(s,i)},this.insertBefore=function(e,t){var i=t.__nodes[0],n=e.__nodes[0],r=t.__nodes[0].parentNode,s=n;if(e.__nodes.length>1){s=document.createDocumentFragment();for(var a=0;a<e.__nodes.length;a++)s.appendChild(e.__nodes[a])}r&&r.insertBefore(s,i)},this.insertAfter=function(e,t){var i=t.__nodes[0],n=e.__nodes[0],r=t.__nodes[0].parentNode,s=r.lastChild,a=n;

if(e.__nodes.length>1){a=document.createDocumentFragment();for(var o=0;o<e.__nodes.length;o++)a.appendChild(e.__nodes[o])}if(s==i)r.appendChild(a);else{var l=t.__nodes[t.__nodes.length-1].nextSibling;r.insertBefore(a,l)}},this.append=function(e,t){var i=e.__nodes[0],n=t.__nodes[0],r=i;if(e.__nodes.length>1){r=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)r.appendChild(e.__nodes[s])}n.appendChild(r)},this.prepend=function(e,t){var i=e.__nodes[0],n=t.__nodes[0],r=i;if(e.__nodes.length>1){r=document.createDocumentFragment();for(var s=0;s<e.__nodes.length;s++)r.appendChild(e.__nodes[s])}n.insertBefore(r,n.firstChild)},this.createPlaceholder=function(e){return new View(null,null,[document.createComment(e)])}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){var e={},t=this;this.value.replace(REG_EXP,function(i,n){var r=lexer(n),s=Renderer.evalExp(t.parent,r);e[n]={val:s}});var i=this.value;for(var n in e)i=i.replace(EXP_START_TAG+n+EXP_END_TAG,e[n].val);this.value=i,LOGGER.log(this,"inited"),this.onInit&&this.onInit(),this.__state=Component.state.inited},display:function(){if(this.observe){var e=lexer(this.value);for(var t in e.varTree){var i=e.varTree[t],n=new AttrObserveNode(this,e);this.parent&&Builder.buildExpModel(this.parent,i,n)}var r=Renderer.evalExp(this.parent,e);this.observe(r)}this.onDisplay&&this.onDisplay(),this.children&&this.children.forEach(function(e){e.display()})}}),Filter.prototype={to:function(){return null}};var TRANSITIONS={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"mozTransitionend",WebkitTransition:"webkitTransitionEnd"},TESTNODE;Transition.prototype={enter:function(){this.__start="enter",this.__css&&this.__view.addClass(this.__type+"-enter"),this.__comp.enter&&this.__comp.enter(),this.__hook.enter&&this.__hook.enter.call(this.__comp,this.__enterDone.bind(this)),this.__css&&(this.__view.el.offsetHeight,this.__view.removeClass(this.__type+"-enter"))},__enterDone:function(){},leave:function(){this.__start="leave",this.__css&&this.__view.addClass(this.__type+"-leave"),this.__hook.leave&&(this.__leaveDone.__trans=this,this.__hook.leave.call(this.__comp,this.__leaveDone.bind(this)))},__leaveDone:function(){this.__comp.leave&&this.__comp.leave()},__done:function(e){if(!(e.elapsedTime<this.__longest)&&this.__start){switch(this.__start){case"enter":this.__enterDone();break;case"leave":this.__leaveDone()}this.__start="",this.__view.removeClass(this.__type+"-leave")}}},Factory.prototype={register:function(e,t,i){e=e.toLowerCase();var n=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),r={},s=t.data;if(delete t.data,Util.ext(r,t),Util.inherits(n,this.baseClass),t.methods)for(var a in t.methods)n.prototype[METHOD_PREFIX+a]=t.methods[a];this.types[e]={clazz:n,props:r,services:i,data:s}},hasTypeOf:function(e){return e in this.types},createCbk:function(e,t){if(e.onCreate){var i=null;if(this.types[t].services){i=[];for(var n=0;n<this.types[t].services.length;n++){var r=ServiceFactory.newInstanceOf(this.types[t].services[n],e);i.push(r)}}i?e.onCreate.apply(e,i):e.onCreate()}}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{getRestrictOf:function(e){return this.types[e].props.restrict},newInstance:function(e){var t=null;if(2===arguments.length){var i=arguments[0],n=arguments[1];t=i,Util.isString(i)?t=this.viewProvider.newInstance(i,n):t.__target=n}else t=e,Util.isDOM(e)&&(t=new View(e,null,[e]));var r=new this.baseClass(t),s=arguments[2];if(s&&Util.ext(r,s),r.methods)for(var a in r.methods)r.methods[a]instanceof Function&&(r[METHOD_PREFIX+a]=r.methods[a].bind(r));if(r.events)for(var a in r.events)r.on(a,r.events[a]);return r},newInstanceOf:function(e,t){if(!this.types[e])return null;var i=null,n=im_compCache[e];if(CACHEABLE&&n&&n.length>0)i=n.pop();else{i=new this.types[e].clazz(this.baseClass),Util.ext(i,this.types[e].props);var r=this.types[e].data;r&&Util.ext(i.data,r),i.name=e}if(i.view=new View(null,t),i.events)for(var s in i.events)i.on(s,i.events[s]);return this._super.createCbk.call(this,i,e),i}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props["final"]},hasEndTag:function(e){return this.types[e].props.endTag},priority:function(e){return this.types[e].props.priority},newInstanceOf:function(e,t,i,n,r){if(!this.types[e])return null;var s=null,a=null,o=n.indexOf(CMD_PARAM_DELIMITER);if(o>-1){s=n.substr(o+1);var l=s.indexOf(CMD_FILTER_DELIMITER);l>-1&&(a=s.substr(l+1),s=s.substring(0,l)),s=s.split(CMD_PARAM_DELIMITER)}var h=new this.types[e].clazz(this.baseClass,n,r,i);if(Util.ext(h,this.types[e].props),t.__impex__view)h.view=t.__impex__view;else{var c=t,p=[t];Util.isArray(t)&&(p=t,c=t.length>1?null:t[0]),h.view=new View(c,null,p),t.__impex__view=h.view}if(s&&(h.params=s),a&&(h.filter=a),h.view.__comp=h,i.add(h),h.view&&(h.view.__nodes[0].removeAttribute(h.name),h.endTag)){var u=h.view.__nodes[h.view.__nodes.length-1];u.removeAttribute(CMD_PREFIX+h.endTag)}if(h.events)for(var v in h.events)h.on(v,h.events[v]);return this._super.createCbk.call(this,h,e),h}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_FilterFactory,Factory),Util.ext(_FilterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var i=new this.types[e].clazz(this.baseClass,t);return Util.ext(i,this.types[e].props),this._super.createCbk.call(this,i,e),i}});var FilterFactory=new _FilterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e,t){if(e=e.toLowerCase(),!this.types[e])return null;var i=null;return this.types[e].props.singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),i=this.types[e].singleton):i=new this.types[e].clazz(this.baseClass),Util.ext(i,this.types[e].props),i.host=t,this._super.createCbk.call(this,i,e),i}});var ServiceFactory=new _ServiceFactory,TransitionFactory={hooks:{},register:function(e,t){this.hooks[e]=t},transitions:{},get:function(e,t){var i=new Transition(e,t,this.hooks[e]);return i}},CMD_PREFIX="x-",CMD_PARAM_DELIMITER=":",CMD_FILTER_DELIMITER=".",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{#?(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,METHOD_PREFIX="$",EXP2HTML_EXP_TAG="#",EXP2HTML_START_EXP=/^\s*#/,FILTER_EXP=/=>\s*(.+?)$/,FILTER_EXP_START_TAG="=>",LOGGER={log:function(){},debug:function(){},error:function(){},warn:function(){}},CACHEABLE=!1,im_compCache={},im_counter=0,impex=new function(){function e(e){var i=e;do{if(t.indexOf(i)>-1)return!0;i=i.parentNode}while(i);return!1}this.version={v:[0,20,0],state:"beta",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://impexjs.org",this.config=function(e){var t=e.delimiters||[];EXP_START_TAG=t[0]||"{{",EXP_END_TAG=t[1]||"}}",REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),LOGGER=e.logger||new function(){this.log=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},CACHEABLE=e.cacheable||!1},this.component=function(e,t,i){return t.template||t.templateURL?(ComponentFactory.register(e,t,i),this):void LOGGER.error("can not find property 'template' or 'templateURL' of component '"+e+"'")},this.directive=function(e,t,i){return DirectiveFactory.register(e,t,i),this},this.service=function(e,t,i){return ServiceFactory.register(e,t,i),this},this.filter=function(e,t,i){return FilterFactory.register(e,t,i),this},this.transition=function(e,t){return TransitionFactory.register(e,t),this},this.render=function(i,n,r){if(!i)return void LOGGER.error("invalid element, can not render");var s=i.tagName.toLowerCase();if(e(i))return void LOGGER.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,i);if(a||(t.push(i),a=ComponentFactory.newInstance(i,null,n)),a.onCreate){var o=null;if(Util.isArray(r)){o=[];for(var l=0;l<r.length;l++){var h=ServiceFactory.newInstanceOf(r[l],a);o.push(h)}}o?a.onCreate.apply(a,o):a.onCreate()}return a.init(),a.display(),a};var t=[];Object.defineProperty(this,"_cs",{enumerable:!1,writable:!0,value:{}})};impex.service("ViewManager",ViewManager),impex.service("ComponentManager",{hasTypeOf:function(e){return ComponentFactory.hasTypeOf(e)}}),impex.service("Transitions",new function(){this.get=function(e,t){return e=e||"x",TransitionFactory.get(e,t)}}),!function(e){function t(e,i,n){for(var r=e.__expNodes.length;r--;){var s=e.__expNodes[r];s.node==i&&"class"===s.attrName&&(s.origin=n)}for(var a=e.children.length;a--;)t(e.children[a],i,n)}function i(){function e(e,t,i){for(var n=[],r=e;t>=r;r+=i)n.push(r);return n}function t(e){for(var i=0;i<e.children.length;i++){var n=e.children[i];n.onDisplay&&n.onDisplay(),n.children.length>0&&t(n)}}function i(e,t){if(null===e)return null;var n=e;if(e instanceof Array){n=e.concat();for(var r=n.length;r--;)n[r]=i(n[r],t)}else if(Util.isObject(e)){n={};var s=Object.keys(e);if(s.length>0)for(var a=t===!1?!1:!e.$__impex__origin,r=s.length;r--;){{var o=s[r];e[o]}0!==o.indexOf("$__impex__")&&(n[o]="object"==typeof e[o]?i(e[o],a):e[o])}t===!1||n.$__impex__origin||(n.$__impex__origin=e)}return n}this.onCreate=function(e,t){this.eachExp=/^(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*,)?\s*[a-zA-Z0-9_$]+?)\s*(?:=>\s*(.+?))?$/,this.forExp=/^\s*(\d+|[a-zA-Z_$].+?)\s+to\s+(\d+|[a-zA-Z_$].+?)\s*$/,this.viewManager=e,this.expInfo=this.parseExp(this.value),this.parentComp=this.parent,this.__view=this.view,this.cache=[],this.cacheable=this.view.el?"false"===this.view.attr("cache")?!1:!0:"false"===this.view.__nodes[0].getAttribute("cache")?!1:!0,this.subComponents=[],this.cacheSize=20,this.step=this.view.el?this.view.attr("step"):this.view.__nodes[0].getAttribute("step");var i=this.view.el?this.view.attr("transition"):this.view.__nodes[0].getAttribute("transition");null!==i&&(this.trans=i,this.ts=t)},this.onInit=function(){var t=this;if(this.forExp.test(this.expInfo.ds)){var i=RegExp.$1,n=RegExp.$2,r=parseFloat(this.step);if(0>r)return void LOGGER.error("step <=0 : "+r);r=r||1,isNaN(i)&&(this.parent.watch(i,function(i,s,a,o,l){var h=e(o>>0,n,r);t.lastDS=h,t.rebuild(h,t.expInfo.k,t.expInfo.v)}),i=this.parent.d(i)),isNaN(n)&&(this.parent.watch(n,function(n,s,a,o,l){var h=e(i,o>>0,r);t.lastDS=h,t.rebuild(h,t.expInfo.k,t.expInfo.v)}),n=this.parent.d(n)),i=parseFloat(i),n=parseFloat(n),this.ds=e(i,n,r)}else this.ds=this.parent.d(this.expInfo.ds),this.parentComp.watch(this.expInfo.ds,function(e,i,n,r){return t.ds?(t.lastDS=Util.isArray(r)?r:e,void t.rebuild(t.lastDS,t.expInfo.k,t.expInfo.v)):(t.ds=t.parentComp.d(t.expInfo.ds),t.lastDS=t.ds,void t.build(t.ds,t.expInfo.k,t.expInfo.v))});this.lastDS=this.ds,this.placeholder=this.viewManager.createPlaceholder("-- directive [each] placeholder --"),this.viewManager.insertBefore(this.placeholder,this.view),this.ds&&this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy()},this.rebuild=function(e,i,n){e=this.doFilter(e);var r=e.length-this.subComponents.length;if(0>r){var s=this.subComponents.splice(0,-1*r);if(this.cache.length<this.cacheSize){for(var a=s.length;a--;)this.cache.push(s[a]);for(var a=this.cache.length;a--;)this.trans&&!this.cache[a].__leaving&&"displayed"===this.cache[a].__state?(this.cache[a].__leaving=!0,this.cache[a].transition.leave()):this.cache[a].suspend(!1)}else for(var a=s.length;a--;)s[a].destroy()}else if(r>0){var o=r;if(this.cacheable){for(var s=this.cache.splice(0,r),a=0;a<s.length;a++)this.subComponents.push(s[a]),this.viewManager.insertBefore(s[a].view,this.placeholder);var o=r-s.length}for(;o--;)this.createSubComp()}var l=Util.isArray(e)?!0:!1,h=0;for(var c in e)if(e.hasOwnProperty(c)&&(!l||!isNaN(c))){var p=this.subComponents[h],u=e[c];if(e[c]&&e[c].$__impex__origin&&(u=e[c].$__impex__origin,e[c].$__impex__origin=null,delete e[c].$__impex__origin),"object"==typeof u){for(var a=u.__im__extPropChain.length;a--&&u.__im__extPropChain[a][0]!==this;);u.__im__extPropChain.splice(a,1),u.__im__extPropChain.push([this,n,h])}var v=p.data.__im__target||p.data;v[n]=u,v.$index=h++,i&&(v[i]=l?c>>0:c),p.__state===Component.state.created&&p.init(),p.display(),Renderer.render(p),t(p)}},this.createSubComp=function(){var e=this.parentComp,t=this.viewManager.createPlaceholder("");this.viewManager.insertBefore(t,this.placeholder);var i=this.__view.clone(),n=e.createSubComponent(i,t);if(this.subComponents.push(n),this.trans){var r=this;n.onInit=function(){this.transition||(this.transition=r.ts.get(r.trans,this))},n.onDisplay=function(){this.transition.enter()},n.leave=function(){this.suspend(!1),this.__leaving=!1}}return n},this.doFilter=function(e){if(!this.filters)return e;var t=this.filters;if(Object.keys(t).length>0){e&&Util.isObject(e)&&(e=i(e));for(var n in t){for(var r=t[n][0],s=t[n][1],a=[],o=s.length;o--;){var l=s[o];l.varTree&&l.words&&(l=Renderer.evalExp(this.parentComp,l)),a[o]=l}r.value=e,e=r.to.apply(r,a)}return e}},this.build=function(e,t,i){var n=Util.isArray(e)?!0:!1,r=0;e=this.doFilter(e),e.__im__extPropChain&&e.__im__extPropChain.push([this,i]);for(var s in e)if(e.hasOwnProperty(s)&&(!n||!isNaN(s))){var a=this.createSubComp(),o=e[s];e[s]&&e[s].$__impex__origin&&(o=e[s].$__impex__origin,e[s].$__impex__origin=null,delete e[s].$__impex__origin),"object"==typeof o&&o.__im__extPropChain.push([this,i,r]);var l=a.data.__im__target||a.data;l[i]=o,l.$index=r++,t&&(l[t]=n?s>>0:s)}for(var h=this.subComponents.length;h--;)this.subComponents[h].init()},this.parseExp=function(e){var t,i,n,r=this;return e.replace(this.eachExp,function(e,s,a,o){t=s;var l=a.replace(/\s/gm,""),h=l.split(",");if(h.length>1?(i=h[0],n=h[1]):n=h[0],o){var c={},p=Scanner.parseFilters(lexer(o),c,r.parent);r.filters=c;for(var u in p)r.parent.watch(u,function(){r.lastDS&&r.rebuild(r.lastDS,r.expInfo.k,r.expInfo.v)})}}),t?{ds:t,k:i,v:n}:void LOGGER.error("invalid each expression : "+e)}}e.directive("ignore",{"final":!0}).directive("on",{onInit:function(){for(var e=this.params.length;e--;)this.view.on(this.params[e],this.value)}}).directive("bind",{onInit:function(){(!this.params||this.params.length<1)&&LOGGER.warn("at least one attribute be binded")},observe:function(e){if(this.params&&!(this.params.length<1)){var t=null;if(this.filter&&(t=this.m(this.filter)),t){var i=t(e);if(!Util.isUndefined(i)&&!i)return}for(var n=this.params.length;n--;){var r=this.params[n];this.view.attr(r,e)}}}}).directive("show",{onCreate:function(e){var t=this.view.attr("transition");null!==t&&(this.transition=e.get(t,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&e!==this.lastRs&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){e?this.view.show():this.view.hide()}},["Transitions"]).directive("show-start",{endTag:"show-end",onCreate:function(){this.__init(),this.display()},observe:function(e){if(this.parent.__state!==Component.state.suspend){var t=this.view.__nodes;if(e)for(var i=t.length;i--;)t[i].style&&(t[i].style.display="");else for(var i=t.length;i--;)t[i].style&&(t[i].style.display="none")}}}).directive("if",{onCreate:function(e,t){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --");var i=this.view.attr("transition");null!==i&&(this.transition=t.get(i,this)),this.lastRs=!1,this.exec(!1)},observe:function(e){this.parent.__state!==Component.state.suspend&&(e!==this.lastRs||this.view.el.parentNode)&&(this.lastRs=e,this.transition?e?this.transition.enter():this.transition.leave():this.exec(e))},enter:function(){this.exec(this.lastRs)},leave:function(){this.exec(this.lastRs)},exec:function(e){if(e){if(this.view.el.parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.el.parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager","Transitions"]).directive("if-start",{endTag:"if-end",onCreate:function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --")},onInit:function(){Scanner.scan(this.view,this)},observe:function(e){if(this.parent.__state!==Component.state.suspend)if(e){if(this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.view,this.placeholder)}else{if(!this.view.__nodes[0].parentNode)return;this.viewManager.replace(this.placeholder,this.view)}}},["ViewManager"]).directive("cloak",{onCreate:function(){var e=this.view.attr("class");return e?(e=e.replace("x-cloak",""),void(this.__cn=e)):void LOGGER.warn("can not find attribute[class] of element["+this.view.name+"] which directive[cloak] on")},onDisplay:function(){t(this.parent,this.view.el,this.__cn);var e=this.view.attr("class").replace("x-cloak","");this.view.attr("class",e)}}).directive("model",{onCreate:function(){var e=this.view.el;switch(this.toNum=e.getAttribute("number"),this.debounce=e.getAttribute("debounce")>>0,e.nodeName.toLowerCase()){case"textarea":case"input":var t=this.view.attr("type");switch(t){case"radio":this.view.on("click","changeModel($event)");break;case"checkbox":this.view.on("click","changeModelCheck($event)");break;default:var i=null===document.body.onpropertychange?"propertychange":"input";this.view.on(i,"changeModel($event)")}break;case"select":var n=e.getAttribute("multiple");null!==n?this.view.on("change","changeModelSelect($event)"):this.view.on("change","changeModel($event)")}},methods:{changeModelSelect:function(e){for(var t=e.target||e.srcElement,i=(t.value,[]),n=t.options.length;n--;){var r=t.options[n];r.selected&&i.push(r.value)}this.parent.d(this.value,i)},changeModelCheck:function(e){var t=e.target||e.srcElement,i=t.value,n=this.parent.d(this.value);if(n instanceof Array||(n=[n]),t.checked)n.push(i);else{var r=n.indexOf(i);r>-1&&n.splice(r,1)}this.parent.d(this.value,n)},changeModel:function(e){if(this.debounce){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null);var t=this;this.debounceTimer=setTimeout(function(){clearTimeout(t.debounceTimer),t.debounceTimer=null,t.setVal(e)},this.debounce)}else this.setVal(e)}},setVal:function(e){var t=(e.target||e.srcElement).value;null!==this.toNum&&(t=parseFloat(t)),this.parent.d(this.value,t)}});var n=new i;n["final"]=!0,n.priority=999,e.directive("each",n,["ViewManager","Transitions"]);var r=new i;r.endTag="each-end",r.priority=999,e.directive("each-start",r,["ViewManager"])}(impex),impex.filter("json",{to:function(){return JSON.stringify(this.value)}}).filter("filterBy",{to:function(e,t){var i=this.value;if(!(i instanceof Array))return LOGGER.warn("can only filter array"),this.value;var n=[];if(e instanceof Function)for(var r=i.length;r--;){var s=e.call(this,i[r]);s&&n.unshift(i[r])}else for(var r=i.length;r--;){var a=i[r];t?(!e||(a[t]+"").indexOf(e)>-1)&&n.unshift(a):(!e||a.indexOf&&a.indexOf(e)>-1)&&n.unshift(a)}return n}}).filter("limitBy",{to:function(e,t){return this.value instanceof Array?e?this.value.splice(t||0,e):this.value:(LOGGER.warn("can only filter array"),this.value)}}).filter("orderBy",{to:function(e,t){return e||t?this.value instanceof Array?(this.value.sort(function(t,i){var n=e?t[e]:t,r=e?i[e]:i;return"string"==typeof n?n.localeCompare(r):"number"==typeof n?n-r:(n+"").localeCompare(r)}),"desc"===t&&this.value.reverse(),this.value):(LOGGER.warn("can only filter array"),this.value):this.value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);