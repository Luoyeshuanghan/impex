!function(global){"use strict";function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,n,r,i,s){this.node=e,this.attrName=t,this.origin=n,this.expMap=r,this.component=i,this.converters=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,n){this.cbk=e,this.ctrlScope=t,this.segments=n}function ViewModel(){}function Component(e){var t="C_"+Object.keys(impex.__components).length;impex.__components[t]=this,this.$__id=t,this.$__state=Component.state.created,this.$view=e,this.$name,this.$parent,this.$__components=[],this.$__directives=[],this.$__expNodes=[],this.$__expPropRoot=new ExpProp,this.$template,this.$templateURL,this.onCreate,this.onInit,this.onDisplay,this.onDestroy}function View(e,t){this.elements=e,this.__evMap={},this.__target=t}function tmplExpFilter(e,t,n){return e=e.replace(REG_TMPL_EXP,function(e,r){var r=r.replace(/\s/gm,"");if("CONTENT"===r)return t;if("BINDPROPS"===r){for(var i="",s=Object.keys(n),o=s.length;o--;)i+=n[s[o]].nodeName+'="'+n[s[o]].nodeValue+'" ';return i}var a=n[r]&&n[r].nodeValue;return a||""})}function Directive(e,t){Component.call(this),this.$value=t,this.$name=e,this.$final=!1,this.$endTag=null,this.observe}function Converter(e){this.$component=e,this.$value,this.$html=!1,this.onCreate}function Service(){this.$singleton,this.onCreate}function Factory(e){this.types={},this.instances=[],this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _ConverterFactory(){Factory.call(this,Converter)}function _ServiceFactory(){Factory.call(this,Service)}function compDebug(e,t){for(var n="",r=e.$parent;r;)n+="=",r=r.$parent;var i="";if(e==lastComp)i="↑↑↑ ↑↑↑ ↑↑↑ ";else{var s=[];s.push("id:"+e.$__id),e.$name&&s.push("name:"+e.$name);var o=e.$view?e.$view.elements[0].tagName:"";s.push("view:"+o),e.$parent&&s.push("parentId:"+(e.$parent?e.$parent.$__id:"null"));var a=e instanceof Directive?"Directive":"Component";i=a+"{"+s.join(",")+"} "}lastComp=e,impex.console.debug(n+(n?"> ":"")+i+t)}var Util=new function(){function e(){impex.console.error("无法获取远程数据 : "+this.url)}function t(){impex.console.error("请求超时 : "+this.url)}function n(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&this.cbk&&this.cbk(this.responseText)}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},this.ext=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];e[i]=t[i]}},this.extProp=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function||void 0!==t[i]&&(e[i]=t[i])}},this.extMethod=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function&&(e[i]=t[i])}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function},this.isWindow=function(e){return"Array"in e&&"XMLHttpRequest"in e&&"XMLDocument"in e&&"JSON"in e};var r=document.createElement("div");this.isDOMStr=function(e){return r.innerHTML=e,r.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName},this.on=function(e,t,n){t.addEventListener?t.addEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.attachEvent(e,n))},this.off=function(e,t,n){t.removeEventListener?t.removeEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.detachEvent(e,n))},this.loadTemplate=function(r,i,s){var o=new XMLHttpRequest;o.open("get",r,!0),o.timeout=s||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=n:o.onreadystatechange=n,o.cbk=i,o.url=r,o.send(null)}},RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),fallback=Object.observe?!1:!0,observedObjects=[],observedOldObjects=[],observedArys=[],observedOldArys=[],Object_observe=Object.observe||function(e,t){var n={};for(var r in e){var i=e[r];n[r]=i}observedOldObjects.push(e),observedObjects.push({oldVer:n,newVer:e,handler:t})},Object_unobserve=Object.unobserve||function(e,t){var n=observedOldObjects.indexOf(e);n>-1&&(observedObjects.splice(n,1),observedOldObjects.splice(n,1))},Array_observe=Array.observe||function(e,t){var n=[];if(!(e instanceof Array))throw new Error("Array.observe cannot observe non-array");for(var r=e.length;r--;)n.unshift(e[r]);observedOldArys.push(e),observedArys.push({oldVer:n,newVer:e,handler:t})},Array_unobserve=Array.unobserve||function(e,t){var n=observedOldArys.indexOf(e);n>-1&&(observedArys.splice(n,1),observedOldArys.splice(n,1))};fallback&&function e(){RAF(function(){for(var t=observedObjects.length;t--;){var n=observedObjects[t],r=n.oldVer,i=n.newVer,s=n.handler,o=[];for(var a in r){if(void 0===i[a]){var h={};h.name=a,h.oldValue=r[a],h.object=i,h.type="delete",o.push(h)}if(i[a]!=r[a]){var h={};h.name=a,h.oldValue=r[a],h.object=i,h.type="update",o.push(h)}}for(var a in i)if(void 0===r[a]){var h={};h.name=a,h.oldValue=r[a],h.object=i,h.type="add",o.push(h)}o.length>0&&s(o),n.oldVer={};for(var a in i){var l=i[a];n.oldVer[a]=l}}for(var t=observedArys.length;t--;){var n=observedArys[t],r=n.oldVer,i=n.newVer,s=n.handler,o=[];if(r.length==i.length){for(var c=r.length;c--;)if(i[c]!=r[c]){var h={};h.name=c,h.oldValue=r[c],h.object=i,h.type="update",o.push(h)}}else{var h={};h.type="splice",h.index=-1,h.object=i;for(var p=[],v=r.length;v--;)p.push(i[v]);var u=[];for(var f in r)p[f]!=r[f]&&(-1==h.index&&(h.index=f),u.push(r[f]));for(var d=[],v=0;v<i.length;v++)d.push(r[v]);var _=[];for(var f in r)i[f]!=d[f]&&(-1==h.index&&(h.index=f),_.push(i[f]));o.push(h)}o.length>0&&s(o)}e()})}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,i){if(a.test(e)){var s=r(i,t);return c="var",s}return o.test(e)?(c="str",n(t,RegExp.$1)):(c="",e)}function n(e,t){for(var n=!1,r=t,i=1;i<e.length;i++){var s=e[i];if("\\"!==s){if(!n&&s===t)return r+t;r+=s,n=!1}else n=!0,r+=s}}function r(n,i,s,o){for(var c="",p=[],v=-1,u=-1,f=-1,d=o||e(),_=0;_<i.length;_++){var m=i[_];if(p.length>0)if(h.test(m)){var g=e(),y=r(n,i.substr(_),!0,g);_=_+y.length-1;var $=y;a.test(y[0])&&(d.subVars["."+y]=g,l.indexOf($)<0&&($=["."+$])),d.words.push($)}else if("]"===m||")"===m){if(p.pop(),0===p.length){var b=i.substring(v,_+1);c+=b,d.segments.push(b),f=_}d.words.push(m),u=_}else{var w=t(m,i.substr(_),n);_=_+w.length-1,d.words.push(w),u=_}else if(h.test(m)){if(c+=m,"."===m){var $=c.substr(f+1);$=$.replace(/\./,""),$&&(d.segments.push($),f=_)}}else{if("["!==m&&"("!==m){if("]"!==m&&")"!==m||!s){var $=c.substr(u+1);$&&("."!==$[0]&&l.indexOf($)<0&&($=["."+$]),d.words.push($));var x=c.substr(f+1);return x&&(d.segments.push(x),f=_),!s&&l.indexOf($)<0&&(n["."+c]=d),c}var $=c;if($[$.length-1]!==m){/[a-zA-Z0-9$_]+\[.+\]/.test(c)?($=$.replace(/[a-zA-Z0-9$_]+\[.+\]/,""),d.words.push($)):l.indexOf($)<0&&d.words.push(["."+$]);var C=$.lastIndexOf(".");C>0&&($=$.substr(C)),d.segments.push($),f=_}return u=_,c}p.push(m),v=_,d.brakLength++;var O=c.substr(u+1);if(O){var $=O;l.indexOf(O)<0&&0>u&&($=["."+O]),d.words.push($)}d.words.push(m);var E="["===m?"]":")";if(c[_-1]!==E){var P=O.lastIndexOf(".");P>-1?(O=O.substr(P),d.segments.push(O)):d.segments.push(O),f=_}u=_}}var N=c.substr(c.lastIndexOf("]")+1),T=c.substr(c.lastIndexOf(")")+1);if(N&&T){var F=N.length<T.length?N:T,x=c.substr(f+1);d.segments.push(x);var $="["===F[0]||"("===F[0]?F:"."===F[0]?F:"."+F;d.words.length<1&&l.indexOf($)<0&&($=[$]),d.words.push($)}return s||(n["."+c]=d),c}function i(e){for(var t in e){var n=e[t],r=null,o=null,a=t.lastIndexOf(".");if("]"===t[t.length-1]||")"===t[t.length-1]){a=s(t,n.brakLength);var h="]"===t[t.length-1]?"[":"(",l=n.brakLength;n.watchPathWords=[];for(var c=0;c<n.words.length;c++){var p=n.words[c];if(p===h&&--l<1)break;n.watchPathWords.push(p)}}else n.watchPathWords=n.words.concat(),n.watchPathWords.splice(-1,1);r=t.substr(a),n.lastVar="("===r[0]?t:r,Object.keys(n.subVars).length<1&&(o=t.substring(0,a).replace(/\.$/,""),n.watchPath=o);for(var c=n.segments.length;c--;)n.segments[c]=n.segments[c].replace(/^\.|\.$/g,"");i(n.subVars)}}function s(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(("["===r||"("===r)&&--t<1)return n}}var o=/(['"])/,a=/[a-zA-Z$_]/,h=/[a-zA-Z$_0-9.]/,l=["as","instanceof"],c="";return function(e){for(var n=[],r={},s=0;s<e.length;s++){var o=e[s];c="";var a=t(o,e.substr(s),r);switch(s=s+a.length-1,c){case"var":n.push(l.indexOf(a)<0?["."+a]:a);break;case"str":case"":n.push(a)}}return i(r),{words:n,varTree:r}}}(),Scanner=new function(){function e(e){var n=[],r=[];t(e,n);for(var i=n.length;i--;){var e=n[i],s=e.nodeValue,o=[],a=0;s.replace(REG_EXP,function(e,t,n){o.push(s.substring(a,n)),o.push(e),a=n+e.length}),o.push(s.substring(a,s.length));for(var h=document.createDocumentFragment(),l=0;l<o.length;l++){var c=o[l].replace(/\s/g,"");if(c){var p=document.createTextNode(o[l]);h.appendChild(p)}}r.unshift(h)}for(var l=n.length;l--;){var v=n[l];r[l].childNodes.length>1&&v.parentNode.replaceChild(r[l],v)}}function t(e,n){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.childNodes.length>0)for(var r=0,i=e.childNodes.length;i>r;r++)t(e.childNodes[r],n)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n.push(e)}}function n(e,t){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.tagName){var i=e.tagName.toLowerCase();if(ComponentFactory.hasTypeOf(i))return void t.createSubComponentOf(i,e);for(var s=e.attributes,o=s.length;o--;){var a=s[o].name.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(a)){if(DirectiveFactory.isFinal(a)){var h=DirectiveFactory.newInstanceOf(a,[e],t,s[o].name,s[o].value);return void t.$__directives.push(h)}if(DirectiveFactory.hasEndTag(a))return[a,s[o].value]}}for(var o=s.length;o--;){var l=s[o],c=l.name,p=l.value;if(REG_CMD.test(c)){var a=c.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(a)){var h=DirectiveFactory.newInstanceOf(a,[e],t,s[o].name,p);t.$__directives.push(h)}}else REG_EXP.test(p)&&r(p,e,t,c)}}if(e.childNodes.length>0){for(var v=null,u=[],o=0,f=e.childNodes.length;f>o;o++)if(v){u.push(e.childNodes[o]);var d=DirectiveFactory.hasEndTag(v[0]),_=e.childNodes[o].getAttribute&&e.childNodes[o].getAttribute(CMD_PREFIX+d);if(Util.isString(_)){var h=DirectiveFactory.newInstanceOf(v[0],u,t,CMD_PREFIX+v[0],v[1]);t.$__directives.push(h),v=null,u=[]}}else v=n(e.childNodes[o],t),v&&u.push(e.childNodes[o]);v&&impex.console.error("can not find endTag of directive["+CMD_PREFIX+v[0]+"]")}}else if(3==e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,e,t)}}function r(e,t,n,r){var s={},o={};if(e.replace(REG_EXP,function(e,t){var r=1;CONVERTER_EXP.test(t)&&(r=i(t,o,n));var a=t;r>1&&(a=t.substr(r));var h=lexer(a);s[t]={words:h.words,varTree:h.varTree}}),!(Object.keys(s).length<1)){var a=new ExpNode(t,r,e,s,n,o);n.$__expNodes.push(a)}}function i(e,t,n){for(var r,i,s=!0,o="",a="",h=[],l=e.indexOf(EXP_CONVERTER_SYM)+1;l<e.length;l++){var c=e[l];switch(c){case" ":case"	":i=!0;continue;case":":r=!0,s=!1,i=!1,a&&(h.push(a),a="");continue;case"|":r=!1,s=!0,i=!1,o&&ConverterFactory.hasTypeOf(o)&&(t[o]=[ConverterFactory.newInstanceOf(o,n),h]),a&&h.push(a),o="",a="",h=[];continue;default:if(i)return o&&(t[o]=[ConverterFactory.newInstanceOf(o,n),h]),a&&h.push(a),l}s?o+=c:r&&(a+=c)}return l}this.scan=function(t,r){for(var i=t.elements?t.elements:[t.element],s=null,o=[],a=0,h=i.length;h>a;a++)if(e(i[a]),s){o.push(i[a]);var l=DirectiveFactory.hasEndTag(s[0]),c=i[a].getAttribute&&i[a].getAttribute(CMD_PREFIX+l);if(Util.isString(c)){var p=DirectiveFactory.newInstanceOf(s[0],o,r,CMD_PREFIX+s[0],s[1]);r.$__directives.push(p),s=null,o=[]}}else s=n(i[a],r),s&&o.push(i[a]);s&&impex.console.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")}},Builder=new function(){function e(e){for(var n=e.$__expNodes.length;n--;){var r=e.$__expNodes[n];for(var i in r.expMap){var s=r.expMap[i],o=s.varTree;for(var a in o){var h=o[a];t(e,h,a,r)}}}for(var n=e.$__components.length;n--;){var l=e.$__components[n];e.$__directives.indexOf(l)>-1||(l.init(),l.display())}for(var n=e.$__directives.length;n--;){var c=e.$__directives[n];c.init()}}function t(e,r,i,s){for(var o in r.subVars){var a=r.subVars[o];t(e,a,o,s)}for(var h=n(e.$__expPropRoot.subProps,r.segments[0],s),l=1;l<r.segments.length;l++){{l===r.segments.length?!0:!1}h=n(h.subProps,r.segments[l],s)}}function n(e,t,n){var r=e[t];return r||(r=e[t]=new ExpProp(t)),n instanceof ExpNode?r.expNodes.indexOf(n)<0&&r.expNodes.push(n):n instanceof AttrObserveNode?r.attrObserveNodes.indexOf(n)<0&&r.attrObserveNodes.push(n):n instanceof Watch&&r.watchs.indexOf(n)<0&&r.watchs.push(n),e[t]}function r(e,t,n,s){function o(e){n.$__state!==Component.state.suspend&&n.$__state!==Component.state.destroyed&&i(e,t,n,s)}if(!(s>DEPTH)){var a=!1;if(Util.isArray(e)){if(e.$__impex__observer)return;e.$__impex__observer=o,e.$__impex__oldVal=e.concat(),Array_observe(e,o),a=!0}else if(Util.isObject(e)){if(Util.isDOM(e))return;if(Util.isWindow(e))return;if(e.$__impex__observer)return;e.$__impex__observer=o,Object_observe(e,o),a=!0}if(a)for(var h=Object.keys(e),l=h.length;l--;){var c=h[l];if(0!==c.indexOf("$")){var p=t.concat();p.push(c),r(e[c],p,n,s+1)}}}}function i(e,t,n,i){if(!Util.isString(e))for(var s=e.length;s--;){var o=e[s],h=o.name;if(!h||0!==h.indexOf("$")){var l=o.object[h],c=t.concat();h&&!Util.isArray(o.object)&&c.push(h);var p=o.oldValue;if(Util.isArray(o.object)&&(l=o.object,p=o.object.$__impex__oldVal),a(n,c,o.type,l,p),!Util.isArray(o.object)&&Util.isArray(o.oldValue))Array_unobserve(o.oldValue,o.oldValue.$__impex__observer);else{if(Util.isArray(o.object))return void(o.object.$__impex__oldVal=o.object.concat());if(Util.isObject(o.oldValue)){var v=o.oldValue.$__impex__observer;v&&(Object_unobserve(o.oldValue,v),o.oldValue.$__impex__observer=null)}}r(l,c,n,i)}}}function s(e,t,n,r,i){for(var s,a=e.$__expPropRoot.subProps,h=0;h<t.length;h++){var l=t[h];{if(!a[l])break;s=a[l],a=a[l].subProps}}if(s){var c=t.length-h,p=[];c>0?o(s,c,p):p.push(s);for(var v=[],h=p.length;h--;){for(var u=p[h].expNodes.length;u--;){var f=p[h].expNodes[u];Renderer.renderExpNode(f)}for(var u=p[h].attrObserveNodes.length;u--;){var d=p[h].attrObserveNodes[u],_=Renderer.evalExp(d.directive,d.expObj);d.directive.observe(_)}for(var u=p[h].watchs.length;u--;){var m=p[h].watchs[u];if(!(m.segments.length<t.length||v.indexOf(m)>-1)){for(var g=!0,y=0;y<m.segments.length&&t[y];y++)if("["!==m.segments[y][0]&&"["!==t[y][0]&&m.segments[y]!==t[y]){g=!1;break}if(g){var $=r,b=i;if(m.segments.length>t.length){for(var w=m.segments.slice(y),x="$var",y=0;y<w.length;y++){var C=w[y];x+="["===C[0]?C:"."+C}try{$=new Function("$var","return "+x)(r),b=new Function("$var","return "+x)(i)}catch(O){impex.console.debug("error on parse watch params"),$=null}}m.cbk&&m.cbk.call(m.ctrlScope,n,$,b),v.push(m)}}}}}}function o(e,t,n){if(1>t)return void n.push(e);for(var r in e.subProps)o(e.subProps[r],t-1,n)}function a(e,t,n,r,i){s(e,t,n,r,i);for(var o=e.$__components.length;o--;){var h=e.$__components[o];a(h,t,n,r,i)}}this.buildExpModel=t,this.build=function(t){e(t);var n=0;r(t,[],t,n+1)}},Renderer=new function(){function renderExpNode(e){var t=calcExp(e.component,e.origin,e.expMap),n=e.converters;if(Object.keys(n).length>0)for(var r in n){var i=n[r][0],s=n[r][1];if(i.$value=t,t=i.to.apply(i,s),i.$html){var o=renderHTML(i,t,e.node,e.component);if(o)return}}null!==t&&updateDOM(e.node,e.attrName,t)}function updateDOM(e,t,n){if(e.setAttribute){e.setAttribute(t,n);var r=propMap[t];r&&r.indexOf(e.tagName)>-1&&(e[t]=n)}else try{e.nodeValue=n}catch(i){}}function calcExp(e,t,n){var r={};for(var i in n){var s=n[i],o=evalExp(e,s);r[i]=void 0==o?"":o}for(var a in r)t=t.replace(EXP_START_TAG+a+EXP_END_TAG,r[a]);return t}function evalExp(e,t){var n=getExpEvalStr(e,t),r="";try{r=new Function("return "+n)()}catch(i){impex.console.debug(i.message+' when eval "'+n+'"')}return r}function getExpEvalStr(e,t){var n=t.varTree,r={};for(var i in n){var s=n[i],o=buildVarPath(e,s,i);r[i]=o}var a=joinExpStr(t.words,r);return a}function joinExpStr(e,t){for(var n="",r=0;r<e.length;r++){var i=e[r];n+=i instanceof Array?t[i[0]]:i}return n}function keyWordsMapping(e,t){return"this"==e?t.__getPath():void 0}function buildVarPath(e,t,n){var r={};for(var i in t.subVars){var s=t.subVars[i],o=buildVarPath(e,s,i);r[i]=o}for(var a=!1,h="",l=0;l<t.words.length;l++){var c=t.words[l];if(c instanceof Array){var p=keyWordsMapping(t.segments[0],e);if(p){a=!0;var v=new RegExp("^\\."+t.segments[0]);h+=c[0].replace(v,p)}else h+=r[c[0]]||c[0]}else h+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var l=0;l<t.watchPathWords.length;l++){var c=t.watchPathWords[l];u+=c instanceof Array?r[c[0]]||c[0]:c}return e=u?varInCtrlScope(e,u):varInCtrlScope(e,h),a?h:(e?e.__getPath():"self")+h}function varInCtrlScope(e,t){for(var n=e;n;){if(void 0!==getVarByPath(t,n.__getPath()))return n;n=n.$parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=void 0;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,n,r){if(e.__lastVal!=t&&Util.isDOMStr(t)&&3==n.nodeType){var i=new View([n]);if(!e.__lastVal){var s=ViewManager.createPlaceholder("-- converter [html] placeholder --");ViewManager.insertBefore(s,i),e.__lastVal=t,e.__placeholder=s}e.__lastComp&&(e.__lastComp.destroy(),i=ViewManager.createPlaceholder(""),ViewManager.insertAfter(i,e.__placeholder));var o=r.createSubComponent(t,i);return o.init(),o.display(),e.__lastComp=o,e.__lastVal=t,!0}}this.render=function(e){for(var t=e.$__expNodes.length;t--;)renderExpNode(e.$__expNodes[t]);for(var n=e.$__components.length;n--;)Renderer.render(e.$__components[n])},this.renderExpNode=renderExpNode;var propMap={value:["INPUT"]};this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};ViewModel.prototype={data:function(path,val){var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);return arguments.length>1?(eval(evalStr+'= "'+(val&&val.replace?val.replace(/\r\n|\n/gm,"\\n"):val)+'"'),this):eval(evalStr)},closest:function(e){var t=lexer(e),n=Renderer.getExpEvalStr(this,t);return n.replace(/^impex\.__components\["(C_[0-9]+)"\]/,""),impex.__components[RegExp.$1]}},Component.state={created:"created",inited:"inited",displayed:"displayed",destroyed:"destroyed",suspend:"suspend"},Util.inherits(Component,ViewModel),Util.ext(Component.prototype,{on:function(e,t,n){this.$view.__on(this,e,t,n)},off:function(e,t){this.$view.__off(this,e,t)},find:function(e,t){e=e.toLowerCase();for(var n=this.$__components.length;n--;){var r=this.$__components[n];if("*"==e||r.$name==e){var i=!0;if(t)for(var s in t)if(r[s]!=t[s]){i=!1;break}if(i)return r}}return null},findD:function(e,t){e=e.toLowerCase();for(var n=this.$__directives.length;n--;){var r=this.$__directives[n];if("*"==e||r.$name==e){var i=!0;if(t)for(var s in t)if(r[s]!=t[s]){i=!1;break}if(i)return r}}return null},watch:function(e,t){var n=lexer(e),r=Object.keys(n.varTree);if(!(r.length<1)){if(r.length>1)return void impex.console.warn("变量表达式"+e+"错误，只能同时watch一个变量");var i=n.varTree[r[0]],s=new Watch(t,this,i.segments);return Builder.buildExpModel(this,i,r[0],s),this}},add:function(e){this.$__components.push(e),e.$parent=this},createSubComponentOf:function(e,t){var n=ComponentFactory.newInstanceOf(e,t.elements?t.elements[0]:t);return this.$__components.push(n),n.$parent=this,n},createSubComponent:function(e,t){var n=ComponentFactory.newInstance(e,t.elements[0]);return this.$__components.push(n),n.$parent=this,n},init:function(){if(this.$__state===Component.state.created){if(this.$templateURL){var e=this;Util.loadTemplate(this.$templateURL,function(t){var n=e.$view.__init(t,e);n!==!1&&(e.__init(t),e.display())})}else{if(this.$template){var t=this.$view.__init(this.$template,this);if(t===!1)return}this.__init(this.$template)}return this}},__init:function(e){Scanner.scan(this.$view,this),compDebug(this,"inited");var t=null;return this.onInit&&(t=this.onInit(e)),t===!1?void this.destroy():void(this.$__state=Component.state.inited)},display:function(){(this.$__state===Component.state.inited||this.$__state===Component.state.suspend)&&(this.$view.__display(),Renderer.render(this),this.$__suspendParent&&(this.$parent=this.$__suspendParent,this.$__suspendParent=null),this.$__state=Component.state.displayed,Builder.build(this),compDebug(this,"displayed"),this.onDisplay&&this.onDisplay())},destroy:function(){if(this.$__state!==Component.state.destroyed){if(compDebug(this,"destroy"),this.$parent){var e=this.$parent.$__components.indexOf(this);e>-1&&this.$parent.$__components.splice(e,1),this.$parent=null}for(this.$view.__destroy(this);this.$__components.length>0;)this.$__components[0].destroy();this.$view=this.$__components=this.$__directives=this.$__expNodes=this.$__expPropRoot=null,this.onDestroy&&this.onDestroy(),this.$__state=Component.state.destroyed}},suspend:function(e){if(this.$__state===Component.state.displayed){if(compDebug(this,"suspend"),this.$parent){var t=this.$parent.$__components.indexOf(this);t>-1&&this.$parent.$__components.splice(t,1),this.$__suspendParent=this.$parent,this.$parent=null}this.$view.__suspend(this,e===!1?!1:!0),this.onSuspend&&this.onSuspend(),this.$__state=Component.state.suspend}},__getPath:function(){return'impex.__components["'+this.$__id+'"]'}}),View.prototype={__init:function(e,t){var n=this.__target.attributes,r=this.__target.innerHTML,i=tmplExpFilter(e,r,n),s=DOMViewProvider.compile(i);if(!s||s.length<1)return impex.console.warn('invalid template "'+e+'" of component['+t.$name+"]"),!1;if(this.elements=s,n)for(var o=n.length;o--;){var a=n[o].name,h=n[o].value;t[a]=h}},__display:function(){if(this.__target&&(!this.elements[0].parentNode||1!==this.elements[0].parentNode.nodeType)){var e=null;if(this.elements.length>1){e=document.createDocumentFragment();for(var t=0;t<this.elements.length;t++)e.appendChild(this.elements[t])}else e=this.elements[0];this.__target.parentNode.replaceChild(e,this.__target),e=null,this.__target=null}},__destroy:function(e){for(var t in this.__evMap)for(var n=this.__evMap[t],r=n.length;r--;)for(var i=n[r],s=i[1],o=this.elements.length;o--;)1===this.elements[o].nodeType&&Util.off(t,this.elements[o],s);var a=this.elements[0].parentNode;if(a){this.elements[0].__impex__view&&(this.elements[0].__impex__view=null);for(var r=this.elements.length;r--;)a.removeChild(this.elements[r])}this.__target&&(this.__target.parentNode.removeChild(this.__target),this.__target=null)},__suspend:function(e,t){t&&(this.__target=document.createComment("-- view suspended of ["+(e.$name||"anonymous")+"] --"),this.elements[0].parentNode.insertBefore(this.__target,this.element));var n=this.elements[0].parentNode;if(n)for(var r=this.elements.length;r--;)n.removeChild(this.elements[r])},__on:function(e,t,n,r){for(var i=n,s=e,o="",a=null,h=function(e){var t=i;if(r instanceof Function&&(t=r.call(s,e,i)),t){if(o!=t){var n=lexer(t),h=Renderer.getExpEvalStr(s,n),l=h.replace("self.$event","$event");a=new Function("$event",l),o=t}a(e)}},l=this.elements.length;l--;){var c=this.elements[l];1===c.nodeType&&Util.on(t,c,h)}this.__evMap[t]||(this.__evMap[t]=[]),this.__evMap[t].push([n,h])},__off:function(e,t,n){for(var r=this.__evMap[t],i=r.length;i--;){var s=r[i],o=s[0],a=s[1];if(o==n)for(var h=this.elements.length;h--;)1===this.elements[h].nodeType&&Util.off(t,this.elements[h],a)}},clone:function(){for(var e=[],t=this.elements.length;t--;){var n=this.elements[t].cloneNode(!0);e.unshift(n)}var r=new View(e);return r},show:function(){for(var e=this.elements.length;e--;)1===this.elements[e].nodeType&&(this.elements[e].style.display="");return this},hide:function(){for(var e=this.elements.length;e--;)1===this.elements[e].nodeType&&(this.elements[e].style.display="none");return this},style:function(e,t){if(arguments.length>1){for(var n=this.elements.length;n--;)1===this.elements[n].nodeType&&(this.elements[n].style[e]=t);return this}for(var n=0;n<this.elements.length&&1!==this.elements[n].nodeType;n++);return this.elements[n].style[e]},attr:function(e,t){if(arguments.length>1){for(var n=this.elements.length;n--;)1===this.elements[n].nodeType&&this.elements[n].setAttribute(e,t);return this}for(var n=0;n<this.elements.length&&1!==this.elements[n].nodeType;n++);return this.elements[n].getAttribute(e)},removeAttr:function(e){for(var t=this.elements.length;t--;)1===this.elements[t].nodeType&&this.elements[t].removeAttribute(e);return this}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,n){if(e.innerHTML=t,!e.childNodes[0])return null;for(var r=[];e.childNodes.length>0;){var i=e.removeChild(e.childNodes[0]);r.push(i)}var s=new View(r,n);return s};var t=["meta","title","base"];this.compile=function(n){if(e.innerHTML=n,!e.children[0])return null;for(var r=[];e.children.length>0;){var i=e.removeChild(e.children[0]),s=i.nodeName.toLowerCase();t.indexOf(s)>-1||r.push(i)}return r}},ViewManager=new function(){this.$singleton=!0,this.replace=function(e,t){var n=t.elements[0],r=e.elements[0],i=t.elements[0].parentNode,s=r;if(e.elements.length>1){s=document.createDocumentFragment();for(var o=0;o<e.elements.length;o++)s.appendChild(e.elements[o])}if(t.elements.length>1){i.insertBefore(s,n);for(var o=t.elements.length;o--;)i.removeChild(t.elements[o])}else i.replaceChild(s,n)},this.insertBefore=function(e,t){var n=t.elements[0],r=e.elements[0],i=t.elements[0].parentNode,s=r;if(e.elements.length>1){s=document.createDocumentFragment();for(var o=0;o<e.elements.length;o++)s.appendChild(e.elements[o])}i.insertBefore(s,n)},this.insertAfter=function(e,t){var n=t.elements[0],r=e.elements[0],i=t.elements[0].parentNode,s=i.lastChild,o=r;if(e.elements.length>1){o=document.createDocumentFragment();for(var a=0;a<e.elements.length;a++)o.appendChild(e.elements[a])}if(s==n)i.appendChild(o);else{var h=t.elements[t.elements.length-1].nextSibling;i.insertBefore(o,h)}},this.createPlaceholder=function(e){return new View([document.createComment(e)])}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){var e={},t=this;this.$value.replace(REG_EXP,function(n,r){var i=lexer(r),s=Renderer.evalExp(t.$parent,i);e[r]={val:s}});var n=this.$value;for(var r in e)n=n.replace(EXP_START_TAG+r+EXP_END_TAG,e[r].val);if(this.$view&&this.$view.elements[0].setAttribute(this.$name,n),this.$value=n,this.observe){var i=lexer(n);for(var s in i.varTree){var o=i.varTree[s],a=new AttrObserveNode(this,i);Builder.buildExpModel(this.$parent,o,s,a)}var h=Renderer.evalExp(this.$parent,i);this.observe(h)}compDebug(this,"inited"),this.onInit&&this.onInit(),this.$__state=Component.state.inited}}),Converter.prototype={to:function(){return null}},Factory.prototype={register:function(e,t,n){e=e.toLowerCase();for(var r=BUILD_IN_PROPS.length;r--;)if(BUILD_IN_PROPS[r]in t)return void impex.console.error("attempt to overwrite build-in property["+BUILD_IN_PROPS[r]+"] of Component["+e+"]");var i=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),s={};Util.extProp(s,t),Util.inherits(i,this.baseClass),Util.extMethod(i.prototype,t),this.types[e]={clazz:i,props:s,services:n}},hasTypeOf:function(e){return e in this.types}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{newInstance:function(e){var t=null;if(2===arguments.length){var n=arguments[0],r=arguments[1];t=n,Util.isString(n)?t=this.viewProvider.newInstance(n,r):t.__target=r}else t=e,Util.isDOM(e)&&(t=new View([e]));var i=new this.baseClass(t);this.instances.push(i);var s=arguments[2],o=arguments[3];if(s){for(var a=BUILD_IN_PROPS.length;a--;)if(BUILD_IN_PROPS[a]in s)return void impex.console.error("attempt to overwrite build-in property["+BUILD_IN_PROPS[a]+"] of Component");Util.ext(i,s)}if(Util.isArray(o)){for(var h=[],a=0;a<o.length;a++){var l=ServiceFactory.newInstanceOf(o[a]);h.push(l)}i.onCreate&&i.onCreate.apply(i,h)}else i.onCreate&&i.onCreate();return i},newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass);Util.extProp(n,this.types[e].props),n.$view=new View(null,t),n.$name=e,this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props.$final},hasEndTag:function(e){return this.types[e].props.$endTag},newInstanceOf:function(e,t,n,r,i){if(!this.types[e])return null;var s=new this.types[e].clazz(this.baseClass,r,i,n);Util.extProp(s,this.types[e].props),t[0].__impex__view?s.$view=t[0].__impex__view:(s.$view=new View(t),t[0].__impex__view=s.$view);var o=null;if(this.types[e].services){o=[];for(var a=0;a<this.types[e].services.length;a++){var h=ServiceFactory.newInstanceOf(this.types[e].services[a]);o.push(h)}}return n.add(s),s.onCreate&&(o?s.onCreate.apply(s,o):s.onCreate()),this.instances.push(s),s}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_ConverterFactory,Factory),Util.ext(_ConverterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass,t);Util.extProp(n,this.types[e].props),this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ConverterFactory=new _ConverterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e){if(e=e.toLowerCase(),!this.types[e])return null;var t=null;this.types[e].props.$singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),t=this.types[e].singleton):(t=new this.types[e].clazz(this.baseClass),this.instances.push(t),Util.extProp(t,this.types[e].props));var n=null;if(this.types[e].services){n=[];for(var r=0;r<this.types[e].services.length;r++){var i=ServiceFactory.newInstanceOf(this.types[e].services[r]);n.push(i)}}return t.onCreate&&t.onCreate.apply(t,n),t}});var ServiceFactory=new _ServiceFactory,CMD_PREFIX="x-",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,CONVERTER_EXP=/^\s*#/,EXP_CONVERTER_SYM="#",DEPTH=9,DEBUG=!1,BUILD_IN_PROPS=["data","closest"],lastComp,impex=new function(){function e(e){var n=e;do{if(t.indexOf(n)>-1)return!0;n=n.parentNode}while(n);return!1}this.version={v:[0,4,0],state:"beta",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://mrsoya.github.io/impex",this.option=function(e){EXP_START_TAG=e.expStartTag||"{{",EXP_END_TAG=e.expEndTag||"}}",DEPTH=parseInt(e.recurDepth)||9,REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),DEBUG=e.debug},this.component=function(e,t,n){return ComponentFactory.register(e,t,n),this},this.directive=function(e,t,n){return DirectiveFactory.register(e,t,n),this},this.service=function(e,t,n){return ServiceFactory.register(e,t,n),this},this.converter=function(e,t,n){return ConverterFactory.register(e,t,n),this},this.render=function(n,r,i){var s=n.tagName.toLowerCase();if(e(n))return void impex.console.warn("element ["+s+"] has been rendered");var o=ComponentFactory.newInstanceOf(s,n);

return o||(t.push(n),o=ComponentFactory.newInstance(n,null,r,i)),o.init(),o.display(),o};var t=[];this.__components={},this.findAll=function(e,t){e=e.toLowerCase();for(var n=[],r=Object.keys(this.__components),i=r.length;i--;){var s=this.__components[r[i]];if("*"==e||s.$name==e){var o=!0;if(t)for(var a in t)if(s[a]!=t[a]){o=!1;break}o&&n.push(s)}}return n}};impex.console=new function(){this.warn=function(e){console.warn("impex warn :: "+e)},this.error=function(e){console.error("impex error :: "+e)},this.debug=function(e){DEBUG&&console.debug("impex debug :: "+e)}},self.console=self.console||new function(){this.log=function(){},this.info=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},impex.service("ViewManager",ViewManager),impex.service("ComponentManager",new function(){this.hasTypeOf=function(e){return ComponentFactory.hasTypeOf(e)},this.findAll=function(e){for(var t=ComponentFactory.instances,n=[],r=t.length;r--;){var i=!0;for(var s in e)if(comp[s]!=e[s]){i=!1;break}i&&n.push(comp)}return n}}),!function(e){function t(e,n,r){for(var i=e.$__expNodes.length;i--;){var s=e.$__expNodes[i];s.node==n&&"class"===s.attrName&&(s.origin=r)}for(var o=e.$__components.length;o--;)t(e.$__components[o],n,r)}function n(){this.onCreate=function(e){this.$eachExp=/(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*=>\s*[a-zA-Z0-9_$]+?)|(?:[a-zA-Z0-9_$]+?))$/,this.$viewManager=e,this.$expInfo=this.parseExp(this.$value),this.$parentComp=this.$parent,this.$__view=this.$view,this.$cache=[],this.$subComponents=[],this.$cacheSize=20},this.onInit=function(){if(this.$__state!==Component.state.inited){this.$ds=this.$parent.data(this.$expInfo.ds),this.$placeholder=this.$viewManager.createPlaceholder("-- directive [each] placeholder --"),this.$viewManager.insertBefore(this.$placeholder,this.$view),this.build(this.$ds,this.$expInfo.k,this.$expInfo.v),this.destroy();var e=this;this.$parentComp.watch(this.$expInfo.ds,function(t,n,r){var i=0,s=0;for(var o in n)n.hasOwnProperty(o)&&0!==o.indexOf("$")&&i++;if(0===i)s=e.$subComponents.length;else for(var o in r)r.hasOwnProperty(o)&&0!==o.indexOf("$")&&s++;e.rebuild(n,i-s,e.$expInfo.k,e.$expInfo.v)})}},this.rebuild=function(e,t,n,r){if(0>t){var i=this.$subComponents.splice(0,-1*t);if(this.$cache.length<this.$cacheSize){for(var s=i.length;s--;)this.$cache.push(i[s]);for(var s=this.$cache.length;s--;)this.$cache[s].suspend(!1)}else for(var s=i.length;s--;)i[s].destroy()}else if(t>0){for(var i=this.$cache.splice(0,t),s=0;s<i.length;s++)this.$subComponents.push(i[s]),this.$viewManager.insertBefore(i[s].$view,this.$placeholder);for(var o=t-i.length;o--;)var a=this.createSubComp()}var h=Util.isArray(e)?!0:!1,l=0;for(var c in e)if(e.hasOwnProperty(c)&&!(h&&isNaN(c)||0===c.indexOf("$__"))){var a=this.$subComponents[l];a[r]=e[c],a.$index=l++,n&&(a[n]=h?c>>0:c),a.init(),a.display()}},this.createSubComp=function(){var e=this.$parentComp,t=this.$viewManager.createPlaceholder("");this.$viewManager.insertBefore(t,this.$placeholder);var n=this.$__view.clone().removeAttr(this.$name),r=e.createSubComponent(n,t);return this.$subComponents.push(r),r},this.build=function(e,t,n){var r=Util.isArray(e)?!0:!1,i=0;for(var s in e)if(e.hasOwnProperty(s)&&!(r&&isNaN(s)||0===s.indexOf("$__"))){var o=this.createSubComp();o[n]=e[s],o.$index=i++,t&&(o[t]=r?s>>0:s)}for(var a=this.$subComponents.length;a--;)this.$subComponents[a].init(),this.$subComponents[a].display()},this.parseExp=function(t){var n,r,i;return t.replace(this.$eachExp,function(e,t,s){n=t;var o=s.replace(/\s/gm,""),a=o.split("=>");a.length>1?(r=a[0],i=a[1]):i=a[0]}),n?{ds:n,k:r,v:i}:void e.console.error("invalid each expression : "+t)}}e.directive("show",{observe:function(e){e?this.$view.show():this.$view.hide()}}),e.directive("show-start",{$endTag:"show-end",onCreate:function(){this.$view.removeAttr("x-show-start"),this.__init(),this.display()},observe:function(e){e?this.$view.show():this.$view.hide()}}),e.directive("if",new function(){this.placeholder=null,this.viewManager,this.onCreate=function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --")},this.observe=function(e){if(e){if(this.$view.elements[0].parentNode)return;this.viewManager.replace(this.$view,this.placeholder)}else{if(!this.$view.elements[0].parentNode)return;this.viewManager.replace(this.placeholder,this.$view)}}},["ViewManager"]),e.directive("if-start",{$endTag:"if-end",onCreate:function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --"),this.$view.removeAttr("x-if-start"),this.__init(),this.display()},observe:function(e){if(e){if(this.$view.elements[0].parentNode)return;this.viewManager.replace(this.$view,this.placeholder)}else{if(!this.$view.elements[0].parentNode)return;this.viewManager.replace(this.placeholder,this.$view)}}},["ViewManager"]),e.directive("cloak",{onCreate:function(){var n=this.$view.attr("class");return n?(n=n.replace("x-cloak",""),this.$view.attr("class",n),void t(this.$parent,this.$view.elements[0],n)):void e.console.warn("can not find attribute[class] of element["+this.$view.name+"] which directive[cloak] on")}});var r=new n;r.$final=!0,e.directive("each",r,["ViewManager"]);var i=new n;i.$endTag="each-end",e.directive("each-start",i,["ViewManager"])}(impex),impex.converter("html",{$html:!0,to:function(){return this.$value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);