!function(global){"use strict";function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,n,r,i,s){this.node=e,this.attrName=t,this.origin=n,this.expMap=r,this.component=i,this.converters=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,n){this.cbk=e,this.ctrlScope=t,this.segments=n}function ViewModel(){}function Component(e){var t="C_"+Object.keys(impex.__components).length;impex.__components[t]=this,this.$__id=t,this.$__state=Component.state.created,this.$view=e,this.$name,this.$parent,this.$__components=[],this.$__directives=[],this.$__expNodes=[],this.$__expPropRoot=new ExpProp,this.$template,this.$templateURL,this.onCreate,this.onInit,this.onDisplay,this.onDestroy}function View(e,t,n){this.element=e instanceof Array?e[0]:e,this.elements=e instanceof Array?e:void 0,this.name=this.element&&this.element.nodeName.toLowerCase(),this.__evMap={},this.__target=n}function tmplExpFilter(e,t,n){return e=e.replace(REG_TMPL_EXP,function(e,r){var r=r.replace(/\s/gm,"");if("CONTENT"==r)return t;if("BINDPROPS"==r){for(var i="",s=Object.keys(n),a=s.length;a--;)i+=n[s[a]].nodeName+'="'+n[s[a]].nodeValue+'" ';return i}var o=n[r]&&n[r].nodeValue;return o||""})}function Directive(e,t){Component.call(this),this.$value=t,this.$name=e,this.$final=!1,this.$endTag=null,this.observe}function Converter(e){this.$component=e,this.$value,this.$html=!1,this.onCreate}function Service(){this.$singleton,this.onCreate}function Factory(e){this.types={},this.instances=[],this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _ConverterFactory(){Factory.call(this,Converter)}function _ServiceFactory(){Factory.call(this,Service)}var Util=new function(){function e(){impex.console.error("无法获取远程数据 : "+this.url)}function t(){impex.console.error("请求超时 : "+this.url)}function n(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&this.cbk&&this.cbk(this.responseText)}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},this.ext=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];e[i]=t[i]}},this.extProp=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function||void 0!==t[i]&&(e[i]=t[i])}},this.extMethod=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function&&(e[i]=t[i])}},this.isObject=function(e){return"object"==typeof e&&null!==e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isUndefined=function(e){return void 0===e},this.isFunction=function(e){return e instanceof Function},this.isWindow=function(e){return"Array"in e&&"XMLHttpRequest"in e&&"XMLDocument"in e&&"JSON"in e};var r=document.createElement("div");this.isDOMStr=function(e){return r.innerHTML=e,r.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName},this.on=function(e,t,n){t.addEventListener?t.addEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.attachEvent(e,n))},this.off=function(e,t,n){t.removeEventListener?t.removeEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.detachEvent(e,n))},this.loadTemplate=function(r,i,s){var a=new XMLHttpRequest;a.open("get",r,!0),a.timeout=s||5e3,a.ontimeout=t,a.onerror=e,null===a.onload?a.onload=n:a.onreadystatechange=n,a.cbk=i,a.url=r,a.send(null)}},RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),fallback=Object.observe?!1:!0,observedObjects=[],observedOldObjects=[],observedArys=[],observedOldArys=[],Object_observe=Object.observe||function(e,t){var n={};for(var r in e){var i=e[r];n[r]=i}observedOldObjects.push(e),observedObjects.push({oldVer:n,newVer:e,handler:t})},Object_unobserve=Object.unobserve||function(e,t){var n=observedOldObjects.indexOf(e);n>-1&&(observedObjects.splice(n,1),observedOldObjects.splice(n,1))},Array_observe=Array.observe||function(e,t){var n=[];if(!(e instanceof Array))throw new Error("Array.observe cannot observe non-array");for(var r=e.length;r--;)n.unshift(e[r]);observedOldArys.push(e),observedArys.push({oldVer:n,newVer:e,handler:t})},Array_unobserve=Array.unobserve||function(e,t){var n=observedOldArys.indexOf(e);n>-1&&(observedArys.splice(n,1),observedOldArys.splice(n,1))};fallback&&function e(){RAF(function(){for(var t=observedObjects.length;t--;){var n=observedObjects[t],r=n.oldVer,i=n.newVer,s=n.handler,a=[];for(var o in r){if(void 0===i[o]){var h={};h.name=o,h.oldValue=r[o],h.object=i,h.type="delete",a.push(h)}if(i[o]!=r[o]){var h={};h.name=o,h.oldValue=r[o],h.object=i,h.type="update",a.push(h)}}for(var o in i)if(void 0===r[o]){var h={};h.name=o,h.oldValue=r[o],h.object=i,h.type="add",a.push(h)}a.length>0&&s(a),n.oldVer={};for(var o in i){var l=i[o];n.oldVer[o]=l}}for(var t=observedArys.length;t--;){var n=observedArys[t],r=n.oldVer,i=n.newVer,s=n.handler,a=[];if(r.length==i.length){for(var c=r.length;c--;)if(i[c]!=r[c]){var h={};h.name=c,h.oldValue=r[c],h.object=i,h.type="update",a.push(h)}}else{var h={};h.type="splice",h.index=-1,h.object=i;for(var p=[],v=r.length;v--;)p.push(i[v]);var u=[];for(var f in r)p[f]!=r[f]&&(-1==h.index&&(h.index=f),u.push(r[f]));for(var d=[],v=0;v<i.length;v++)d.push(r[v]);var _=[];for(var f in r)i[f]!=d[f]&&(-1==h.index&&(h.index=f),_.push(i[f]));a.push(h)}a.length>0&&s(a)}e()})}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,i){if(o.test(e)){var s=r(i,t);return c="var",s}return a.test(e)?(c="str",n(t,RegExp.$1)):(c="",e)}function n(e,t){for(var n=!1,r=t,i=1;i<e.length;i++){var s=e[i];if("\\"!=s){if(!n&&s==t)return r+t;r+=s,n=!1}else n=!0,r+=s}}function r(n,i,s,a){for(var c="",p=[],v=-1,u=-1,f=-1,d=a||e(),_=0;_<i.length;_++){var m=i[_];if(p.length>0)if(h.test(m)){var g=e(),y=r(n,i.substr(_),!0,g);_=_+y.length-1;var b=y;o.test(y[0])&&(d.subVars["."+y]=g,l.indexOf(b)<0&&(b=["."+b])),d.words.push(b)}else if("]"==m){if(p.pop(),0==p.length){var $=i.substring(v,_+1);c+=$,d.segments.push($),f=_}d.words.push("]"),u=_}else{var w=t(m,i.substr(_),n);_=_+w.length-1,d.words.push(w),u=_}else if(h.test(m)){if(c+=m,"."==m){var b=c.substr(f+1);b=b.replace(/\./,""),b&&(d.segments.push(b),f=_)}}else{if("["!=m){if("]"==m&&s){var b=c;return"]"!=b[b.length-1]&&(/[a-zA-Z0-9$_]+\[.+\]/.test(c)?(b=b.replace(/[a-zA-Z0-9$_]+\[.+\]/,""),d.words.push(b)):l.indexOf(b)<0&&d.words.push(["."+b]),b=b.substr(b.lastIndexOf(".")),d.segments.push(b),f=_),u=_,c}var b=c.substr(u+1);b&&("."!=b[0]&&l.indexOf(b)<0&&(b=["."+b]),d.words.push(b));var x=c.substr(f+1);return x&&(d.segments.push(x),f=_),!s&&l.indexOf(b)<0&&(n["."+c]=d),c}p.push("["),v=_,d.brakLength++;var C=c.substr(u+1);if(C){var b=C;l.indexOf(C)<0&&0>u&&(b=["."+C]),d.words.push(b)}if(d.words.push("["),"]"!=c[_-1]){var E=C.lastIndexOf(".");E>-1?(C=C.substr(E),d.segments.push(C)):d.segments.push(C),f=_}u=_}}var O=c.substr(c.lastIndexOf("]")+1);if(O){var x=c.substr(f+1);d.segments.push(x);var b="["==O[0]?O:"."==O[0]?O:"."+O;d.words.length<1&&l.indexOf(b)<0&&(b=[b]),d.words.push(b)}return s||(n["."+c]=d),c}function i(e){for(var t in e){var n=e[t],r=null,a=null,o=t.lastIndexOf(".");if("]"==t[t.length-1]){o=s(t,n.brakLength);var h=n.brakLength;n.watchPathWords=[];for(var l=0;l<n.words.length;l++){var c=n.words[l];if("["==c&&--h<1)break;n.watchPathWords.push(c)}}else n.watchPathWords=n.words.concat(),n.watchPathWords.splice(-1,1);r=t.substr(o),n.lastVar=r,Object.keys(n.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),n.watchPath=a);for(var l=n.segments.length;l--;)n.segments[l]=n.segments[l].replace(/^\.|\.$/g,"");i(n.subVars)}}function s(e,t){for(var n=0;n<e.length;n++){var r=e[n];if("["==r&&--t<1)return n}}var a=/(['"])/,o=/[a-zA-Z$_]/,h=/[a-zA-Z$_0-9.]/,l=["as","instanceof"],c="";return function(e){for(var n=[],r={},s=0;s<e.length;s++){var a=e[s];c="";var o=t(a,e.substr(s),r);switch(s=s+o.length-1,c){case"var":n.push(l.indexOf(o)<0?["."+o]:o);break;case"str":case"":n.push(o)}}return i(r),{words:n,varTree:r}}}(),Scanner=new function(){function e(e){var n=[],r=[];t(e,n);for(var i=n.length;i--;){var e=n[i],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,n){a.push(s.substring(o,n)),a.push(e),o=n+e.length}),a.push(s.substring(o,s.length));for(var h=document.createDocumentFragment(),l=0;l<a.length;l++){var c=a[l].replace(/\s/g,"");if(c){var p=document.createTextNode(a[l]);h.appendChild(p)}}r.unshift(h)}for(var l=n.length;l--;){var v=n[l];r[l].childNodes.length>1&&v.parentNode.replaceChild(r[l],v)}}function t(e,n){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.childNodes.length>0)for(var r=0,i=e.childNodes.length;i>r;r++)t(e.childNodes[r],n)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n.push(e)}}function n(e,t){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.tagName){var i=e.tagName.toLowerCase();if(ComponentFactory.hasTypeOf(i))return void t.createSubComponentOf(i,e);for(var s=e.attributes,a=s.length;a--;){var o=s[a].name.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(o)){if(DirectiveFactory.isFinal(o)){var h=DirectiveFactory.newInstanceOf(o,e,t,s[a].name,s[a].value);return void t.$__directives.push(h)}if(DirectiveFactory.hasEndTag(o))return[o,s[a].value]}}for(var a=s.length;a--;){var l=s[a],c=l.name,p=l.value;if(REG_CMD.test(c)){var o=c.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(o)){var h=DirectiveFactory.newInstanceOf(o,e,t,s[a].name,p);t.$__directives.push(h)}}else REG_EXP.test(p)&&r(p,e,t,c)}}if(e.childNodes.length>0){for(var v=null,u=[],a=0,f=e.childNodes.length;f>a;a++)if(v){u.push(e.childNodes[a]);var d=DirectiveFactory.hasEndTag(v[0]),_=e.childNodes[a].getAttribute&&e.childNodes[a].getAttribute(CMD_PREFIX+d);if(Util.isString(_)){var h=DirectiveFactory.newInstanceOf(v[0],u,t,CMD_PREFIX+v[0],v[1]);t.$__directives.push(h),v=null}}else v=n(e.childNodes[a],t),v&&u.push(e.childNodes[a]);v&&impex.console.error("can not find endTag of directive["+CMD_PREFIX+v[0]+"]")}}else if(3==e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,e,t)}}function r(e,t,n,r){var s={},a={};if(e.replace(REG_EXP,function(e,t){var r=1;CONVERTER_EXP.test(t)&&(r=i(t,a,n));var o=t;r>1&&(o=t.substr(r));var h=lexer(o);s[t]={words:h.words,varTree:h.varTree}}),!(Object.keys(s).length<1)){var o=new ExpNode(t,r,e,s,n,a);n.$__expNodes.push(o)}}function i(e,t,n){for(var r,i,s=!0,a="",o="",h=[],l=e.indexOf(EXP_CONVERTER_SYM)+1;l<e.length;l++){var c=e[l];switch(c){case" ":case"	":i=!0;continue;case":":r=!0,s=!1,i=!1,o&&(h.push(o),o="");continue;case"|":r=!1,s=!0,i=!1,a&&ConverterFactory.hasTypeOf(a)&&(t[a]=[ConverterFactory.newInstanceOf(a,n),h]),o&&h.push(o),a="",o="",h=[];continue;default:if(i)return a&&(t[a]=[ConverterFactory.newInstanceOf(a,n),h]),o&&h.push(o),l}s?a+=c:r&&(o+=c)}return l}this.scan=function(t,r){for(var i=t.elements?t.elements:[t.element],s=null,a=[],o=0,h=i.length;h>o;o++)if(e(i[o]),s){a.push(i[o]);var l=DirectiveFactory.hasEndTag(s[0]),c=i[o].getAttribute&&i[o].getAttribute(CMD_PREFIX+l);if(Util.isString(c)){var p=DirectiveFactory.newInstanceOf(s[0],a,r,CMD_PREFIX+s[0],s[1]);r.$__directives.push(p),s=null}}else s=n(i[o],r),s&&a.push(i[o]);s&&impex.console.error("can not find endTag of directive["+CMD_PREFIX+s[0]+"]")}},Builder=new function(){function e(e){for(var n=e.$__expNodes.length;n--;){var r=e.$__expNodes[n];for(var i in r.expMap){var s=r.expMap[i],a=s.varTree;for(var o in a){var h=a[o];t(e,h,o,r)}}}for(var n=e.$__components.length;n--;){var l=e.$__components[n];e.$__directives.indexOf(l)>-1||(l.init(),l.display())}for(var n=e.$__directives.length;n--;){var c=e.$__directives[n];c.init()}}function t(e,r,i,s){for(var a in r.subVars){var o=r.subVars[a];t(e,o,a,s)}for(var h=n(e.$__expPropRoot.subProps,r.segments[0],s),l=1;l<r.segments.length;l++){{l==r.segments.length?!0:!1}h=n(h.subProps,r.segments[l],s)}}function n(e,t,n){var r=e[t];return r||(r=e[t]=new ExpProp(t)),n instanceof ExpNode?r.expNodes.indexOf(n)<0&&r.expNodes.push(n):n instanceof AttrObserveNode?r.attrObserveNodes.indexOf(n)<0&&r.attrObserveNodes.push(n):n instanceof Watch&&r.watchs.indexOf(n)<0&&r.watchs.push(n),e[t]}function r(e,t,n,s){if(!(s>DEPTH)){var a=!1;if(Util.isArray(e))e.$__observer=function(e){n.$__state!=Component.state.suspend&&n.$__state!=Component.state.destroyed&&i(e,t,n,s)},e.$__oldVal=e.concat(),Array_observe(e,e.$__observer),a=!0;else if(Util.isObject(e)){if(Util.isDOM(e))return;if(Util.isWindow(e))return;e.$__observer=function(e){n.$__state!=Component.state.suspend&&n.$__state!=Component.state.destroyed&&i(e,t,n,s)},Object_observe(e,e.$__observer),a=!0}if(a)for(var o=Object.keys(e),h=o.length;h--;){var l=o[h];if(0!==l.indexOf("$")){var c=t.concat();c.push(l),r(e[l],c,n,s+1)}}}}function i(e,t,n,i){if(!Util.isString(e))for(var s=e.length;s--;){var a=e[s],h=a.name;if(!h||0!==h.indexOf("$")){var l=a.object[h],c=t.concat();h&&!Util.isArray(a.object)&&c.push(h);var p=a.oldValue;if(Util.isArray(a.object)&&(l=a.object,p=a.object.$__oldVal),o(n,c,a.type,l,p),!Util.isArray(a.object)&&Util.isArray(a.oldValue))Array_unobserve(a.oldValue,a.oldValue.$__observer);else{if(Util.isArray(a.object))return void(a.object.$__oldVal=a.object.concat());Util.isObject(a.oldValue)&&(Object_unobserve(a.oldValue,a.oldValue.$__observer),a.oldValue.$__observer=null)}r(l,c,n,i)}}}function s(e,t,n,r,i){for(var s,o=e.$__expPropRoot.subProps,h=0;h<t.length;h++){var l=t[h];{if(!o[l])break;s=o[l],o=o[l].subProps}}if(s){var c=t.length-h,p=[];c>0?a(s,c,p):p.push(s);for(var v=[],h=p.length;h--;){for(var u=p[h].expNodes.length;u--;){var f=p[h].expNodes[u];Renderer.renderExpNode(f)}for(var u=p[h].attrObserveNodes.length;u--;){var d=p[h].attrObserveNodes[u],_=Renderer.evalExp(d.directive,d.expObj);d.directive.observe(_)}for(var u=p[h].watchs.length;u--;){var m=p[h].watchs[u];if(!(m.segments.length<t.length||v.indexOf(m)>-1)){for(var g=!0,y=0;y<m.segments.length&&t[y];y++)if("["!=m.segments[y][0]&&"["!=t[y][0]&&m.segments[y]!=t[y]){g=!1;break}if(g){var b=r,$=i;if(m.segments.length>t.length){for(var w=m.segments.slice(y),x="$var",y=0;y<w.length;y++){var C=w[y];x+="["==C[0]?C:"."+C}try{b=new Function("$var","return "+x)(r)}catch(E){b=null}}m.cbk&&m.cbk.call(m.ctrlScope,n,b,$),v.push(m)}}}}}}function a(e,t,n){if(1>t)return void n.push(e);for(var r in e.subProps)a(e.subProps[r],t-1,n)}function o(e,t,n,r,i){s(e,t,n,r,i);for(var a=e.$__components.length;a--;){var h=e.$__components[a];o(h,t,n,r,i)}}this.buildExpModel=t,this.build=function(t){e(t);var n=0;r(t,[],t,n+1)}},Renderer=new function(){function renderExpNode(e){var t=calcExp(e.component,e.origin,e.expMap),n=e.converters;if(Object.keys(n).length>0)for(var r in n){var i=n[r][0],s=n[r][1];if(i.$value=t,t=i.to.apply(i,s),i.$html){var a=renderHTML(i,t,e.node,e.component);if(a)return}}null!=t&&updateDOM(e.node,e.attrName,t)}function updateDOM(e,t,n){if(e.setAttribute){e.setAttribute(t,n);var r=propMap[t];r&&r.indexOf(e.tagName)>-1&&(e[t]=n)}else try{e.nodeValue=n}catch(i){}}function calcExp(e,t,n){var r={};for(var i in n){var s=n[i],a=evalExp(e,s);r[i]=void 0==a?"":a}for(var o in r)t=t.replace(EXP_START_TAG+o+EXP_END_TAG,r[o]);return t}function evalExp(e,t){var n=getExpEvalStr(e,t),r="";try{r=new Function("return "+n)()}catch(i){impex.console.debug(i.message+" "+n)}return r}function getExpEvalStr(e,t){var n=t.varTree,r={};for(var i in n){var s=n[i],a=buildVarPath(e,s,i);r[i]=a}var o=joinExpStr(t.words,r);return o}function joinExpStr(e,t){for(var n="",r=0;r<e.length;r++){var i=e[r];n+=i instanceof Array?t[i[0]]:i}return n}function keyWordsMapping(e,t){return"this"==e?t.__getPath():void 0}function buildVarPath(e,t,n){var r={};for(var i in t.subVars){var s=t.subVars[i],a=buildVarPath(e,s,i);r[i]=a}for(var o=!1,h="",l=0;l<t.words.length;l++){var c=t.words[l];if(c instanceof Array){var p=keyWordsMapping(t.segments[0],e);if(p){o=!0;var v=new RegExp("^\\."+t.segments[0]);h+=c[0].replace(v,p)}else h+=r[c[0]]||c[0]}else h+=c}var u="";if(t.watchPath)u=t.watchPath;else for(var l=0;l<t.watchPathWords.length;l++){var c=t.watchPathWords[l];u+=c instanceof Array?r[c[0]]||c[0]:c}return e=u?varInCtrlScope(e,u):varInCtrlScope(e,h),o?h:(e?e.__getPath():"self")+h}function varInCtrlScope(e,t){for(var n=e;n;){if(void 0!=getVarByPath(t,n.__getPath()))return n;n=n.$parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=null;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,n,r){if(e.__lastVal!=t&&Util.isDOMStr(t)){if(!e.__lastVal){var i=ViewManager.createPlaceholder("-- converter [html] placeholder --");ViewManager.insertBefore(i,n),e.__lastVal=t,e.__placeholder=i}if(3==n.nodeType){e.__lastComp&&(e.__lastComp.destroy(),n=ViewManager.createPlaceholder(""),ViewManager.insertAfter(n,e.__placeholder));var s=r.createSubComponent(t,n);return s.init(),s.display(),e.__lastComp=s,e.__lastVal=t,!0}}}this.render=function(e){for(var t=e.$__expNodes.length;t--;)renderExpNode(e.$__expNodes[t]);for(var n=e.$__components.length;n--;)Renderer.render(e.$__components[n])},this.renderExpNode=renderExpNode;var propMap={value:["INPUT"]};this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};ViewModel.prototype={data:function(path,val){var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);return arguments.length>1?(eval(evalStr+'= "'+val.replace(/\r\n|\n/gm,"\\n")+'"'),this):eval(evalStr)}},Component.state={created:"created",inited:"inited",displayed:"displayed",destroyed:"destroyed",suspend:"suspend"},Util.inherits(Component,ViewModel),Util.ext(Component.prototype,{on:function(e,t,n){this.$view.__on(this,e,t,n)},off:function(e,t){this.$view.__off(this,e,t)},find:function(e,t){e=e.toLowerCase();for(var n=this.$__components.length;n--;){var r=this.$__components[n];if("*"==e||r.$name==e){var i=!0;if(t)for(var s in t)if(r[s]!=t[s]){i=!1;break}if(i)return r}}return null},findD:function(e,t){e=e.toLowerCase();for(var n=this.$__directives.length;n--;){var r=this.$__directives[n];if("*"==e||r.$name==e){var i=!0;if(t)for(var s in t)if(r[s]!=t[s]){i=!1;break}if(i)return r}}return null},watch:function(e,t){var n=lexer(e),r=Object.keys(n.varTree);if(!(r.length<1)){if(r.length>1)return void impex.console.warn("变量表达式"+e+"错误，只能同时watch一个变量");var i=n.varTree[r[0]],s=new Watch(t,this,i.segments);return Builder.buildExpModel(this,i,r[0],s),this}},add:function(e){this.$__components.push(e),e.$parent=this},createSubComponentOf:function(e,t){var n=ComponentFactory.newInstanceOf(e,t.element?t.element:t);return this.$__components.push(n),n.$parent=this,n},createSubComponent:function(e,t){var n=ComponentFactory.newInstance(e,t.element?t.element:t);return this.$__components.push(n),n.$parent=this,n},init:function(){if(this.$__state==Component.state.created){if(this.$templateURL){var e=this;Util.loadTemplate(this.$templateURL,function(t){var n=e.$view.__init(t,e);n!==!1&&(e.__init(t),e.display())})}else{if(this.$template){var t=this.$view.__init(this.$template,this);if(t===!1)return}this.__init(this.$template)}return this}},__init:function(e){Scanner.scan(this.$view,this);var t=null;return this.onInit&&(t=this.onInit(e)),t===!1?void this.destroy():void(this.$__state=Component.state.inited)},display:function(){(this.$__state==Component.state.inited||this.$__state==Component.state.suspend)&&(this.$view.__display(),Renderer.render(this),this.$__suspendParent&&(this.$parent=this.$__suspendParent,this.$__suspendParent=null),this.$__state=Component.state.displayed,Builder.build(this),this.onDisplay&&this.onDisplay())},destroy:function(){if(this.$__state!=Component.state.destroyed){if(this.$parent){var e=this.$parent.$__components.indexOf(this);e>-1&&this.$parent.$__components.splice(e,1),this.$parent=null}for(this.$view.__destroy(this);this.$__components.length>0;)this.$__components[0].destroy();this.$view=this.$__components=this.$__directives=this.$__expNodes=this.$__expPropRoot=null,this.onDestroy&&this.onDestroy(),this.$__state=Component.state.destroyed}},suspend:function(e){if(this.$__state==Component.state.displayed){if(this.$parent){var t=this.$parent.$__components.indexOf(this);t>-1&&this.$parent.$__components.splice(t,1),this.$__suspendParent=this.$parent,this.$parent=null}this.$view.__suspend(this,0==e?!1:!0),this.$__state=Component.state.suspend}},__getPath:function(){return'impex.__components["'+this.$__id+'"]'}}),View.prototype={__init:function(e,t){var n=this.__target.attributes,r=this.__target.innerHTML,i=tmplExpFilter(e,r,n),s=DOMViewProvider.compile(i);if(!s||s.length<1)return impex.console.warn('invalid template "'+e+'" of component['+t.$name+"]"),!1;if(this.name=s[0].nodeName.toLowerCase(),this.element=s[0],s.length>1&&(this.elements=s),n)for(var a=n.length;a--;){var o=n[a].name,h=n[a].value;t[o]=h}},__display:function(){if(this.__target&&(!this.element.parentNode||1!==this.element.parentNode.nodeType)){var e=null;if(this.elements&&this.elements.length>1){e=document.createDocumentFragment();for(var t=0;t<this.elements.length;t++)e.appendChild(this.elements[t])}else e=this.element;this.__target.parentNode.replaceChild(e,this.__target),e=null,this.__target=null}},__destroy:function(e){for(var t in this.__evMap)for(var n=this.__evMap[t],r=n.length;r--;){var i=n[r],s=i[1];Util.off(t,this.element,s)}if(this.elements){var a=this.elements[0].parentNode;if(a)for(var r=this.elements.length;r--;)this.elements[r].__impex__view&&(this.elements[r].__impex__view=null),a.removeChild(this.elements[r])}else this.element.__impex__view&&(this.element.__impex__view=null),this.element.parentNode.removeChild(this.element);this.__target&&(this.__target.parentNode.removeChild(this.__target),this.__target=null)},__suspend:function(e,t){if(t&&(this.__target=document.createComment("-- view suspended of ["+(e.$name||"anonymous")+"] --"),this.element.parentNode.insertBefore(this.__target,this.element)),this.elements){var n=this.elements[0].parentNode;if(n)for(var r=this.elements.length;r--;)n.removeChild(this.elements[r])}else this.element.parentNode.removeChild(this.element)},__on:function(e,t,n,r){var i=n,s=e,a=null,o="",h=null;Util.on(t,this.element,a=function(e){var t=i;if(r instanceof Function&&(t=r.call(s,e,i)),t){if(o!=t){var n=lexer(t),a=Renderer.getExpEvalStr(s,n),l=a.replace("self.$event","$event");h=new Function("$event",l),o=t}h(e)}}),this.__evMap[t]||(this.__evMap[t]=[]),this.__evMap[t].push([n,a])},__off:function(e,t,n){for(var r=this.__evMap[t],i=r.length;i--;){var s=r[i],a=s[0],o=s[1];a==n&&Util.off(t,this.element,o)}},clone:function(){var e=null;if(this.elements){e=[];for(var t=this.elements.length;t--;){var n=this.elements[t].cloneNode(!0);e.unshift(n)}}else e=this.element.cloneNode(!0);var r=new View(e,this.name);return r},show:function(){return this.element.style.display="",this},hide:function(){return this.element.style.display="none",this},style:function(e,t){return arguments.length>1?(this.element.style[e]=t,this):this.element.style[e]},attr:function(e,t){return arguments.length>1?(this.element.setAttribute(e,t),this):this.element.getAttribute(e)},removeAttr:function(e){return this.element.removeAttribute(e),this}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,n){if(e.innerHTML=t,!e.childNodes[0])return null;for(var r=[];e.childNodes.length>0;){var i=e.removeChild(e.childNodes[0]);r.push(i)}var s=new View(r,null,n);return s};var t=["meta","title","base"];this.compile=function(n){if(e.innerHTML=n,!e.children[0])return null;for(var r=[];e.children.length>0;){var i=e.removeChild(e.children[0]),s=i.nodeName.toLowerCase();t.indexOf(s)>-1||r.push(i)}return r}},ViewManager=new function(){this.$singleton=!0,this.replace=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e,i=n.parentNode;i&&i.replaceChild(r,n)},this.insertBefore=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e;n.parentNode.insertBefore(r,n)},this.insertAfter=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e,i=n.parentNode,s=i.lastChild;s==n?i.appendChild(r):i.insertBefore(r,n.nextSibling)},this.createPlaceholder=function(e){return new View(document.createComment(e))}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){var e={},t=this;this.$value.replace(REG_EXP,function(n,r){var i=lexer(r),s=Renderer.evalExp(t.$parent,i);e[r]={val:s}});var n=this.$value;for(var r in e)n=n.replace(EXP_START_TAG+r+EXP_END_TAG,e[r].val);if(this.$view.attr(this.$name,n),this.$value=n,this.observe){var i=lexer(n);for(var s in i.varTree){var a=i.varTree[s],o=new AttrObserveNode(this,i);Builder.buildExpModel(this.$parent,a,s,o)}var h=Renderer.evalExp(this.$parent,i);this.observe(h)}this.onInit&&this.onInit()}}),Converter.prototype={to:function(){return null}},Factory.prototype={register:function(e,t,n){e=e.toLowerCase();var r=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),i={};Util.extProp(i,t),Util.inherits(r,this.baseClass),Util.extMethod(r.prototype,t),this.types[e]={clazz:r,props:i,services:n}},hasTypeOf:function(e){return e in this.types}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{newInstance:function(e){var t=null;if(2==arguments.length){var n=arguments[0],r=arguments[1];t=n,Util.isString(n)?t=this.viewProvider.newInstance(n,r):t.__target=r}else t=e,Util.isDOM(e)&&(t=new View(e,e.tagName.toLowerCase()));var i=new this.baseClass(t);this.instances.push(i);var s=arguments[2],a=arguments[3];if(s&&Util.ext(i,s),Util.isArray(a)){for(var o=[],h=0;h<a.length;h++){var l=ServiceFactory.newInstanceOf(a[h]);o.push(l)}i.onCreate&&i.onCreate.apply(i,o)}else i.onCreate&&i.onCreate();return i},newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass);Util.extProp(n,this.types[e].props),n.$view=new View(null,null,t),n.$name=e,this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props.$final},hasEndTag:function(e){return this.types[e].props.$endTag},newInstanceOf:function(e,t,n,r,i){if(!this.types[e])return null;var s=new this.types[e].clazz(this.baseClass,r,i,n);Util.extProp(s,this.types[e].props),t.__impex__view?s.$view=t.__impex__view:(s.$view=new View(t),t.__impex__view=s.$view);var a=null;if(this.types[e].services){a=[];for(var o=0;o<this.types[e].services.length;o++){var h=ServiceFactory.newInstanceOf(this.types[e].services[o]);a.push(h)}}return n.add(s),s.onCreate&&(a?s.onCreate.apply(s,a):s.onCreate()),this.instances.push(s),s}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_ConverterFactory,Factory),Util.ext(_ConverterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass,t);Util.extProp(n,this.types[e].props),this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ConverterFactory=new _ConverterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e){if(e=e.toLowerCase(),!this.types[e])return null;var t=null;this.types[e].props.$singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),t=this.types[e].singleton):(t=new this.types[e].clazz(this.baseClass),this.instances.push(t),Util.extProp(t,this.types[e].props));var n=null;if(this.types[e].services){n=[];for(var r=0;r<this.types[e].services.length;r++){var i=ServiceFactory.newInstanceOf(this.types[e].services[r]);n.push(i)}}return t.onCreate&&t.onCreate.apply(t,n),t}});var ServiceFactory=new _ServiceFactory,CMD_PREFIX="x-",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,CONVERTER_EXP=/^\s*#/,EXP_CONVERTER_SYM="#",DEPTH=9,DEBUG=!1,impex=new function(){function e(e){var n=e;do{if(t.indexOf(n)>-1)return!0;n=n.parentNode}while(n);return!1}this.version={v:[0,3,1],state:"beta",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://mrsoya.github.io/impex",this.option=function(e){EXP_START_TAG=e.expStartTag||"{{",EXP_END_TAG=e.expEndTag||"}}",DEPTH=parseInt(e.recurDepth)||9,REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),DEBUG=e.debug},this.component=function(e,t,n){return ComponentFactory.register(e,t,n),this},this.directive=function(e,t,n){return DirectiveFactory.register(e,t,n),this},this.service=function(e,t,n){return ServiceFactory.register(e,t,n),this},this.converter=function(e,t,n){return ConverterFactory.register(e,t,n),this},this.render=function(n,r,i){var s=n.tagName.toLowerCase();if(e(n))return void impex.console.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,n);return a||(t.push(n),a=ComponentFactory.newInstance(n,null,r,i)),a.init(),a.display(),a};var t=[];this.__components={},this.findAll=function(e,t){e=e.toLowerCase();for(var n=[],r=Object.keys(this.__components),i=r.length;i--;){var s=this.__components[r[i]];if("*"==e||s.$name==e){var a=!0;if(t)for(var o in t)if(s[o]!=t[o]){a=!1;break}a&&n.push(s)}}return n}};impex.console=new function(){this.warn=function(e){console.warn("impex warn :: "+e)},this.error=function(e){console.error("impex error :: "+e)},this.debug=function(e){DEBUG&&console.debug("impex debug :: "+e)}},self.console=self.console||new function(){this.log=function(){},this.info=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},impex.service("ViewManager",ViewManager),impex.service("ComponentManager",new function(){this.hasTypeOf=function(e){return ComponentFactory.hasTypeOf(e)},this.findAll=function(e){for(var t=ComponentFactory.instances,n=[],r=t.length;r--;){var i=!0;for(var s in e)if(comp[s]!=e[s]){i=!1;break}i&&n.push(comp)}return n}}),!function(e){function t(e,n,r){for(var i=e.$__expNodes.length;i--;){var s=e.$__expNodes[i];s.node==n&&"class"==s.attrName&&(s.origin=r)}for(var a=e.$__components.length;a--;)t(e.$__components[a],n,r)}function n(){this.onCreate=function(e){this.$eachExp=/(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*=>\s*[a-zA-Z0-9_$]+?)|(?:[a-zA-Z0-9_$]+?))$/,this.$viewManager=e,this.$expInfo=this.parseExp(this.$value),this.$parentComp=this.$parent,this.$__view=this.$view,this.$cache=[],this.$subComponents=[],this.$cacheSize=20},this.onInit=function(){this.$ds=this.$parent.data(this.$expInfo.ds),this.$placeholder=this.$viewManager.createPlaceholder("-- directive [each] placeholder --"),this.$viewManager.insertBefore(this.$placeholder,this.$view),this.build(this.$ds,this.$expInfo.k,this.$expInfo.v),this.destroy();var e=this;this.$parentComp.watch(this.$expInfo.ds,function(t,n,r){var i=0;for(var s in n)n.hasOwnProperty(s)&&0!=s.indexOf("$")&&i++;var a=0;for(var s in r)r.hasOwnProperty(s)&&0!=s.indexOf("$")&&a++;e.rebuild(n,i-a,e.$expInfo.k,e.$expInfo.v)})},this.rebuild=function(e,t,n,r){if(0>t){var i=this.$subComponents.splice(0,-1*t);if(this.$cache.length<this.$cacheSize){for(var s=i.length;s--;)this.$cache.push(i[s]);for(var s=this.$cache.length;s--;)this.$cache[s].suspend(!1)}else for(var s=i.length;s--;)i[s].destroy();

}else if(t>0){for(var i=this.$cache.splice(0,t),s=0;s<i.length;s++)this.$subComponents.push(i[s]),this.$viewManager.insertBefore(i[s].$view,this.$placeholder);for(var a=t-i.length;a--;)var o=this.createSubComp()}var h=Util.isArray(e)?!0:!1,l=0;for(var c in e)if(e.hasOwnProperty(c)&&(!h||!isNaN(c))){var o=this.$subComponents[l];o[r]=e[c],o.$index=l++,n&&(o[n]=h?c>>0:c),o.init(),o.display()}},this.createSubComp=function(){var e=this.$parentComp,t=this.$viewManager.createPlaceholder("");this.$viewManager.insertBefore(t,this.$placeholder);var n=this.$__view.clone().removeAttr(this.$name),r=e.createSubComponent(n,t);return this.$subComponents.push(r),r},this.build=function(e,t,n){var r=Util.isArray(e)?!0:!1,i=0;for(var s in e)if(e.hasOwnProperty(s)&&(!r||!isNaN(s))){var a=this.createSubComp();a[n]=e[s],a.$index=i++,t&&(a[t]=r?s>>0:s)}for(var o=this.$subComponents.length;o--;)this.$subComponents[o].init(),this.$subComponents[o].display()},this.parseExp=function(t){var n,r,i;return t.replace(this.$eachExp,function(e,t,s){n=t;var a=s.replace(/\s/gm,""),o=a.split("=>");o.length>1?(r=o[0],i=o[1]):i=o[0]}),n?{ds:n,k:r,v:i}:void e.console.error("invalid each expression : "+t)}}e.directive("show",{observe:function(e){e?this.$view.show():this.$view.hide()}}),e.directive("if",new function(){this.placeholder=null,this.viewManager,this.onCreate=function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --")},this.observe=function(e){e?this.viewManager.replace(this.$view,this.placeholder):this.viewManager.replace(this.placeholder,this.$view)}},["ViewManager"]),e.directive("cloak",{onCreate:function(){var n=this.$view.attr("class");return n?(n=n.replace("x-cloak",""),this.$view.attr("class",n),void t(this.$parent,this.$view.element,n)):void e.console.warn("can not find attribute[class] of element["+this.$view.name+"] which directive[cloak] on")}});var r=new n;r.$final=!0,e.directive("each",r,["ViewManager"]);var i=new n;i.$endTag="each-end",e.directive("each-start",i,["ViewManager"])}(impex),impex.converter("html",{$html:!0,to:function(){return this.$value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);