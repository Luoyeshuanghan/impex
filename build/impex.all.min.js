!function(global){"use strict";function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,n,r,i,s){this.node=e,this.attrName=t,this.origin=n,this.expMap=r,this.component=i,this.converters=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,n){this.cbk=e,this.ctrlScope=t,this.segments=n}function ViewModel(){}function Component(e){var t="C_"+Object.keys(impex.__components).length;impex.__components[t]=this,this.__id=t,this.__state=Component.state.created,this.$view=e,this.$name,this.$parent,this.$__components=[],this.$__directives=[],this.$__expNodes=[],this.$__expPropRoot=new ExpProp,this.$template,this.$templateURL,this.onCreate,this.onInit,this.onDisplay,this.onDestroy}function View(e,t,n){this.element=e,this.name=t,this.__evMap={},this.__target=n}function tmplExpFilter(e,t,n){return e=e.replace(REG_TMPL_EXP,function(e,r){var r=r.replace(/\s/gm,"");if("tagBody"==r)return t;var i=n[r]&&n[r].nodeValue;return i})}function Directive(e,t){Component.call(this),this.$value=t,this.$name=e,this.$final=!1,this.observe}function Converter(e){this.$component=e,this.$value,this.$html=!1,this.onCreate}function Service(){this.$singleton,this.onCreate}function Factory(e){this.types={},this.instances=[],this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _ConverterFactory(){Factory.call(this,Converter)}function _ServiceFactory(){Factory.call(this,Service)}function updateCloakAttr(e,t,n){for(var r=e.$__expNodes.length;r--;){var i=e.$__expNodes[r];i.node==t&&"class"==i.attrName&&(i.origin=n)}for(var s=e.$__components.length;s--;)updateCloakAttr(e.$__components[s],t,n)}var Util=new function(){function e(){impex.console.error("无法获取远程数据 : "+this.url)}function t(){impex.console.error("请求超时 : "+this.url)}function n(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&this.cbk&&this.cbk(this.responseText)}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},this.ext=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];e[i]=t[i]}},this.extProp=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function||t[i]&&(e[i]=t[i])}},this.extMethod=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function&&(e[i]=t[i])}},this.isObject=function(e){return"object"==typeof e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isFunction=function(e){return e instanceof Function},this.isWindow=function(e){return"Array"in e&&"XMLHttpRequest"in e&&"XMLDocument"in e&&"JSON"in e};var r=document.createElement("div");this.isDOMStr=function(e){return r.innerHTML=e,r.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName},this.on=function(e,t,n){t.addEventListener?t.addEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.attachEvent(e,n))},this.off=function(e,t,n){t.removeEventListener?t.removeEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.detachEvent(e,n))},this.loadTemplate=function(r,i,s){var a=new XMLHttpRequest;a.open("get",r,!0),a.timeout=s||5e3,a.ontimeout=t,a.onerror=e,null===a.onload?a.onload=n:a.onreadystatechange=n,a.cbk=i,a.url=r,a.send(null)}},RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),fallback=Object.observe?!1:!0,observedObjects=[],observedArys=[],observedOldArys=[],Object_observe=Object.observe||function(e,t){var n={};for(var r in e){var i=e[r];n[r]=i}observedObjects.push({oldVer:n,newVer:e,handler:t})},Array_observe=Array.observe||function(e,t){var n=[];if(!(e instanceof Array))throw new Error("Array.observe cannot observe non-array");for(var r=e.length;r--;)n.unshift(e[r]);observedOldArys.push(e),observedArys.push({oldVer:n,newVer:e,handler:t})},Array_unobserve=Array.unobserve||function(e){var t=observedOldArys.indexOf(e);t>-1&&(observedArys.splice(t,1),observedOldArys.splice(t,1))};fallback&&function e(){RAF(function(){for(var t=observedObjects.length;t--;){var n=observedObjects[t],r=n.oldVer,i=n.newVer,s=n.handler,a=[];for(var o in r){if(void 0===i[o]){var h={};h.name=o,h.oldValue=r[o],h.object=i,h.type="delete",a.push(h)}if(i[o]!=r[o]){var h={};h.name=o,h.oldValue=r[o],h.object=i,h.type="update",a.push(h)}}for(var o in i)if(void 0===r[o]){var h={};h.name=o,h.oldValue=r[o],h.object=i,h.type="add",a.push(h)}a.length>0&&s(a),n.oldVer={};for(var o in i){var c=i[o];n.oldVer[o]=c}}for(var t=observedArys.length;t--;){var n=observedArys[t],r=n.oldVer,i=n.newVer,s=n.handler,a=[];if(r.length==i.length){for(var l in r)if(i[l]!=r[l]){var h={};h.name=l,h.oldValue=r[l],h.object=i,h.type="update",a.push(h)}}else{var h={};h.type="splice",h.index=-1,h.object=i;for(var p=[],t=r.length;t--;)p.push(i[t]);var u=[];for(var l in r)p[l]!=r[l]&&(-1==h.index&&(h.index=l),u.push(r[l]));for(var v=[],f=0;f<i.length;f++)v.push(r[f]);var d=[];for(var l in r)i[l]!=v[l]&&(-1==h.index&&(h.index=l),d.push(i[l]));a.push(h)}a.length>0&&s(a)}e()})}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,i){if(o.test(e)){var s=r(i,t);return l="var",s}return a.test(e)?(l="str",n(t,RegExp.$1)):(l="",e)}function n(e,t){for(var n=!1,r=t,i=1;i<e.length;i++){var s=e[i];if("\\"!=s){if(!n&&s==t)return r+t;r+=s,n=!1}else n=!0,r+=s}}function r(n,i,s,a){for(var l="",p=[],u=-1,v=-1,f=-1,d=a||e(),m=0;m<i.length;m++){var _=i[m];if(p.length>0)if(h.test(_)){var g=e(),y=r(n,i.substr(m),!0,g);m=m+y.length-1;var w=y;o.test(y[0])&&(d.subVars["."+y]=g,c.indexOf(w)<0&&(w=["."+w])),d.words.push(w)}else if("]"==_){if(p.pop(),0==p.length){var b=i.substring(u,m+1);l+=b,d.segments.push(b),f=m}d.words.push("]"),v=m}else{var x=t(_,i.substr(m),n);m=m+x.length-1,d.words.push(x),v=m}else if(h.test(_)){if(l+=_,"."==_){var w=l.substr(f+1);w=w.replace(/\./,""),w&&(d.segments.push(w),f=m)}}else{if("["!=_){if("]"==_&&s){var w=l;return"]"!=w[w.length-1]&&(/[a-zA-Z0-9$_]+\[.+\]/.test(l)?(w=w.replace(/[a-zA-Z0-9$_]+\[.+\]/,""),d.words.push(w)):c.indexOf(w)<0&&d.words.push(["."+w]),w=w.substr(w.lastIndexOf(".")),d.segments.push(w),f=m),v=m,l}var w=l.substr(v+1);w&&("."!=w[0]&&c.indexOf(w)<0&&(w=["."+w]),d.words.push(w));var E=l.substr(f+1);return E&&(d.segments.push(E),f=m),!s&&c.indexOf(w)<0&&(n["."+l]=d),l}p.push("["),u=m,d.brakLength++;var C=l.substr(v+1);if(C){var w=C;c.indexOf(C)<0&&0>v&&(w=["."+C]),d.words.push(w)}if(d.words.push("["),"]"!=l[m-1]){var $=C.lastIndexOf(".");$>-1?(C=C.substr($),d.segments.push(C)):d.segments.push(C),f=m}v=m}}var O=l.substr(l.lastIndexOf("]")+1);if(O){var E=l.substr(f+1);d.segments.push(E);var w="["==O[0]?O:"."==O[0]?O:"."+O;d.words.length<1&&c.indexOf(w)<0&&(w=[w]),d.words.push(w)}return s||(n["."+l]=d),l}function i(e){for(var t in e){var n=e[t],r=null,a=null,o=t.lastIndexOf(".");if("]"==t[t.length-1]){o=s(t,n.brakLength);var h=n.brakLength;n.watchPathWords=[];for(var c=0;c<n.words.length;c++){var l=n.words[c];if("["==l&&--h<1)break;n.watchPathWords.push(l)}}else n.watchPathWords=n.words.concat(),n.watchPathWords.splice(-1,1);r=t.substr(o),n.lastVar=r,Object.keys(n.subVars).length<1&&(a=t.substring(0,o).replace(/\.$/,""),n.watchPath=a);for(var c=n.segments.length;c--;)n.segments[c]=n.segments[c].replace(/^\.|\.$/g,"");i(n.subVars)}}function s(e,t){for(var n=0;n<e.length;n++){var r=e[n];if("["==r&&--t<1)return n}}var a=/(['"])/,o=/[a-zA-Z$_]/,h=/[a-zA-Z$_0-9.]/,c=["as","instanceof"],l="";return function(e){for(var n=[],r={},s=0;s<e.length;s++){var a=e[s];l="";var o=t(a,e.substr(s),r);switch(s=s+o.length-1,l){case"var":n.push(c.indexOf(o)<0?["."+o]:o);break;case"str":case"":n.push(o)}}return i(r),{words:n,varTree:r}}}(),Scanner=new function(){function e(e){var n=[],r=[];t(e,n);for(var i=n.length;i--;){var e=n[i],s=e.nodeValue,a=[],o=0;s.replace(REG_EXP,function(e,t,n){a.push(s.substring(o,n)),a.push(e),o=n+e.length}),a.push(s.substring(o,s.length));for(var h=document.createDocumentFragment(),c=0;c<a.length;c++){var l=document.createTextNode(a[c]);h.appendChild(l)}r.unshift(h)}for(var c=n.length;c--;){var p=n[c];r[c].childNodes.length>1&&p.parentNode.replaceChild(r[c],p)}}function t(e,n){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.childNodes.length>0)for(var r=0,i=e.childNodes.length;i>r;r++)t(e.childNodes[r],n)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n.push(e)}}function n(e,t){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.tagName){var i=e.tagName.toLowerCase();if(ComponentFactory.hasTypeOf(i))return void t.createSubComponentOf(i,e);for(var s=e.attributes,a=s.length;a--;){var o=s[a].name.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(o)&&DirectiveFactory.isFinal(o)){var h=DirectiveFactory.newInstanceOf(o,e,t,s[a].name,s[a].value);return void t.$__directives.push(h)}}for(var a=s.length;a--;){var c=s[a],l=c.name,p=c.value;if(REG_CMD.test(l)){var o=l.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(o)){var h=DirectiveFactory.newInstanceOf(o,e,t,s[a].name,p);t.$__directives.push(h)}}else REG_EXP.test(p)&&r(p,e,t,l)}}if(e.childNodes.length>0)for(var a=0,u=e.childNodes.length;u>a;a++)n(e.childNodes[a],t)}else if(3==e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,e,t)}}function r(e,t,n,r){var s={},a={};if(e.replace(REG_EXP,function(e,t){var r=1;CONVERTER_EXP.test(t)&&(r=i(t,a,n));var o=t;r>1&&(o=t.substr(r));var h=lexer(o);s[t]={words:h.words,varTree:h.varTree}}),!(Object.keys(s).length<1)){var o=new ExpNode(t,r,e,s,n,a);n.$__expNodes.push(o)}}function i(e,t,n){for(var r,i,s=!0,a="",o="",h=[],c=e.indexOf(EXP_CONVERTER_SYM)+1;c<e.length;c++){var l=e[c];switch(l){case" ":case"	":i=!0;continue;case":":r=!0,s=!1,i=!1,o&&(h.push(o),o="");continue;case"|":r=!1,s=!0,i=!1,a&&ConverterFactory.hasTypeOf(a)&&(t[a]=[ConverterFactory.newInstanceOf(a,n),h]),o&&h.push(o),a="",o="",h=[];continue;default:if(i)return a&&(t[a]=[ConverterFactory.newInstanceOf(a,n),h]),o&&h.push(o),c}s?a+=l:r&&(o+=l)}return c}this.scan=function(t,r){var i=t.element;e(i),n(i,r)}},Builder=new function(){function e(e){for(var n=e.$__expNodes.length;n--;){var r=e.$__expNodes[n];for(var i in r.expMap){var s=r.expMap[i],a=s.varTree;for(var o in a){var h=a[o];t(e,h,o,r)}}}for(var n=e.$__components.length;n--;){var c=e.$__components[n];e.$__directives.indexOf(c)>-1||(c.init(),c.display())}for(var n=e.$__directives.length;n--;){var l=e.$__directives[n];l.init()}}function t(e,r,i,s){for(var a in r.subVars){var o=r.subVars[a];t(e,o,a,s)}for(var h=n(e.$__expPropRoot.subProps,r.segments[0],s),c=1;c<r.segments.length;c++){{c==r.segments.length?!0:!1}h=n(h.subProps,r.segments[c],s)}}function n(e,t,n){var r=e[t];return r||(r=e[t]=new ExpProp(t)),n instanceof ExpNode?r.expNodes.indexOf(n)<0&&r.expNodes.push(n):n instanceof AttrObserveNode?r.attrObserveNodes.indexOf(n)<0&&r.attrObserveNodes.push(n):n instanceof Watch&&r.watchs.indexOf(n)<0&&r.watchs.push(n),e[t]}function r(e,t,n,s){if(!(s>DEPTH)){var a=!1;if(Util.isArray(e))Array_observe(e,function(e){i(e,t,n,s)}),a=!0;else if(Util.isObject(e)){if(Util.isWindow(e))return;Object_observe(e,function(e){i(e,t,n,s)}),a=!0}if(a)for(var o=Object.keys(e),h=o.length;h--;){var c=o[h];if(0!==c.indexOf("$")){var l=t.concat();l.push(c),r(e[c],l,n,s+1)}}}}function i(e,t,n,i){for(var s=e.length;s--;){var a=e[s],h=a.name||a.index;if(!h.indexOf||0!==h.indexOf("$")){var c=a.object[h],l=t.concat();a.name&&l.push(h),o(n,l,a.type,c,a.oldValue),r(c,l,n,i)}}}function s(e,t,n,r,i){for(var s,o=e.$__expPropRoot.subProps,h=0;h<t.length;h++){var c=t[h];{if(!o[c])break;s=o[c],o=o[c].subProps}}if(s){var l=t.length-h,p=[];l>0?a(s,l,p):p.push(s);for(var u=[],h=p.length;h--;){for(var v=p[h].expNodes.length;v--;){var f=p[h].expNodes[v];Renderer.renderExpNode(f)}for(var v=p[h].attrObserveNodes.length;v--;){var d=p[h].attrObserveNodes[v],m=Renderer.evalExp(d.directive,d.expObj);d.directive.observe(m)}for(var v=p[h].watchs.length;v--;){var _=p[h].watchs[v];if(_.segments.length==t.length){for(var g=!0,y=0;y<_.segments.length;y++)if("["!=_.segments[y][0]&&"["!=t[y][0]&&_.segments[y]!=t[y]){g=!1;break}g&&u.indexOf(_)<0&&(_.cbk&&_.cbk.call(_.ctrlScope,n,r,i),u.push(_))}}}}}function a(e,t,n){if(1>t)return void n.push(e);for(var r in e.subProps)a(e.subProps[r],t-1,n)}function o(e,t,n,r,i){s(e,t,n,r,i);for(var a=e.$__components.length;a--;){var h=e.$__components[a];o(h,t,n,r,i)}}this.buildExpModel=t,this.build=function(t){e(t);var n=0;r(t,[],t,n+1)}},Renderer=new function(){function renderExpNode(e){var t=calcExp(e.component,e.origin,e.expMap),n=e.converters;if(Object.keys(n).length>0)for(var r in n){var i=n[r][0],s=n[r][1];if(i.$value=t,t=i.to.apply(i,s),i.$html){var a=renderHTML(i,t,e.node,e.component);if(a)return}}null!=t&&updateDOM(e.node,e.attrName,t)}function updateDOM(e,t,n){e.setAttribute?e.setAttribute(t,n):e.nodeValue=n}function calcExp(e,t,n){var r={};for(var i in n){var s=n[i],a=evalExp(e,s);r[i]=void 0==a?"":a}for(var o in r)t=t.replace(EXP_START_TAG+o+EXP_END_TAG,r[o]);return t}function evalExp(e,t){var n=getExpEvalStr(e,t),r="";try{r=new Function("return "+n)()}catch(i){impex.console.debug(i.message+" "+n)}return r}function getExpEvalStr(e,t){var n=t.varTree,r={};for(var i in n){var s=n[i],a=buildVarPath(e,s,i);r[i]=a}var o=joinExpStr(t.words,r);return o}function joinExpStr(e,t){for(var n="",r=0;r<e.length;r++){var i=e[r];n+=i instanceof Array?t[i[0]]:i}return n}function keyWordsMapping(e,t){return"this"==e?t.__getPath():void 0}function buildVarPath(e,t,n){var r={};for(var i in t.subVars){var s=t.subVars[i],a=buildVarPath(e,s,i);r[i]=a}for(var o=!1,h="",c=0;c<t.words.length;c++){var l=t.words[c];if(l instanceof Array){var p=keyWordsMapping(t.segments[0],e);if(p){o=!0;var u=new RegExp("^\\."+t.segments[0]);h+=l[0].replace(u,p)}else h+=r[l[0]]||l[0]}else h+=l}var v="";if(t.watchPath)v=t.watchPath;else for(var c=0;c<t.watchPathWords.length;c++){var l=t.watchPathWords[c];v+=l instanceof Array?r[l[0]]||l[0]:l}return e=v?varInCtrlScope(e,v):varInCtrlScope(e,h),o?h:(e?e.__getPath():"self")+h}function varInCtrlScope(e,t){for(var n=e;n;){if(void 0!=getVarByPath(t,n.__getPath()))return n;n=n.$parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=null;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,n,r){if(e.__lastVal!=t&&Util.isDOMStr(t)){if(!e.__lastVal){var i=ViewManager.createPlaceholder("-- converter [html] placeholder --");ViewManager.insertBefore(i,n),e.__lastVal=t,e.__placeholder=i}if(3==n.nodeType){e.__lastComp&&(e.__lastComp.destroy(),n=ViewManager.createPlaceholder(""),ViewManager.insertAfter(n,e.__placeholder));var s=r.createSubComponent(t,n);return s.init(),s.display(),e.__lastComp=s,e.__lastVal=t,!0}}}this.render=function(e){for(var t=e.$__expNodes.length;t--;)renderExpNode(e.$__expNodes[t]);for(var n=e.$__components.length;n--;)Renderer.render(e.$__components[n])},this.renderExpNode=renderExpNode,this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};ViewModel.prototype={data:function(path,val){var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);return arguments.length>1?(eval(evalStr+'= "'+val+'"'),this):eval(evalStr)}},Component.state={created:"created",inited:"inited",displayed:"displayed",destroyed:"destroyed"},Util.inherits(Component,ViewModel),Util.ext(Component.prototype,{on:function(e,t,n){this.$view.__on(this,e,t,n)},find:function(e,t){e=e.toLowerCase();for(var n=this.$__components.length;n--;){var r=this.$__components[n];if(r.$name==e){var i=!0;if(t)for(var s in t)if(r[s]!=t[s]){i=!1;break}if(i)return r}}return null},watch:function(e,t){var n=lexer(e),r=Object.keys(n.varTree);if(!(r.length<1)){if(r.length>1)return void impex.console.warn("变量表达式"+e+"错误，只能同时watch一个变量");var i=n.varTree[r[0]],s=new Watch(t,this,i.segments);Builder.buildExpModel(this,i,r[0],s)}},add:function(e){this.$__components.push(e),e.$parent=this},createSubComponentOf:function(e,t){var n=ComponentFactory.newInstanceOf(e,t.element?t.element:t);return this.$__components.push(n),n.$parent=this,n},createSubComponent:function(e,t){var n=ComponentFactory.newInstance(e,t.element?t.element:t);return this.$__components.push(n),n.$parent=this,n},init:function(){if(this.__state==Component.state.created){if(this.$templateURL){var e=this;Util.loadTemplate(this.$templateURL,function(t){var n=e.$view.__init(t,e);n!==!1&&(e.__init(),e.display())})}else{if(this.$template){var t=this.$view.__init(this.$template,this);if(t===!1)return}this.__init()}return this}},__init:function(){Scanner.scan(this.$view,this),this.onInit&&this.onInit(),this.__state=Component.state.inited},display:function(){this.__state==Component.state.inited&&(this.$view.__display(),Renderer.render(this),this.onDisplay&&this.onDisplay(),this.__state=Component.state.displayed,Builder.build(this))},destroy:function(){if(this.__state!=Component.state.destroyed){var e=this.$parent.$__components.indexOf(this);e>-1&&this.$parent.$__components.splice(e,1),this.$parent=null,this.$view.__destroy(),this.onDestroy&&this.onDestroy(),this.__state=Component.state.destroyed}},__getPath:function(){return'impex.__components["'+this.__id+'"]'}}),View.prototype={__init:function(e,t){var n=this.__target.attributes,r=this.__target.innerHTML,i=tmplExpFilter(e,r,n),s=DOMViewProvider.compile(i);if(!s)return impex.console.warn('invalid template "'+e+'" of component['+t.$name+"]"),!1;if(this.name=s.nodeName.toLowerCase(),this.element=s,n)for(var a=n.length;a--;){var o=n[a].name,h=n[a].value;t[o]=h}},__display:function(){this.__target&&!this.element.parentNode&&this.__target.parentNode.replaceChild(this.element,this.__target)},__destroy:function(){for(var e in this.__evMap)for(var t=this.__evMap[e].length;t--;){var n=this.__evMap[e][t][0],r=this.__evMap[e][t][1];Util.off(e,n,r)}this.element.parentNode.removeChild(this.element)},__on:function(e,t,n,r){var i=n,s=e,a=null,o="",h=null;Util.on(t,this.element,a=function(e){var t=i;if(r instanceof Function&&(t=r(e,i)),t){if(o!=t){var n=lexer(t),a=Renderer.getExpEvalStr(s,n),c=a.replace("self.$event","$event");h=new Function("$event",c),o=t}h(e)}}),this.__evMap[t]||(this.__evMap[t]=[]),this.__evMap[t].push([this.element,a])},clone:function(){var e=new View(this.element.cloneNode(!0),this.name);return e},show:function(){return this.element.style.display="",this},hide:function(){return this.element.style.display="none",this},style:function(e,t){return arguments.length>1?(this.element.style[e]=t,this):this.element.style[e]},attr:function(e,t){return arguments.length>1?(this.element.setAttribute(e,t),this):this.element.getAttribute(e)},removeAttr:function(e){return this.element.removeAttribute(e),this}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,n){if(e.innerHTML=t,!e.children[0])return null;var r=e.removeChild(e.children[0]),i=new View(r,r.tagName.toLowerCase(),n);return i};var t=["meta","title","base"];this.compile=function(n){if(e.innerHTML=n,!e.children[0])return null;for(;e.children.length>0;){var r=e.removeChild(e.children[0]),i=r.nodeName.toLowerCase();if(!(t.indexOf(i)>-1))return r}}},ViewManager=new function(){this.$singleton=!0,this.replace=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e,i=n.parentNode;i&&i.replaceChild(r,n)},this.insertBefore=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e;n.parentNode.insertBefore(r,n)},this.insertAfter=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e,i=n.parentNode,s=i.lastChild;s==n?i.appendChild(r):i.insertBefore(r,n.nextSibling)},this.createPlaceholder=function(e){return new View(document.createComment(e))}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){var e={},t=this;this.$value.replace(REG_EXP,function(n,r){var i=lexer(r),s=Renderer.evalExp(t.$parent,i);e[r]={val:s}});var n=this.$value;for(var r in e)n=n.replace(EXP_START_TAG+r+EXP_END_TAG,e[r].val);if(this.$view.attr(this.$name,n),this.$value=n,this.observe){var i=lexer(n);for(var s in i.varTree){var a=i.varTree[s],o=new AttrObserveNode(this,i);Builder.buildExpModel(this.$parent,a,s,o)}var h=Renderer.evalExp(this.$parent,i);this.observe(h)}this.onInit&&this.onInit()}}),Converter.prototype={to:function(){return null}},Factory.prototype={register:function(e,t,n){e=e.toLowerCase();var r=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),i={};Util.extProp(i,t),Util.inherits(r,this.baseClass),Util.extMethod(r.prototype,t),this.types[e]={clazz:r,props:i,services:n}},hasTypeOf:function(e){return e in this.types}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{newInstance:function(e){var t=null;if(2==arguments.length){var n=arguments[0],r=arguments[1];t=n,Util.isString(n)?t=this.viewProvider.newInstance(n,r):t.__target=r}else t=e,Util.isDOM(e)&&(t=new View(e,e.tagName.toLowerCase()));var i=new this.baseClass(t);this.instances.push(i);var s=arguments[2],a=arguments[3];if(s&&Util.ext(i,s),Util.isArray(a)){for(var o=[],h=0;h<a.length;h++){var c=ServiceFactory.newInstanceOf(a[h]);o.push(c)}i.onCreate&&i.onCreate.apply(i,o)}return i},newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass);Util.extProp(n,this.types[e].props),n.$view=new View(null,null,t),n.$name=e,this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props.$final},newInstanceOf:function(e,t,n,r,i){if(!this.types[e])return null;var s=new this.types[e].clazz(this.baseClass,r,i,n);Util.extProp(s,this.types[e].props),s.$view=new View(t,t.tagName.toLowerCase());var a=null;if(this.types[e].services){a=[];for(var o=0;o<this.types[e].services.length;o++){var h=ServiceFactory.newInstanceOf(this.types[e].services[o]);a.push(h)}}return n.add(s),s.onCreate&&s.onCreate.apply(s,a),this.instances.push(s),s}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_ConverterFactory,Factory),Util.ext(_ConverterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass,t);Util.extProp(n,this.types[e].props),this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ConverterFactory=new _ConverterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e){if(e=e.toLowerCase(),!this.types[e])return null;var t=null;this.types[e].props.$singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),t=this.types[e].singleton):(t=new this.types[e].clazz(this.baseClass),this.instances.push(t),Util.extProp(t,this.types[e].props));var n=null;if(this.types[e].services){n=[];for(var r=0;r<this.types[e].services.length;r++){var i=ServiceFactory.newInstanceOf(this.types[e].services[r]);n.push(i)}}return t.onCreate&&t.onCreate.apply(t,n),t}});var ServiceFactory=new _ServiceFactory,CMD_PREFIX="x-",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,CONVERTER_EXP=/^\s*#/,EXP_CONVERTER_SYM="#",DEPTH=9,DEBUG=!1,impex=new function(){function e(e){var n=e;do{if(t.indexOf(n)>-1)return!0;n=n.parentNode}while(n);return!1}this.version={v:[0,1,3],state:"alpha",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://mrsoya.github.io/impex",this.option=function(e){EXP_START_TAG=e.expStartTag||"{{",EXP_END_TAG=e.expEndTag||"}}",DEPTH=parseInt(e.recurDepth)||9,REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),DEBUG=e.debug},this.component=function(e,t,n){return ComponentFactory.register(e,t,n),this},this.directive=function(e,t,n){return DirectiveFactory.register(e,t,n),this},this.service=function(e,t,n){return ServiceFactory.register(e,t,n),this},this.converter=function(e,t,n){return ConverterFactory.register(e,t,n),this},this.render=function(n,r,i){var s=n.tagName.toLowerCase();if(e(n))return void impex.console.warn("element ["+s+"] has been rendered");var a=ComponentFactory.newInstanceOf(s,n);return a||(t.push(n),a=ComponentFactory.newInstance(n,null,r,i)),a.init(),a.display(),a};var t=[];this.__components={}};impex.console=new function(){this.warn=function(e){console.warn("impex warn :: "+e)},this.error=function(e){console.error("impex error :: "+e)},this.debug=function(e){DEBUG&&console.debug("impex debug :: "+e)}},self.console=self.console||new function(){this.log=function(){},this.info=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},impex.service("ViewManager",ViewManager),impex.service("ComponentManager",new function(){this.hasTypeOf=function(e){return ComponentFactory.hasTypeOf(e)},this.findAll=function(e){for(var t=ComponentFactory.instances,n=[],r=t.length;r--;){var i=!0;for(var s in e)if(comp[s]!=e[s]){i=!1;break}i&&n.push(comp)}return n}}),impex.directive("click",{onInit:function(){this.on("click",this.$value)}}),impex.directive("show",{observe:function(e){e?this.$view.show():this.$view.hide()}}),impex.directive("if",new function(){this.placeholder=null,this.viewManager,this.onCreate=function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --")},this.observe=function(e){e?this.viewManager.replace(this.$view,this.placeholder):this.viewManager.replace(this.placeholder,this.$view)}},["ViewManager"]),impex.directive("cloak",{onCreate:function(){var e=this.$view.attr("class");e=e.replace("x-cloak",""),this.$view.attr("class",e),updateCloakAttr(this.$parent,this.$view.element,e)}}),impex.directive("bind",{onCreate:function(){"input"==this.$view.name&&this.on("input","changeModel($event)")},changeModel:function(e){this.$parent.data(this.$value,e.target.value)}}),impex.directive("each",new function(){this.$final=!0,this.$eachExp=/(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*=>\s*[a-zA-Z0-9_$]+?)|(?:[a-zA-Z0-9_$]+?))$/,this.viewManager,this.placeholder=null,this.parent=null,this.onCreate=function(e){this.viewManager=e,this.parent=this.$parent,this.expInfo=this.parseExp(this.$value),this.ds=this.parent.data(this.expInfo.ds),this.subComponents=[]},this.onInit=function(){this.placeholder=this.viewManager.createPlaceholder("-- directive [each] placeholder --"),this.viewManager.insertBefore(this.placeholder,this.$view),this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy();var e=this;this.parent.watch(this.expInfo.ds,function(t,n,r){e.rebuild()})},this.rebuild=function(){for(var e=this.parent.data(this.expInfo.ds),t=this.subComponents.length;t--;)this.subComponents[t].destroy();this.subComponents=[],this.build(e,this.expInfo.k,this.expInfo.v)},this.build=function(e,t,n){var r=this.parent,i=Util.isArray(e)?!0:!1;for(var s in e){var a=this.viewManager.createPlaceholder("");this.viewManager.insertBefore(a,this.placeholder);var o=this.$view.clone().removeAttr("x-each"),h=r.createSubComponent(o,a);this.subComponents.push(h),h[n]=e[s],t&&(h[t]=i?s>>0:s)}for(var c=this.subComponents.length;c--;)this.subComponents[c].init(),this.subComponents[c].display()},this.parseExp=function(e){var t,n,r;return e.replace(this.$eachExp,function(e,i,s){t=i;var a=s.replace(/\s/gm,""),o=a.split("=>");o.length>1?(n=o[0],r=o[1]):r=o[0]}),t?{ds:t,k:n,v:r}:void impex.console.error(e+"解析错误，不是合法的each语法")}},["ViewManager"]),impex.converter("html",{$html:!0,to:function(){return this.$value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);