!function(global){"use strict";function ExpProp(e){this.propName=e,this.subProps={},this.expNodes=[],this.attrObserveNodes=[],this.watchs=[]}function ExpNode(e,t,n,r,i,s){this.node=e,this.attrName=t,this.origin=n,this.expMap=r,this.component=i,this.converters=s}function AttrObserveNode(e,t){this.directive=e,this.expObj=t}function Watch(e,t,n){this.cbk=e,this.ctrlScope=t,this.segments=n}function ViewModel(){}function Component(e){var t="C_"+Object.keys(impex.__components).length;impex.__components[t]=this,this.__id=t,this.__state=Component.state.created,this.$view=e,this.$name,this.$parent,this.$__components=[],this.$__directives=[],this.$__expNodes=[],this.$__expPropRoot=new ExpProp,this.$template,this.$templateURL,this.onCreate,this.onInit,this.onDisplay,this.onDestroy}function View(e,t,n){this.element=e,this.name=t,this.__evMap={},this.__target=n}function tmplExpFilter(e,t,n){return e=e.replace(REG_TMPL_EXP,function(e,r){var r=r.replace(/\s/gm,"");if("tagBody"==r)return t;var i=n[r]&&n[r].nodeValue;return i})}function Directive(e,t){Component.call(this),this.$value=t,this.$name=e,this.$final=!1,this.observe}function Converter(e){this.$component=e,this.$value,this.$html=!1,this.onCreate}function Service(){this.$singleton,this.onCreate}function Factory(e){this.types={},this.instances=[],this.baseClass=e}function _ComponentFactory(e){Factory.call(this,Component),this.viewProvider=e}function _DirectiveFactory(){Factory.call(this,Directive)}function _ConverterFactory(){Factory.call(this,Converter)}function _ServiceFactory(){Factory.call(this,Service)}function updateCloakAttr(e,t,n){for(var r=e.$__expNodes.length;r--;){var i=e.$__expNodes[r];i.node==t&&"class"==i.attrName&&(i.origin=n)}for(var s=e.$__components.length;s--;)updateCloakAttr(e.$__components[s],t,n)}var Util=new function(){function e(){impex.console.error("无法获取远程数据 : "+this.url)}function t(){impex.console.error("请求超时 : "+this.url)}function n(){(0===this.status||this.status>=200&&this.status<300||304===this.status)&&this.cbk&&this.cbk(this.responseText)}this.inherits=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},this.ext=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];e[i]=t[i]}},this.extProp=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function||t[i]&&(e[i]=t[i])}},this.extMethod=function(e,t){for(var n=Object.keys(t),r=n.length;r--;){var i=n[r];t[i]instanceof Function&&(e[i]=t[i])}},this.isObject=function(e){return"object"==typeof e},this.isArray=function(e){return e instanceof Array},this.isString=function(e){return"string"==typeof e},this.isFunction=function(e){return e instanceof Function},this.isWindow=function(e){return"Array"in e&&"XMLHttpRequest"in e&&"XMLDocument"in e&&"JSON"in e};var r=document.createElement("div");this.isDOMStr=function(e){return r.innerHTML=e,r.children[0]?!0:!1},this.isDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&e.nodeType&&"string"==typeof e.nodeName},this.on=function(e,t,n){t.addEventListener?t.addEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.attachEvent(e,n))},this.off=function(e,t,n){t.removeEventListener?t.removeEventListener(e,n,!1):(e.indexOf("on")<0&&(e="on"+e),t.detachEvent(e,n))},this.loadTemplate=function(r,i,s){var o=new XMLHttpRequest;o.open("get",r,!0),o.timeout=s||5e3,o.ontimeout=t,o.onerror=e,null===o.onload?o.onload=n:o.onreadystatechange=n,o.cbk=i,o.url=r,o.send(null)}},RAF=function(e){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||function(t){return e.setTimeout(function(){t(Date.now())},16.7)}}(self),fallback=Object.observe?!1:!0,observedObjects=[],observedOldObjects=[],observedArys=[],observedOldArys=[],Object_observe=Object.observe||function(e,t){var n={};for(var r in e){var i=e[r];n[r]=i}observedOldObjects.push(e),observedObjects.push({oldVer:n,newVer:e,handler:t})},Object_unobserve=Object.unobserve||function(e,t){var n=observedOldObjects.indexOf(e);n>-1&&(observedObjects.splice(n,1),observedOldObjects.splice(n,1))},Array_observe=Array.observe||function(e,t){var n=[];if(!(e instanceof Array))throw new Error("Array.observe cannot observe non-array");for(var r=e.length;r--;)n.unshift(e[r]);observedOldArys.push(e),observedArys.push({oldVer:n,newVer:e,handler:t})},Array_unobserve=Array.unobserve||function(e,t){var n=observedOldArys.indexOf(e);n>-1&&(observedArys.splice(n,1),observedOldArys.splice(n,1))};fallback&&function e(){RAF(function(){for(var t=observedObjects.length;t--;){var n=observedObjects[t],r=n.oldVer,i=n.newVer,s=n.handler,o=[];for(var a in r){if(void 0===i[a]){var c={};c.name=a,c.oldValue=r[a],c.object=i,c.type="delete",o.push(c)}if(i[a]!=r[a]){var c={};c.name=a,c.oldValue=r[a],c.object=i,c.type="update",o.push(c)}}for(var a in i)if(void 0===r[a]){var c={};c.name=a,c.oldValue=r[a],c.object=i,c.type="add",o.push(c)}o.length>0&&s(o),n.oldVer={};for(var a in i){var h=i[a];n.oldVer[a]=h}}for(var t=observedArys.length;t--;){var n=observedArys[t],r=n.oldVer,i=n.newVer,s=n.handler,o=[];if(r.length==i.length){for(var l=r.length;l--;)if(i[l]!=r[l]){var c={};c.name=l,c.oldValue=r[l],c.object=i,c.type="update",o.push(c)}}else{var c={};c.type="splice",c.index=-1,c.object=i;for(var p=[],u=r.length;u--;)p.push(i[u]);var v=[];for(var f in r)p[f]!=r[f]&&(-1==c.index&&(c.index=f),v.push(r[f]));for(var d=[],u=0;u<i.length;u++)d.push(r[u]);var m=[];for(var f in r)i[f]!=d[f]&&(-1==c.index&&(c.index=f),m.push(i[f]));o.push(c)}o.length>0&&s(o)}e()})}();var lexer=function(){function e(){return{subVars:{},words:[],segments:[],brakLength:0}}function t(e,t,i){if(a.test(e)){var s=r(i,t);return l="var",s}return o.test(e)?(l="str",n(t,RegExp.$1)):(l="",e)}function n(e,t){for(var n=!1,r=t,i=1;i<e.length;i++){var s=e[i];if("\\"!=s){if(!n&&s==t)return r+t;r+=s,n=!1}else n=!0,r+=s}}function r(n,i,s,o){for(var l="",p=[],u=-1,v=-1,f=-1,d=o||e(),m=0;m<i.length;m++){var _=i[m];if(p.length>0)if(c.test(_)){var g=e(),y=r(n,i.substr(m),!0,g);m=m+y.length-1;var b=y;a.test(y[0])&&(d.subVars["."+y]=g,h.indexOf(b)<0&&(b=["."+b])),d.words.push(b)}else if("]"==_){if(p.pop(),0==p.length){var w=i.substring(u,m+1);l+=w,d.segments.push(w),f=m}d.words.push("]"),v=m}else{var x=t(_,i.substr(m),n);m=m+x.length-1,d.words.push(x),v=m}else if(c.test(_)){if(l+=_,"."==_){var b=l.substr(f+1);b=b.replace(/\./,""),b&&(d.segments.push(b),f=m)}}else{if("["!=_){if("]"==_&&s){var b=l;return"]"!=b[b.length-1]&&(/[a-zA-Z0-9$_]+\[.+\]/.test(l)?(b=b.replace(/[a-zA-Z0-9$_]+\[.+\]/,""),d.words.push(b)):h.indexOf(b)<0&&d.words.push(["."+b]),b=b.substr(b.lastIndexOf(".")),d.segments.push(b),f=m),v=m,l}var b=l.substr(v+1);b&&("."!=b[0]&&h.indexOf(b)<0&&(b=["."+b]),d.words.push(b));var $=l.substr(f+1);return $&&(d.segments.push($),f=m),!s&&h.indexOf(b)<0&&(n["."+l]=d),l}p.push("["),u=m,d.brakLength++;var E=l.substr(v+1);if(E){var b=E;h.indexOf(E)<0&&0>v&&(b=["."+E]),d.words.push(b)}if(d.words.push("["),"]"!=l[m-1]){var C=E.lastIndexOf(".");C>-1?(E=E.substr(C),d.segments.push(E)):d.segments.push(E),f=m}v=m}}var O=l.substr(l.lastIndexOf("]")+1);if(O){var $=l.substr(f+1);d.segments.push($);var b="["==O[0]?O:"."==O[0]?O:"."+O;d.words.length<1&&h.indexOf(b)<0&&(b=[b]),d.words.push(b)}return s||(n["."+l]=d),l}function i(e){for(var t in e){var n=e[t],r=null,o=null,a=t.lastIndexOf(".");if("]"==t[t.length-1]){a=s(t,n.brakLength);var c=n.brakLength;n.watchPathWords=[];for(var h=0;h<n.words.length;h++){var l=n.words[h];if("["==l&&--c<1)break;n.watchPathWords.push(l)}}else n.watchPathWords=n.words.concat(),n.watchPathWords.splice(-1,1);r=t.substr(a),n.lastVar=r,Object.keys(n.subVars).length<1&&(o=t.substring(0,a).replace(/\.$/,""),n.watchPath=o);for(var h=n.segments.length;h--;)n.segments[h]=n.segments[h].replace(/^\.|\.$/g,"");i(n.subVars)}}function s(e,t){for(var n=0;n<e.length;n++){var r=e[n];if("["==r&&--t<1)return n}}var o=/(['"])/,a=/[a-zA-Z$_]/,c=/[a-zA-Z$_0-9.]/,h=["as","instanceof"],l="";return function(e){for(var n=[],r={},s=0;s<e.length;s++){var o=e[s];l="";var a=t(o,e.substr(s),r);switch(s=s+a.length-1,l){case"var":n.push(h.indexOf(a)<0?["."+a]:a);break;case"str":case"":n.push(a)}}return i(r),{words:n,varTree:r}}}(),Scanner=new function(){function e(e){var n=[],r=[];t(e,n);for(var i=n.length;i--;){var e=n[i],s=e.nodeValue,o=[],a=0;s.replace(REG_EXP,function(e,t,n){o.push(s.substring(a,n)),o.push(e),a=n+e.length}),o.push(s.substring(a,s.length));for(var c=document.createDocumentFragment(),h=0;h<o.length;h++){var l=document.createTextNode(o[h]);c.appendChild(l)}r.unshift(c)}for(var h=n.length;h--;){var p=n[h];r[h].childNodes.length>1&&p.parentNode.replaceChild(r[h],p)}}function t(e,n){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.childNodes.length>0)for(var r=0,i=e.childNodes.length;i>r;r++)t(e.childNodes[r],n)}else if(3===e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;n.push(e)}}function n(e,t){if("SCRIPT"!=e.tagName)if(e.attributes||11==e.nodeType){if(e.tagName){var i=e.tagName.toLowerCase();if(ComponentFactory.hasTypeOf(i))return void t.createSubComponentOf(i,e);for(var s=e.attributes,o=s.length;o--;){var a=s[o].name.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(a)&&DirectiveFactory.isFinal(a)){var c=DirectiveFactory.newInstanceOf(a,e,t,s[o].name,s[o].value);return void t.$__directives.push(c)}}for(var o=s.length;o--;){var h=s[o],l=h.name,p=h.value;if(REG_CMD.test(l)){var a=l.replace(CMD_PREFIX,"");if(DirectiveFactory.hasTypeOf(a)){var c=DirectiveFactory.newInstanceOf(a,e,t,s[o].name,p);t.$__directives.push(c)}}else REG_EXP.test(p)&&r(p,e,t,l)}}if(e.childNodes.length>0)for(var o=0,u=e.childNodes.length;u>o;o++)n(e.childNodes[o],t)}else if(3==e.nodeType){if(e.nodeValue.replace(/\t|\r|\s/gim,"").length<1)return;r(e.nodeValue,e,t)}}function r(e,t,n,r){var s={},o={};if(e.replace(REG_EXP,function(e,t){var r=1;CONVERTER_EXP.test(t)&&(r=i(t,o,n));var a=t;r>1&&(a=t.substr(r));var c=lexer(a);s[t]={words:c.words,varTree:c.varTree}}),!(Object.keys(s).length<1)){var a=new ExpNode(t,r,e,s,n,o);n.$__expNodes.push(a)}}function i(e,t,n){for(var r,i,s=!0,o="",a="",c=[],h=e.indexOf(EXP_CONVERTER_SYM)+1;h<e.length;h++){var l=e[h];switch(l){case" ":case"	":i=!0;continue;case":":r=!0,s=!1,i=!1,a&&(c.push(a),a="");continue;case"|":r=!1,s=!0,i=!1,o&&ConverterFactory.hasTypeOf(o)&&(t[o]=[ConverterFactory.newInstanceOf(o,n),c]),a&&c.push(a),o="",a="",c=[];continue;default:if(i)return o&&(t[o]=[ConverterFactory.newInstanceOf(o,n),c]),a&&c.push(a),h}s?o+=l:r&&(a+=l)}return h}this.scan=function(t,r){var i=t.element;e(i),n(i,r)}},Builder=new function(){function e(e){for(var n=e.$__expNodes.length;n--;){var r=e.$__expNodes[n];for(var i in r.expMap){var s=r.expMap[i],o=s.varTree;for(var a in o){var c=o[a];t(e,c,a,r)}}}for(var n=e.$__components.length;n--;){var h=e.$__components[n];e.$__directives.indexOf(h)>-1||(h.init(),h.display())}for(var n=e.$__directives.length;n--;){var l=e.$__directives[n];l.init()}}function t(e,r,i,s){for(var o in r.subVars){var a=r.subVars[o];t(e,a,o,s)}for(var c=n(e.$__expPropRoot.subProps,r.segments[0],s),h=1;h<r.segments.length;h++){{h==r.segments.length?!0:!1}c=n(c.subProps,r.segments[h],s)}}function n(e,t,n){var r=e[t];return r||(r=e[t]=new ExpProp(t)),n instanceof ExpNode?r.expNodes.indexOf(n)<0&&r.expNodes.push(n):n instanceof AttrObserveNode?r.attrObserveNodes.indexOf(n)<0&&r.attrObserveNodes.push(n):n instanceof Watch&&r.watchs.indexOf(n)<0&&r.watchs.push(n),e[t]}function r(e,t,n,s){if(!(s>DEPTH)){var o=!1;if(Util.isArray(e))e.$__observer=function(e){i(e,t,n,s)},Array_observe(e,e.$__observer),o=!0;else if(Util.isObject(e)){if(Util.isDOM(e))return;if(Util.isWindow(e))return;e.$__observer=function(e){i(e,t,n,s)},Object_observe(e,e.$__observer),o=!0}if(o)for(var a=Object.keys(e),c=a.length;c--;){var h=a[c];if(0!==h.indexOf("$")){var l=t.concat();l.push(h),r(e[h],l,n,s+1)}}}}function i(e,t,n,i){for(var s=e.length;s--;){var o=e[s],c=o.name||o.index;if(!c.indexOf||0!==c.indexOf("$")){var h=o.object[c],l=t.concat();o.name&&l.push(c),a(n,l,o.type,h,o.oldValue),Util.isArray(o.oldValue)?Array_unobserve(o.oldValue,o.oldValue.$__observer):Util.isArray(o.object)&&!o.oldValue?(Array_unobserve(o.object,o.object.$__observer),Array_observe(o.object,o.object.$__observer)):Util.isObject(o.oldValue)&&(Object_unobserve(o.oldValue,o.oldValue.$__observer),o.oldValue.$__observer=null),r(h,l,n,i)}}}function s(e,t,n,r,i){for(var s,a=e.$__expPropRoot.subProps,c=0;c<t.length;c++){var h=t[c];{if(!a[h])break;s=a[h],a=a[h].subProps}}if(s){var l=t.length-c,p=[];l>0?o(s,l,p):p.push(s);for(var u=[],c=p.length;c--;){for(var v=p[c].expNodes.length;v--;){var f=p[c].expNodes[v];Renderer.renderExpNode(f)}for(var v=p[c].attrObserveNodes.length;v--;){var d=p[c].attrObserveNodes[v],m=Renderer.evalExp(d.directive,d.expObj);d.directive.observe(m)}for(var v=p[c].watchs.length;v--;){var _=p[c].watchs[v];if(_.segments.length==t.length){for(var g=!0,y=0;y<_.segments.length;y++)if("["!=_.segments[y][0]&&"["!=t[y][0]&&_.segments[y]!=t[y]){g=!1;break}g&&u.indexOf(_)<0&&(_.cbk&&_.cbk.call(_.ctrlScope,n,r,i),u.push(_))}}}}}function o(e,t,n){if(1>t)return void n.push(e);for(var r in e.subProps)o(e.subProps[r],t-1,n)}function a(e,t,n,r,i){s(e,t,n,r,i);for(var o=e.$__components.length;o--;){var c=e.$__components[o];a(c,t,n,r,i)}}this.buildExpModel=t,this.build=function(t){e(t);var n=0;r(t,[],t,n+1)}},Renderer=new function(){function renderExpNode(e){var t=calcExp(e.component,e.origin,e.expMap),n=e.converters;if(Object.keys(n).length>0)for(var r in n){var i=n[r][0],s=n[r][1];if(i.$value=t,t=i.to.apply(i,s),i.$html){var o=renderHTML(i,t,e.node,e.component);if(o)return}}null!=t&&updateDOM(e.node,e.attrName,t)}function updateDOM(e,t,n){e.setAttribute?e.setAttribute(t,n):e.nodeValue=n}function calcExp(e,t,n){var r={};for(var i in n){var s=n[i],o=evalExp(e,s);r[i]=void 0==o?"":o}for(var a in r)t=t.replace(EXP_START_TAG+a+EXP_END_TAG,r[a]);return t}function evalExp(e,t){var n=getExpEvalStr(e,t),r="";try{r=new Function("return "+n)()}catch(i){impex.console.debug(i.message+" "+n)}return r}function getExpEvalStr(e,t){var n=t.varTree,r={};for(var i in n){var s=n[i],o=buildVarPath(e,s,i);r[i]=o}var a=joinExpStr(t.words,r);return a}function joinExpStr(e,t){for(var n="",r=0;r<e.length;r++){var i=e[r];n+=i instanceof Array?t[i[0]]:i}return n}function keyWordsMapping(e,t){return"this"==e?t.__getPath():void 0}function buildVarPath(e,t,n){var r={};for(var i in t.subVars){var s=t.subVars[i],o=buildVarPath(e,s,i);r[i]=o}for(var a=!1,c="",h=0;h<t.words.length;h++){var l=t.words[h];if(l instanceof Array){var p=keyWordsMapping(t.segments[0],e);if(p){a=!0;var u=new RegExp("^\\."+t.segments[0]);c+=l[0].replace(u,p)}else c+=r[l[0]]||l[0]}else c+=l}var v="";if(t.watchPath)v=t.watchPath;else for(var h=0;h<t.watchPathWords.length;h++){var l=t.watchPathWords[h];v+=l instanceof Array?r[l[0]]||l[0]:l}return e=v?varInCtrlScope(e,v):varInCtrlScope(e,c),a?c:(e?e.__getPath():"self")+c}function varInCtrlScope(e,t){for(var n=e;n;){if(void 0!=getVarByPath(t,n.__getPath()))return n;n=n.$parent}}function getVarByPath(path,mPath){var varExp=mPath+path,rs=null;try{rs=eval(varExp.replace(/^\./,""))}catch(e){}return rs}function renderHTML(e,t,n,r){if(e.__lastVal!=t&&Util.isDOMStr(t)){if(!e.__lastVal){var i=ViewManager.createPlaceholder("-- converter [html] placeholder --");ViewManager.insertBefore(i,n),e.__lastVal=t,e.__placeholder=i}if(3==n.nodeType){e.__lastComp&&(e.__lastComp.destroy(),n=ViewManager.createPlaceholder(""),ViewManager.insertAfter(n,e.__placeholder));var s=r.createSubComponent(t,n);return s.init(),s.display(),e.__lastComp=s,e.__lastVal=t,!0}}}this.render=function(e){for(var t=e.$__expNodes.length;t--;)renderExpNode(e.$__expNodes[t]);for(var n=e.$__components.length;n--;)Renderer.render(e.$__components[n])},this.renderExpNode=renderExpNode,this.evalExp=evalExp,this.getExpEvalStr=getExpEvalStr};ViewModel.prototype={data:function(path,val){var expObj=lexer(path),evalStr=Renderer.getExpEvalStr(this,expObj);return arguments.length>1?(eval(evalStr+'= "'+val+'"'),this):eval(evalStr)}},Component.state={created:"created",inited:"inited",displayed:"displayed",destroyed:"destroyed"},Util.inherits(Component,ViewModel),Util.ext(Component.prototype,{on:function(e,t,n){this.$view.__on(this,e,t,n)},find:function(e,t){e=e.toLowerCase();for(var n=this.$__components.length;n--;){var r=this.$__components[n];if(r.$name==e){var i=!0;if(t)for(var s in t)if(r[s]!=t[s]){i=!1;break}if(i)return r}}return null},watch:function(e,t){var n=lexer(e),r=Object.keys(n.varTree);if(!(r.length<1)){if(r.length>1)return void impex.console.warn("变量表达式"+e+"错误，只能同时watch一个变量");var i=n.varTree[r[0]],s=new Watch(t,this,i.segments);Builder.buildExpModel(this,i,r[0],s)}},add:function(e){this.$__components.push(e),e.$parent=this},createSubComponentOf:function(e,t){var n=ComponentFactory.newInstanceOf(e,t.element?t.element:t);return this.$__components.push(n),n.$parent=this,n},createSubComponent:function(e,t){var n=ComponentFactory.newInstance(e,t.element?t.element:t);return this.$__components.push(n),n.$parent=this,n},init:function(){if(this.__state==Component.state.created){if(this.$templateURL){var e=this;Util.loadTemplate(this.$templateURL,function(t){var n=e.$view.__init(t,e);n!==!1&&(e.__init(),e.display())})}else{if(this.$template){var t=this.$view.__init(this.$template,this);if(t===!1)return}this.__init()}return this}},__init:function(){Scanner.scan(this.$view,this),this.onInit&&this.onInit(),this.__state=Component.state.inited},display:function(){this.__state==Component.state.inited&&(this.$view.__display(),Renderer.render(this),this.onDisplay&&this.onDisplay(),this.__state=Component.state.displayed,Builder.build(this))},destroy:function(){if(this.__state!=Component.state.destroyed){var e=this.$parent.$__components.indexOf(this);e>-1&&this.$parent.$__components.splice(e,1),this.$parent=null,this.$view.__destroy(),this.onDestroy&&this.onDestroy(),this.__state=Component.state.destroyed}},__getPath:function(){return'impex.__components["'+this.__id+'"]'}}),View.prototype={__init:function(e,t){var n=this.__target.attributes,r=this.__target.innerHTML,i=tmplExpFilter(e,r,n),s=DOMViewProvider.compile(i);if(!s)return impex.console.warn('invalid template "'+e+'" of component['+t.$name+"]"),!1;if(this.name=s.nodeName.toLowerCase(),this.element=s,n)for(var o=n.length;o--;){var a=n[o].name,c=n[o].value;t[a]=c}},__display:function(){!this.__target||this.element.parentNode&&1===this.element.parentNode.nodeType||this.__target.parentNode.replaceChild(this.element,this.__target)},__destroy:function(){for(var e in this.__evMap)for(var t=this.__evMap[e].length;t--;){var n=this.__evMap[e][t][0],r=this.__evMap[e][t][1];Util.off(e,n,r)}this.element.parentNode.removeChild(this.element)},__on:function(e,t,n,r){var i=n,s=e,o=null,a="",c=null;Util.on(t,this.element,o=function(e){var t=i;if(r instanceof Function&&(t=r(e,i)),t){if(a!=t){var n=lexer(t),o=Renderer.getExpEvalStr(s,n),h=o.replace("self.$event","$event");c=new Function("$event",h),a=t}c(e)}}),this.__evMap[t]||(this.__evMap[t]=[]),this.__evMap[t].push([this.element,o])},clone:function(){var e=new View(this.element.cloneNode(!0),this.name);return e},show:function(){return this.element.style.display="",this},hide:function(){return this.element.style.display="none",this},style:function(e,t){return arguments.length>1?(this.element.style[e]=t,this):this.element.style[e]},attr:function(e,t){return arguments.length>1?(this.element.setAttribute(e,t),this):this.element.getAttribute(e)},removeAttr:function(e){return this.element.removeAttribute(e),this}};var DOMViewProvider=new function(){var e=document.createElement("div");this.newInstance=function(t,n){if(e.innerHTML=t,!e.children[0])return null;var r=e.removeChild(e.children[0]),i=new View(r,r.tagName.toLowerCase(),n);return i};var t=["meta","title","base"];this.compile=function(n){if(e.innerHTML=n,!e.children[0])return null;for(;e.children.length>0;){var r=e.removeChild(e.children[0]),i=r.nodeName.toLowerCase();if(!(t.indexOf(i)>-1))return r}}},ViewManager=new function(){this.$singleton=!0,this.replace=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e,i=n.parentNode;i&&i.replaceChild(r,n)},this.insertBefore=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e;n.parentNode.insertBefore(r,n)},this.insertAfter=function(e,t){var n=t instanceof View?t.element:t,r=e instanceof View?e.element:e,i=n.parentNode,s=i.lastChild;s==n?i.appendChild(r):i.insertBefore(r,n.nextSibling)},this.createPlaceholder=function(e){return new View(document.createComment(e))}};Util.inherits(Directive,Component),Util.ext(Directive.prototype,{init:function(){var e={},t=this;this.$value.replace(REG_EXP,function(n,r){var i=lexer(r),s=Renderer.evalExp(t.$parent,i);e[r]={val:s}});var n=this.$value;for(var r in e)n=n.replace(EXP_START_TAG+r+EXP_END_TAG,e[r].val);if(this.$view.attr(this.$name,n),this.$value=n,this.observe){var i=lexer(n);for(var s in i.varTree){var o=i.varTree[s],a=new AttrObserveNode(this,i);Builder.buildExpModel(this.$parent,o,s,a)}var c=Renderer.evalExp(this.$parent,i);this.observe(c)}this.onInit&&this.onInit()}}),Converter.prototype={to:function(){return null}},Factory.prototype={register:function(e,t,n){e=e.toLowerCase();var r=new Function("clazz","var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);clazz.apply(this,args)"),i={};Util.extProp(i,t),Util.inherits(r,this.baseClass),Util.extMethod(r.prototype,t),this.types[e]={clazz:r,props:i,services:n}},hasTypeOf:function(e){return e in this.types}},Util.inherits(_ComponentFactory,Factory),Util.ext(_ComponentFactory.prototype,{newInstance:function(e){var t=null;if(2==arguments.length){var n=arguments[0],r=arguments[1];t=n,Util.isString(n)?t=this.viewProvider.newInstance(n,r):t.__target=r}else t=e,Util.isDOM(e)&&(t=new View(e,e.tagName.toLowerCase()));var i=new this.baseClass(t);this.instances.push(i);var s=arguments[2],o=arguments[3];if(s&&Util.ext(i,s),Util.isArray(o)){for(var a=[],c=0;c<o.length;c++){var h=ServiceFactory.newInstanceOf(o[c]);a.push(h)}i.onCreate&&i.onCreate.apply(i,a)}return i},newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass);Util.extProp(n,this.types[e].props),n.$view=new View(null,null,t),n.$name=e,this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ComponentFactory=new _ComponentFactory(DOMViewProvider);Util.inherits(_DirectiveFactory,Factory),Util.ext(_DirectiveFactory.prototype,{isFinal:function(e){return!!this.types[e].props.$final},newInstanceOf:function(e,t,n,r,i){if(!this.types[e])return null;var s=new this.types[e].clazz(this.baseClass,r,i,n);Util.extProp(s,this.types[e].props),s.$view=new View(t,t.tagName.toLowerCase());var o=null;if(this.types[e].services){o=[];for(var a=0;a<this.types[e].services.length;a++){var c=ServiceFactory.newInstanceOf(this.types[e].services[a]);o.push(c)}}return n.add(s),s.onCreate&&(o?s.onCreate.apply(s,o):s.onCreate()),this.instances.push(s),s}});var DirectiveFactory=new _DirectiveFactory;Util.inherits(_ConverterFactory,Factory),Util.ext(_ConverterFactory.prototype,{newInstanceOf:function(e,t){if(!this.types[e])return null;var n=new this.types[e].clazz(this.baseClass,t);Util.extProp(n,this.types[e].props),this.instances.push(n);var r=null;if(this.types[e].services){r=[];for(var i=0;i<this.types[e].services.length;i++){var s=ServiceFactory.newInstanceOf(this.types[e].services[i]);r.push(s)}}return n.onCreate&&n.onCreate.apply(n,r),n}});var ConverterFactory=new _ConverterFactory;Util.inherits(_ServiceFactory,Factory),Util.ext(_ServiceFactory.prototype,{newInstanceOf:function(e){if(e=e.toLowerCase(),!this.types[e])return null;var t=null;this.types[e].props.$singleton?(this.types[e].singleton||(this.types[e].singleton=new this.types[e].clazz(this.baseClass)),t=this.types[e].singleton):(t=new this.types[e].clazz(this.baseClass),this.instances.push(t),Util.extProp(t,this.types[e].props));var n=null;if(this.types[e].services){n=[];for(var r=0;r<this.types[e].services.length;r++){var i=ServiceFactory.newInstanceOf(this.types[e].services[r]);n.push(i)}}return t.onCreate&&t.onCreate.apply(t,n),t}});var ServiceFactory=new _ServiceFactory,CMD_PREFIX="x-",EXP_START_TAG="{{",EXP_END_TAG="}}",REG_EXP=/\{\{(.*?)\}\}/gim,REG_TMPL_EXP=/\{\{=(.*?)\}\}/gim,REG_CMD=/x-.*/,CONVERTER_EXP=/^\s*#/,EXP_CONVERTER_SYM="#",DEPTH=9,DEBUG=!1,impex=new function(){function e(e){var n=e;do{if(t.indexOf(n)>-1)return!0;n=n.parentNode}while(n);return!1}this.version={v:[0,1,3],state:"alpha",toString:function(){return impex.version.v.join(".")+" "+impex.version.state}},this.website="http://mrsoya.github.io/impex",this.option=function(e){EXP_START_TAG=e.expStartTag||"{{",EXP_END_TAG=e.expEndTag||"}}",DEPTH=parseInt(e.recurDepth)||9,REG_EXP=new RegExp(EXP_START_TAG+"(.*?)"+EXP_END_TAG,"img"),REG_TMPL_EXP=new RegExp(EXP_START_TAG+"=(.*?)"+EXP_END_TAG,"img"),DEBUG=e.debug},this.component=function(e,t,n){return ComponentFactory.register(e,t,n),this},this.directive=function(e,t,n){return DirectiveFactory.register(e,t,n),this},this.service=function(e,t,n){return ServiceFactory.register(e,t,n),this},this.converter=function(e,t,n){return ConverterFactory.register(e,t,n),this},this.render=function(n,r,i){var s=n.tagName.toLowerCase();if(e(n))return void impex.console.warn("element ["+s+"] has been rendered");var o=ComponentFactory.newInstanceOf(s,n);return o||(t.push(n),o=ComponentFactory.newInstance(n,null,r,i)),o.init(),o.display(),o};var t=[];this.__components={}};impex.console=new function(){this.warn=function(e){console.warn("impex warn :: "+e)},this.error=function(e){console.error("impex error :: "+e)},this.debug=function(e){DEBUG&&console.debug("impex debug :: "+e)}},self.console=self.console||new function(){this.log=function(){},this.info=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},impex.service("ViewManager",ViewManager),impex.service("ComponentManager",new function(){this.hasTypeOf=function(e){return ComponentFactory.hasTypeOf(e)},this.findAll=function(e){for(var t=ComponentFactory.instances,n=[],r=t.length;r--;){var i=!0;for(var s in e)if(comp[s]!=e[s]){i=!1;break}i&&n.push(comp)}return n}}),impex.directive("click",{onInit:function(){this.on("click",this.$value)}}),impex.directive("show",{observe:function(e){e?this.$view.show():this.$view.hide()}}),impex.directive("if",new function(){this.placeholder=null,this.viewManager,this.onCreate=function(e){this.viewManager=e,this.placeholder=e.createPlaceholder("-- directive [if] placeholder --")},this.observe=function(e){e?this.viewManager.replace(this.$view,this.placeholder):this.viewManager.replace(this.placeholder,this.$view)}},["ViewManager"]),impex.directive("cloak",{onCreate:function(){var e=this.$view.attr("class");e=e.replace("x-cloak",""),this.$view.attr("class",e),updateCloakAttr(this.$parent,this.$view.element,e)}}),impex.directive("bind",{onCreate:function(){if("input"==this.$view.name){var e=null===document.body.onpropertychange?"propertychange":"input";this.on(e,"changeModel($event)")}},changeModel:function(e){this.$parent.data(this.$value,(e.target||e.srcElement).value)}}),impex.directive("each",new function(){this.$final=!0,this.$eachExp=/(.+?)\s+as\s+((?:[a-zA-Z0-9_$]+?\s*=>\s*[a-zA-Z0-9_$]+?)|(?:[a-zA-Z0-9_$]+?))$/,this.viewManager,this.placeholder=null,this.parent=null,this.onCreate=function(e){this.viewManager=e,this.parent=this.$parent,this.expInfo=this.parseExp(this.$value),this.ds=this.parent.data(this.expInfo.ds),this.subComponents=[]},this.onInit=function(){this.placeholder=this.viewManager.createPlaceholder("-- directive [each] placeholder --"),this.viewManager.insertBefore(this.placeholder,this.$view),this.build(this.ds,this.expInfo.k,this.expInfo.v),this.destroy();var e=this;this.parent.watch(this.expInfo.ds,function(t,n,r){e.rebuild()})},this.rebuild=function(){for(var e=this.parent.data(this.expInfo.ds),t=this.subComponents.length;t--;)this.subComponents[t].destroy();this.subComponents=[],this.build(e,this.expInfo.k,this.expInfo.v)},this.build=function(e,t,n){var r=this.parent,i=Util.isArray(e)?!0:!1;for(var s in e)if(e.hasOwnProperty(s)){var o=this.viewManager.createPlaceholder("");this.viewManager.insertBefore(o,this.placeholder);var a=this.$view.clone().removeAttr("x-each"),c=r.createSubComponent(a,o);this.subComponents.push(c),c[n]=e[s],t&&(c[t]=i?s>>0:s)}for(var h=this.subComponents.length;h--;)this.subComponents[h].init(),this.subComponents[h].display()},this.parseExp=function(e){var t,n,r;return e.replace(this.$eachExp,function(e,i,s){t=i;var o=s.replace(/\s/gm,""),a=o.split("=>");a.length>1?(n=a[0],r=a[1]):r=a[0]}),t?{ds:t,k:n,v:r}:void impex.console.error(e+"解析错误，不是合法的each语法")}},["ViewManager"]),impex.converter("html",{$html:!0,to:function(){return this.$value}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=impex:global.impex=impex}(window||this);